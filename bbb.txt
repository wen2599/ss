File: backend/ai_helper.php\n<?php
// File: backend/ai_helper.php (ç»ˆæé˜²å¾¡æ€§ä¿®å¤ç‰ˆ)

require_once __DIR__ . '/helpers/mail_parser.php';
require_once __DIR__ . '/db_operations.php';
require_once __DIR__ . '/lottery/rules.php';

function analyzeBetSlipWithAI(string $emailContent, string $lotteryType = 'é¦™æ¸¯å…­åˆå½©'): array {
    return analyzeSingleBetWithAI($emailContent, $lotteryType, null);
}

function analyzeSingleBetWithAI(string $betText, string $lotteryType = 'é¦™æ¸¯å…­åˆå½©', ?array $context = null): array {
    return analyzeWithCloudflareAI($betText, $lotteryType, $context);
}

/**
 * ç»ˆæé˜²å¾¡æ€§è§£æå‡½æ•°ï¼šä»AIè¿”å›çš„æ–‡æœ¬ä¸­å®‰å…¨åœ°æå–JSONã€‚
 */
function extract_json_from_ai_response(string $text): ?string {
    // 1. å°è¯•ç›´æ¥è§£ç ï¼Œçœ‹å®ƒæœ¬èº«æ˜¯ä¸æ˜¯ä¸€ä¸ªçº¯å‡€çš„JSON
    json_decode($text);
    if (json_last_error() === JSON_ERROR_NONE) {
        return $text;
    }

    // 2. å°è¯•ä» ```json ... ``` ä»£ç å—ä¸­æå–
    if (preg_match('/```json\s*([\s\S]*?)\s*```/', $text, $matches)) {
        return $matches[1];
    }

    // 3. å°è¯•è´ªå©ªåŒ¹é…ç¬¬ä¸€ä¸ª { å’Œæœ€åä¸€ä¸ª }
    $first_brace = strpos($text, '{');
    $last_brace = strrpos($text, '}');
    if ($first_brace !== false && $last_brace !== false && $last_brace > $first_brace) {
        return substr($text, $first_brace, $last_brace - $first_brace + 1);
    }

    return null; // æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥äº†
}


function analyzeWithCloudflareAI(string $text, string $lotteryType = 'é¦™æ¸¯å…­åˆå½©', ?array $context = null): array {
    $accountId = config('CLOUDFLARE_ACCOUNT_ID');
    $apiToken = config('CLOUDFLARE_API_TOKEN');

    if (!$accountId || !$apiToken) {
        return ['success' => false, 'message' => 'Cloudflare AI credentials not configured.'];
    }

    $model = '@cf/meta/llama-3-8b-instruct';
    $url = "https://api.cloudflare.com/client/v4/accounts/{$accountId}/ai/run/{$model}";

    // Prompt ä¿æŒä¸å˜...
    $prompt = "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å…­åˆå½©ä¸‹æ³¨å•è¯†åˆ«åŠ©æ‰‹ã€‚è¯·ä»ä»¥ä¸‹æ–‡æœ¬ä¸­ç²¾ç¡®è¯†åˆ«å‡ºä¸‹æ³¨ä¿¡æ¯ï¼Œå¹¶ä»¥ä¸¥æ ¼çš„JSONæ ¼å¼è¿”å›ç»“æœã€‚\n\n";
    if ($context) {
        $prompt .= "--- ç”¨æˆ·ä¿®æ­£ä¿¡æ¯ ---\n";
        $prompt .= "è¿™æ˜¯æˆ‘ï¼ˆAIï¼‰ä¸Šæ¬¡çš„è§£æç»“æœ: " . json_encode($context['original_parse']) . "\n";
        $prompt .= "ç”¨æˆ·æŒ‡å‡ºæ­£ç¡®çš„æ€»é‡‘é¢åº”è¯¥æ˜¯: " . $context['corrected_total_amount'] . "å…ƒ\n";
        if (!empty($context['reason'])) {
            $prompt .= "ç”¨æˆ·ç»™å‡ºçš„ç†ç”±æ˜¯: '" . $context['reason'] . "'\n";
        }
        $prompt .= "è¯·æ ¹æ®è¿™äº›çº¿ç´¢ï¼Œé‡æ–°æ€è€ƒå¹¶ç”Ÿæˆä¸€ä»½å…¨æ–°çš„ã€æ›´å‡†ç¡®çš„è§£æã€‚ç‰¹åˆ«æ³¨æ„é‡‘é¢çš„è®¡ç®—æ–¹å¼ï¼Œç¡®ä¿æœ€ç»ˆçš„ 'total_amount' å­—æ®µç­‰äºç”¨æˆ·æä¾›çš„æ­£ç¡®æ€»é‡‘é¢ã€‚\n";
        $prompt .= "-------------------\n\n";
    }
    $prompt .= "è¯·éµå¾ªä»¥ä¸‹æ ¼å¼å’Œè§„åˆ™ï¼š\n";
    $prompt .= "1. \"æ¾³é—¨36,48å„30#\" â†’ è¡¨ç¤ºå·ç 36å’Œ48å„ä¸‹æ³¨30å…ƒ\n";
    $prompt .= "2. \"é¦™æ¸¯ï¼š10.22.34å„5å—\" â†’ è¡¨ç¤ºå·ç 10,22,34å„ä¸‹æ³¨5å…ƒ\n";
    $prompt .= "3. \"40x10å…ƒ\" â†’ è¡¨ç¤ºå·ç 40ä¸‹æ³¨10å…ƒ\n";
    $prompt .= "å½“å‰é»˜è®¤å½©ç¥¨ç±»å‹: {$lotteryType}\n\n";
    $prompt .= "è¿”å›çš„JSONæ ¼å¼å¿…é¡»å¦‚ä¸‹ï¼š\n";
    $prompt .= "{\n    \"lottery_type\": \"{$lotteryType}\",\n    \"bets\": [\n        {\n            \"bet_type\": \"ç©æ³•ï¼ˆç‰¹ç /å¹³ç /ç”Ÿè‚–ç­‰ï¼‰\",\n            \"targets\": [\"å·ç æˆ–ç›®æ ‡\"],\n            \"amount\": é‡‘é¢,\n            \"raw_text\": \"åŸå§‹ä¸‹æ³¨æ–‡æœ¬ç‰‡æ®µ\"\n        }\n    ],\n    \"total_amount\": æ€»ä¸‹æ³¨é‡‘é¢ // åŠ¡å¿…ç²¾ç¡®è®¡ç®—æ‰€æœ‰ä¸‹æ³¨çš„æ€»å’Œ\n}\n\n";
    $prompt .= "èŠå¤©è®°å½•åŸæ–‡ï¼š\n---\n{$text}\n---";

    $payload = [ 'messages' => [ ['role' => 'system', 'content' => 'ä½ æ˜¯ä¸€ä¸ªåªè¾“å‡ºä¸¥æ ¼JSONæ ¼å¼çš„åŠ©æ‰‹ã€‚ä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæ€§æ–‡å­—ã€‚'], ['role' => 'user', 'content' => $prompt] ] ];
    $headers = [ 'Authorization: Bearer ' . $apiToken, 'Content-Type: application/json' ];
    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($payload));
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_TIMEOUT, 60);
    $responseBody = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    $log_file = __DIR__ . '/ai_debug.log';
    $log_content = "====== AI Request ======\n";
    $log_content .= "Time: " . date('Y-m-d H:i:s') . "\n";
    $log_content .= "Prompt Text: " . $text . "\n";
    $log_content .= "HTTP Code: " . $httpCode . "\n";
    $log_content .= "Raw Response: " . $responseBody . "\n\n";
    file_put_contents($log_file, $log_content, FILE_APPEND);

    if ($httpCode !== 200) { return ['success' => false, 'message' => "AI API Error (HTTP {$httpCode}): " . $responseBody]; }

    $responseData = json_decode($responseBody, true);
    $ai_response_text = $responseData['result']['response'] ?? null;
    if (!$ai_response_text) { return ['success' => false, 'message' => 'AIè¿”å›äº†æ— æ•ˆçš„ç»“æ„ã€‚']; }

    // ã€ã€ã€ã€ã€æ ¸å¿ƒä¿®å¤ç‚¹ã€‘ã€‘ã€‘ã€‘ã€‘
    // ä½¿ç”¨æ–°çš„ç»ˆæé˜²å¾¡æ€§è§£æå‡½æ•°
    $json_string = extract_json_from_ai_response($ai_response_text);

    if (!$json_string) {
        return ['success' => false, 'message' => 'AIæ²¡æœ‰è¿”å›æœ‰æ•ˆçš„JSONå†…å®¹ã€‚åŸå§‹è¿”å›: ' . $ai_response_text];
    }

    $bet_data = json_decode($json_string, true);
    if (json_last_error() !== JSON_ERROR_NONE) {
        return ['success' => false, 'message' => 'ä»AIå“åº”ä¸­æå–çš„å†…å®¹æ— æ³•è¢«è§£æä¸ºJSONã€‚æå–å†…å®¹: ' . $json_string];
    }

    // (åç»­æ•°æ®å¤„ç†é€»è¾‘ä¿æŒä¸å˜)
    if (isset($bet_data['bets']) && is_array($bet_data['bets'])) {
        $totalAmount = 0;
        foreach ($bet_data['bets'] as $bet) {
            $amount = floatval($bet['amount'] ?? 0);
            $targetCount = is_array($bet['targets']) ? count($bet['targets']) : 1;
            $bet_type = $bet['bet_type'] ?? '';
            if (in_array($bet_type, ['ç‰¹ç ', 'å·ç ', 'å¹³ç '])) {
                $totalAmount += $amount * $targetCount;
            } else {
                $totalAmount += $amount;
            }
        }
        if (!isset($bet_data['total_amount'])) {
            $bet_data['total_amount'] = $totalAmount;
        }
    }

    return ['success' => true, 'data' => $bet_data];
}

// reanalyzeEmailWithAI å’Œ trainAIWithCorrection ä¿æŒä¸å˜
function reanalyzeEmailWithAI(int $emailId): array {
    try {
        $pdo = get_db_connection();
        $stmt = $pdo->prepare("SELECT content FROM raw_emails WHERE id = ?");
        $stmt->execute([$emailId]);
        $emailContent = $stmt->fetchColumn();
        if (!$emailContent) return ['success' => false, 'message' => 'Email not found'];
        $aiResult = analyzeBetSlipWithAI($emailContent);
        if ($aiResult['success']) {
            $stmtDelete = $pdo->prepare("DELETE FROM parsed_bets WHERE email_id = ?");
            $stmtDelete->execute([$emailId]);
            $model_used = $aiResult['model'] ?? 'unknown_model';
            $bet_data_json = json_encode($aiResult['data']);
            $stmtInsert = $pdo->prepare("INSERT INTO parsed_bets (email_id, bet_data_json, ai_model_used) VALUES (?, ?, ?)");
            $stmtInsert->execute([$emailId, $bet_data_json, $model_used]);
            $stmtUpdate = $pdo->prepare("UPDATE raw_emails SET status = 'processed' WHERE id = ?");
            $stmtUpdate->execute([$emailId]);
            return ['success' => true, 'message' => 'é‡æ–°è§£ææˆåŠŸ', 'batch_id' => $pdo->lastInsertId()];
        } else {
            $stmtUpdate = $pdo->prepare("UPDATE raw_emails SET status = 'failed' WHERE id = ?");
            $stmtUpdate->execute([$emailId]);
            return ['success' => false, 'message' => 'AIè§£æå¤±è´¥: ' . ($aiResult['message'] ?? 'æœªçŸ¥é”™è¯¯')];
        }
    } catch (Exception $e) {
        return ['success' => false, 'message' => 'é‡æ–°è§£æè¿‡ç¨‹ä¸­å‡ºé”™: ' . $e->getMessage()];
    }
}
function trainAIWithCorrection($learning_data) {
    $log_message = "AI Learning Triggered:\n" . json_encode($learning_data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . "\n\n";
    error_log($log_message, 3, __DIR__ . '/ai_learning.log');
    return true;
}

?>\n\n---\n\nFile: backend/api_header.php\n<?php
// File: backend/api_header.php

if (defined('API_HEADER_LOADED')) return;
define('API_HEADER_LOADED', true);

// ä½¿ç”¨ config() å‡½æ•°ï¼Œå¹¶æä¾›ä¸€ä¸ªå®‰å…¨çš„å¤‡ç”¨å€¼ï¼ˆå°½ç®¡æˆ‘ä»¬æœŸæœ›å®ƒèƒ½è¯»åˆ°æ­£ç¡®çš„URLï¼‰
$frontend_url = config('FRONTEND_URL');

// å¦‚æœ frontend_url ä¸ºç©ºæˆ–æœªè®¾ç½®ï¼Œåˆ™ä¸å‘é€ä»»ä½• CORS å¤´ï¼Œä»¥ä¾¿åœ¨æµè§ˆå™¨ä¸­çœ‹åˆ°æ›´æ˜ç¡®çš„é”™è¯¯
if ($frontend_url) {
    header("Access-Control-Allow-Origin: " . $frontend_url);
} else {
    // æ•…æ„ä¸è®¾ç½®ï¼Œè¿™æ ·æµè§ˆå™¨ä¼šæŠ¥ä¸€ä¸ªå…³äºç¼ºå°‘å¤´çš„é”™è¯¯ï¼Œè€Œä¸æ˜¯å…³äº '*' çš„é”™è¯¯
    // è¿™èƒ½å¸®åŠ©æˆ‘ä»¬ç¡®è®¤é—®é¢˜å°±æ˜¯ FRONTEND_URL æ²¡è¯»åˆ°
}

header('Access-Control-Allow-Credentials: true');
header('Access-Control-Allow-Methods: GET, POST, OPTIONS, DELETE, PUT');
header('Access-Control-Allow-Headers: Content-Type, Authorization, X-Requested-With');

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(204);
    exit;
}

header('Content-Type: application/json');

if (session_status() === PHP_SESSION_NONE) {
    session_set_cookie_params([
        'lifetime' => 86400, 'path' => '/',
        'domain' => '', 'secure' => true,
        'httponly' => true, 'samesite' => 'None'
    ]);
    session_start();
}\n\n---\n\nFile: backend/config.php\n<?php
// File: backend/config.php (Final Debugging Version for FRONTEND_URL)

// å®šä¹‰ä¸€ä¸ªè°ƒè¯•æ—¥å¿—æ–‡ä»¶è·¯å¾„
define('CONFIG_DEBUG_LOG', __DIR__ . '/config_debug.log');

// åœ¨è„šæœ¬æ‰§è¡Œæ—¶ï¼Œå¦‚æœæ—¥å¿—å·²å­˜åœ¨ï¼Œåˆ™ä¸æ¸…ç©ºï¼Œä»¥ä¾¿æˆ‘ä»¬è¿½åŠ æ—¥å¿—
// unlink(CONFIG_DEBUG_LOG);

function _log_config_debug($message) {
    error_log(date('[Y-m-d H:i:s] ') . $message . "\n", 3, CONFIG_DEBUG_LOG);
}

// è®°å½•å“ªä¸ªæ–‡ä»¶æ­£åœ¨åŠ è½½ config.php
$caller = debug_backtrace()[0]['file'];
_log_config_debug("--- config.php loaded by: {$caller} ---");

if (!function_exists('config')) {
    function config(string $key, $default = null) {
        static $config = null;

        if ($config === null) {
            _log_config_debug("Static \$config is null. Initializing...");
            $config = [];
            $envPath = __DIR__ . '/.env';

            if (file_exists($envPath) && is_readable($envPath)) {
                $lines = file($envPath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
                if ($lines) {
                    foreach ($lines as $line) {
                        if (strpos(trim($line), ';') === 0) continue;
                        if (strpos($line, ';') !== false) {
                            $line = substr($line, 0, strpos($line, ';'));
                        }
                        if (strpos($line, '=') !== false) {
                            list($name, $value) = explode('=', $line, 2);
                            $name = trim($name);
                            $value = trim(trim($value), "\"'");
                            $config[$name] = $value;
                            if ($name === 'FRONTEND_URL') {
                                _log_config_debug("SUCCESS: Found and loaded [FRONTEND_URL] = [{$value}]");
                            }
                        }
                    }
                }
            } else {
                 _log_config_debug("FATAL: .env file not found or not readable.");
            }
        }

        $returnValue = $config[$key] ?? $default;
        _log_config_debug("config('{$key}') requested, returning: " . ($returnValue ?? 'NULL'));
        return $returnValue;
    }
}

// ... Error Handling ...
ini_set('display_errors', '0');
ini_set('log_errors', '1');
ini_set('error_log', __DIR__ . '/debug.log');
error_reporting(E_ALL);\n\n---\n\nFile: backend/database_schema.sql\nCREATE TABLE IF NOT EXISTS `users` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `email` VARCHAR(255) NOT NULL,
  `password_hash` VARCHAR(255) NOT NULL,
  `status` ENUM('active', 'banned') NOT NULL DEFAULT 'active',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `raw_emails` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `user_id` INT NOT NULL,
  `content` MEDIUMTEXT NOT NULL,
  `status` ENUM('pending', 'processed', 'failed') NOT NULL DEFAULT 'pending',
  `received_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `parsed_bets` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `email_id` INT NOT NULL,
  `bet_data_json` JSON NOT NULL,
  `ai_model_used` VARCHAR(50),
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`email_id`) REFERENCES `raw_emails`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `lottery_results` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `lottery_type` VARCHAR(100) NOT NULL,
  `issue_number` VARCHAR(255) NOT NULL,
  `winning_numbers` JSON NOT NULL,
  `zodiac_signs` JSON NOT NULL,
  `colors` JSON NOT NULL,
  `drawing_date` DATE,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY `type_issue` (`lottery_type`, `issue_number`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `settlements` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `bet_id` INT NOT NULL,
  `result_data_json` JSON NOT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`bet_id`) REFERENCES `parsed_bets`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n---\n\nFile: backend/db_operations.php\n<?php
// File: backend/db_operations.php

if (defined('DB_OPERATIONS_LOADED')) return;
define('DB_OPERATIONS_LOADED', true);

function get_db_connection() {
    static $pdo = null;
    if ($pdo === null) {
        $dsn = sprintf("mysql:host=%s;port=%s;dbname=%s;charset=utf8mb4",
            config('DB_HOST'),
            config('DB_PORT'),
            config('DB_DATABASE')
        );

        $options = [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
            PDO::ATTR_EMULATE_PREPARES => false
        ];

        $pdo = new PDO($dsn, config('DB_USERNAME'), config('DB_PASSWORD'), $options);
    }
    return $pdo;
}
?>\n\n---\n\nFile: backend/index.php\n<?php
// File: backend/index.php (è·¯ç”±æ›´æ–°)

/**
 * Main API Entry Point.
 * This script is responsible for loading core dependencies and routing
 * requests to the appropriate endpoint handlers.
 */

// --- 1. Load ALL core dependencies in one place, in the correct order ---

// config.php defines the config() helper function and sets up error logging.
require_once __DIR__ . '/config.php';

// db_operations.php defines get_db_connection() and uses the config() helper.
require_once __DIR__ . '/db_operations.php';

// api_header.php handles CORS headers, session start, and content type. It also uses config().
require_once __DIR__ . '/api_header.php';


// --- 2. Get endpoint parameter from the URL ---
$endpoint = $_GET['endpoint'] ?? null;

if ($endpoint === null) {
    http_response_code(400); // Bad Request
    echo json_encode(['status' => 'error', 'message' => 'Missing endpoint parameter.']);
    exit();
}


// --- 3. Define the routing map ---
// This array maps the 'endpoint' string to the physical PHP file.
$routes = [
    // Authentication endpoints
    'register'              => 'auth/register.php',
    'login'                 => 'auth/login.php',
    'logout'                => 'auth/logout.php',
    'check_session'         => 'auth/check_session.php',

    // Email related endpoints
    'get_emails'            => 'auth/get_emails.php',
    'get_email_details'     => 'auth/get_email_details.php',
    'update_bet_batch'      => 'auth/update_bet_batch.php',
    'reanalyze_email'       => 'auth/reanalyze_email.php',
    'download_settlement'   => 'auth/download_settlement.php',
    'smart_parse_email'     => 'auth/smart_parse_email.php',
    'parse_single_bet'      => 'auth/parse_single_bet.php',
    'split_email_lines'     => 'auth/split_email_lines.php',
    'calibrate_ai_parse'    => 'auth/calibrate_ai_parse.php',
    'quick_calibrate_ai'    => 'auth/quick_calibrate_ai.php', // <-- æ–°å¢å¿«é€Ÿæ ¡å‡†è·¯ç”±

    // Lottery related endpoints
    'get_lottery_results'       => 'lottery/get_results.php',
    'get_lottery_result_by_issue' => 'lottery/get_result_by_issue.php',

    // Odds template endpoints
    'odds_template'         => 'auth/odds_template.php',
];


// --- 4. Route the request ---
if (isset($routes[$endpoint])) {
    // If the endpoint is valid, include the corresponding handler file.
    require_once __DIR__ . '/' . $routes[$endpoint];
} else {
    // If the endpoint is not found in our map, return a 404 error.
    http_response_code(404); // Not Found
    echo json_encode(['status' => 'error', 'message' => 'Endpoint not found.']);
}

// --- 5. Log the request for debugging ---
if (defined('MAIL_LOG_FILE')) {
    $log_message = sprintf(
        "API Request: %s %s - Endpoint: %s - User: %s\n",
        $_SERVER['REQUEST_METHOD'],
        $_SERVER['REQUEST_URI'],
        $endpoint ?? 'none',
        $_SESSION['user_id'] ?? 'guest'
    );
    error_log($log_message, 3, MAIL_LOG_FILE);
}
?>\n\n---\n\nFile: backend/initialize_database.php\n<?php
// File: backend/initialize_database.php (Final Corrected Version)

// å¼€å¯å‘½ä»¤è¡Œé”™è¯¯æ˜¾ç¤ºï¼Œä»¥ä¾¿çœ‹åˆ°ä»»ä½•é—®é¢˜
ini_set('display_errors', 1);
error_reporting(E_ALL);

echo "--- Database Initialization Script ---\n\n";
echo "Step 1: Loading core files...\n";

// ã€å…³é”®ä¿®å¤ã€‘ç¡®ä¿æ‰€æœ‰å¿…è¦çš„æ–‡ä»¶éƒ½è¢«åŠ è½½
// é¦–å…ˆåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå› ä¸ºå®ƒå®šä¹‰äº† config() å‡½æ•°
require_once __DIR__ . '/config.php';
// ç„¶ååŠ è½½æ•°æ®åº“æ“ä½œæ–‡ä»¶ï¼Œå› ä¸ºå®ƒå®šä¹‰äº† get_db_connection() å‡½æ•°
require_once __DIR__ . '/db_operations.php';

echo "  [SUCCESS] All core files loaded.\n\n";

try {
    echo "Step 2: Getting database connection...\n";
    // ç°åœ¨ get_db_connection() å‡½æ•°è‚¯å®šæ˜¯å·²å®šä¹‰çš„
    $pdo = get_db_connection();
    echo "  [SUCCESS] Database connection established.\n\n";

    echo "Step 3: Reading schema file...\n";
    $sql_file_path = __DIR__ . '/database_schema.sql';
    if (!file_exists($sql_file_path)) {
        throw new Exception("File not found: {$sql_file_path}");
    }
    $sql = file_get_contents($sql_file_path);
    echo "  [SUCCESS] SQL schema file read.\n\n";

    echo "Step 4: Executing SQL to create tables...\n";
    $pdo->exec($sql);
    echo "  [SUCCESS] All tables created or already exist.\n\n";

} catch (Throwable $e) { // æ•è·æ‰€æœ‰ç±»å‹çš„é”™è¯¯
    echo "\n[FAILURE] An error occurred during initialization:\n";
    echo "--------------------------------------------------\n";
    echo "Error Type: " . get_class($e) . "\n";
    echo "Message: " . $e->getMessage() . "\n";
    echo "File: " . $e->getFile() . "\n";
    echo "Line: " . $e->getLine() . "\n";
    echo "--------------------------------------------------\n";
    exit(1);
}

echo "--- Initialization Complete! ---\n";
?>\n\n---\n\nFile: backend/mail_receiver_light.php\n<?php
// File: mail_receiver_light.php (ä¿®æ”¹ä¸ºä»…æ¥æ”¶ï¼Œä¸è‡ªåŠ¨è§£æ)

// --- ç‹¬ç«‹çš„æ—¥å¿—ç³»ç»Ÿ ---
define('MAIL_LOG_FILE', __DIR__ . '/mail_debug.log');
function log_mail_debug($message) {
    error_log(date('[Y-m-d H:i:s] ') . $message . "\n", 3, MAIL_LOG_FILE);
}

log_mail_debug("=== é‚®ä»¶æ¥æ”¶å™¨å¼€å§‹ (ä»…æ¥æ”¶æ¨¡å¼) ===");

try {
    // --- 1. åŠ è½½æ ¸å¿ƒä¾èµ– ---
    require_once __DIR__ . '/config.php';
    log_mail_debug("ä¾èµ–åŠ è½½å®Œæˆ");

    // --- 2. å®‰å…¨éªŒè¯ (Bearer Token) ---
    $secret = config('EMAIL_WORKER_SECRET');
    if (!$secret) {
        throw new Exception("EMAIL_WORKER_SECRET æœªé…ç½®");
    }

    $auth_header = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
    $token = str_replace('Bearer ', '', $auth_header);

    if (!hash_equals($secret, $token)) {
        log_mail_debug("ç¦æ­¢è®¿é—®: æ— æ•ˆçš„ token");
        http_response_code(403);
        echo json_encode(['status' => 'error', 'message' => 'ç¦æ­¢è®¿é—®']);
        exit;
    }
    log_mail_debug("å®‰å…¨æ£€æŸ¥é€šè¿‡");

    // --- 3. è·å–å¹¶éªŒè¯è¾“å…¥ (JSONæ ¼å¼) ---
    $json_input = file_get_contents('php://input');
    if (empty($json_input)) {
        throw new Exception("ç©ºçš„ JSON è¾“å…¥");
    }

    $input = json_decode($json_input, true);
    if ($input === null) {
        throw new Exception("æ— æ•ˆçš„ JSON æ•°æ®");
    }

    $sender_email = $input['sender'] ?? null;
    $raw_content = $input['raw_content'] ?? null;

    if (empty($sender_email) || empty($raw_content)) {
        throw new Exception("ç¼ºå°‘ 'sender' æˆ– 'raw_content' å­—æ®µ");
    }
    log_mail_debug("æ”¶åˆ°æ¥è‡ª: " . $sender_email . " çš„é‚®ä»¶");

    // --- 4. è¿æ¥æ•°æ®åº“ ---
    $dsn = sprintf("mysql:host=%s;port=%s;dbname=%s;charset=utf8mb4",
        config('DB_HOST'), config('DB_PORT'), config('DB_DATABASE')
    );
    $options = [ PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION ];
    $pdo = new PDO($dsn, config('DB_USERNAME'), config('DB_PASSWORD'), $options);
    log_mail_debug("æ•°æ®åº“è¿æ¥æˆåŠŸ");

    // --- 5. æŸ¥æ‰¾ç”¨æˆ· ---
    $stmt_find = $pdo->prepare("SELECT id FROM users WHERE email = ? AND status = 'active'");
    $stmt_find->execute([$sender_email]);
    $user_id = $stmt_find->fetchColumn();

    if ($user_id) {
        log_mail_debug("æ‰¾åˆ°ç”¨æˆ· ID: " . $user_id);

        // --- 6. è‡ªåŠ¨æ¸…ç†ï¼šæ£€æŸ¥å¹¶åˆ é™¤è¶…å‡º10å°é™åˆ¶çš„é‚®ä»¶ ---
        $stmt_count = $pdo->prepare("SELECT COUNT(*) FROM raw_emails WHERE user_id = ?");
        $stmt_count->execute([$user_id]);
        $email_count = $stmt_count->fetchColumn();

        if ($email_count >= 10) {
            log_mail_debug("ç”¨æˆ·é‚®ä»¶æ•°é‡: {$email_count}, å¼€å§‹è‡ªåŠ¨æ¸…ç†...");

            // æ‰¾å‡ºæœ€æ—©çš„é‚®ä»¶IDè¿›è¡Œåˆ é™¤
            $stmt_oldest = $pdo->prepare("
                SELECT id FROM raw_emails
                WHERE user_id = ?
                ORDER BY received_at ASC
                LIMIT 1
            ");
            $stmt_oldest->execute([$user_id]);
            $oldest_email_id = $stmt_oldest->fetchColumn();

            if ($oldest_email_id) {
                // å…ˆåˆ é™¤ç›¸å…³çš„parsed_betsè®°å½•ï¼ˆå¤–é”®çº¦æŸï¼‰
                $stmt_delete_bets = $pdo->prepare("DELETE FROM parsed_bets WHERE email_id = ?");
                $stmt_delete_bets->execute([$oldest_email_id]);

                // å†åˆ é™¤é‚®ä»¶è®°å½•
                $stmt_delete_email = $pdo->prepare("DELETE FROM raw_emails WHERE id = ?");
                $stmt_delete_email->execute([$oldest_email_id]);

                log_mail_debug("å·²è‡ªåŠ¨åˆ é™¤æœ€æ—§é‚®ä»¶ ID: " . $oldest_email_id);
            }
        }

        // --- æ­¥éª¤ A: å­˜å…¥åŸå§‹é‚®ä»¶ï¼ˆä¸è‡ªåŠ¨è§£æï¼‰---
        $stmt_insert_raw = $pdo->prepare("INSERT INTO raw_emails (user_id, content, status) VALUES (?, ?, 'pending')");
        $stmt_insert_raw->execute([$user_id, $raw_content]);
        $email_id = $pdo->lastInsertId();
        log_mail_debug("é‚®ä»¶å­˜å…¥ raw_emailsï¼ŒID: " . $email_id);

        // ä¸å†è‡ªåŠ¨è°ƒç”¨AIè§£æï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨è§£æ
        http_response_code(200);
        echo json_encode([
            'status' => 'success',
            'message' => 'é‚®ä»¶æ¥æ”¶æˆåŠŸï¼Œè¯·æ‰‹åŠ¨è§£æ',
            'email_id' => $email_id
        ]);

    } else {
        log_mail_debug("ç”¨æˆ· '{$sender_email}' æœªæ‰¾åˆ°æˆ–æœªæ¿€æ´»ã€‚å¿½ç•¥é‚®ä»¶");
        http_response_code(200);
        echo json_encode(['status' => 'success', 'message' => 'ç”¨æˆ·æœªå¤„ç†']);
    }

} catch (Throwable $e) {
    log_mail_debug("--- ä¸¥é‡é”™è¯¯ ---");
    log_mail_debug("é”™è¯¯ä¿¡æ¯: " . $e->getMessage());
    log_mail_debug("æ–‡ä»¶: " . $e->getFile() . " ç¬¬ " . $e->getLine() . " è¡Œ");
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'å†…éƒ¨æœåŠ¡å™¨é”™è¯¯']);
}

log_mail_debug("=== é‚®ä»¶æ¥æ”¶å™¨å®Œæˆ ===\n");
?>\n\n---\n\nFile: backend/setup_bot.php\n<?php
// File: backend/setup_bot.php (Final version that reads from .env)

// --- ç‹¬ç«‹çš„ .env åŠ è½½å™¨ (å’Œ receiver.php ä¸­é‚£ä¸ªä¸€æ ·) ---
function load_env_for_setup() {
    $envPath = __DIR__ . '/.env';
    if (!file_exists($envPath)) {
        die("Error: .env file not found in " . __DIR__);
    }
    $lines = file($envPath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    if (!$lines) {
        die("Error: Could not read .env file.");
    }
    foreach ($lines as $line) {
        if (strpos(trim($line), ';') === 0) continue;
        if (strpos($line, ';') !== false) $line = substr($line, 0, strpos($line, ';'));
        if (strpos($line, '=') !== false) {
            list($name, $value) = explode('=', $line, 2);
            // è¿™é‡Œæˆ‘ä»¬åªéœ€è¦ getenv èƒ½å·¥ä½œå°±è¡Œ
            putenv(trim($name) . "=" . trim(trim($value), "\"'"));
        }
    }
}

// åŠ è½½é…ç½®
load_env_for_setup();

$bot_token = getenv('TELEGRAM_BOT_TOKEN');
$webhook_secret = getenv('TELEGRAM_WEBHOOK_SECRET'); // ä» .env è¯»å–æ–°å¯†é’¥

if (!$bot_token || !$webhook_secret) {
    die("Error: TELEGRAM_BOT_TOKEN or TELEGRAM_WEBHOOK_SECRET not found in .env file.");
}

// ç›´æ¥æŒ‡å‘æˆ‘ä»¬è½»é‡çº§çš„ receiver.php
$webhook_url = "https://wenge.cloudns.ch/telegram/receiver.php?secret=" . urlencode($webhook_secret);

$api_url = "https://api.telegram.org/bot{$bot_token}/setWebhook?url=" . urlencode($webhook_url);

// è°ƒç”¨ API å¹¶æ˜¾ç¤ºç»“æœ
$response = file_get_contents($api_url);
header('Content-Type: application/json');
echo $response;
?>\n\n---\n\nFile: backend/auth/calibrate_ai_parse.php\n<?php
// File: backend/auth/calibrate_ai_parse.php (ä¿®å¤ç‰ˆ)

require_once __DIR__ . '/../ai_helper.php';

// 1. èº«ä»½éªŒè¯
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

$user_id = $_SESSION['user_id'];

// 2. è·å–è¾“å…¥æ•°æ®
$input = json_decode(file_get_contents('php://input'), true);

// 3. ã€æ ¸å¿ƒä¿®å¤ã€‘æ›´ä¸¥æ ¼å’Œæ¸…æ™°çš„è¾“å…¥éªŒè¯
$email_id = filter_var($input['email_id'] ?? null, FILTER_VALIDATE_INT);
$line_number = filter_var($input['line_number'] ?? null, FILTER_VALIDATE_INT);
$batch_id = filter_var($input['batch_id'] ?? null, FILTER_VALIDATE_INT);
$correction_data = $input['correction'] ?? null;

if ($email_id === false || $email_id <= 0) {
    http_response_code(400);
    // å‘å‰ç«¯è¿”å›æ›´å…·ä½“çš„ä¿¡æ¯ï¼Œæ–¹ä¾¿è°ƒè¯•
    echo json_encode(['status' => 'error', 'message' => 'Invalid or missing Email ID.']);
    exit;
}
if ($line_number === false || $line_number <= 0) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Invalid or missing Line Number.']);
    exit;
}
if ($batch_id === false || $batch_id <= 0) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Invalid or missing Batch ID.']);
    exit;
}
if (empty($correction_data) || !is_array($correction_data)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Missing correction data.']);
    exit;
}


try {
    $pdo = get_db_connection();
    $pdo->beginTransaction();

    // 4. è·å–åŸå§‹è§£ææ•°æ®å’Œé‚®ä»¶å†…å®¹
    $stmt = $pdo->prepare("
        SELECT pb.bet_data_json, re.content AS original_email_content
        FROM parsed_bets pb
        JOIN raw_emails re ON pb.email_id = re.id
        WHERE pb.id = ? AND re.user_id = ? AND pb.line_number = ?
    ");
    $stmt->execute([$batch_id, $user_id, $line_number]);
    $original_data = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$original_data) {
        throw new Exception("Record not found or access denied.", 403);
    }
    $original_parse = json_decode($original_data['bet_data_json'], true);
    $original_text = $original_parse['raw_text'] ?? ''; // ä»æ—§è§£æä¸­è·å–å•è¡Œæ–‡æœ¬

    // 5. æ ¹æ®ç”¨æˆ·çš„ä¿®æ­£ï¼Œé‡æ–°æ„å»ºä¸€ä¸ªå®Œç¾çš„ bet_data_json
    $targets_array = preg_split('/[.,\s]+/', $correction_data['targets']);
    $targets_array = array_values(array_filter($targets_array, 'strlen')); // ç¡®ä¿æ˜¯è¿ç»­ç´¢å¼•æ•°ç»„

    $amount_value = floatval($correction_data['amount']);
    $total_amount = 0;

    $bet_entry = [
        'bet_type' => $correction_data['bet_type'],
        'targets' => $targets_array,
        'amount' => $amount_value,
        'raw_text' => $original_text,
        'lottery_type' => $original_parse['lottery_type'] ?? 'é¦™æ¸¯å…­åˆå½©' // ä¿ç•™åŸå§‹å½©ç¥¨ç±»å‹
    ];

    // æ ¹æ®é‡‘é¢æ¨¡å¼è®¡ç®—æ€»é‡‘é¢
    if ($correction_data['amount_mode'] === 'per_target') {
        $total_amount = $amount_value * count($targets_array);
    } else {
        $total_amount = $amount_value;
    }

    $corrected_parse = [
        'raw_text' => $original_text,
        'line_number' => intval($line_number),
        'bets' => [$bet_entry], // ç®€åŒ–ä¸ºåªåŒ…å«ä¸€ä¸ªèšåˆåçš„bet
        'total_amount' => $total_amount,
        'lottery_type' => $original_parse['lottery_type'] ?? 'é¦™æ¸¯å…­åˆå½©'
    ];

    // 6. è§¦å‘AIå­¦ä¹ 
    if (function_exists('trainAIWithCorrection')) {
        trainAIWithCorrection([
            'original_text' => $original_text,
            'original_parse' => $original_parse,
            'corrected_parse' => $corrected_parse,
            'correction_reason' => $correction_data['reason'] ?? ''
        ]);
    }

    // 7. æ›´æ–°æ•°æ®åº“ä¸­çš„ bet_data_json
    $stmt_update = $pdo->prepare("UPDATE parsed_bets SET bet_data_json = ? WHERE id = ?");
    $stmt_update->execute([json_encode($corrected_parse), $batch_id]);

    // 8. é‡æ–°ç»“ç®—
    require_once __DIR__ . '/get_email_details.php'; // å¼•å…¥ç»“ç®—å‡½æ•°

    // è·å–æœ€æ–°å¼€å¥–ç»“æœå’Œèµ”ç‡æ¨¡æ¿
    $stmt_odds = $pdo->prepare("SELECT * FROM user_odds_templates WHERE user_id = ?");
    $stmt_odds->execute([$user_id]);
    $userOddsTemplate = $stmt_odds->fetch(PDO::FETCH_ASSOC);

    $sql_latest_results = "SELECT r1.* FROM lottery_results r1 JOIN (SELECT lottery_type, MAX(id) AS max_id FROM lottery_results GROUP BY lottery_type) r2 ON r1.lottery_type = r2.lottery_type AND r1.id = r2.max_id";
    $stmt_latest = $pdo->query($sql_latest_results);
    $latest_results_raw = $stmt_latest->fetchAll(PDO::FETCH_ASSOC);

    $latest_results = [];
    foreach ($latest_results_raw as $row) {
        foreach(['winning_numbers', 'zodiac_signs', 'colors'] as $key) {
            $row[$key] = json_decode($row[$key], true) ?: [];
        }
        $latest_results[$row['lottery_type']] = $row;
    }

    $lottery_result_for_settlement = $latest_results[$corrected_parse['lottery_type']] ?? null;
    $settlement_data = calculateBatchSettlement($corrected_parse, $lottery_result_for_settlement, $userOddsTemplate);
    $corrected_parse['settlement'] = $settlement_data;

    // 9. æäº¤äº‹åŠ¡
    $pdo->commit();

    // 10. è¿”å›åŒ…å«æœ€æ–°è§£æå’Œç»“ç®—çš„å®Œæ•´æ•°æ®
    http_response_code(200);
    echo json_encode([
        'status' => 'success',
        'message' => 'AIæ ¡å‡†æˆåŠŸå¹¶å·²é‡æ–°ç»“ç®—ï¼',
        'data' => [
            'batch_id' => $batch_id,
            // ã€é‡è¦ã€‘è¿”å›çš„ç»“æ„è¦å’Œ parse_single_bet ä¸€è‡´
            'parse_result' => $corrected_parse,
            'line_number' => intval($line_number)
        ]
    ]);

} catch (Throwable $e) {
    if (isset($pdo) && $pdo->inTransaction()) {
        $pdo->rollBack();
    }
    error_log("AI Calibration Error: " . $e->getMessage() . " in " . $e->getFile() . " on line " . $e->getLine());
    http_response_code($e->getCode() == 403 ? 403 : 500);
    echo json_encode(['status' => 'error', 'message' => 'æ ¡å‡†å¤±è´¥: ' . $e->getMessage()]);
}
?>\n\n---\n\nFile: backend/auth/check_session.php\n<?php
// File: backend/auth/check_session.php

// api_header.php å·²ç»å¯åŠ¨äº† session

// æ£€æŸ¥ session ä¸­æ˜¯å¦å­˜åœ¨ user_id
if (isset($_SESSION['user_id']) && !empty($_SESSION['user_id'])) {
    // ç”¨æˆ·å·²ç™»å½•ï¼Œè¿”å›ç”¨æˆ·ä¿¡æ¯
    http_response_code(200);
    echo json_encode([
        'status' => 'success',
        'isAuthenticated' => true,
        'user' => [
            'id' => $_SESSION['user_id'],
            'email' => $_SESSION['user_email'] ?? 'N/A' // æä¾›ä¸€ä¸ªé»˜è®¤å€¼ä»¥é˜²ä¸‡ä¸€
        ]
    ]);
} else {
    // ç”¨æˆ·æœªç™»å½•
    http_response_code(200); // å³ä½¿æœªç™»å½•ï¼Œè¯·æ±‚æœ¬èº«ä¹Ÿæ˜¯æˆåŠŸçš„
    echo json_encode([
        'status' => 'success',
        'isAuthenticated' => false,
        'user' => null
    ]);
}
?>\n\n---\n\nFile: backend/auth/download_settlement.php\n<?php
// File: backend/auth/download_settlement.php

// 1. èº«ä»½éªŒè¯
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

$user_id = $_SESSION['user_id'];
$email_id = $_GET['id'] ?? null;

if (empty($email_id)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email ID is required.']);
    exit;
}

try {
    $pdo = get_db_connection();

    // éªŒè¯é‚®ä»¶å±äºå½“å‰ç”¨æˆ·
    $stmt_email = $pdo->prepare("SELECT content FROM raw_emails WHERE id = ? AND user_id = ?");
    $stmt_email->execute([$email_id, $user_id]);
    $raw_content = $stmt_email->fetchColumn();

    if ($raw_content === false) {
        http_response_code(404);
        echo json_encode(['status' => 'error', 'message' => 'Email not found or access denied.']);
        exit;
    }

    // è·å–å¢å¼ºåçš„å†…å®¹ï¼ˆåŒ…å«ç»“ç®—ä¿¡æ¯ï¼‰
    require_once __DIR__ . '/../helpers/mail_parser.php';
    $clean_content = parse_email_body($raw_content);

    // è·å–æ‰€æœ‰å…³è”çš„ä¸‹æ³¨æ‰¹æ¬¡å’Œç»“ç®—ä¿¡æ¯
    $stmt_bets = $pdo->prepare("
        SELECT pb.id, pb.bet_data_json, pb.ai_model_used
        FROM parsed_bets pb
        WHERE pb.email_id = ?
        ORDER BY pb.id ASC
    ");
    $stmt_bets->execute([$email_id]);
    $bet_batches_raw = $stmt_bets->fetchAll(PDO::FETCH_ASSOC);

    $enhanced_content = $clean_content;

    // å¦‚æœæ²¡æœ‰æ‰¹æ¬¡ï¼Œä½¿ç”¨æ‰‹åŠ¨è§£æ
    if (empty($bet_batches_raw)) {
        require_once __DIR__ . '/../helpers/manual_parser.php';
        $manual_data = parseBetManually($clean_content);
        if (!empty($manual_data['bets'])) {
            $enhanced_content = enhanceEmailContent($clean_content, $manual_data);
        }
    } else {
        // å¤„ç†æ¯ä¸ªæ‰¹æ¬¡ï¼Œå°†ç»“ç®—ä¿¡æ¯åµŒå…¥å†…å®¹
        foreach ($bet_batches_raw as $batch) {
            $batch_data = json_decode($batch['bet_data_json'], true);

            // ä¸ºæ¯ä¸ªæ‰¹æ¬¡æ·»åŠ ç»“ç®—ä¿¡æ¯åˆ°å†…å®¹ä¸­
            $settlement_info = "\n\n" . str_repeat("=", 50) . "\n";
            $settlement_info .= "ğŸ¯ ç»“ç®—ç»“æœ (æ‰¹æ¬¡ {$batch['id']})\n";
            $settlement_info .= str_repeat("=", 50) . "\n";

            $total_bet = 0;
            if (isset($batch_data['bets']) && is_array($batch_data['bets'])) {
                foreach ($batch_data['bets'] as $bet) {
                    $amount = floatval($bet['amount'] ?? 0);
                    $targets = $bet['targets'] ?? [];
                    if ($amount > 0 && is_array($targets)) {
                        $total_bet += $amount * count($targets);
                    }
                }
            }

            $settlement_info .= "ğŸ’° æ€»æŠ•æ³¨é‡‘é¢: {$total_bet} å…ƒ\n";
            $settlement_info .= "ğŸ“Š AIæ¨¡å‹: {$batch['ai_model_used']}\n";
            $settlement_info .= str_repeat("=", 50) . "\n";

            $enhanced_content .= $settlement_info;
        }
    }

    // ç”Ÿæˆæ–‡ä»¶åï¼ˆæ—¥æœŸæ—¶é—´æ ¼å¼ï¼‰
    $filename = date('Ymd_His') . '_settlement.txt';

    // è®¾ç½®å“åº”å¤´ï¼Œç›´æ¥è¾“å‡ºTXTæ–‡ä»¶
    header('Content-Type: text/plain');
    header('Content-Disposition: attachment; filename="' . $filename . '"');
    header('Content-Length: ' . strlen($enhanced_content));

    echo $enhanced_content;
    exit;

} catch (Throwable $e) {
    error_log("Error generating settlement file for email_id {$email_id}: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Internal Server Error: ' . $e->getMessage()]);
}
?>\n\n---\n\nFile: backend/auth/get_email_content.php\n<?php
// File: backend/auth/get_email_content.php (with Server-Side Parsing)

// æ ¸å¿ƒä¾èµ–ç”± index.php åŠ è½½

// ã€æ–°å¢ã€‘åŠ è½½é‚®ä»¶è§£æå™¨å¸®åŠ©æ–‡ä»¶
// ç¡®ä¿è¿™ä¸ªè·¯å¾„æ˜¯æ­£ç¡®çš„ã€‚å¦‚æœä½ çš„ helpers ç›®å½•åœ¨ backend/ æ ¹ç›®å½•ä¸‹ã€‚
require_once __DIR__ . '/../helpers/mail_parser.php';

// 1. èº«ä»½éªŒè¯æ£€æŸ¥
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

$user_id = $_SESSION['user_id'];
$email_id = $_GET['id'] ?? null;

if (empty($email_id)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email ID is required.']);
    exit;
}

try {
    $pdo = get_db_connection();

    // 2. æŸ¥è¯¢ç‰¹å®šé‚®ä»¶çš„åŸå§‹å†…å®¹
    $stmt = $pdo->prepare(
        "SELECT id, content
         FROM raw_emails
         WHERE id = ? AND user_id = ?"
    );

    $stmt->bindParam(1, $email_id, PDO::PARAM_INT);
    $stmt->bindParam(2, $user_id, PDO::PARAM_INT);
    $stmt->execute();

    $email = $stmt->fetch(PDO::FETCH_ASSOC);

    if ($email) {
        // --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œè¿›è¡Œé‚®ä»¶è§£æ ---
        $raw_content = $email['content'];
        $clean_body = parse_email_body($raw_content);

        // åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„ï¼ŒåªåŒ…å«æˆ‘ä»¬æƒ³è¿”å›ç»™å‰ç«¯çš„æ•°æ®
        $response_data = [
            'id' => $email['id'],
            'content' => $clean_body // è¿”å›è§£æåçš„å¹²å‡€æ­£æ–‡
        ];

        // 3. è¿”å›åŒ…å«å¹²å‡€æ­£æ–‡çš„æˆåŠŸå“åº”
        http_response_code(200);
        echo json_encode(['status' => 'success', 'data' => $response_data]);

    } else {
        http_response_code(404);
        echo json_encode(['status' => 'error', 'message' => 'Email not found or access denied.']);
    }

} catch (PDOException $e) {
    error_log("Error fetching email content for user {$user_id}, email {$email_id}: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Database error.']);
} catch (Throwable $e) {
    // æ•è·å¯èƒ½åœ¨ parse_email_body ä¸­å‘ç”Ÿçš„é”™è¯¯
    error_log("Error parsing email content for email {$email_id}: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Failed to parse email content on server.']);
}
?>\n\n---\n\nFile: backend/auth/get_email_details.php\n<?php
// File: backend/auth/get_email_details.php (å®Œæ•´ä¿®å¤ç‰ˆ)

if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

$user_id = $_SESSION['user_id'];
$email_id = $_GET['id'] ?? null;

if (empty($email_id)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email ID is required.']);
    exit;
}

try {
    $pdo = get_db_connection();

    // --- è·å–ç”¨æˆ·èµ”ç‡æ¨¡æ¿ ---
    $stmt_odds = $pdo->prepare("SELECT * FROM user_odds_templates WHERE user_id = ?");
    $stmt_odds->execute([$user_id]);
    $userOddsTemplate = $stmt_odds->fetch(PDO::FETCH_ASSOC);

    // --- 1. è·å–åŸå§‹é‚®ä»¶å†…å®¹ ---
    $stmt_email = $pdo->prepare("SELECT content FROM raw_emails WHERE id = ? AND user_id = ?");
    $stmt_email->execute([$email_id, $user_id]);
    $raw_content = $stmt_email->fetchColumn();

    if ($raw_content === false) {
        http_response_code(404);
        echo json_encode(['status' => 'error', 'message' => 'Email not found or access denied.']);
        exit;
    }

    require_once __DIR__ . '/../helpers/mail_parser.php';
    $clean_content = parse_email_body($raw_content);

    // --- 2. è·å–æ‰€æœ‰å…³è”çš„ä¸‹æ³¨æ‰¹æ¬¡ ---
    $stmt_bets = $pdo->prepare("
        SELECT pb.id, pb.bet_data_json, pb.ai_model_used
        FROM parsed_bets pb
        WHERE pb.email_id = ?
        ORDER BY pb.id ASC
    ");
    $stmt_bets->execute([$email_id]);
    $bet_batches_raw = $stmt_bets->fetchAll(PDO::FETCH_ASSOC);

    $bet_batches = [];
    $enhanced_content = $clean_content;

    // --- 3. è·å–æ‰€æœ‰å½©ç§çš„æœ€æ–°å¼€å¥–ç»“æœ ---
    $sql_latest_results = "
        SELECT r1.*
        FROM lottery_results r1
        JOIN (
            SELECT lottery_type, MAX(id) AS max_id
            FROM lottery_results
            GROUP BY lottery_type
        ) r2 ON r1.lottery_type = r2.lottery_type AND r1.id = r2.max_id
    ";
    $stmt_latest = $pdo->query($sql_latest_results);
    $latest_results_raw = $stmt_latest->fetchAll(PDO::FETCH_ASSOC);

    $latest_results = [];
    foreach ($latest_results_raw as $row) {
        foreach(['winning_numbers', 'zodiac_signs', 'colors'] as $key) {
            $decoded = json_decode($row[$key], true);
            $row[$key] = $decoded ?: [];
        }
        $latest_results[$row['lottery_type']] = $row;
    }

    // --- 4. å¤„ç†ä¸‹æ³¨æ‰¹æ¬¡ ---
    foreach ($bet_batches_raw as $batch) {
        $batch_data = json_decode($batch['bet_data_json'], true);
        $batch_info = [
            'batch_id' => $batch['id'],
            'data' => $batch_data,
            'ai_model' => $batch['ai_model_used']
        ];

        // --- 5. ä¸ºæ¯ä¸ªæ‰¹æ¬¡è®¡ç®—ç»“ç®—ï¼ˆä½¿ç”¨å®é™…å¼€å¥–ç»“æœå’Œç”¨æˆ·èµ”ç‡æ¨¡æ¿ï¼‰---
        if (isset($batch_data['bets']) && is_array($batch_data['bets'])) {
            $lottery_type = $batch_data['lottery_type'] ?? 'é¦™æ¸¯å…­åˆå½©';
            $lottery_result = $latest_results[$lottery_type] ?? null;

            $settlement_data = calculateBatchSettlement($batch_data, $lottery_result, $userOddsTemplate);
            $batch_info['settlement'] = $settlement_data;

            // --- 6. å°†ç»“ç®—ç»“æœåµŒå…¥é‚®ä»¶å†…å®¹ ---
            $enhanced_content = embedSettlementInContent(
                $enhanced_content,
                $batch_data,
                $settlement_data,
                $batch['id']
            );
        }

        $bet_batches[] = $batch_info;
    }

    // --- 7. å¦‚æœæ²¡æœ‰ä»»ä½•æ‰¹æ¬¡ï¼Œä½¿ç”¨æ‰‹åŠ¨è§£æ ---
    if (empty($bet_batches)) {
        require_once __DIR__ . '/../helpers/manual_parser.php';
        $manual_data = parseBetManually($clean_content);
        if (!empty($manual_data['bets'])) {
            // ä¸ºæ‰‹åŠ¨è§£æçš„æ•°æ®è®¡ç®—ç»“ç®—
            $settlement_data = calculateManualSettlement($manual_data, $latest_results, $userOddsTemplate);

            $batch_info = [
                'batch_id' => 0,
                'data' => $manual_data,
                'ai_model' => 'manual_parser',
                'settlement' => $settlement_data
            ];

            $bet_batches[] = $batch_info;
            $enhanced_content = embedManualSettlement($clean_content, $manual_data, $settlement_data);
        } else {
            $enhanced_content = $clean_content . "\n\n--- æœªæ£€æµ‹åˆ°ä¸‹æ³¨ä¿¡æ¯ ---\n";
        }
    }

    // --- 8. è¿”å›å¢å¼ºåçš„é‚®ä»¶å†…å®¹ ---
    http_response_code(200);
    echo json_encode([
        'status' => 'success',
        'data' => [
            'email_content' => $clean_content,
            'enhanced_content' => $enhanced_content,
            'bet_batches' => $bet_batches,
            'latest_lottery_results' => $latest_results
        ]
    ]);

} catch (Throwable $e) {
    error_log("Error in get_email_details.php for email_id {$email_id}: " . $e->getMessage());
    error_log("Stack trace: " . $e->getTraceAsString());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Internal Server Error: ' . $e->getMessage()]);
}

/**
 * è®¡ç®—å•ä¸ªæ‰¹æ¬¡çš„ç»“ç®—ç»“æœ - ä½¿ç”¨ç”¨æˆ·èµ”ç‡æ¨¡æ¿
 */
function calculateBatchSettlement(array $batchData, ?array $lotteryResult = null, ?array $userOddsTemplate = null): array {
    $settlement = [
        'total_bet_amount' => 0,
        'winning_details' => [],
        'net_profits' => [],
        'summary' => '',
        'timestamp' => date('Y-m-d H:i:s'),
        'has_lottery_data' => !is_null($lotteryResult) &&
                             isset($lotteryResult['winning_numbers']) &&
                             is_array($lotteryResult['winning_numbers']) &&
                             !empty($lotteryResult['winning_numbers']),
        'used_odds' => null
    ];

    if (!isset($batchData['bets']) || !is_array($batchData['bets'])) {
        $settlement['summary'] = 'æ— ä¸‹æ³¨æ•°æ®';
        return $settlement;
    }

    $totalBet = 0;
    $winningBets = [];

    foreach ($batchData['bets'] as $bet) {
        $amount = floatval($bet['amount'] ?? 0);
        $betType = $bet['bet_type'] ?? '';
        $targets = $bet['targets'] ?? [];

        if ($amount > 0 && is_array($targets)) {
            foreach ($targets as $target) {
                $totalBet += $amount;

                // å¦‚æœæœ‰æœ‰æ•ˆçš„å¼€å¥–ç»“æœï¼Œè¿›è¡Œå®é™…ç»“ç®—è®¡ç®—
                if ($settlement['has_lottery_data']) {
                    $winningNumbers = $lotteryResult['winning_numbers'];

                    // æ ¹æ®ä¸‹æ³¨ç±»å‹è·å–å¯¹åº”çš„èµ”ç‡
                    $odds = getUserOddsForBetType($betType, $userOddsTemplate);
                    $settlement['used_odds'] = $odds;

                    if ($odds === null) {
                        continue; // å¦‚æœæ²¡æœ‰è®¾ç½®è¯¥ç©æ³•çš„èµ”ç‡ï¼Œè·³è¿‡ç»“ç®—
                    }

                    if ($betType === 'ç‰¹ç ' || $betType === 'å·ç ') {
                        // ç‰¹ç ç©æ³•ï¼šåªå¯¹æ¯”ç‰¹ç ï¼ˆæœ€åä¸€ä¸ªå·ç ï¼‰
                        $specialNumber = end($winningNumbers);
                        if (strval(trim($target)) === strval(trim($specialNumber))) {
                            $winningBets[] = [
                                'number' => $target,
                                'amount' => $amount,
                                'odds' => $odds,
                                'bet_type' => $betType
                            ];
                        }
                    } elseif ($betType === 'å¹³ç ') {
                        // å¹³ç ç©æ³•ï¼šå¯¹æ¯”æ‰€æœ‰å·ç 
                        $winningNumbersStr = array_map('strval', array_map('trim', $winningNumbers));
                        if (in_array(strval(trim($target)), $winningNumbersStr)) {
                            $winningBets[] = [
                                'number' => $target,
                                'amount' => $amount,
                                'odds' => $odds,
                                'bet_type' => $betType
                            ];
                        }
                    } elseif ($betType === 'ç”Ÿè‚–') {
                        // ç”Ÿè‚–ç©æ³•ï¼šæ ¹æ®å·ç å¯¹åº”çš„ç”Ÿè‚–æ¥åˆ¤æ–­
                        $targetZodiac = getZodiacByNumber($target);
                        if ($targetZodiac && isset($lotteryResult['zodiac_signs']) && is_array($lotteryResult['zodiac_signs'])) {
                            $zodiacsStr = array_map('strval', array_map('trim', $lotteryResult['zodiac_signs']));
                            if (in_array($targetZodiac, $zodiacsStr)) {
                                $winningBets[] = [
                                    'number' => $target,
                                    'amount' => $amount,
                                    'odds' => $odds,
                                    'bet_type' => $betType,
                                    'zodiac' => $targetZodiac
                                ];
                            }
                        }
                    }
                    // å…¶ä»–ç©æ³•ç±»å‹å¯ä»¥åœ¨è¿™é‡Œæ‰©å±•
                }
            }
        }
    }

    $settlement['total_bet_amount'] = $totalBet;
    $settlement['winning_details'] = $winningBets;

    // è®¡ç®—å‡€æ”¶ç›Šï¼ˆä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„å•ä¸€èµ”ç‡ï¼‰
    $totalWin = 0;
    foreach ($winningBets as $win) {
        $totalWin += $win['amount'] * $win['odds'];
    }
    $netProfit = $totalWin - $totalBet;

    $settlement['net_profits'] = [
        'total_win' => $totalWin,
        'net_profit' => $netProfit,
        'is_profit' => $netProfit >= 0,
        'odds' => $settlement['used_odds']
    ];

    $winCount = count($winningBets);
    if ($settlement['has_lottery_data']) {
        $specialNumber = end($lotteryResult['winning_numbers']);
        $oddsInfo = $settlement['used_odds'] ? " (èµ”ç‡: {$settlement['used_odds']})" : "";
        $settlement['summary'] = "æ€»ä¸‹æ³¨ {$totalBet} å…ƒï¼Œä¸­å¥– {$winCount} æ³¨{$oddsInfo}ï¼Œç‰¹ç : {$specialNumber}";
    } else {
        $oddsInfo = $settlement['used_odds'] ? " (èµ”ç‡: {$settlement['used_odds']})" : "";
        $settlement['summary'] = "æ€»ä¸‹æ³¨ {$totalBet} å…ƒ{$oddsInfo}ï¼ˆç­‰å¾…å¼€å¥–æ•°æ®ï¼‰";
    }

    return $settlement;
}

/**
 * æ ¹æ®ä¸‹æ³¨ç±»å‹è·å–ç”¨æˆ·è®¾ç½®çš„èµ”ç‡
 */
function getUserOddsForBetType(string $betType, ?array $userOddsTemplate): ?float {
    if (!$userOddsTemplate) {
        return null;
    }

    $oddsMapping = [
        'ç‰¹ç ' => 'special_code_odds',
        'å·ç ' => 'special_code_odds',
        'å¹³ç ' => 'flat_special_odds',
        'å¹³ç‰¹' => 'flat_special_odds',
        'ä¸²ç ' => 'serial_code_odds',
        'è¿è‚–' => 'even_xiao_odds',
        'å…­è‚–' => 'six_xiao_odds',
        'å¤§å°' => 'size_single_double_odds',
        'å•åŒ' => 'size_single_double_odds'
    ];

    $templateKey = $oddsMapping[$betType] ?? null;
    if ($templateKey && isset($userOddsTemplate[$templateKey]) && $userOddsTemplate[$templateKey] !== null) {
        return floatval($userOddsTemplate[$templateKey]);
    }

    return null;
}

/**
 * è®¡ç®—æ‰‹åŠ¨è§£æçš„ç»“ç®—
 */
function calculateManualSettlement(array $manualData, array $latestResults, ?array $userOddsTemplate = null): array {
    $settlement = [
        'total_bet_amount' => $manualData['total_amount'],
        'winning_details' => [],
        'net_profits' => [],
        'summary' => '',
        'timestamp' => date('Y-m-d H:i:s'),
        'has_lottery_data' => !empty($latestResults),
        'used_odds' => null
    ];

    $winningBets = [];

    // ä½¿ç”¨æ‰€æœ‰å½©ç¥¨ç±»å‹çš„ç»“æœè¿›è¡Œç»“ç®—
    foreach ($manualData['bets'] as $bet) {
        $amount = $bet['amount'];
        $betType = $bet['bet_type'];
        $targets = $bet['targets'];
        $lotteryType = $bet['lottery_type'] ?? 'é¦™æ¸¯å…­åˆå½©';

        // é€‰æ‹©å¯¹åº”çš„å¼€å¥–ç»“æœ
        $result = null;
        if (isset($latestResults[$lotteryType])) {
            $result = $latestResults[$lotteryType];
        } elseif ($lotteryType === 'æ¾³é—¨å…­åˆå½©' && isset($latestResults['æ–°æ¾³é—¨å…­åˆå½©'])) {
            $result = $latestResults['æ–°æ¾³é—¨å…­åˆå½©'];
        } elseif ($lotteryType === 'æ¾³é—¨å…­åˆå½©' && isset($latestResults['è€æ¾³é—¨å…­åˆå½©'])) {
            $result = $latestResults['è€æ¾³é—¨å…­åˆå½©'];
        } else {
            // å¦‚æœæ²¡æœ‰å¯¹åº”çš„å¼€å¥–ç»“æœï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„ç»“æœ
            $result = reset($latestResults) ?: null;
        }

        // è·å–ç”¨æˆ·è®¾ç½®çš„èµ”ç‡
        $odds = getUserOddsForBetType($betType, $userOddsTemplate);
        $settlement['used_odds'] = $odds;

        foreach ($targets as $target) {
            if ($result && isset($result['winning_numbers']) && is_array($result['winning_numbers'])) {
                $winningNumbers = $result['winning_numbers'];

                if ($betType === 'å·ç ' || $betType === 'ç‰¹ç ' || $betType === 'ç”Ÿè‚–') {
                    // ç‰¹ç ç©æ³•ï¼šå¯¹æ¯”ç‰¹ç ï¼ˆæœ€åä¸€ä¸ªå·ç ï¼‰
                    $specialNumber = end($winningNumbers);
                    if (strval(trim($target)) === strval(trim($specialNumber))) {
                        $zodiacInfo = isset($bet['zodiac']) ? " [{$bet['zodiac']}]" : "";
                        $winningBets[] = [
                            'number' => $target,
                            'amount' => $amount,
                            'odds' => $odds ?: 45, // å¦‚æœæ²¡æœ‰è®¾ç½®èµ”ç‡ï¼Œä½¿ç”¨é»˜è®¤45
                            'bet_type' => $betType,
                            'lottery_type' => $result['lottery_type'],
                            'zodiac' => $bet['zodiac'] ?? null
                        ];
                    }
                }
            }
        }
    }

    $settlement['winning_details'] = $winningBets;

    // è®¡ç®—å‡€æ”¶ç›Š
    $totalWin = 0;
    foreach ($winningBets as $win) {
        $totalWin += $win['amount'] * $win['odds'];
    }
    $netProfit = $totalWin - $manualData['total_amount'];

    $settlement['net_profits'] = [
        'total_win' => $totalWin,
        'net_profit' => $netProfit,
        'is_profit' => $netProfit >= 0,
        'odds' => $settlement['used_odds']
    ];

    $winCount = count($winningBets);
    if (!empty($latestResults)) {
        $oddsInfo = $settlement['used_odds'] ? " (èµ”ç‡: {$settlement['used_odds']})" : "";
        $settlement['summary'] = "æ€»ä¸‹æ³¨ {$manualData['total_amount']} å…ƒï¼Œä¸­å¥– {$winCount} æ³¨{$oddsInfo}";
    } else {
        $oddsInfo = $settlement['used_odds'] ? " (èµ”ç‡: {$settlement['used_odds']})" : "";
        $settlement['summary'] = "æ€»ä¸‹æ³¨ {$manualData['total_amount']} å…ƒ{$oddsInfo}ï¼ˆç­‰å¾…å¼€å¥–æ•°æ®ï¼‰";
    }

    return $settlement;
}

/**
 * æ ¹æ®å·ç è·å–ç”Ÿè‚–
 */
function getZodiacByNumber($number): ?string {
    $zodiacMap = [
        '01' => 'è›‡', '13' => 'è›‡', '25' => 'è›‡', '37' => 'è›‡', '49' => 'è›‡',
        '02' => 'é¾™', '14' => 'é¾™', '26' => 'é¾™', '38' => 'é¾™',
        '03' => 'å…”', '15' => 'å…”', '27' => 'å…”', '39' => 'å…”',
        '04' => 'è™', '16' => 'è™', '28' => 'è™', '40' => 'è™',
        '05' => 'ç‰›', '17' => 'ç‰›', '29' => 'ç‰›', '41' => 'ç‰›',
        '06' => 'é¼ ', '18' => 'é¼ ', '30' => 'é¼ ', '42' => 'é¼ ',
        '07' => 'çŒª', '19' => 'çŒª', '31' => 'çŒª', '43' => 'çŒª',
        '08' => 'ç‹—', '20' => 'ç‹—', '32' => 'ç‹—', '44' => 'ç‹—',
        '09' => 'é¸¡', '21' => 'é¸¡', '33' => 'é¸¡', '45' => 'é¸¡',
        '10' => 'çŒ´', '22' => 'çŒ´', '34' => 'çŒ´', '46' => 'çŒ´',
        '11' => 'ç¾Š', '23' => 'ç¾Š', '35' => 'ç¾Š', '47' => 'ç¾Š',
        '12' => 'é©¬', '24' => 'é©¬', '36' => 'é©¬', '48' => 'é©¬'
    ];

    $numberPadded = str_pad(strval(trim($number)), 2, '0', STR_PAD_LEFT);
    return $zodiacMap[$numberPadded] ?? null;
}

/**
 * å°†ç»“ç®—ç»“æœåµŒå…¥é‚®ä»¶å†…å®¹
 */
function embedSettlementInContent(string $content, array $batchData, array $settlement, int $batchId): string {
    $rawText = $batchData['raw_text'] ?? '';

    // å¦‚æœæ²¡æœ‰åŸå§‹æ–‡æœ¬ï¼Œåœ¨å†…å®¹æœ«å°¾æ·»åŠ ç»“ç®—ä¿¡æ¯
    if (empty($rawText)) {
        $settlementHtml = buildSettlementHtml($settlement, $batchId);
        return $content . "\n\n" . $settlementHtml;
    }

    // æŸ¥æ‰¾åŸå§‹æ–‡æœ¬åœ¨å†…å®¹ä¸­çš„ä½ç½®
    $position = strpos($content, $rawText);

    if ($position === false) {
        // å¦‚æœæ‰¾ä¸åˆ°åŸå§‹æ–‡æœ¬ï¼Œåœ¨å†…å®¹æœ«å°¾æ·»åŠ ç»“ç®—ä¿¡æ¯
        $settlementHtml = buildSettlementHtml($settlement, $batchId);
        return $content . "\n\n" . $settlementHtml;
    }

    // æ„å»ºç»“ç®—HTML
    $settlementHtml = buildPlainSettlementHtml($settlement, $batchId);

    // åœ¨åŸå§‹æ–‡æœ¬åæ’å…¥ç»“ç®—ä¿¡æ¯
    $insertPosition = $position + strlen($rawText);
    $newContent = substr($content, 0, $insertPosition) .
                  $settlementHtml .
                  substr($content, $insertPosition);

    return $newContent;
}

/**
 * åµŒå…¥æ‰‹åŠ¨è§£æçš„ç»“ç®—ç»“æœ
 */
function embedManualSettlement(string $content, array $manualData, array $settlement): string {
    $settlementHtml = buildPlainSettlementHtml($settlement, 0);
    return $content . "\n\n" . $settlementHtml;
}

/**
 * æ„å»ºçº¯æ–‡æœ¬ç»“ç®—HTML
 */
function buildPlainSettlementHtml(array $settlement, int $batchId): string {
    $html = "\n\n" . str_repeat("=", 50) . "\n";
    $html .= "ğŸ¯ ç»“ç®—ç»“æœ (æ‰¹æ¬¡ {$batchId})\n";
    $html .= str_repeat("=", 50) . "\n";

    // æ€»ä¸‹æ³¨é‡‘é¢
    $html .= "ğŸ’° æ€»æŠ•æ³¨é‡‘é¢: {$settlement['total_bet_amount']} å…ƒ\n";

    // ä¸­å¥–è¯¦æƒ…
    if (!empty($settlement['winning_details'])) {
        $html .= "ğŸŠ ä¸­å¥–è¯¦æƒ…:\n";
        foreach ($settlement['winning_details'] as $win) {
            $lotteryTypeInfo = isset($win['lottery_type']) ? " ({$win['lottery_type']})" : "";
            $zodiacInfo = isset($win['zodiac']) ? " [{$win['zodiac']}]" : "";
            $oddsInfo = isset($win['odds']) ? " (èµ”ç‡ {$win['odds']})" : "";
            $html .= "   - å·ç  {$win['number']}{$zodiacInfo}: {$win['amount']} å…ƒ{$oddsInfo}{$lotteryTypeInfo}\n";
        }
    } else {
        if ($settlement['has_lottery_data']) {
            $html .= "âŒ ä¸­å¥–è¯¦æƒ…: æœªä¸­å¥–\n";
        } else {
            $html .= "â³ ä¸­å¥–è¯¦æƒ…: ç­‰å¾…å¼€å¥–æ•°æ®\n";
        }
    }

    // ç»“ç®—ç»“æœ
    $html .= "\nğŸ“ˆ ç»“ç®—ç»“æœ:\n";
    if ($settlement['net_profits'] && isset($settlement['net_profits']['net_profit'])) {
        $netProfit = $settlement['net_profits']['net_profit'];
        $isProfit = $settlement['net_profits']['is_profit'];
        $oddsInfo = $settlement['used_odds'] ? " (èµ”ç‡: {$settlement['used_odds']})" : "";

        $emoji = $isProfit ? 'ğŸŸ¢' : 'ğŸ”´';
        $profitText = $isProfit ? "ç›ˆåˆ©" : "äºæŸ";
        $netAmount = abs($netProfit);

        $html .= "{$emoji} {$profitText} {$netAmount} å…ƒ{$oddsInfo}\n";
    }

    // æ·»åŠ å¼€å¥–æ•°æ®ä¿¡æ¯
    if (!$settlement['has_lottery_data']) {
        $html .= "\nâš ï¸  æ³¨æ„: å½“å‰æ— å¼€å¥–æ•°æ®ï¼Œä»¥ä¸Šä¸ºæ¨¡æ‹Ÿç»“ç®—ç»“æœ\n";
    }

    $html .= str_repeat("=", 50) . "\n";

    return $html;
}

/**
 * æ„å»ºç»“ç®—HTML - ä¿ç•™åŸå‡½æ•°å…¼å®¹æ€§
 */
function buildSettlementHtml(array $settlement, int $batchId): string {
    return buildPlainSettlementHtml($settlement, $batchId);
}
?>\n\n---\n\nFile: backend/auth/get_emails.php\n<?php
// File: backend/auth/get_emails.php

// æ ¸å¿ƒä¾èµ–ç”± index.php åŠ è½½ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨

// 1. èº«ä»½éªŒè¯æ£€æŸ¥
if (!isset($_SESSION['user_id'])) {
    http_response_code(401); // Unauthorized
    echo json_encode(['status' => 'error', 'message' => 'æ‚¨éœ€è¦ç™»å½•æ‰èƒ½æŸ¥çœ‹é‚®ä»¶ã€‚']);
    exit;
}

$user_id = $_SESSION['user_id'];
$limit = 20; // é™åˆ¶ä¸€æ¬¡æœ€å¤šè·å–20å°é‚®ä»¶

try {
    $pdo = get_db_connection();

    // 2. ä»æ•°æ®åº“æŸ¥è¯¢é‚®ä»¶
    // æˆ‘ä»¬åªæŸ¥è¯¢ raw_emails è¡¨ï¼Œå› ä¸ºå‰ç«¯åˆ—è¡¨åªéœ€è¦é‚®ä»¶çš„åŸºæœ¬ä¿¡æ¯
    // å…³é”®ï¼šWHERE user_id = ? ç¡®ä¿äº†ç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±çš„é‚®ä»¶
    $stmt = $pdo->prepare(
        "SELECT id, status, received_at
         FROM raw_emails
         WHERE user_id = ?
         ORDER BY received_at DESC
         LIMIT ?"
    );

    // PDO::PARAM_INT å‘Šè¯‰æ•°æ®åº“è¿™æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œæ›´å®‰å…¨
    $stmt->bindParam(1, $user_id, PDO::PARAM_INT);
    $stmt->bindParam(2, $limit, PDO::PARAM_INT);
    $stmt->execute();

    $emails = $stmt->fetchAll(PDO::FETCH_ASSOC);

    // 3. è¿”å›æˆåŠŸå“åº”
    http_response_code(200);
    echo json_encode(['status' => 'success', 'data' => $emails]);

} catch (PDOException $e) {
    error_log("Error fetching emails for user {$user_id}: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'è·å–é‚®ä»¶åˆ—è¡¨æ—¶å‘ç”Ÿæ•°æ®åº“é”™è¯¯ã€‚']);
}
?>\n\n---\n\nFile: backend/auth/login.php\n<?php
// File: backend/auth/login.php

require_once __DIR__ . '/../db_operations.php';

// 1. è·å– POST è¯·æ±‚çš„ JSON æ•°æ®
$data = json_decode(file_get_contents('php://input'), true);
$email = $data['email'] ?? null;
$password = $data['password'] ?? null;

// 2. åŸºæœ¬éªŒè¯
if (empty($email) || empty($password)) {
    http_response_code(400); // Bad Request
    echo json_encode(['status' => 'error', 'message' => 'é‚®ç®±å’Œå¯†ç ä¸èƒ½ä¸ºç©ºã€‚']);
    exit;
}

try {
    // 3. ä»æ•°æ®åº“ä¸­æŸ¥æ‰¾ç”¨æˆ·
    $pdo = get_db_connection();
    $stmt = $pdo->prepare("SELECT id, email, password_hash, status FROM users WHERE email = ?");
    $stmt->execute([$email]);
    $user = $stmt->fetch(PDO::FETCH_ASSOC);

    // 4. éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨ã€å¯†ç æ˜¯å¦æ­£ç¡®ä»¥åŠè´¦æˆ·çŠ¶æ€
    if ($user && password_verify($password, $user['password_hash'])) {

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«å°ç¦
        if ($user['status'] === 'banned') {
            http_response_code(403); // Forbidden
            echo json_encode(['status' => 'error', 'message' => 'æ‚¨çš„è´¦æˆ·å·²è¢«å°ç¦ã€‚']);
            exit;
        }

        // 5. å¯†ç æ­£ç¡®ï¼Œåˆ›å»º Session
        // api_header.php å·²ç»è°ƒç”¨äº† session_start()
        session_regenerate_id(true); // é˜²æ­¢ä¼šè¯å›ºå®šæ”»å‡»
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['user_email'] = $user['email'];

        // 6. è¿”å›æˆåŠŸå“åº”å’Œç”¨æˆ·ä¿¡æ¯
        http_response_code(200);
        echo json_encode([
            'status' => 'success',
            'message' => 'ç™»å½•æˆåŠŸï¼',
            'user' => [
                'id' => $user['id'],
                'email' => $user['email']
            ]
        ]);

    } else {
        // ç”¨æˆ·ä¸å­˜åœ¨æˆ–å¯†ç é”™è¯¯
        http_response_code(401); // Unauthorized
        echo json_encode(['status' => 'error', 'message' => 'é‚®ç®±æˆ–å¯†ç é”™è¯¯ã€‚']);
    }

} catch (PDOException $e) {
    // æ•°æ®åº“é”™è¯¯
    error_log("Login Error: " . $e->getMessage()); // è®°å½•é”™è¯¯æ—¥å¿—
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚']);
}
?>\n\n---\n\nFile: backend/auth/logout.php\n<?php
// File: backend/auth/logout.php

// api_header.php å·²ç»å¯åŠ¨äº† session, æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥æ“ä½œå®ƒ

// 1. æ¸…ç©ºæ‰€æœ‰ session å˜é‡
$_SESSION = [];

// 2. åˆ é™¤ session cookie
// è¿™æ˜¯ç¡®ä¿æµè§ˆå™¨åˆ é™¤ä¼šè¯æ ‡è¯†çš„å…³é”®æ­¥éª¤
if (ini_get("session.use_cookies")) {
    $params = session_get_cookie_params();
    setcookie(session_name(), '', time() - 42000,
        $params["path"], $params["domain"],
        $params["secure"], $params["httponly"]
    );
}

// 3. é”€æ¯æœåŠ¡å™¨ä¸Šçš„ session æ•°æ®
session_destroy();

// 4. è¿”å›æˆåŠŸå“åº”
http_response_code(200);
echo json_encode(['status' => 'success', 'message' => 'ç™»å‡ºæˆåŠŸï¼']);
?>\n\n---\n\nFile: backend/auth/odds_template.php\n<?php
// File: backend/auth/odds_template.php (ä¿®å¤ç‰ˆ)
require_once __DIR__ . '/../db_operations.php';

// 1. èº«ä»½éªŒè¯
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

$user_id = $_SESSION['user_id'];

try {
    $pdo = get_db_connection();

    if ($_SERVER['REQUEST_METHOD'] === 'GET') {
        // è·å–ç”¨æˆ·èµ”ç‡æ¨¡æ¿
        $stmt = $pdo->prepare("SELECT * FROM user_odds_templates WHERE user_id = ?");
        $stmt->execute([$user_id]);
        $template = $stmt->fetch(PDO::FETCH_ASSOC);

        if (!$template) {
            // å¦‚æœæ²¡æœ‰æ¨¡æ¿ï¼Œè¿”å›ç©ºæ¨¡æ¿ç»“æ„
            $template = [
                'special_code_odds' => null,
                'flat_special_odds' => null,
                'serial_code_odds' => null,
                'even_xiao_odds' => null,
                'six_xiao_odds' => null,
                'size_single_double_odds' => null
            ];
        }

        http_response_code(200);
        echo json_encode([
            'status' => 'success',
            'data' => $template
        ]);

    } elseif ($_SERVER['REQUEST_METHOD'] === 'POST') {
        // æ›´æ–°ç”¨æˆ·èµ”ç‡æ¨¡æ¿
        $input = json_decode(file_get_contents('php://input'), true);

        // éªŒè¯è¾“å…¥æ•°æ®
        if (!$input) {
            http_response_code(400);
            echo json_encode(['status' => 'error', 'message' => 'Invalid JSON data']);
            exit;
        }

        // å®‰å…¨åœ°è·å–å’Œè½¬æ¢æ•°å€¼
        $special_code_odds = isset($input['special_code_odds']) && $input['special_code_odds'] !== '' ? floatval($input['special_code_odds']) : null;
        $flat_special_odds = isset($input['flat_special_odds']) && $input['flat_special_odds'] !== '' ? floatval($input['flat_special_odds']) : null;
        $serial_code_odds = isset($input['serial_code_odds']) && $input['serial_code_odds'] !== '' ? floatval($input['serial_code_odds']) : null;
        $even_xiao_odds = isset($input['even_xiao_odds']) && $input['even_xiao_odds'] !== '' ? floatval($input['even_xiao_odds']) : null;
        $six_xiao_odds = isset($input['six_xiao_odds']) && $input['six_xiao_odds'] !== '' ? floatval($input['six_xiao_odds']) : null;
        $size_single_double_odds = isset($input['size_single_double_odds']) && $input['size_single_double_odds'] !== '' ? floatval($input['size_single_double_odds']) : null;

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ¨¡æ¿
        $stmt_check = $pdo->prepare("SELECT id FROM user_odds_templates WHERE user_id = ?");
        $stmt_check->execute([$user_id]);
        $existing_template = $stmt_check->fetch();

        if ($existing_template) {
            // æ›´æ–°ç°æœ‰æ¨¡æ¿
            $stmt = $pdo->prepare("
                UPDATE user_odds_templates
                SET special_code_odds = ?, flat_special_odds = ?, serial_code_odds = ?,
                    even_xiao_odds = ?, six_xiao_odds = ?, size_single_double_odds = ?,
                    updated_at = CURRENT_TIMESTAMP
                WHERE user_id = ?
            ");
            $result = $stmt->execute([
                $special_code_odds, $flat_special_odds, $serial_code_odds,
                $even_xiao_odds, $six_xiao_odds, $size_single_double_odds,
                $user_id
            ]);
        } else {
            // æ’å…¥æ–°æ¨¡æ¿
            $stmt = $pdo->prepare("
                INSERT INTO user_odds_templates
                (user_id, special_code_odds, flat_special_odds, serial_code_odds,
                 even_xiao_odds, six_xiao_odds, size_single_double_odds)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            ");
            $result = $stmt->execute([
                $user_id, $special_code_odds, $flat_special_odds, $serial_code_odds,
                $even_xiao_odds, $six_xiao_odds, $size_single_double_odds
            ]);
        }

        if ($result) {
            http_response_code(200);
            echo json_encode([
                'status' => 'success',
                'message' => 'èµ”ç‡æ¨¡æ¿ä¿å­˜æˆåŠŸ'
            ]);
        } else {
            throw new Exception('Failed to save template');
        }
    }

} catch (PDOException $e) {
    error_log("Database error in odds_template: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'æ•°æ®åº“é”™è¯¯: ' . $e->getMessage()]);
} catch (Exception $e) {
    error_log("General error in odds_template: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'æœåŠ¡å™¨é”™è¯¯: ' . $e->getMessage()]);
} catch (Throwable $e) {
    error_log("Unexpected error in odds_template: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'æœªçŸ¥é”™è¯¯: ' . $e->getMessage()]);
}
?>\n\n---\n\nFile: backend/auth/parse_single_bet.php\n<?php
// File: backend/auth/parse_single_bet.php (ä¿®å¤ç‰ˆï¼Œæ”¯æŒå½©ç¥¨ç±»å‹å‚æ•°)

if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

$input = json_decode(file_get_contents('php://input'), true);
$email_id = $input['email_id'] ?? null;
$bet_text = $input['bet_text'] ?? null;
$line_number = $input['line_number'] ?? null;
$lottery_type = $input['lottery_type'] ?? 'é¦™æ¸¯å…­åˆå½©'; // æ–°å¢å‚æ•°

// å‚æ•°éªŒè¯
if (empty($email_id) || !is_numeric($email_id)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Valid Email ID is required.']);
    exit;
}

if (empty($bet_text) || !is_string($bet_text)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Valid bet text is required.']);
    exit;
}

try {
    $pdo = get_db_connection();
    $user_id = $_SESSION['user_id'];

    // éªŒè¯é‚®ä»¶å±äºå½“å‰ç”¨æˆ·
    $stmt = $pdo->prepare("SELECT id FROM raw_emails WHERE id = ? AND user_id = ?");
    $stmt->execute([intval($email_id), $user_id]);
    if (!$stmt->fetch()) {
        http_response_code(403);
        echo json_encode(['status' => 'error', 'message' => 'Access denied. Email not found.']);
        exit;
    }

    // è·å–ç”¨æˆ·èµ”ç‡æ¨¡æ¿
    $stmt_odds = $pdo->prepare("SELECT * FROM user_odds_templates WHERE user_id = ?");
    $stmt_odds->execute([$user_id]);
    $userOddsTemplate = $stmt_odds->fetch(PDO::FETCH_ASSOC);

    // å¦‚æœæ²¡æœ‰èµ”ç‡æ¨¡æ¿ï¼Œè®¾ç½®ä¸ºç©ºæ•°ç»„
    if (!$userOddsTemplate) {
        $userOddsTemplate = [];
    }

    // è·å–æœ€æ–°å¼€å¥–ç»“æœ
    $sql_latest_results = "
        SELECT r1.* FROM lottery_results r1
        JOIN (SELECT lottery_type, MAX(id) AS max_id FROM lottery_results GROUP BY lottery_type) r2
        ON r1.lottery_type = r2.lottery_type AND r1.id = r2.max_id
    ";
    $stmt_latest = $pdo->query($sql_latest_results);
    $latest_results_raw = $stmt_latest->fetchAll(PDO::FETCH_ASSOC);

    $latest_results = [];
    foreach ($latest_results_raw as $row) {
        foreach(['winning_numbers', 'zodiac_signs', 'colors'] as $key) {
            $decoded = json_decode($row[$key], true);
            $row[$key] = $decoded ?: [];
        }
        $latest_results[$row['lottery_type']] = $row;
    }

    // è§£æå•æ¡ä¸‹æ³¨
    $parse_result = parseSingleBetText($bet_text, $latest_results, $userOddsTemplate, $lottery_type);

    // ä¿å­˜åˆ°æ•°æ®åº“
    $bet_data_json = json_encode([
        'raw_text' => $bet_text,
        'line_number' => $line_number ? intval($line_number) : null,
        'bets' => $parse_result['bets'],
        'total_amount' => $parse_result['total_amount'],
        'lottery_type' => $parse_result['lottery_type'],
        'settlement' => $parse_result['settlement']
    ]);

    $stmt_insert = $pdo->prepare("
        INSERT INTO parsed_bets (email_id, bet_data_json, ai_model_used, line_number)
        VALUES (?, ?, 'single_line_parser', ?)
    ");
    $stmt_insert->execute([
        intval($email_id),
        $bet_data_json,
        $line_number ? intval($line_number) : null
    ]);

    http_response_code(200);
    echo json_encode([
        'status' => 'success',
        'data' => [
            'batch_id' => $pdo->lastInsertId(),
            'parse_result' => $parse_result,
            'line_number' => $line_number
        ]
    ]);

} catch (Throwable $e) {
    error_log("Error parsing single bet: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'è§£æå¤±è´¥: ' . $e->getMessage()]);
}

// åœ¨ parseSingleBetText å‡½æ•°ä¸­ï¼Œç¡®ä¿æ­£ç¡®è®¡ç®—æ€»ä¸‹æ³¨é‡‘é¢
function parseSingleBetText(string $text, array $latest_results, ?array $userOddsTemplate = null, string $lottery_type = 'é¦™æ¸¯å…­åˆå½©'): array {
    require_once __DIR__ . '/../helpers/manual_parser.php';

    // å…ˆå°è¯•æ‰‹åŠ¨è§£æ
    $manual_data = parseBetManually($text);

    // å¦‚æœæ‰‹åŠ¨è§£ææ²¡æœ‰ç»“æœï¼Œå°è¯•AIè§£æ
    if (empty($manual_data['bets'])) {
        require_once __DIR__ . '/../ai_helper.php';
        // ä½¿ç”¨ä¸“é—¨çš„å•æ¡ä¸‹æ³¨AIè§£æå‡½æ•°
        $ai_result = analyzeSingleBetWithAI($text, $lottery_type);

        if ($ai_result['success'] && isset($ai_result['data'])) {
            $manual_data = $ai_result['data'];
        }
    }

    // ç¡®ä¿å½©ç¥¨ç±»å‹æ­£ç¡®è®¾ç½®
    $manual_data['lottery_type'] = $lottery_type;

    // é‡æ–°è®¡ç®—æ€»ä¸‹æ³¨é‡‘é¢ï¼Œç¡®ä¿å‡†ç¡®æ€§
    $total_amount = 0;
    if (isset($manual_data['bets']) && is_array($manual_data['bets'])) {
        foreach ($manual_data['bets'] as &$bet) {
            $amount = floatval($bet['amount'] ?? 0);
            $targets = $bet['targets'] ?? [];

            if ($amount > 0) {
                // å¯¹äºç‰¹ç ã€å·ç ç­‰ç©æ³•ï¼Œæ¯ä¸ªç›®æ ‡éƒ½ç®—ä¸€æ¬¡ä¸‹æ³¨
                if ($bet['bet_type'] === 'ç‰¹ç ' || $bet['bet_type'] === 'å·ç ' || $bet['bet_type'] === 'å¹³ç ') {
                    $bet_total = $amount * (is_array($targets) ? count($targets) : 1);
                } else {
                    // å¯¹äºå…­è‚–ç­‰ç»„åˆç©æ³•ï¼Œåªç®—ä¸€æ¬¡ä¸‹æ³¨
                    $bet_total = $amount;
                }
                $total_amount += $bet_total;
            }

            // ç¡®ä¿æ¯ä¸ªä¸‹æ³¨éƒ½æœ‰å½©ç¥¨ç±»å‹
            if (!isset($bet['lottery_type'])) {
                $bet['lottery_type'] = $manual_data['lottery_type'];
            }
        }
        $manual_data['total_amount'] = $total_amount;
    }

    // è®¡ç®—ç»“ç®—
    $settlement_data = calculateManualSettlementDirect($manual_data, $latest_results, $userOddsTemplate);

    return [
        'bets' => $manual_data['bets'] ?? [],
        'total_amount' => $manual_data['total_amount'] ?? 0,
        'lottery_type' => $manual_data['lottery_type'] ?? $lottery_type,
        'settlement' => $settlement_data,
        'raw_text' => $text
    ];
}\n\n---\n\nFile: backend/auth/quick_calibrate_ai.php\n<?php
// File: backend/auth/quick_calibrate_ai.php

require_once __DIR__ . '/../ai_helper.php';

// 1. èº«ä»½éªŒè¯
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}
$user_id = $_SESSION['user_id'];

// 2. è·å–å¹¶ä¸¥æ ¼éªŒè¯è¾“å…¥
$input = json_decode(file_get_contents('php://input'), true);
$email_id = filter_var($input['email_id'] ?? null, FILTER_VALIDATE_INT);
$line_number = filter_var($input['line_number'] ?? null, FILTER_VALIDATE_INT);
$batch_id = filter_var($input['batch_id'] ?? null, FILTER_VALIDATE_INT);
$corrected_total_amount = filter_var($input['corrected_total_amount'] ?? null, FILTER_VALIDATE_FLOAT, FILTER_FLAG_ALLOW_FRACTION);
$reason = trim($input['reason'] ?? '');

if (!$email_id || !$line_number || !$batch_id || $corrected_total_amount === false) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Missing or invalid required parameters.']);
    exit;
}

try {
    $pdo = get_db_connection();
    $pdo->beginTransaction();

    // 3. è·å–åŸå§‹è§£ææ•°æ®å’Œå•è¡Œæ–‡æœ¬
    $stmt = $pdo->prepare("
        SELECT bet_data_json FROM parsed_bets pb
        JOIN raw_emails re ON pb.email_id = re.id
        WHERE pb.id = ? AND re.user_id = ?
    ");
    $stmt->execute([$batch_id, $user_id]);
    $original_bet_json = $stmt->fetchColumn();

    if (!$original_bet_json) {
        throw new Exception("Record not found or access denied.", 403);
    }
    $original_parse = json_decode($original_bet_json, true);
    $original_text = $original_parse['raw_text'] ?? '';
    $lottery_type = $original_parse['lottery_type'] ?? 'é¦™æ¸¯å…­åˆå½©';

    // 4. è°ƒç”¨AIè¿›è¡Œå¸¦æœ‰â€œæç¤ºâ€çš„é‡æ–°è§£æ
    $ai_result = analyzeSingleBetWithAI($original_text, $lottery_type, [
        'original_parse' => $original_parse,
        'corrected_total_amount' => $corrected_total_amount,
        'reason' => $reason
    ]);

    if (!$ai_result['success'] || empty($ai_result['data'])) {
        throw new Exception($ai_result['message'] ?? 'AI re-parsing failed.');
    }

    $new_parse_data = $ai_result['data'];
    $new_parse_data['line_number'] = $line_number; // ç¡®ä¿line_numberåœ¨æ•°æ®ä¸­
    $new_parse_data['raw_text'] = $original_text; // ç¡®ä¿åŸå§‹æ–‡æœ¬åœ¨æ•°æ®ä¸­

    // 5. é‡æ–°ç»“ç®—
    require_once __DIR__ . '/get_email_details.php';
    $stmt_odds = $pdo->prepare("SELECT * FROM user_odds_templates WHERE user_id = ?");
    $stmt_odds->execute([$user_id]);
    $userOddsTemplate = $stmt_odds->fetch(PDO::FETCH_ASSOC);

    $sql_latest_results = "SELECT r1.* FROM lottery_results r1 JOIN (SELECT lottery_type, MAX(id) AS max_id FROM lottery_results GROUP BY lottery_type) r2 ON r1.lottery_type = r2.lottery_type AND r1.id = r2.max_id";
    $stmt_latest = $pdo->query($sql_latest_results);
    $latest_results_raw = $stmt_latest->fetchAll(PDO::FETCH_ASSOC);
    $latest_results = [];
    foreach ($latest_results_raw as $row) {
        foreach(['winning_numbers', 'zodiac_signs', 'colors'] as $key) { $row[$key] = json_decode($row[$key], true) ?: []; }
        $latest_results[$row['lottery_type']] = $row;
    }

    $lottery_result_for_settlement = $latest_results[$new_parse_data['lottery_type']] ?? null;
    $settlement_data = calculateBatchSettlement($new_parse_data, $lottery_result_for_settlement, $userOddsTemplate);
    $new_parse_data['settlement'] = $settlement_data;

    // 6. æ›´æ–°æ•°æ®åº“
    $stmt_update = $pdo->prepare("UPDATE parsed_bets SET bet_data_json = ? WHERE id = ?");
    $stmt_update->execute([json_encode($new_parse_data), $batch_id]);

    // 7. æäº¤äº‹åŠ¡
    $pdo->commit();

    // 8. è¿”å›æˆåŠŸå“åº”
    http_response_code(200);
    echo json_encode([
        'status' => 'success',
        'message' => 'AIå·²æ ¹æ®æ‚¨çš„æç¤ºé‡æ–°è§£æå¹¶ç»“ç®—ï¼',
        'data' => [
            'batch_id' => $batch_id,
            'parse_result' => $new_parse_data,
            'line_number' => intval($line_number)
        ]
    ]);

} catch (Throwable $e) {
    if (isset($pdo) && $pdo->inTransaction()) {
        $pdo->rollBack();
    }
    error_log("Quick Calibration Error: " . $e->getMessage());
    http_response_code($e->getCode() == 403 ? 403 : 500);
    echo json_encode(['status' => 'error', 'message' => 'å¿«é€Ÿæ ¡å‡†å¤±è´¥: ' . $e->getMessage()]);
}
?>\n\n---\n\nFile: backend/auth/reanalyze_email.php\n<?php
// File: backend/auth/reanalyze_email.php

// æ ¸å¿ƒä¾èµ–ç”± index.php åŠ è½½

// 1. èº«ä»½éªŒè¯æ£€æŸ¥
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

// 2. è·å–è¾“å…¥å‚æ•°
$input = json_decode(file_get_contents('php://input'), true);
$email_id = $input['email_id'] ?? null;

if (empty($email_id)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email ID is required.']);
    exit;
}

// 3. éªŒè¯é‚®ä»¶å±äºå½“å‰ç”¨æˆ·
try {
    $pdo = get_db_connection();

    $stmt = $pdo->prepare("SELECT id FROM raw_emails WHERE id = ? AND user_id = ?");
    $stmt->execute([$email_id, $_SESSION['user_id']]);

    if (!$stmt->fetch()) {
        http_response_code(403);
        echo json_encode(['status' => 'error', 'message' => 'Access denied.']);
        exit;
    }

} catch (PDOException $e) {
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Database error.']);
    exit;
}

// 4. æ‰§è¡Œé‡æ–°è§£æ
require_once __DIR__ . '/../ai_helper.php';
$result = reanalyzeEmailWithAI($email_id);

if ($result['success']) {
    http_response_code(200);
    echo json_encode([
        'status' => 'success',
        'message' => $result['message'],
        'batch_id' => $result['batch_id'] ?? null
    ]);
} else {
    http_response_code(500);
    echo json_encode([
        'status' => 'error',
        'message' => $result['message']
    ]);
}
?>\n\n---\n\nFile: backend/auth/register.php\n<?php // backend/auth/register.php
require_once __DIR__ . '/../db_operations.php';

$data = json_decode(file_get_contents('php://input'), true);
$email = $data['email'] ?? null;
$password = $data['password'] ?? null;

if (!$email || !$password) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email and password are required.']);
    exit;
}

try {
    $pdo = get_db_connection();
    $stmt = $pdo->prepare("SELECT id FROM users WHERE email = ?");
    $stmt->execute([$email]);
    if ($stmt->fetch()) {
        http_response_code(409);
        echo json_encode(['status' => 'error', 'message' => 'Email already registered.']);
        exit;
    }

    $hash = password_hash($password, PASSWORD_DEFAULT);
    $stmt = $pdo->prepare("INSERT INTO users (email, password_hash) VALUES (?, ?)");
    $stmt->execute([$email, $hash]);

    echo json_encode(['status' => 'success', 'message' => 'Registration successful.']);
} catch (PDOException $e) {
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Database error.']);
}\n\n---\n\nFile: backend/auth/smart_parse_email.php\n<?php
// File: backend/auth/smart_parse_email.php

// 1. èº«ä»½éªŒè¯
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

// 2. è·å–è¾“å…¥å‚æ•°
$input = json_decode(file_get_contents('php://input'), true);
$email_id = $input['email_id'] ?? null;
$lottery_types = $input['lottery_types'] ?? [];

if (empty($email_id) || empty($lottery_types)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email ID and lottery types are required.']);
    exit;
}

// 3. éªŒè¯é‚®ä»¶å±äºå½“å‰ç”¨æˆ·
try {
    $pdo = get_db_connection();
    $user_id = $_SESSION['user_id'];

    $stmt = $pdo->prepare("SELECT id, content FROM raw_emails WHERE id = ? AND user_id = ?");
    $stmt->execute([$email_id, $user_id]);
    $email = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$email) {
        http_response_code(403);
        echo json_encode(['status' => 'error', 'message' => 'Access denied.']);
        exit;
    }

    // 4. è·å–ç”¨æˆ·èµ”ç‡æ¨¡æ¿
    $stmt_odds = $pdo->prepare("SELECT * FROM user_odds_templates WHERE user_id = ?");
    $stmt_odds->execute([$user_id]);
    $userOddsTemplate = $stmt_odds->fetch(PDO::FETCH_ASSOC);

    if (!$userOddsTemplate || empty(array_filter($userOddsTemplate, function($value) {
        return $value !== null;
    }))) {
        http_response_code(400);
        echo json_encode(['status' => 'error', 'message' => 'è¯·å…ˆè®¾ç½®èµ”ç‡æ¨¡æ¿']);
        exit;
    }

    // 5. è·å–é€‰æ‹©çš„å½©ç¥¨ç±»å‹çš„å¼€å¥–ç»“æœ
    require_once __DIR__ . '/../helpers/mail_parser.php';
    $clean_content = parse_email_body($email['content']);

    // è·å–æœ€æ–°å¼€å¥–ç»“æœ
    $placeholders = implode(',', array_fill(0, count($lottery_types), '?'));
    $sql_latest_results = "
        SELECT r1.*
        FROM lottery_results r1
        JOIN (
            SELECT lottery_type, MAX(id) AS max_id
            FROM lottery_results
            GROUP BY lottery_type
        ) r2 ON r1.lottery_type = r2.lottery_type AND r1.id = r2.max_id
        WHERE r1.lottery_type IN ($placeholders)
    ";
    $stmt_latest = $pdo->prepare($sql_latest_results);
    $stmt_latest->execute($lottery_types);
    $latest_results_raw = $stmt_latest->fetchAll(PDO::FETCH_ASSOC);

    $latest_results = [];
    foreach ($latest_results_raw as $row) {
        foreach(['winning_numbers', 'zodiac_signs', 'colors'] as $key) {
            $decoded = json_decode($row[$key], true);
            $row[$key] = $decoded ?: [];
        }
        $latest_results[$row['lottery_type']] = $row;
    }

    // 6. å…ˆå°è¯•æ¨¡æ¿è§£æ
    require_once __DIR__ . '/../helpers/manual_parser.php';
    $manual_data = parseBetManually($clean_content);
    $parse_method = 'template';

    // 7. å¦‚æœæ¨¡æ¿è§£ææ²¡æœ‰ç»“æœï¼Œä½¿ç”¨AIè§£æ
    if (empty($manual_data['bets'])) {
        require_once __DIR__ . '/../ai_helper.php';
        $ai_result = analyzeBetSlipWithAI($email['content']);
        $parse_method = 'ai';

        if ($ai_result['success'] && isset($ai_result['data'])) {
            $manual_data = $ai_result['data'];
            // æ·»åŠ åŸå§‹æ–‡æœ¬åˆ°AIè§£æç»“æœä¸­
            if (isset($manual_data['bets'])) {
                foreach ($manual_data['bets'] as &$bet) {
                    $bet['raw_text'] = $bet['raw_text'] ?? 'AIè§£æ';
                }
            }
        }
    }

    // 8. è®¡ç®—ç»“ç®—ç»“æœ
    require_once __DIR__ . '/get_email_details.php'; // ä¸ºäº†ä½¿ç”¨ç»“ç®—å‡½æ•°
    $settlement_data = calculateManualSettlement($manual_data, $latest_results, $userOddsTemplate);

    // 9. åˆ é™¤æ—§çš„è§£æè®°å½•å¹¶ä¿å­˜æ–°çš„
    $stmt_delete = $pdo->prepare("DELETE FROM parsed_bets WHERE email_id = ?");
    $stmt_delete->execute([$email_id]);

    $model_used = $parse_method === 'ai' ? 'cloudflare_ai' : 'manual_template';
    $bet_data_json = json_encode($manual_data);

    $stmt_insert = $pdo->prepare("INSERT INTO parsed_bets (email_id, bet_data_json, ai_model_used) VALUES (?, ?, ?)");
    $stmt_insert->execute([$email_id, $bet_data_json, $model_used]);

    // 10. æ›´æ–°é‚®ä»¶çŠ¶æ€
    $stmt_update = $pdo->prepare("UPDATE raw_emails SET status = 'processed' WHERE id = ?");
    $stmt_update->execute([$email_id]);

    // 11. è¿”å›ç»“æœ
    http_response_code(200);
    echo json_encode([
        'status' => 'success',
        'message' => 'è§£æå®Œæˆ',
        'parse_method' => $parse_method,
        'batch_id' => $pdo->lastInsertId(),
        'settlement' => $settlement_data,
        'bet_data' => $manual_data
    ]);

} catch (Throwable $e) {
    error_log("Error in smart_parse_email for email {$email_id}: " . $e->getMessage());
    error_log("Stack trace: " . $e->getTraceAsString());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'è§£æå¤±è´¥: ' . $e->getMessage()]);
}
?>\n\n---\n\nFile: backend/auth/split_email_lines.php\n<?php
// File: backend/auth/split_email_lines.php (ä¼˜åŒ–ç‰ˆ)

if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

$email_id = $_GET['id'] ?? null;

if (empty($email_id)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email ID is required.']);
    exit;
}

try {
    $pdo = get_db_connection();
    $user_id = $_SESSION['user_id'];

    // è·å–é‚®ä»¶å†…å®¹
    $stmt = $pdo->prepare("SELECT content FROM raw_emails WHERE id = ? AND user_id = ?");
    $stmt->execute([$email_id, $user_id]);
    $raw_content = $stmt->fetchColumn();

    if ($raw_content === false) {
        http_response_code(404);
        echo json_encode(['status' => 'error', 'message' => 'Email not found.']);
        exit;
    }

    require_once __DIR__ . '/../helpers/mail_parser.php';
    $clean_content = parse_email_body($raw_content);

    // æ™ºèƒ½æ‹†åˆ†ä¸‹æ³¨å• - ä½¿ç”¨ä¼˜åŒ–ç®—æ³•
    $bet_lines = splitBetLinesIntelligently($clean_content);

    // è·å–å·²è§£æçš„æ‰¹æ¬¡
    $stmt_bets = $pdo->prepare("
        SELECT id, bet_data_json, line_number
        FROM parsed_bets
        WHERE email_id = ?
        ORDER BY line_number ASC
    ");
    $stmt_bets->execute([$email_id]);
    $existing_batches = $stmt_bets->fetchAll(PDO::FETCH_ASSOC);

    // ç»„ç»‡å“åº”æ•°æ®
    $lines_data = [];
    foreach ($bet_lines as $index => $line) {
        $line_number = $index + 1;
        $existing_batch = null;

        // æŸ¥æ‰¾æ˜¯å¦å·²è§£æ
        foreach ($existing_batches as $batch) {
            $batch_data = json_decode($batch['bet_data_json'], true);
            if ($batch['line_number'] == $line_number) {
                $existing_batch = [
                    'batch_id' => $batch['id'],
                    'data' => $batch_data,
                    'line_number' => $line_number
                ];
                break;
            }
        }

        $lines_data[] = [
            'line_number' => $line_number,
            'text' => trim($line),
            'is_parsed' => !is_null($existing_batch),
            'batch_data' => $existing_batch
        ];
    }

    http_response_code(200);
    echo json_encode([
        'status' => 'success',
        'data' => [
            'email_content' => $clean_content,
            'lines' => $lines_data,
            'total_lines' => count($bet_lines)
        ]
    ]);

} catch (Throwable $e) {
    error_log("Error splitting email lines: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'æ‹†åˆ†å¤±è´¥: ' . $e->getMessage()]);
}

/**
 * æ™ºèƒ½æ‹†åˆ†ä¸‹æ³¨å•è¡Œ - ä¼˜åŒ–ç‰ˆ
 */
function splitBetLinesIntelligently(string $content): array {
    $lines = explode("\n", $content);
    $bet_lines = [];

    // å®šä¹‰ä¸‹æ³¨å…³é”®è¯æ¨¡å¼
    $bet_patterns = [
        // æ¾³é—¨æ¨¡å¼
        '/æ¾³é—¨[ï¼Œ,].*?\d+.*?(å…ƒ|å—|#)/u',
        // é¦™æ¸¯æ¨¡å¼
        '/é¦™æ¸¯[ï¼š:].*?\d+.*?(å…ƒ|å—|#)/u',
        // å·ç æ¨¡å¼
        '/\b\d{2}(?:[.,]\d{2})*.*?(å„|Ã—|x)\s*\d+\s*(å…ƒ|å—|#)/u',
        // ç”Ÿè‚–æ¨¡å¼
        '/[é¼ ç‰›è™å…”é¾™è›‡é©¬ç¾ŠçŒ´é¸¡ç‹—çŒª].*?\d+\s*(å…ƒ|å—|é—·)/u',
        // é‡‘é¢æ¨¡å¼
        '/å„\s*\d+\s*(å…ƒ|å—|#|é—·)/u',
        // å…­è‚–æ¨¡å¼
        '/[é¼ ç‰›è™å…”é¾™è›‡é©¬ç¾ŠçŒ´é¸¡ç‹—çŒª]{2,}.*?\d+\s*(å…ƒ|å—|é—·)/u'
    ];

    $current_bet = '';

    foreach ($lines as $line) {
        $line = trim($line);
        if (empty($line)) continue;

        // è·³è¿‡èŠå¤©è®°å½•å¤´éƒ¨å’Œéä¸‹æ³¨å†…å®¹
        if (preg_match('/^(èƒœåˆ©|å¾®ä¿¡|èŠå¤©è®°å½•|â€”â€”â€”â€”â€”|\d{4}-\d{2}-\d{2}|è€éƒ½)/u', $line)) {
            // å¦‚æœå½“å‰æœ‰ç´¯ç§¯çš„ä¸‹æ³¨å†…å®¹ï¼Œå…ˆä¿å­˜
            if (!empty($current_bet)) {
                $bet_lines[] = $current_bet;
                $current_bet = '';
            }
            continue;
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸‹æ³¨ç‰¹å¾
        $is_bet_line = false;
        foreach ($bet_patterns as $pattern) {
            if (preg_match($pattern, $line)) {
                $is_bet_line = true;
                break;
            }
        }

        if ($is_bet_line) {
            // å¦‚æœå½“å‰æœ‰ç´¯ç§¯å†…å®¹ï¼Œå…ˆä¿å­˜
            if (!empty($current_bet)) {
                $bet_lines[] = $current_bet;
            }
            $current_bet = $line;
        } else if (!empty($current_bet)) {
            // å¦‚æœä¸æ˜¯ä¸‹æ³¨è¡Œä½†å½“å‰æœ‰ç´¯ç§¯ï¼Œå¯èƒ½æ˜¯ä¸‹æ³¨çš„å»¶ç»­
            $current_bet .= ' ' . $line;
        }
    }

    // æ·»åŠ æœ€åä¸€æ¡
    if (!empty($current_bet)) {
        $bet_lines[] = $current_bet;
    }

    return array_filter($bet_lines, function($line) {
        $line = trim($line);
        if (empty($line)) return false;

        // æœ€ç»ˆè¿‡æ»¤ï¼šå¿…é¡»åŒ…å«æ•°å­—å’Œé‡‘é¢å•ä½
        return preg_match('/\d.*?(å…ƒ|å—|#|é—·)|(å„|Ã—|x)\s*\d/u', $line);
    });
}

/**
 * æ—§ç‰ˆæ‹†åˆ†å‡½æ•°ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
 */
function splitBetLines(string $content): array {
    return splitBetLinesIntelligently($content);
}
?>\n\n---\n\nFile: backend/auth/update_bet_batch.php\n<?php
// File: backend/auth/update_bet_batch.php (with AI Learning)

// Include necessary files
require_once __DIR__ . '/../config.php';
require_once __DIR__ . '/../db_operations.php';
require_once __DIR__ . '/../ai_helper.php'; // Include for trainAIWithCorrection

/**
 * è§¦å‘AIå­¦ä¹ ä¿®æ­£
 */
function triggerAILearning($batch_id, $original_bet_data, $corrected_data) {
    try {
        $pdo = get_db_connection();
        // è·å–åŸå§‹é‚®ä»¶å†…å®¹
        $stmt = $pdo->prepare("
            SELECT re.content
            FROM parsed_bets pb
            JOIN raw_emails re ON pb.email_id = re.id
            WHERE pb.id = ?
        ");
        $stmt->execute([$batch_id]);
        $original_content = $stmt->fetchColumn();

        if ($original_content) {
            // æ„å»ºå­¦ä¹ æ•°æ®
            $learning_data = [
                'original_text' => $original_content,
                'original_parse' => $original_bet_data,
                'corrected_parse' => $corrected_data,
                'learning_timestamp' => date('Y-m-d H:i:s')
            ];

            // å®é™…è°ƒç”¨ AI å­¦ä¹ å‡½æ•°
            trainAIWithCorrection($learning_data);
            error_log("AI Learning Triggered for batch_id: " . $batch_id);

        } else {
            error_log("Could not find original email content for batch_id: " . $batch_id);
        }

    } catch (Exception $e) {
        error_log("Error in AI learning trigger for batch_id {$batch_id}: " . $e->getMessage());
    }
}


// --- Main script execution ---

// 1. èº«ä»½éªŒè¯
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

// 2. è·å–å¹¶éªŒè¯è¾“å…¥
$input = json_decode(file_get_contents('php://input'), true);
$batch_id = $input['batch_id'] ?? null;
$updated_data = $input['data'] ?? null;

if (empty($batch_id) || !is_numeric($batch_id) || $updated_data === null) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Invalid input: batch_id and data are required.']);
    exit;
}

$updated_data_json = json_encode($updated_data);
if ($updated_data_json === false) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Invalid JSON data provided.']);
    exit;
}

$pdo = null;
try {
    $pdo = get_db_connection();
    $pdo->beginTransaction();

    // 3. å®‰å…¨æ€§æ£€æŸ¥ & è·å–åŸå§‹æ•°æ®
    $stmt_check = $pdo->prepare("
        SELECT pb.id, pb.bet_data_json
        FROM parsed_bets pb
        JOIN raw_emails re ON pb.email_id = re.id
        WHERE pb.id = ? AND re.user_id = ?
    ");
    $stmt_check->execute([$batch_id, $_SESSION['user_id']]);
    $original_record = $stmt_check->fetch(PDO::FETCH_ASSOC);

    if ($original_record === false) {
        http_response_code(403);
        echo json_encode(['status' => 'error', 'message' => 'Access denied or record not found.']);
        $pdo->rollBack();
        exit;
    }

    $original_bet_data = json_decode($original_record['bet_data_json'], true);

    // 4. æ‰§è¡Œæ›´æ–°
    $stmt_update = $pdo->prepare("UPDATE parsed_bets SET bet_data_json = ? WHERE id = ?");
    $stmt_update->execute([$updated_data_json, $batch_id]);

    // 5. è§¦å‘AIå­¦ä¹  (å¦‚æœéœ€è¦)
    if (isset($updated_data['correction'])) {
        // è®°å½•ä¿®æ­£åˆ°æ•°æ®åº“
        try {
            $stmt_correction = $pdo->prepare("
                INSERT INTO ai_corrections
                (batch_id, original_amount, corrected_amount, correction_reason, corrected_at, user_id)
                VALUES (?, ?, ?, ?, ?, ?)
            ");
            $stmt_correction->execute([
                $batch_id,
                $updated_data['correction']['original_amount'],
                $updated_data['correction']['corrected_amount'],
                $updated_data['correction']['correction_reason'],
                $updated_data['correction']['corrected_at'],
                $_SESSION['user_id']
            ]);
        } catch (Exception $e) {
            error_log("Failed to save AI correction to DB: " . $e->getMessage());
            // This might not be a fatal error, so we log it but don't stop the process
        }

        // è§¦å‘AIå­¦ä¹ 
        triggerAILearning($batch_id, $original_bet_data, $updated_data);
    }

    // 6. æäº¤äº‹åŠ¡
    $pdo->commit();

    http_response_code(200);
    echo json_encode(['status' => 'success', 'message' => 'Bet batch updated successfully.']);

} catch (Exception $e) {
    if ($pdo && $pdo->inTransaction()) {
        $pdo->rollBack();
    }
    error_log("Error updating bet batch {$batch_id}: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'An error occurred during the update process.']);
}

?>\n\n---\n\nFile: backend/helpers/mail_parser.php\n<?php
// File: backend/helpers/mail_parser.php

if (!function_exists('parse_email_body')) {
    /**
     * ä»åŸå§‹ MIME é‚®ä»¶æ–‡æœ¬ä¸­è§£æå¹¶è§£ç å‡ºæœ€åˆé€‚çš„ç”¨æˆ·æ­£æ–‡ã€‚
     * ä¼˜å…ˆæå– text/plain éƒ¨åˆ†ã€‚
     *
     * @param string $raw_email å®Œæ•´çš„åŸå§‹é‚®ä»¶å†…å®¹ã€‚
     * @return string æ¸…ç†å’Œè§£ç åçš„æ­£æ–‡æ–‡æœ¬ã€‚
     */
    function parse_email_body(string $raw_email): string {
        // 1. åˆ†ç¦»é‚®ä»¶å¤´å’Œé‚®ä»¶ä½“
        $parts = explode("\r\n\r\n", $raw_email, 2);
        if (count($parts) !== 2) {
            return $raw_email; // æ ¼å¼ä¸è§„èŒƒï¼Œè¿”å›åŸæ–‡
        }
        list($headers_raw, $body_raw) = $parts;

        // 2. è§£æé‚®ä»¶å¤´çš„ Content-Type
        if (!preg_match('/Content-Type: (.*)/i', $headers_raw, $matches)) {
            return $body_raw; // æ²¡æœ‰ Content-Typeï¼Œç›´æ¥è¿”å›é‚®ä»¶ä½“
        }
        $content_type_header = $matches[1];

        // 3. å¦‚æœä¸æ˜¯ multipart é‚®ä»¶ï¼Œç›´æ¥è§£ç é‚®ä»¶ä½“
        if (strpos(strtolower($content_type_header), 'multipart/') === false) {
            if (preg_match('/Content-Transfer-Encoding: (base64|quoted-printable)/i', $headers_raw, $encoding_match)) {
                return decode_body_part($body_raw, $encoding_match[1]);
            }
            return $body_raw;
        }

        // 4. å¦‚æœæ˜¯ multipart é‚®ä»¶ï¼Œè§£æ boundary
        if (!preg_match('/boundary="?([^"]+)"?/i', $content_type_header, $boundary_match)) {
            return $body_raw; // æ‰¾ä¸åˆ° boundaryï¼Œæ— æ³•è§£æ
        }
        $boundary = $boundary_match[1];

        // 5. æŒ‰ boundary åˆ†å‰²é‚®ä»¶ä½“
        $body_parts = explode('--' . $boundary, $body_raw);
        array_shift($body_parts); // ç§»é™¤ç¬¬ä¸€ä¸ªç©ºéƒ¨åˆ†
        array_pop($body_parts);   // ç§»é™¤æœ€åä¸€ä¸ª '--' ç»“å°¾çš„éƒ¨åˆ†

        $plain_text_body = '';
        $html_body = '';

        // 6. éå†æ¯ä¸ªéƒ¨åˆ†ï¼Œå¯»æ‰¾ text/plain å’Œ text/html
        foreach ($body_parts as $part) {
            if (empty(trim($part))) continue;

            $part_parts = explode("\r\n\r\n", $part, 2);
            if (count($part_parts) !== 2) continue;
            list($part_header_raw, $part_body_raw) = $part_parts;

            // æ£€æŸ¥å½“å‰éƒ¨åˆ†çš„ Content-Type
            if (preg_match('/Content-Type: text\/plain/i', $part_header_raw)) {
                if (preg_match('/Content-Transfer-Encoding: (base64|quoted-printable)/i', $part_header_raw, $encoding_match)) {
                    $plain_text_body = decode_body_part($part_body_raw, $encoding_match[1]);
                } else {
                    $plain_text_body = $part_body_raw;
                }
            } elseif (preg_match('/Content-Type: text\/html/i', $part_header_raw)) {
                if (preg_match('/Content-Transfer-Encoding: (base64|quoted-printable)/i', $part_header_raw, $encoding_match)) {
                    // è§£ç HTMLå¹¶å»é™¤æ‰€æœ‰HTMLæ ‡ç­¾ï¼Œå¾—åˆ°çº¯æ–‡æœ¬
                    $html_body = strip_tags(decode_body_part($part_body_raw, $encoding_match[1]));
                } else {
                    $html_body = strip_tags($part_body_raw);
                }
            }
        }

        // 7. ä¼˜å…ˆè¿”å›çº¯æ–‡æœ¬æ­£æ–‡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›ä»HTMLä¸­æå–çš„æ–‡æœ¬
        return trim($plain_text_body) ?: trim($html_body) ?: 'æ— æ³•è§£æé‚®ä»¶æ­£æ–‡';
    }
}

if (!function_exists('decode_body_part')) {
    /**
     * è§£ç  base64 æˆ– quoted-printable ç¼–ç çš„é‚®ä»¶ä½“éƒ¨åˆ†ã€‚
     * @param string $body
     * @param string $encoding
     * @return string
     */
    function decode_body_part(string $body, string $encoding): string {
        $encoding = strtolower(trim($encoding));
        if ($encoding === 'base64') {
            return base64_decode($body);
        } elseif ($encoding === 'quoted-printable') {
            return quoted_printable_decode($body);
        }
        return $body; // å¦‚æœç¼–ç ä¸è®¤è¯†ï¼Œè¿”å›åŸæ–‡
    }
}
?>\n\n---\n\nFile: backend/helpers/manual_parser.php\n<?php
// File: backend/helpers/manual_parser.php (ä¼˜åŒ–èšåˆæ˜¾ç¤º)

/**
 * æ‰‹åŠ¨è§£æä¸‹æ³¨ä¿¡æ¯ - èšåˆç›¸åŒé‡‘é¢çš„ä¸‹æ³¨
 */
function parseBetManually(string $text): array {
    $bets = [];
    $totalAmount = 0;

    // æ¸…ç†æ–‡æœ¬
    $text = preg_replace('/\s+/', ' ', $text);
    $text = trim($text);

    // 1. è§£ææ··åˆä¸‹æ³¨æ ¼å¼: "æ¾³é—¨ã€40Ã—10å…ƒã€39ã€30ã€å„5å…ƒã€é¦™æ¸¯ã€40Ã—10å…ƒã€02ã€04ã€09ã€45ã€å„5å…ƒ"
    if (preg_match('/æ¾³é—¨[ï¼Œ,].*é¦™æ¸¯[ï¼Œ,]/u', $text)) {
        // è§£ææ¾³é—¨éƒ¨åˆ†
        if (preg_match('/æ¾³é—¨[ï¼Œ,]\s*([^é¦™æ¸¯]+)é¦™æ¸¯/u', $text, $matches)) {
            $macau_part = $matches[1];
            parseMixedBetPart($macau_part, 'æ¾³é—¨å…­åˆå½©', $bets, $totalAmount);
        }

        // è§£æé¦™æ¸¯éƒ¨åˆ†
        if (preg_match('/é¦™æ¸¯[ï¼Œ,]\s*(.+)$/u', $text, $matches)) {
            $hk_part = $matches[1];
            parseMixedBetPart($hk_part, 'é¦™æ¸¯å…­åˆå½©', $bets, $totalAmount);
        }
    }
    // 2. è§£æçº¯æ¾³é—¨ä¸‹æ³¨ - ä¼˜åŒ–ç‚¹å·åˆ†éš”æ ¼å¼
    else if (preg_match('/æ¾³é—¨[ï¼Œ,:]\s*([\d.]+)å„(\d+)(å—|å…ƒ)/u', $text, $matches)) {
        $numbers_text = $matches[1];
        $amount = intval($matches[2]);

        $numbers = explode('.', $numbers_text);
        $numbers = array_filter($numbers, function($num) {
            return !empty(trim($num));
        });

        if (!empty($numbers)) {
            $bets[] = [
                'bet_type' => 'ç‰¹ç ',
                'targets' => $numbers,
                'amount' => $amount,
                'total_bet' => $amount * count($numbers),
                'raw_text' => "æ¾³é—¨å·ç " . implode('.', $numbers) . "å„{$amount}å—",
                'lottery_type' => 'æ¾³é—¨å…­åˆå½©'
            ];
            $totalAmount += $amount * count($numbers);
        }
    }
    // 3. è§£æçº¯é¦™æ¸¯ä¸‹æ³¨ - ä¼˜åŒ–ç‚¹å·åˆ†éš”æ ¼å¼
    else if (preg_match('/é¦™æ¸¯[ï¼Œ,:]\s*([\d.]+)å„(\d+)(å—|å…ƒ)/u', $text, $matches)) {
        $numbers_text = $matches[1];
        $amount = intval($matches[2]);

        $numbers = explode('.', $numbers_text);
        $numbers = array_filter($numbers, function($num) {
            return !empty(trim($num));
        });

        if (!empty($numbers)) {
            $bets[] = [
                'bet_type' => 'ç‰¹ç ',
                'targets' => $numbers,
                'amount' => $amount,
                'total_bet' => $amount * count($numbers),
                'raw_text' => "é¦™æ¸¯å·ç " . implode('.', $numbers) . "å„{$amount}å—",
                'lottery_type' => 'é¦™æ¸¯å…­åˆå½©'
            ];
            $totalAmount += $amount * count($numbers);
        }
    }
    // 4. è§£æå…­è‚–ä¸‹æ³¨
    else if (preg_match('/([é¼ ç‰›è™å…”é¾™è›‡é©¬ç¾ŠçŒ´é¸¡ç‹—çŒª]{2,})è‚–\s*(\d+)\s*é—·/u', $text, $matches)) {
        $zodiacs = preg_split('//u', $matches[1], -1, PREG_SPLIT_NO_EMPTY);
        $amount = intval($matches[2]);

        if (count($zodiacs) >= 2) {
            $bets[] = [
                'bet_type' => 'å…­è‚–',
                'targets' => $zodiacs,
                'amount' => $amount,
                'total_bet' => $amount, // å…­è‚–åªç®—ä¸€æ¬¡ä¸‹æ³¨
                'raw_text' => implode('', $zodiacs) . "è‚–{$amount}é—·",
                'lottery_type' => 'æ··åˆ'
            ];
            $totalAmount += $amount;
        }
    }
    // 5. è§£æå…¶ä»–æ ¼å¼...

    return [
        'lottery_type' => count($bets) > 0 ? 'æ··åˆ' : 'æœªçŸ¥',
        'issue_number' => '',
        'bets' => $bets,
        'total_amount' => $totalAmount
    ];
}\n\n---\n\nFile: backend/lottery/get_result_by_issue.php\n<?php
// File: backend/lottery/get_result_by_issue.php

$issue_number = $_GET['issue'] ?? null;
$lottery_type = $_GET['type'] ?? null;

if (empty($issue_number) || empty($lottery_type)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Lottery type and issue number are required.']);
    exit;
}

try {
    $pdo = get_db_connection();
    $stmt = $pdo->prepare("SELECT * FROM lottery_results WHERE lottery_type = ? AND issue_number = ?");
    $stmt->execute([$lottery_type, $issue_number]);
    $result = $stmt->fetch(PDO::FETCH_ASSOC);

    if ($result) {
        // è§£ç  JSON å­—æ®µ
        foreach(['winning_numbers', 'zodiac_signs', 'colors'] as $key) {
            $result[$key] = json_decode($result[$key]) ?: [];
        }
        echo json_encode(['status' => 'success', 'data' => $result]);
    } else {
        http_response_code(404);
        echo json_encode(['status' => 'error', 'message' => 'Lottery result for this issue not found.']);
    }

} catch (PDOException $e) {
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Database error.']);
}
?>\n\n---\n\nFile: backend/lottery/get_results.php\n<?php
// File: backend/lottery/get_results.php (Simplified, No Requires)

if (!function_exists('get_db_connection')) {
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Core function get_db_connection() is missing.']);
    exit;
}

try {
    $pdo = get_db_connection();
    // ... (rest of the file is the same)
    $sql = "SELECT r1.* FROM lottery_results r1 JOIN (SELECT lottery_type, MAX(id) AS max_id FROM lottery_results GROUP BY lottery_type) r2 ON r1.lottery_type = r2.lottery_type AND r1.id = r2.max_id";
    $stmt = $pdo->query($sql);
    $results = $stmt->fetchAll(PDO::FETCH_ASSOC);
    // ... processing logic ...
    $grouped_results = [];
    foreach ($results as $row) {
        foreach(['winning_numbers', 'zodiac_signs', 'colors'] as $key) {
            $decoded = json_decode($row[$key]);
            $row[$key] = $decoded ?: [];
        }
        $grouped_results[$row['lottery_type']] = $row;
    }
    $lottery_types = ['é¦™æ¸¯å…­åˆå½©', 'æ–°æ¾³é—¨å…­åˆå½©', 'è€æ¾³é—¨å…­åˆå½©'];
    $final_data = [];
    foreach ($lottery_types as $type) {
        $final_data[$type] = $grouped_results[$type] ?? null;
    }
    echo json_encode(['status' => 'success', 'data' => $final_data]);
} catch (Throwable $e) {
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'An error occurred.', 'details' => $e->getMessage()]);
}
?>\n\n---\n\nFile: backend/lottery/rules.php\n<?php
// File: backend/lottery/rules.php

if (!function_exists('get_lottery_rules')) {
    /**
     * è¿”å›æ‰€æœ‰å·ç çš„å±æ€§ï¼ŒåŒ…æ‹¬æ³¢è‰²å’Œç”Ÿè‚–ã€‚
     * @return array
     */
    function get_lottery_rules() {
        // ä½¿ç”¨é™æ€å˜é‡ï¼Œç¡®ä¿è¿™ä¸ªåºå¤§çš„æ•°ç»„åªè¢«æ„å»ºä¸€æ¬¡
        static $rules = null;

        if ($rules === null) {
            $rules = [
                '01' => ['color' => 'çº¢æ³¢', 'zodiac' => 'è›‡'], '02' => ['color' => 'çº¢æ³¢', 'zodiac' => 'é¾™'],
                '03' => ['color' => 'è“æ³¢', 'zodiac' => 'å…”'], '04' => ['color' => 'è“æ³¢', 'zodiac' => 'è™'],
                '05' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'ç‰›'], '06' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'é¼ '],
                '07' => ['color' => 'çº¢æ³¢', 'zodiac' => 'çŒª'], '08' => ['color' => 'çº¢æ³¢', 'zodiac' => 'ç‹—'],
                '09' => ['color' => 'è“æ³¢', 'zodiac' => 'é¸¡'], '10' => ['color' => 'è“æ³¢', 'zodiac' => 'çŒ´'],
                '11' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'ç¾Š'], '12' => ['color' => 'çº¢æ³¢', 'zodiac' => 'é©¬'],
                '13' => ['color' => 'çº¢æ³¢', 'zodiac' => 'è›‡'], '14' => ['color' => 'è“æ³¢', 'zodiac' => 'é¾™'],
                '15' => ['color' => 'è“æ³¢', 'zodiac' => 'å…”'], '16' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'è™'],
                '17' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'ç‰›'], '18' => ['color' => 'çº¢æ³¢', 'zodiac' => 'é¼ '],
                '19' => ['color' => 'çº¢æ³¢', 'zodiac' => 'çŒª'], '20' => ['color' => 'è“æ³¢', 'zodiac' => 'ç‹—'],
                '21' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'é¸¡'], '22' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'çŒ´'],
                '23' => ['color' => 'çº¢æ³¢', 'zodiac' => 'ç¾Š'], '24' => ['color' => 'çº¢æ³¢', 'zodiac' => 'é©¬'],
                '25' => ['color' => 'è“æ³¢', 'zodiac' => 'è›‡'], '26' => ['color' => 'è“æ³¢', 'zodiac' => 'é¾™'],
                '27' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'å…”'], '28' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'è™'],
                '29' => ['color' => 'çº¢æ³¢', 'zodiac' => 'ç‰›'], '30' => ['color' => 'çº¢æ³¢', 'zodiac' => 'é¼ '],
                '31' => ['color' => 'è“æ³¢', 'zodiac' => 'çŒª'], '32' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'ç‹—'],
                '33' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'é¸¡'], '34' => ['color' => 'çº¢æ³¢', 'zodiac' => 'çŒ´'],
                '35' => ['color' => 'çº¢æ³¢', 'zodiac' => 'ç¾Š'], '36' => ['color' => 'è“æ³¢', 'zodiac' => 'é©¬'],
                '37' => ['color' => 'è“æ³¢', 'zodiac' => 'è›‡'], '38' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'é¾™'],
                '39' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'å…”'], '40' => ['color' => 'çº¢æ³¢', 'zodiac' => 'è™'],
                '41' => ['color' => 'è“æ³¢', 'zodiac' => 'ç‰›'], '42' => ['color' => 'è“æ³¢', 'zodiac' => 'é¼ '],
                '43' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'çŒª'], '44' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'ç‹—'],
                '45' => ['color' => 'çº¢æ³¢', 'zodiac' => 'é¸¡'], '46' => ['color' => 'çº¢æ³¢', 'zodiac' => 'çŒ´'],
                '47' => ['color' => 'è“æ³¢', 'zodiac' => 'ç¾Š'], '48' => ['color' => 'è“æ³¢', 'zodiac' => 'é©¬'],
                '49' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'è›‡'],
            ];
        }
        return $rules;
    }
}

if (!function_exists('get_color_by_number')) {
    /**
     * æ ¹æ®å·ç è·å–å…¶æ³¢è‰²ã€‚
     * @param string $number
     * @return string|null
     */
    function get_color_by_number(string $number) {
        $rules = get_lottery_rules();
        // ç¡®ä¿å·ç æ˜¯ä¸¤ä½æ•°ï¼Œä¾‹å¦‚ '5' -> '05'
        $number_padded = str_pad($number, 2, '0', STR_PAD_LEFT);
        return $rules[$number_padded]['color'] ?? null;
    }
}

if (!function_exists('get_zodiac_by_number')) {
    /**
     * æ ¹æ®å·ç è·å–å…¶ç”Ÿè‚–ã€‚
     * @param string $number
     * @return string|null
     */
    function get_zodiac_by_number(string $number) {
        $rules = get_lottery_rules();
        $number_padded = str_pad($number, 2, '0', STR_PAD_LEFT);
        return $rules[$number_padded]['zodiac'] ?? null;
    }
}
?>\n\n---\n\n
