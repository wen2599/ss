---
File: backend/database_schema.sql
```
CREATE TABLE IF NOT EXISTS `users` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `email` VARCHAR(255) NOT NULL,
  `password_hash` VARCHAR(255) NOT NULL,
  `status` ENUM('active', 'banned') NOT NULL DEFAULT 'active',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `raw_emails` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `user_id` INT NOT NULL,
  `content` MEDIUMTEXT NOT NULL,
  `status` ENUM('pending', 'processed', 'failed') NOT NULL DEFAULT 'pending',
  `received_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `parsed_bets` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `email_id` INT NOT NULL,
  `bet_data_json` JSON NOT NULL,
  `ai_model_used` VARCHAR(50),
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`email_id`) REFERENCES `raw_emails`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `lottery_results` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `lottery_type` VARCHAR(100) NOT NULL,
  `issue_number` VARCHAR(255) NOT NULL,
  `winning_numbers` JSON NOT NULL,
  `zodiac_signs` JSON NOT NULL,
  `colors` JSON NOT NULL,
  `drawing_date` DATE,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY `type_issue` (`lottery_type`, `issue_number`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `settlements` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `bet_id` INT NOT NULL,
  `result_data_json` JSON NOT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`bet_id`) REFERENCES `parsed_bets`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;```
---
File: backend/mail_receiver_light.php
```
<?php
// File: mail_receiver_light.php (‰øÆÊîπ‰∏∫‰ªÖÊé•Êî∂Ôºå‰∏çËá™Âä®Ëß£Êûê)

// --- Áã¨Á´ãÁöÑÊó•ÂøóÁ≥ªÁªü ---
define('MAIL_LOG_FILE', __DIR__ . '/mail_debug.log');
function log_mail_debug($message) {
    error_log(date('[Y-m-d H:i:s] ') . $message . "\n", 3, MAIL_LOG_FILE);
}

log_mail_debug("=== ÈÇÆ‰ª∂Êé•Êî∂Âô®ÂºÄÂßã (‰ªÖÊé•Êî∂Ê®°Âºè) ===");

try {
    // --- 1. Âä†ËΩΩÊ†∏ÂøÉ‰æùËµñ ---
    require_once __DIR__ . '/config.php';
    log_mail_debug("‰æùËµñÂä†ËΩΩÂÆåÊàê");

    // --- 2. ÂÆâÂÖ®È™åËØÅ (Bearer Token) ---
    $secret = config('EMAIL_WORKER_SECRET');
    if (!$secret) {
        throw new Exception("EMAIL_WORKER_SECRET Êú™ÈÖçÁΩÆ");
    }

    $auth_header = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
    $token = str_replace('Bearer ', '', $auth_header);

    if (!hash_equals($secret, $token)) {
        log_mail_debug("Á¶ÅÊ≠¢ËÆøÈóÆ: Êó†ÊïàÁöÑ token");
        http_response_code(403);
        echo json_encode(['status' => 'error', 'message' => 'Á¶ÅÊ≠¢ËÆøÈóÆ']);
        exit;
    }
    log_mail_debug("ÂÆâÂÖ®Ê£ÄÊü•ÈÄöËøá");

    // --- 3. Ëé∑ÂèñÂπ∂È™åËØÅËæìÂÖ• (JSONÊ†ºÂºè) ---
    $json_input = file_get_contents('php://input');
    if (empty($json_input)) {
        throw new Exception("Á©∫ÁöÑ JSON ËæìÂÖ•");
    }

    $input = json_decode($json_input, true);
    if ($input === null) {
        throw new Exception("Êó†ÊïàÁöÑ JSON Êï∞ÊçÆ");
    }

    $sender_email = $input['sender'] ?? null;
    $raw_content = $input['raw_content'] ?? null;

    if (empty($sender_email) || empty($raw_content)) {
        throw new Exception("Áº∫Â∞ë 'sender' Êàñ 'raw_content' Â≠óÊÆµ");
    }
    log_mail_debug("Êî∂Âà∞Êù•Ëá™: " . $sender_email . " ÁöÑÈÇÆ‰ª∂");

    // --- 4. ËøûÊé•Êï∞ÊçÆÂ∫ì ---
    $dsn = sprintf("mysql:host=%s;port=%s;dbname=%s;charset=utf8mb4",
        config('DB_HOST'), config('DB_PORT'), config('DB_DATABASE')
    );
    $options = [ PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION ];
    $pdo = new PDO($dsn, config('DB_USERNAME'), config('DB_PASSWORD'), $options);
    log_mail_debug("Êï∞ÊçÆÂ∫ìËøûÊé•ÊàêÂäü");

    // --- 5. Êü•ÊâæÁî®Êà∑ ---
    $stmt_find = $pdo->prepare("SELECT id FROM users WHERE email = ? AND status = 'active'");
    $stmt_find->execute([$sender_email]);
    $user_id = $stmt_find->fetchColumn();

    if ($user_id) {
        log_mail_debug("ÊâæÂà∞Áî®Êà∑ ID: " . $user_id);

        // --- 6. Ëá™Âä®Ê∏ÖÁêÜÔºöÊ£ÄÊü•Âπ∂Âà†Èô§Ë∂ÖÂá∫10Â∞ÅÈôêÂà∂ÁöÑÈÇÆ‰ª∂ ---
        $stmt_count = $pdo->prepare("SELECT COUNT(*) FROM raw_emails WHERE user_id = ?");
        $stmt_count->execute([$user_id]);
        $email_count = $stmt_count->fetchColumn();

        if ($email_count >= 10) {
            log_mail_debug("Áî®Êà∑ÈÇÆ‰ª∂Êï∞Èáè: {$email_count}, ÂºÄÂßãËá™Âä®Ê∏ÖÁêÜ...");

            // ÊâæÂá∫ÊúÄÊó©ÁöÑÈÇÆ‰ª∂IDËøõË°åÂà†Èô§
            $stmt_oldest = $pdo->prepare("
                SELECT id FROM raw_emails
                WHERE user_id = ?
                ORDER BY received_at ASC
                LIMIT 1
            ");
            $stmt_oldest->execute([$user_id]);
            $oldest_email_id = $stmt_oldest->fetchColumn();

            if ($oldest_email_id) {
                // ÂÖàÂà†Èô§Áõ∏ÂÖ≥ÁöÑparsed_betsËÆ∞ÂΩïÔºàÂ§ñÈîÆÁ∫¶ÊùüÔºâ
                $stmt_delete_bets = $pdo->prepare("DELETE FROM parsed_bets WHERE email_id = ?");
                $stmt_delete_bets->execute([$oldest_email_id]);

                // ÂÜçÂà†Èô§ÈÇÆ‰ª∂ËÆ∞ÂΩï
                $stmt_delete_email = $pdo->prepare("DELETE FROM raw_emails WHERE id = ?");
                $stmt_delete_email->execute([$oldest_email_id]);

                log_mail_debug("Â∑≤Ëá™Âä®Âà†Èô§ÊúÄÊóßÈÇÆ‰ª∂ ID: " . $oldest_email_id);
            }
        }

        // --- Ê≠•È™§ A: Â≠òÂÖ•ÂéüÂßãÈÇÆ‰ª∂Ôºà‰∏çËá™Âä®Ëß£ÊûêÔºâ---
        $stmt_insert_raw = $pdo->prepare("INSERT INTO raw_emails (user_id, content, status) VALUES (?, ?, 'pending')");
        $stmt_insert_raw->execute([$user_id, $raw_content]);
        $email_id = $pdo->lastInsertId();
        log_mail_debug("ÈÇÆ‰ª∂Â≠òÂÖ• raw_emailsÔºåID: " . $email_id);

        // ‰∏çÂÜçËá™Âä®Ë∞ÉÁî®AIËß£ÊûêÔºåÁ≠âÂæÖÁî®Êà∑ÊâãÂä®Ëß£Êûê
        http_response_code(200);
        echo json_encode([
            'status' => 'success',
            'message' => 'ÈÇÆ‰ª∂Êé•Êî∂ÊàêÂäüÔºåËØ∑ÊâãÂä®Ëß£Êûê',
            'email_id' => $email_id
        ]);

    } else {
        log_mail_debug("Áî®Êà∑ '{$sender_email}' Êú™ÊâæÂà∞ÊàñÊú™ÊøÄÊ¥ª„ÄÇÂøΩÁï•ÈÇÆ‰ª∂");
        http_response_code(200);
        echo json_encode(['status' => 'success', 'message' => 'Áî®Êà∑Êú™Â§ÑÁêÜ']);
    }

} catch (Throwable $e) {
    log_mail_debug("--- ‰∏•ÈáçÈîôËØØ ---");
    log_mail_debug("ÈîôËØØ‰ø°ÊÅØ: " . $e->getMessage());
    log_mail_debug("Êñá‰ª∂: " . $e->getFile() . " Á¨¨ " . $e->getLine() . " Ë°å");
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'ÂÜÖÈÉ®ÊúçÂä°Âô®ÈîôËØØ']);
}

log_mail_debug("=== ÈÇÆ‰ª∂Êé•Êî∂Âô®ÂÆåÊàê ===\n");
?>
```
---
File: backend/helpers/mail_parser.php
```
<?php
// File: backend/helpers/mail_parser.php

if (!function_exists('parse_email_body')) {
    /**
     * ‰ªéÂéüÂßã MIME ÈÇÆ‰ª∂ÊñáÊú¨‰∏≠Ëß£ÊûêÂπ∂Ëß£Á†ÅÂá∫ÊúÄÂêàÈÄÇÁöÑÁî®Êà∑Ê≠£Êñá„ÄÇ
     * ‰ºòÂÖàÊèêÂèñ text/plain ÈÉ®ÂàÜ„ÄÇ
     *
     * @param string $raw_email ÂÆåÊï¥ÁöÑÂéüÂßãÈÇÆ‰ª∂ÂÜÖÂÆπ„ÄÇ
     * @return string Ê∏ÖÁêÜÂíåËß£Á†ÅÂêéÁöÑÊ≠£ÊñáÊñáÊú¨„ÄÇ
     */
    function parse_email_body(string $raw_email): string {
        // 1. ÂàÜÁ¶ªÈÇÆ‰ª∂Â§¥ÂíåÈÇÆ‰ª∂‰Ωì
        $parts = explode("\r\n\r\n", $raw_email, 2);
        if (count($parts) !== 2) {
            return $raw_email; // Ê†ºÂºè‰∏çËßÑËåÉÔºåËøîÂõûÂéüÊñá
        }
        list($headers_raw, $body_raw) = $parts;

        // 2. Ëß£ÊûêÈÇÆ‰ª∂Â§¥ÁöÑ Content-Type
        if (!preg_match('/Content-Type: (.*)/i', $headers_raw, $matches)) {
            return $body_raw; // Ê≤°Êúâ Content-TypeÔºåÁõ¥Êé•ËøîÂõûÈÇÆ‰ª∂‰Ωì
        }
        $content_type_header = $matches[1];

        // 3. Â¶ÇÊûú‰∏çÊòØ multipart ÈÇÆ‰ª∂ÔºåÁõ¥Êé•Ëß£Á†ÅÈÇÆ‰ª∂‰Ωì
        if (strpos(strtolower($content_type_header), 'multipart/') === false) {
            if (preg_match('/Content-Transfer-Encoding: (base64|quoted-printable)/i', $headers_raw, $encoding_match)) {
                return decode_body_part($body_raw, $encoding_match[1]);
            }
            return $body_raw;
        }

        // 4. Â¶ÇÊûúÊòØ multipart ÈÇÆ‰ª∂ÔºåËß£Êûê boundary
        if (!preg_match('/boundary="?([^"]+)"?/i', $content_type_header, $boundary_match)) {
            return $body_raw; // Êâæ‰∏çÂà∞ boundaryÔºåÊó†Ê≥ïËß£Êûê
        }
        $boundary = $boundary_match[1];

        // 5. Êåâ boundary ÂàÜÂâ≤ÈÇÆ‰ª∂‰Ωì
        $body_parts = explode('--' . $boundary, $body_raw);
        array_shift($body_parts); // ÁßªÈô§Á¨¨‰∏Ä‰∏™Á©∫ÈÉ®ÂàÜ
        array_pop($body_parts);   // ÁßªÈô§ÊúÄÂêé‰∏Ä‰∏™ '--' ÁªìÂ∞æÁöÑÈÉ®ÂàÜ

        $plain_text_body = '';
        $html_body = '';

        // 6. ÈÅçÂéÜÊØè‰∏™ÈÉ®ÂàÜÔºåÂØªÊâæ text/plain Âíå text/html
        foreach ($body_parts as $part) {
            if (empty(trim($part))) continue;

            $part_parts = explode("\r\n\r\n", $part, 2);
            if (count($part_parts) !== 2) continue;
            list($part_header_raw, $part_body_raw) = $part_parts;

            // Ê£ÄÊü•ÂΩìÂâçÈÉ®ÂàÜÁöÑ Content-Type
            if (preg_match('/Content-Type: text\/plain/i', $part_header_raw)) {
                if (preg_match('/Content-Transfer-Encoding: (base64|quoted-printable)/i', $part_header_raw, $encoding_match)) {
                    $plain_text_body = decode_body_part($part_body_raw, $encoding_match[1]);
                } else {
                    $plain_text_body = $part_body_raw;
                }
            } elseif (preg_match('/Content-Type: text\/html/i', $part_header_raw)) {
                if (preg_match('/Content-Transfer-Encoding: (base64|quoted-printable)/i', $part_header_raw, $encoding_match)) {
                    // Ëß£Á†ÅHTMLÂπ∂ÂéªÈô§ÊâÄÊúâHTMLÊ†áÁ≠æÔºåÂæóÂà∞Á∫ØÊñáÊú¨
                    $html_body = strip_tags(decode_body_part($part_body_raw, $encoding_match[1]));
                } else {
                    $html_body = strip_tags($part_body_raw);
                }
            }
        }

        // 7. ‰ºòÂÖàËøîÂõûÁ∫ØÊñáÊú¨Ê≠£ÊñáÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®ÂàôËøîÂõû‰ªéHTML‰∏≠ÊèêÂèñÁöÑÊñáÊú¨
        return trim($plain_text_body) ?: trim($html_body) ?: 'Êó†Ê≥ïËß£ÊûêÈÇÆ‰ª∂Ê≠£Êñá';
    }
}

if (!function_exists('decode_body_part')) {
    /**
     * Ëß£Á†Å base64 Êàñ quoted-printable ÁºñÁ†ÅÁöÑÈÇÆ‰ª∂‰ΩìÈÉ®ÂàÜ„ÄÇ
     * @param string $body
     * @param string $encoding
     * @return string
     */
    function decode_body_part(string $body, string $encoding): string {
        $encoding = strtolower(trim($encoding));
        if ($encoding === 'base64') {
            return base64_decode($body);
        } elseif ($encoding === 'quoted-printable') {
            return quoted_printable_decode($body);
        }
        return $body; // Â¶ÇÊûúÁºñÁ†Å‰∏çËÆ§ËØÜÔºåËøîÂõûÂéüÊñá
    }
}
?>```
---
File: backend/helpers/manual_parser.php
```
<?php
// File: backend/helpers/manual_parser.php (‰ºòÂåñËÅöÂêàÊòæÁ§∫)

/**
 * ÊâãÂä®Ëß£Êûê‰∏ãÊ≥®‰ø°ÊÅØ - ËÅöÂêàÁõ∏ÂêåÈáëÈ¢ùÁöÑ‰∏ãÊ≥®
 */
function parseBetManually(string $text): array {
    $bets = [];
    $totalAmount = 0;

    // Ê∏ÖÁêÜÊñáÊú¨
    $text = preg_replace('/\s+/', ' ', $text);
    $text = trim($text);

    // 1. Ëß£ÊûêÊ∑∑Âêà‰∏ãÊ≥®Ê†ºÂºè: "Êæ≥Èó®„ÄÅ40√ó10ÂÖÉ„ÄÅ39„ÄÅ30„ÄÅÂêÑ5ÂÖÉ„ÄÅÈ¶ôÊ∏Ø„ÄÅ40√ó10ÂÖÉ„ÄÅ02„ÄÅ04„ÄÅ09„ÄÅ45„ÄÅÂêÑ5ÂÖÉ"
    if (preg_match('/Êæ≥Èó®[Ôºå,].*È¶ôÊ∏Ø[Ôºå,]/u', $text)) {
        // Ëß£ÊûêÊæ≥Èó®ÈÉ®ÂàÜ
        if (preg_match('/Êæ≥Èó®[Ôºå,]\s*([^È¶ôÊ∏Ø]+)È¶ôÊ∏Ø/u', $text, $matches)) {
            $macau_part = $matches[1];
            parseMixedBetPart($macau_part, 'Êæ≥Èó®ÂÖ≠ÂêàÂΩ©', $bets, $totalAmount);
        }

        // Ëß£ÊûêÈ¶ôÊ∏ØÈÉ®ÂàÜ
        if (preg_match('/È¶ôÊ∏Ø[Ôºå,]\s*(.+)$/u', $text, $matches)) {
            $hk_part = $matches[1];
            parseMixedBetPart($hk_part, 'È¶ôÊ∏ØÂÖ≠ÂêàÂΩ©', $bets, $totalAmount);
        }
    }
    // 2. Ëß£ÊûêÁ∫ØÊæ≥Èó®‰∏ãÊ≥® - ‰ºòÂåñÁÇπÂè∑ÂàÜÈöîÊ†ºÂºè
    else if (preg_match('/Êæ≥Èó®[Ôºå,:]\s*([\d.]+)ÂêÑ(\d+)(Âùó|ÂÖÉ)/u', $text, $matches)) {
        $numbers_text = $matches[1];
        $amount = intval($matches[2]);

        $numbers = explode('.', $numbers_text);
        $numbers = array_filter($numbers, function($num) {
            return !empty(trim($num));
        });

        if (!empty($numbers)) {
            $bets[] = [
                'bet_type' => 'ÁâπÁ†Å',
                'targets' => $numbers,
                'amount' => $amount,
                'total_bet' => $amount * count($numbers),
                'raw_text' => "Êæ≥Èó®Âè∑Á†Å" . implode('.', $numbers) . "ÂêÑ{$amount}Âùó",
                'lottery_type' => 'Êæ≥Èó®ÂÖ≠ÂêàÂΩ©'
            ];
            $totalAmount += $amount * count($numbers);
        }
    }
    // 3. Ëß£ÊûêÁ∫ØÈ¶ôÊ∏Ø‰∏ãÊ≥® - ‰ºòÂåñÁÇπÂè∑ÂàÜÈöîÊ†ºÂºè
    else if (preg_match('/È¶ôÊ∏Ø[Ôºå,:]\s*([\d.]+)ÂêÑ(\d+)(Âùó|ÂÖÉ)/u', $text, $matches)) {
        $numbers_text = $matches[1];
        $amount = intval($matches[2]);

        $numbers = explode('.', $numbers_text);
        $numbers = array_filter($numbers, function($num) {
            return !empty(trim($num));
        });

        if (!empty($numbers)) {
            $bets[] = [
                'bet_type' => 'ÁâπÁ†Å',
                'targets' => $numbers,
                'amount' => $amount,
                'total_bet' => $amount * count($numbers),
                'raw_text' => "È¶ôÊ∏ØÂè∑Á†Å" . implode('.', $numbers) . "ÂêÑ{$amount}Âùó",
                'lottery_type' => 'È¶ôÊ∏ØÂÖ≠ÂêàÂΩ©'
            ];
            $totalAmount += $amount * count($numbers);
        }
    }
    // 4. Ëß£ÊûêÂÖ≠ËÇñ‰∏ãÊ≥®
    else if (preg_match('/([Èº†ÁâõËôéÂÖîÈæôËõáÈ©¨ÁæäÁå¥È∏°ÁãóÁå™]{2,})ËÇñ\s*(\d+)\s*Èó∑/u', $text, $matches)) {
        $zodiacs = preg_split('//u', $matches[1], -1, PREG_SPLIT_NO_EMPTY);
        $amount = intval($matches[2]);

        if (count($zodiacs) >= 2) {
            $bets[] = [
                'bet_type' => 'ÂÖ≠ËÇñ',
                'targets' => $zodiacs,
                'amount' => $amount,
                'total_bet' => $amount, // ÂÖ≠ËÇñÂè™ÁÆó‰∏ÄÊ¨°‰∏ãÊ≥®
                'raw_text' => implode('', $zodiacs) . "ËÇñ{$amount}Èó∑",
                'lottery_type' => 'Ê∑∑Âêà'
            ];
            $totalAmount += $amount;
        }
    }
    // 5. Ëß£ÊûêÂÖ∂‰ªñÊ†ºÂºè...

    return [
        'lottery_type' => count($bets) > 0 ? 'Ê∑∑Âêà' : 'Êú™Áü•',
        'issue_number' => '',
        'bets' => $bets,
        'total_amount' => $totalAmount
    ];
}
```
---
File: backend/auth/logout.php
```
<?php
// File: backend/auth/logout.php

// api_header.php Â∑≤ÁªèÂêØÂä®‰∫Ü session, ÊâÄ‰ª•Êàë‰ª¨ÂèØ‰ª•Áõ¥Êé•Êìç‰ΩúÂÆÉ

// 1. Ê∏ÖÁ©∫ÊâÄÊúâ session ÂèòÈáè
$_SESSION = [];

// 2. Âà†Èô§ session cookie
// ËøôÊòØÁ°Æ‰øùÊµèËßàÂô®Âà†Èô§‰ºöËØùÊ†áËØÜÁöÑÂÖ≥ÈîÆÊ≠•È™§
if (ini_get("session.use_cookies")) {
    $params = session_get_cookie_params();
    setcookie(session_name(), '', time() - 42000,
        $params["path"], $params["domain"],
        $params["secure"], $params["httponly"]
    );
}

// 3. ÈîÄÊØÅÊúçÂä°Âô®‰∏äÁöÑ session Êï∞ÊçÆ
session_destroy();

// 4. ËøîÂõûÊàêÂäüÂìçÂ∫î
http_response_code(200);
echo json_encode(['status' => 'success', 'message' => 'ÁôªÂá∫ÊàêÂäüÔºÅ']);
?>```
---
File: backend/auth/reanalyze_email.php
```
<?php
// File: backend/auth/reanalyze_email.php

// Ê†∏ÂøÉ‰æùËµñÁî± index.php Âä†ËΩΩ

// 1. Ë∫´‰ªΩÈ™åËØÅÊ£ÄÊü•
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

// 2. Ëé∑ÂèñËæìÂÖ•ÂèÇÊï∞
$input = json_decode(file_get_contents('php://input'), true);
$email_id = $input['email_id'] ?? null;

if (empty($email_id)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email ID is required.']);
    exit;
}

// 3. È™åËØÅÈÇÆ‰ª∂Â±û‰∫éÂΩìÂâçÁî®Êà∑
try {
    $pdo = get_db_connection();

    $stmt = $pdo->prepare("SELECT id FROM raw_emails WHERE id = ? AND user_id = ?");
    $stmt->execute([$email_id, $_SESSION['user_id']]);

    if (!$stmt->fetch()) {
        http_response_code(403);
        echo json_encode(['status' => 'error', 'message' => 'Access denied.']);
        exit;
    }

} catch (PDOException $e) {
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Database error.']);
    exit;
}

// 4. ÊâßË°åÈáçÊñ∞Ëß£Êûê
require_once __DIR__ . '/../ai_helper.php';
$result = reanalyzeEmailWithAI($email_id);

if ($result['success']) {
    http_response_code(200);
    echo json_encode([
        'status' => 'success',
        'message' => $result['message'],
        'batch_id' => $result['batch_id'] ?? null
    ]);
} else {
    http_response_code(500);
    echo json_encode([
        'status' => 'error',
        'message' => $result['message']
    ]);
}
?>```
---
File: backend/auth/get_email_content.php
```
<?php
// File: backend/auth/get_email_content.php (with Server-Side Parsing)

// Ê†∏ÂøÉ‰æùËµñÁî± index.php Âä†ËΩΩ

// „ÄêÊñ∞Â¢û„ÄëÂä†ËΩΩÈÇÆ‰ª∂Ëß£ÊûêÂô®Â∏ÆÂä©Êñá‰ª∂
// Á°Æ‰øùËøô‰∏™Ë∑ØÂæÑÊòØÊ≠£Á°ÆÁöÑ„ÄÇÂ¶ÇÊûú‰Ω†ÁöÑ helpers ÁõÆÂΩïÂú® backend/ Ê†πÁõÆÂΩï‰∏ã„ÄÇ
require_once __DIR__ . '/../helpers/mail_parser.php';

// 1. Ë∫´‰ªΩÈ™åËØÅÊ£ÄÊü•
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

$user_id = $_SESSION['user_id'];
$email_id = $_GET['id'] ?? null;

if (empty($email_id)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email ID is required.']);
    exit;
}

try {
    $pdo = get_db_connection();

    // 2. Êü•ËØ¢ÁâπÂÆöÈÇÆ‰ª∂ÁöÑÂéüÂßãÂÜÖÂÆπ
    $stmt = $pdo->prepare(
        "SELECT id, content
         FROM raw_emails
         WHERE id = ? AND user_id = ?"
    );

    $stmt->bindParam(1, $email_id, PDO::PARAM_INT);
    $stmt->bindParam(2, $user_id, PDO::PARAM_INT);
    $stmt->execute();

    $email = $stmt->fetch(PDO::FETCH_ASSOC);

    if ($email) {
        // --- „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ËøôÈáåËøõË°åÈÇÆ‰ª∂Ëß£Êûê ---
        $raw_content = $email['content'];
        $clean_body = parse_email_body($raw_content);

        // ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÊï∞ÁªÑÔºåÂè™ÂåÖÂê´Êàë‰ª¨ÊÉ≥ËøîÂõûÁªôÂâçÁ´ØÁöÑÊï∞ÊçÆ
        $response_data = [
            'id' => $email['id'],
            'content' => $clean_body // ËøîÂõûËß£ÊûêÂêéÁöÑÂπ≤ÂáÄÊ≠£Êñá
        ];

        // 3. ËøîÂõûÂåÖÂê´Âπ≤ÂáÄÊ≠£ÊñáÁöÑÊàêÂäüÂìçÂ∫î
        http_response_code(200);
        echo json_encode(['status' => 'success', 'data' => $response_data]);

    } else {
        http_response_code(404);
        echo json_encode(['status' => 'error', 'message' => 'Email not found or access denied.']);
    }

} catch (PDOException $e) {
    error_log("Error fetching email content for user {$user_id}, email {$email_id}: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Database error.']);
} catch (Throwable $e) {
    // ÊçïËé∑ÂèØËÉΩÂú® parse_email_body ‰∏≠ÂèëÁîüÁöÑÈîôËØØ
    error_log("Error parsing email content for email {$email_id}: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Failed to parse email content on server.']);
}
?>```
---
File: backend/auth/check_session.php
```
<?php
// File: backend/auth/check_session.php

// api_header.php Â∑≤ÁªèÂêØÂä®‰∫Ü session

// Ê£ÄÊü• session ‰∏≠ÊòØÂê¶Â≠òÂú® user_id
if (isset($_SESSION['user_id']) && !empty($_SESSION['user_id'])) {
    // Áî®Êà∑Â∑≤ÁôªÂΩïÔºåËøîÂõûÁî®Êà∑‰ø°ÊÅØ
    http_response_code(200);
    echo json_encode([
        'status' => 'success',
        'isAuthenticated' => true,
        'user' => [
            'id' => $_SESSION['user_id'],
            'email' => $_SESSION['user_email'] ?? 'N/A' // Êèê‰æõ‰∏Ä‰∏™ÈªòËÆ§ÂÄº‰ª•Èò≤‰∏á‰∏Ä
        ]
    ]);
} else {
    // Áî®Êà∑Êú™ÁôªÂΩï
    http_response_code(200); // Âç≥‰ΩøÊú™ÁôªÂΩïÔºåËØ∑Ê±ÇÊú¨Ë∫´‰πüÊòØÊàêÂäüÁöÑ
    echo json_encode([
        'status' => 'success',
        'isAuthenticated' => false,
        'user' => null
    ]);
}
?>```
---
File: backend/auth/smart_parse_email.php
```
<?php
// File: backend/auth/smart_parse_email.php

// 1. Ë∫´‰ªΩÈ™åËØÅ
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

// 2. Ëé∑ÂèñËæìÂÖ•ÂèÇÊï∞
$input = json_decode(file_get_contents('php://input'), true);
$email_id = $input['email_id'] ?? null;
$lottery_types = $input['lottery_types'] ?? [];

if (empty($email_id) || empty($lottery_types)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email ID and lottery types are required.']);
    exit;
}

// 3. È™åËØÅÈÇÆ‰ª∂Â±û‰∫éÂΩìÂâçÁî®Êà∑
try {
    $pdo = get_db_connection();
    $user_id = $_SESSION['user_id'];

    $stmt = $pdo->prepare("SELECT id, content FROM raw_emails WHERE id = ? AND user_id = ?");
    $stmt->execute([$email_id, $user_id]);
    $email = $stmt->fetch(PDO::FETCH_ASSOC);

    if (!$email) {
        http_response_code(403);
        echo json_encode(['status' => 'error', 'message' => 'Access denied.']);
        exit;
    }

    // 4. Ëé∑ÂèñÁî®Êà∑ËµîÁéáÊ®°Êùø
    $stmt_odds = $pdo->prepare("SELECT * FROM user_odds_templates WHERE user_id = ?");
    $stmt_odds->execute([$user_id]);
    $userOddsTemplate = $stmt_odds->fetch(PDO::FETCH_ASSOC);

    if (!$userOddsTemplate || empty(array_filter($userOddsTemplate, function($value) {
        return $value !== null;
    }))) {
        http_response_code(400);
        echo json_encode(['status' => 'error', 'message' => 'ËØ∑ÂÖàËÆæÁΩÆËµîÁéáÊ®°Êùø']);
        exit;
    }

    // 5. Ëé∑ÂèñÈÄâÊã©ÁöÑÂΩ©Á•®Á±ªÂûãÁöÑÂºÄÂ•ñÁªìÊûú
    require_once __DIR__ . '/../helpers/mail_parser.php';
    $clean_content = parse_email_body($email['content']);

    // Ëé∑ÂèñÊúÄÊñ∞ÂºÄÂ•ñÁªìÊûú
    $placeholders = implode(',', array_fill(0, count($lottery_types), '?'));
    $sql_latest_results = "
        SELECT r1.*
        FROM lottery_results r1
        JOIN (
            SELECT lottery_type, MAX(id) AS max_id
            FROM lottery_results
            GROUP BY lottery_type
        ) r2 ON r1.lottery_type = r2.lottery_type AND r1.id = r2.max_id
        WHERE r1.lottery_type IN ($placeholders)
    ";
    $stmt_latest = $pdo->prepare($sql_latest_results);
    $stmt_latest->execute($lottery_types);
    $latest_results_raw = $stmt_latest->fetchAll(PDO::FETCH_ASSOC);

    $latest_results = [];
    foreach ($latest_results_raw as $row) {
        foreach(['winning_numbers', 'zodiac_signs', 'colors'] as $key) {
            $decoded = json_decode($row[$key], true);
            $row[$key] = $decoded ?: [];
        }
        $latest_results[$row['lottery_type']] = $row;
    }

    // 6. ÂÖàÂ∞ùËØïÊ®°ÊùøËß£Êûê
    require_once __DIR__ . '/../helpers/manual_parser.php';
    $manual_data = parseBetManually($clean_content);
    $parse_method = 'template';

    // 7. Â¶ÇÊûúÊ®°ÊùøËß£ÊûêÊ≤°ÊúâÁªìÊûúÔºå‰ΩøÁî®AIËß£Êûê
    if (empty($manual_data['bets'])) {
        require_once __DIR__ . '/../ai_helper.php';
        $ai_result = analyzeBetSlipWithAI($email['content']);
        $parse_method = 'ai';

        if ($ai_result['success'] && isset($ai_result['data'])) {
            $manual_data = $ai_result['data'];
            // Ê∑ªÂä†ÂéüÂßãÊñáÊú¨Âà∞AIËß£ÊûêÁªìÊûú‰∏≠
            if (isset($manual_data['bets'])) {
                foreach ($manual_data['bets'] as &$bet) {
                    $bet['raw_text'] = $bet['raw_text'] ?? 'AIËß£Êûê';
                }
            }
        }
    }

    // 8. ËÆ°ÁÆóÁªìÁÆóÁªìÊûú
    require_once __DIR__ . '/get_email_details.php'; // ‰∏∫‰∫Ü‰ΩøÁî®ÁªìÁÆóÂáΩÊï∞
    $settlement_data = calculateManualSettlement($manual_data, $latest_results, $userOddsTemplate);

    // 9. Âà†Èô§ÊóßÁöÑËß£ÊûêËÆ∞ÂΩïÂπ∂‰øùÂ≠òÊñ∞ÁöÑ
    $stmt_delete = $pdo->prepare("DELETE FROM parsed_bets WHERE email_id = ?");
    $stmt_delete->execute([$email_id]);

    $model_used = $parse_method === 'ai' ? 'cloudflare_ai' : 'manual_template';
    $bet_data_json = json_encode($manual_data);

    $stmt_insert = $pdo->prepare("INSERT INTO parsed_bets (email_id, bet_data_json, ai_model_used) VALUES (?, ?, ?)");
    $stmt_insert->execute([$email_id, $bet_data_json, $model_used]);

    // 10. Êõ¥Êñ∞ÈÇÆ‰ª∂Áä∂ÊÄÅ
    $stmt_update = $pdo->prepare("UPDATE raw_emails SET status = 'processed' WHERE id = ?");
    $stmt_update->execute([$email_id]);

    // 11. ËøîÂõûÁªìÊûú
    http_response_code(200);
    echo json_encode([
        'status' => 'success',
        'message' => 'Ëß£ÊûêÂÆåÊàê',
        'parse_method' => $parse_method,
        'batch_id' => $pdo->lastInsertId(),
        'settlement' => $settlement_data,
        'bet_data' => $manual_data
    ]);

} catch (Throwable $e) {
    error_log("Error in smart_parse_email for email {$email_id}: " . $e->getMessage());
    error_log("Stack trace: " . $e->getTraceAsString());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Ëß£ÊûêÂ§±Ë¥•: ' . $e->getMessage()]);
}
?>```
---
File: backend/auth/odds_template.php
```
<?php
// File: backend/auth/odds_template.php (‰øÆÂ§çÁâà)
require_once __DIR__ . '/../db_operations.php';

// 1. Ë∫´‰ªΩÈ™åËØÅ
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

$user_id = $_SESSION['user_id'];

try {
    $pdo = get_db_connection();

    if ($_SERVER['REQUEST_METHOD'] === 'GET') {
        // Ëé∑ÂèñÁî®Êà∑ËµîÁéáÊ®°Êùø
        $stmt = $pdo->prepare("SELECT * FROM user_odds_templates WHERE user_id = ?");
        $stmt->execute([$user_id]);
        $template = $stmt->fetch(PDO::FETCH_ASSOC);

        if (!$template) {
            // Â¶ÇÊûúÊ≤°ÊúâÊ®°ÊùøÔºåËøîÂõûÁ©∫Ê®°ÊùøÁªìÊûÑ
            $template = [
                'special_code_odds' => null,
                'flat_special_odds' => null,
                'serial_code_odds' => null,
                'even_xiao_odds' => null,
                'six_xiao_odds' => null,
                'size_single_double_odds' => null
            ];
        }

        http_response_code(200);
        echo json_encode([
            'status' => 'success',
            'data' => $template
        ]);

    } elseif ($_SERVER['REQUEST_METHOD'] === 'POST') {
        // Êõ¥Êñ∞Áî®Êà∑ËµîÁéáÊ®°Êùø
        $input = json_decode(file_get_contents('php://input'), true);

        // È™åËØÅËæìÂÖ•Êï∞ÊçÆ
        if (!$input) {
            http_response_code(400);
            echo json_encode(['status' => 'error', 'message' => 'Invalid JSON data']);
            exit;
        }

        // ÂÆâÂÖ®Âú∞Ëé∑ÂèñÂíåËΩ¨Êç¢Êï∞ÂÄº
        $special_code_odds = isset($input['special_code_odds']) && $input['special_code_odds'] !== '' ? floatval($input['special_code_odds']) : null;
        $flat_special_odds = isset($input['flat_special_odds']) && $input['flat_special_odds'] !== '' ? floatval($input['flat_special_odds']) : null;
        $serial_code_odds = isset($input['serial_code_odds']) && $input['serial_code_odds'] !== '' ? floatval($input['serial_code_odds']) : null;
        $even_xiao_odds = isset($input['even_xiao_odds']) && $input['even_xiao_odds'] !== '' ? floatval($input['even_xiao_odds']) : null;
        $six_xiao_odds = isset($input['six_xiao_odds']) && $input['six_xiao_odds'] !== '' ? floatval($input['six_xiao_odds']) : null;
        $size_single_double_odds = isset($input['size_single_double_odds']) && $input['size_single_double_odds'] !== '' ? floatval($input['size_single_double_odds']) : null;

        // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Ê®°Êùø
        $stmt_check = $pdo->prepare("SELECT id FROM user_odds_templates WHERE user_id = ?");
        $stmt_check->execute([$user_id]);
        $existing_template = $stmt_check->fetch();

        if ($existing_template) {
            // Êõ¥Êñ∞Áé∞ÊúâÊ®°Êùø
            $stmt = $pdo->prepare("
                UPDATE user_odds_templates
                SET special_code_odds = ?, flat_special_odds = ?, serial_code_odds = ?,
                    even_xiao_odds = ?, six_xiao_odds = ?, size_single_double_odds = ?,
                    updated_at = CURRENT_TIMESTAMP
                WHERE user_id = ?
            ");
            $result = $stmt->execute([
                $special_code_odds, $flat_special_odds, $serial_code_odds,
                $even_xiao_odds, $six_xiao_odds, $size_single_double_odds,
                $user_id
            ]);
        } else {
            // ÊèíÂÖ•Êñ∞Ê®°Êùø
            $stmt = $pdo->prepare("
                INSERT INTO user_odds_templates
                (user_id, special_code_odds, flat_special_odds, serial_code_odds,
                 even_xiao_odds, six_xiao_odds, size_single_double_odds)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            ");
            $result = $stmt->execute([
                $user_id, $special_code_odds, $flat_special_odds, $serial_code_odds,
                $even_xiao_odds, $six_xiao_odds, $size_single_double_odds
            ]);
        }

        if ($result) {
            http_response_code(200);
            echo json_encode([
                'status' => 'success',
                'message' => 'ËµîÁéáÊ®°Êùø‰øùÂ≠òÊàêÂäü'
            ]);
        } else {
            throw new Exception('Failed to save template');
        }
    }

} catch (PDOException $e) {
    error_log("Database error in odds_template: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Êï∞ÊçÆÂ∫ìÈîôËØØ: ' . $e->getMessage()]);
} catch (Exception $e) {
    error_log("General error in odds_template: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'ÊúçÂä°Âô®ÈîôËØØ: ' . $e->getMessage()]);
} catch (Throwable $e) {
    error_log("Unexpected error in odds_template: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Êú™Áü•ÈîôËØØ: ' . $e->getMessage()]);
}
?>```
---
File: backend/auth/login.php
```
<?php
// File: backend/auth/login.php

require_once __DIR__ . '/../db_operations.php';

// 1. Ëé∑Âèñ POST ËØ∑Ê±ÇÁöÑ JSON Êï∞ÊçÆ
$data = json_decode(file_get_contents('php://input'), true);
$email = $data['email'] ?? null;
$password = $data['password'] ?? null;

// 2. Âü∫Êú¨È™åËØÅ
if (empty($email) || empty($password)) {
    http_response_code(400); // Bad Request
    echo json_encode(['status' => 'error', 'message' => 'ÈÇÆÁÆ±ÂíåÂØÜÁ†Å‰∏çËÉΩ‰∏∫Á©∫„ÄÇ']);
    exit;
}

try {
    // 3. ‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Êü•ÊâæÁî®Êà∑
    $pdo = get_db_connection();
    $stmt = $pdo->prepare("SELECT id, email, password_hash, status FROM users WHERE email = ?");
    $stmt->execute([$email]);
    $user = $stmt->fetch(PDO::FETCH_ASSOC);

    // 4. È™åËØÅÁî®Êà∑ÊòØÂê¶Â≠òÂú®„ÄÅÂØÜÁ†ÅÊòØÂê¶Ê≠£Á°Æ‰ª•ÂèäË¥¶Êà∑Áä∂ÊÄÅ
    if ($user && password_verify($password, $user['password_hash'])) {

        // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Ë¢´Â∞ÅÁ¶Å
        if ($user['status'] === 'banned') {
            http_response_code(403); // Forbidden
            echo json_encode(['status' => 'error', 'message' => 'ÊÇ®ÁöÑË¥¶Êà∑Â∑≤Ë¢´Â∞ÅÁ¶Å„ÄÇ']);
            exit;
        }

        // 5. ÂØÜÁ†ÅÊ≠£Á°ÆÔºåÂàõÂª∫ Session
        // api_header.php Â∑≤ÁªèË∞ÉÁî®‰∫Ü session_start()
        session_regenerate_id(true); // Èò≤Ê≠¢‰ºöËØùÂõ∫ÂÆöÊîªÂáª
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['user_email'] = $user['email'];

        // 6. ËøîÂõûÊàêÂäüÂìçÂ∫îÂíåÁî®Êà∑‰ø°ÊÅØ
        http_response_code(200);
        echo json_encode([
            'status' => 'success',
            'message' => 'ÁôªÂΩïÊàêÂäüÔºÅ',
            'user' => [
                'id' => $user['id'],
                'email' => $user['email']
            ]
        ]);

    } else {
        // Áî®Êà∑‰∏çÂ≠òÂú®ÊàñÂØÜÁ†ÅÈîôËØØ
        http_response_code(401); // Unauthorized
        echo json_encode(['status' => 'error', 'message' => 'ÈÇÆÁÆ±ÊàñÂØÜÁ†ÅÈîôËØØ„ÄÇ']);
    }

} catch (PDOException $e) {
    // Êï∞ÊçÆÂ∫ìÈîôËØØ
    error_log("Login Error: " . $e->getMessage()); // ËÆ∞ÂΩïÈîôËØØÊó•Âøó
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'ÊúçÂä°Âô®ÂÜÖÈÉ®ÈîôËØØÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ']);
}
?>```
---
File: backend/auth/download_settlement.php
```
<?php
// File: backend/auth/download_settlement.php

// 1. Ë∫´‰ªΩÈ™åËØÅ
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

$user_id = $_SESSION['user_id'];
$email_id = $_GET['id'] ?? null;

if (empty($email_id)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email ID is required.']);
    exit;
}

try {
    $pdo = get_db_connection();

    // È™åËØÅÈÇÆ‰ª∂Â±û‰∫éÂΩìÂâçÁî®Êà∑
    $stmt_email = $pdo->prepare("SELECT content FROM raw_emails WHERE id = ? AND user_id = ?");
    $stmt_email->execute([$email_id, $user_id]);
    $raw_content = $stmt_email->fetchColumn();

    if ($raw_content === false) {
        http_response_code(404);
        echo json_encode(['status' => 'error', 'message' => 'Email not found or access denied.']);
        exit;
    }

    // Ëé∑ÂèñÂ¢ûÂº∫ÂêéÁöÑÂÜÖÂÆπÔºàÂåÖÂê´ÁªìÁÆó‰ø°ÊÅØÔºâ
    require_once __DIR__ . '/../helpers/mail_parser.php';
    $clean_content = parse_email_body($raw_content);

    // Ëé∑ÂèñÊâÄÊúâÂÖ≥ËÅîÁöÑ‰∏ãÊ≥®ÊâπÊ¨°ÂíåÁªìÁÆó‰ø°ÊÅØ
    $stmt_bets = $pdo->prepare("
        SELECT pb.id, pb.bet_data_json, pb.ai_model_used
        FROM parsed_bets pb
        WHERE pb.email_id = ?
        ORDER BY pb.id ASC
    ");
    $stmt_bets->execute([$email_id]);
    $bet_batches_raw = $stmt_bets->fetchAll(PDO::FETCH_ASSOC);

    $enhanced_content = $clean_content;

    // Â¶ÇÊûúÊ≤°ÊúâÊâπÊ¨°Ôºå‰ΩøÁî®ÊâãÂä®Ëß£Êûê
    if (empty($bet_batches_raw)) {
        require_once __DIR__ . '/../helpers/manual_parser.php';
        $manual_data = parseBetManually($clean_content);
        if (!empty($manual_data['bets'])) {
            $enhanced_content = enhanceEmailContent($clean_content, $manual_data);
        }
    } else {
        // Â§ÑÁêÜÊØè‰∏™ÊâπÊ¨°ÔºåÂ∞ÜÁªìÁÆó‰ø°ÊÅØÂµåÂÖ•ÂÜÖÂÆπ
        foreach ($bet_batches_raw as $batch) {
            $batch_data = json_decode($batch['bet_data_json'], true);

            // ‰∏∫ÊØè‰∏™ÊâπÊ¨°Ê∑ªÂä†ÁªìÁÆó‰ø°ÊÅØÂà∞ÂÜÖÂÆπ‰∏≠
            $settlement_info = "\n\n" . str_repeat("=", 50) . "\n";
            $settlement_info .= "üéØ ÁªìÁÆóÁªìÊûú (ÊâπÊ¨° {$batch['id']})\n";
            $settlement_info .= str_repeat("=", 50) . "\n";

            $total_bet = 0;
            if (isset($batch_data['bets']) && is_array($batch_data['bets'])) {
                foreach ($batch_data['bets'] as $bet) {
                    $amount = floatval($bet['amount'] ?? 0);
                    $targets = $bet['targets'] ?? [];
                    if ($amount > 0 && is_array($targets)) {
                        $total_bet += $amount * count($targets);
                    }
                }
            }

            $settlement_info .= "üí∞ ÊÄªÊäïÊ≥®ÈáëÈ¢ù: {$total_bet} ÂÖÉ\n";
            $settlement_info .= "üìä AIÊ®°Âûã: {$batch['ai_model_used']}\n";
            $settlement_info .= str_repeat("=", 50) . "\n";

            $enhanced_content .= $settlement_info;
        }
    }

    // ÁîüÊàêÊñá‰ª∂ÂêçÔºàÊó•ÊúüÊó∂Èó¥Ê†ºÂºèÔºâ
    $filename = date('Ymd_His') . '_settlement.txt';

    // ËÆæÁΩÆÂìçÂ∫îÂ§¥ÔºåÁõ¥Êé•ËæìÂá∫TXTÊñá‰ª∂
    header('Content-Type: text/plain');
    header('Content-Disposition: attachment; filename="' . $filename . '"');
    header('Content-Length: ' . strlen($enhanced_content));

    echo $enhanced_content;
    exit;

} catch (Throwable $e) {
    error_log("Error generating settlement file for email_id {$email_id}: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Internal Server Error: ' . $e->getMessage()]);
}
?>
```
---
File: backend/auth/register.php
```
<?php // backend/auth/register.php
require_once __DIR__ . '/../db_operations.php';

$data = json_decode(file_get_contents('php://input'), true);
$email = $data['email'] ?? null;
$password = $data['password'] ?? null;

if (!$email || !$password) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email and password are required.']);
    exit;
}

try {
    $pdo = get_db_connection();
    $stmt = $pdo->prepare("SELECT id FROM users WHERE email = ?");
    $stmt->execute([$email]);
    if ($stmt->fetch()) {
        http_response_code(409);
        echo json_encode(['status' => 'error', 'message' => 'Email already registered.']);
        exit;
    }

    $hash = password_hash($password, PASSWORD_DEFAULT);
    $stmt = $pdo->prepare("INSERT INTO users (email, password_hash) VALUES (?, ?)");
    $stmt->execute([$email, $hash]);

    echo json_encode(['status' => 'success', 'message' => 'Registration successful.']);
} catch (PDOException $e) {
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Database error.']);
}```
---
File: backend/auth/split_email_lines.php
```
<?php
// File: backend/auth/split_email_lines.php (‰ºòÂåñÁâà)

if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

$email_id = $_GET['id'] ?? null;

if (empty($email_id)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email ID is required.']);
    exit;
}

try {
    $pdo = get_db_connection();
    $user_id = $_SESSION['user_id'];

    // Ëé∑ÂèñÈÇÆ‰ª∂ÂÜÖÂÆπ
    $stmt = $pdo->prepare("SELECT content FROM raw_emails WHERE id = ? AND user_id = ?");
    $stmt->execute([$email_id, $user_id]);
    $raw_content = $stmt->fetchColumn();

    if ($raw_content === false) {
        http_response_code(404);
        echo json_encode(['status' => 'error', 'message' => 'Email not found.']);
        exit;
    }

    require_once __DIR__ . '/../helpers/mail_parser.php';
    $clean_content = parse_email_body($raw_content);

    // Êô∫ËÉΩÊãÜÂàÜ‰∏ãÊ≥®Âçï - ‰ΩøÁî®‰ºòÂåñÁÆóÊ≥ï
    $bet_lines = splitBetLinesIntelligently($clean_content);

    // Ëé∑ÂèñÂ∑≤Ëß£ÊûêÁöÑÊâπÊ¨°
    $stmt_bets = $pdo->prepare("
        SELECT id, bet_data_json, line_number
        FROM parsed_bets
        WHERE email_id = ?
        ORDER BY line_number ASC
    ");
    $stmt_bets->execute([$email_id]);
    $existing_batches = $stmt_bets->fetchAll(PDO::FETCH_ASSOC);

    // ÁªÑÁªáÂìçÂ∫îÊï∞ÊçÆ
    $lines_data = [];
    foreach ($bet_lines as $index => $line) {
        $line_number = $index + 1;
        $existing_batch = null;

        // Êü•ÊâæÊòØÂê¶Â∑≤Ëß£Êûê
        foreach ($existing_batches as $batch) {
            $batch_data = json_decode($batch['bet_data_json'], true);
            if ($batch['line_number'] == $line_number) {
                $existing_batch = [
                    'batch_id' => $batch['id'],
                    'data' => $batch_data,
                    'line_number' => $line_number
                ];
                break;
            }
        }

        $lines_data[] = [
            'line_number' => $line_number,
            'text' => trim($line),
            'is_parsed' => !is_null($existing_batch),
            'batch_data' => $existing_batch
        ];
    }

    http_response_code(200);
    echo json_encode([
        'status' => 'success',
        'data' => [
            'email_content' => $clean_content,
            'lines' => $lines_data,
            'total_lines' => count($bet_lines)
        ]
    ]);

} catch (Throwable $e) {
    error_log("Error splitting email lines: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'ÊãÜÂàÜÂ§±Ë¥•: ' . $e->getMessage()]);
}

/**
 * Êô∫ËÉΩÊãÜÂàÜ‰∏ãÊ≥®ÂçïË°å - ‰ºòÂåñÁâà
 */
function splitBetLinesIntelligently(string $content): array {
    $lines = explode("\n", $content);
    $bet_lines = [];

    // ÂÆö‰πâ‰∏ãÊ≥®ÂÖ≥ÈîÆËØçÊ®°Âºè
    $bet_patterns = [
        // Êæ≥Èó®Ê®°Âºè
        '/Êæ≥Èó®[Ôºå,].*?\d+.*?(ÂÖÉ|Âùó|#)/u',
        // È¶ôÊ∏ØÊ®°Âºè
        '/È¶ôÊ∏Ø[Ôºö:].*?\d+.*?(ÂÖÉ|Âùó|#)/u',
        // Âè∑Á†ÅÊ®°Âºè
        '/\b\d{2}(?:[.,]\d{2})*.*?(ÂêÑ|√ó|x)\s*\d+\s*(ÂÖÉ|Âùó|#)/u',
        // ÁîüËÇñÊ®°Âºè
        '/[Èº†ÁâõËôéÂÖîÈæôËõáÈ©¨ÁæäÁå¥È∏°ÁãóÁå™].*?\d+\s*(ÂÖÉ|Âùó|Èó∑)/u',
        // ÈáëÈ¢ùÊ®°Âºè
        '/ÂêÑ\s*\d+\s*(ÂÖÉ|Âùó|#|Èó∑)/u',
        // ÂÖ≠ËÇñÊ®°Âºè
        '/[Èº†ÁâõËôéÂÖîÈæôËõáÈ©¨ÁæäÁå¥È∏°ÁãóÁå™]{2,}.*?\d+\s*(ÂÖÉ|Âùó|Èó∑)/u'
    ];

    $current_bet = '';

    foreach ($lines as $line) {
        $line = trim($line);
        if (empty($line)) continue;

        // Ë∑≥ËøáËÅäÂ§©ËÆ∞ÂΩïÂ§¥ÈÉ®ÂíåÈùû‰∏ãÊ≥®ÂÜÖÂÆπ
        if (preg_match('/^(ËÉúÂà©|ÂæÆ‰ø°|ËÅäÂ§©ËÆ∞ÂΩï|‚Äî‚Äî‚Äî‚Äî‚Äî|\d{4}-\d{2}-\d{2}|ËÄÅÈÉΩ)/u', $line)) {
            // Â¶ÇÊûúÂΩìÂâçÊúâÁ¥ØÁßØÁöÑ‰∏ãÊ≥®ÂÜÖÂÆπÔºåÂÖà‰øùÂ≠ò
            if (!empty($current_bet)) {
                $bet_lines[] = $current_bet;
                $current_bet = '';
            }
            continue;
        }

        // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´‰∏ãÊ≥®ÁâπÂæÅ
        $is_bet_line = false;
        foreach ($bet_patterns as $pattern) {
            if (preg_match($pattern, $line)) {
                $is_bet_line = true;
                break;
            }
        }

        if ($is_bet_line) {
            // Â¶ÇÊûúÂΩìÂâçÊúâÁ¥ØÁßØÂÜÖÂÆπÔºåÂÖà‰øùÂ≠ò
            if (!empty($current_bet)) {
                $bet_lines[] = $current_bet;
            }
            $current_bet = $line;
        } else if (!empty($current_bet)) {
            // Â¶ÇÊûú‰∏çÊòØ‰∏ãÊ≥®Ë°å‰ΩÜÂΩìÂâçÊúâÁ¥ØÁßØÔºåÂèØËÉΩÊòØ‰∏ãÊ≥®ÁöÑÂª∂Áª≠
            $current_bet .= ' ' . $line;
        }
    }

    // Ê∑ªÂä†ÊúÄÂêé‰∏ÄÊù°
    if (!empty($current_bet)) {
        $bet_lines[] = $current_bet;
    }

    return array_filter($bet_lines, function($line) {
        $line = trim($line);
        if (empty($line)) return false;

        // ÊúÄÁªàËøáÊª§ÔºöÂøÖÈ°ªÂåÖÂê´Êï∞Â≠óÂíåÈáëÈ¢ùÂçï‰Ωç
        return preg_match('/\d.*?(ÂÖÉ|Âùó|#|Èó∑)|(ÂêÑ|√ó|x)\s*\d/u', $line);
    });
}

/**
 * ÊóßÁâàÊãÜÂàÜÂáΩÊï∞Ôºà‰øùÁïôÂÖºÂÆπÊÄßÔºâ
 */
function splitBetLines(string $content): array {
    return splitBetLinesIntelligently($content);
}
?>
```
---
File: backend/auth/parse_single_bet.php
```
<?php
// File: backend/auth/parse_single_bet.php (‰øÆÂ§çÁâàÔºåÊîØÊåÅÂΩ©Á•®Á±ªÂûãÂèÇÊï∞)

if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

$input = json_decode(file_get_contents('php://input'), true);
$email_id = $input['email_id'] ?? null;
$bet_text = $input['bet_text'] ?? null;
$line_number = $input['line_number'] ?? null;
$lottery_type = $input['lottery_type'] ?? 'È¶ôÊ∏ØÂÖ≠ÂêàÂΩ©'; // Êñ∞Â¢ûÂèÇÊï∞

// ÂèÇÊï∞È™åËØÅ
if (empty($email_id) || !is_numeric($email_id)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Valid Email ID is required.']);
    exit;
}

if (empty($bet_text) || !is_string($bet_text)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Valid bet text is required.']);
    exit;
}

try {
    $pdo = get_db_connection();
    $user_id = $_SESSION['user_id'];

    // È™åËØÅÈÇÆ‰ª∂Â±û‰∫éÂΩìÂâçÁî®Êà∑
    $stmt = $pdo->prepare("SELECT id FROM raw_emails WHERE id = ? AND user_id = ?");
    $stmt->execute([intval($email_id), $user_id]);
    if (!$stmt->fetch()) {
        http_response_code(403);
        echo json_encode(['status' => 'error', 'message' => 'Access denied. Email not found.']);
        exit;
    }

    // Ëé∑ÂèñÁî®Êà∑ËµîÁéáÊ®°Êùø
    $stmt_odds = $pdo->prepare("SELECT * FROM user_odds_templates WHERE user_id = ?");
    $stmt_odds->execute([$user_id]);
    $userOddsTemplate = $stmt_odds->fetch(PDO::FETCH_ASSOC);

    // Â¶ÇÊûúÊ≤°ÊúâËµîÁéáÊ®°ÊùøÔºåËÆæÁΩÆ‰∏∫Á©∫Êï∞ÁªÑ
    if (!$userOddsTemplate) {
        $userOddsTemplate = [];
    }

    // Ëé∑ÂèñÊúÄÊñ∞ÂºÄÂ•ñÁªìÊûú
    $sql_latest_results = "
        SELECT r1.* FROM lottery_results r1
        JOIN (SELECT lottery_type, MAX(id) AS max_id FROM lottery_results GROUP BY lottery_type) r2
        ON r1.lottery_type = r2.lottery_type AND r1.id = r2.max_id
    ";
    $stmt_latest = $pdo->query($sql_latest_results);
    $latest_results_raw = $stmt_latest->fetchAll(PDO::FETCH_ASSOC);

    $latest_results = [];
    foreach ($latest_results_raw as $row) {
        foreach(['winning_numbers', 'zodiac_signs', 'colors'] as $key) {
            $decoded = json_decode($row[$key], true);
            $row[$key] = $decoded ?: [];
        }
        $latest_results[$row['lottery_type']] = $row;
    }

    // Ëß£ÊûêÂçïÊù°‰∏ãÊ≥®
    $parse_result = parseSingleBetText($bet_text, $latest_results, $userOddsTemplate, $lottery_type);

    // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
    $bet_data_json = json_encode([
        'raw_text' => $bet_text,
        'line_number' => $line_number ? intval($line_number) : null,
        'bets' => $parse_result['bets'],
        'total_amount' => $parse_result['total_amount'],
        'lottery_type' => $parse_result['lottery_type'],
        'settlement' => $parse_result['settlement']
    ]);

    $stmt_insert = $pdo->prepare("
        INSERT INTO parsed_bets (email_id, bet_data_json, ai_model_used, line_number)
        VALUES (?, ?, 'single_line_parser', ?)
    ");
    $stmt_insert->execute([
        intval($email_id),
        $bet_data_json,
        $line_number ? intval($line_number) : null
    ]);

    http_response_code(200);
    echo json_encode([
        'status' => 'success',
        'data' => [
            'batch_id' => $pdo->lastInsertId(),
            'parse_result' => $parse_result,
            'line_number' => $line_number
        ]
    ]);

} catch (Throwable $e) {
    error_log("Error parsing single bet: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Ëß£ÊûêÂ§±Ë¥•: ' . $e->getMessage()]);
}

// Âú® parseSingleBetText ÂáΩÊï∞‰∏≠ÔºåÁ°Æ‰øùÊ≠£Á°ÆËÆ°ÁÆóÊÄª‰∏ãÊ≥®ÈáëÈ¢ù
function parseSingleBetText(string $text, array $latest_results, ?array $userOddsTemplate = null, string $lottery_type = 'È¶ôÊ∏ØÂÖ≠ÂêàÂΩ©'): array {
    require_once __DIR__ . '/../helpers/manual_parser.php';

    // ÂÖàÂ∞ùËØïÊâãÂä®Ëß£Êûê
    $manual_data = parseBetManually($text);

    // Â¶ÇÊûúÊâãÂä®Ëß£ÊûêÊ≤°ÊúâÁªìÊûúÔºåÂ∞ùËØïAIËß£Êûê
    if (empty($manual_data['bets'])) {
        require_once __DIR__ . '/../ai_helper.php';
        // ‰ΩøÁî®‰∏ìÈó®ÁöÑÂçïÊù°‰∏ãÊ≥®AIËß£ÊûêÂáΩÊï∞
        $ai_result = analyzeSingleBetWithAI($text, $lottery_type);

        if ($ai_result['success'] && isset($ai_result['data'])) {
            $manual_data = $ai_result['data'];
        }
    }

    // Á°Æ‰øùÂΩ©Á•®Á±ªÂûãÊ≠£Á°ÆËÆæÁΩÆ
    $manual_data['lottery_type'] = $lottery_type;

    // ÈáçÊñ∞ËÆ°ÁÆóÊÄª‰∏ãÊ≥®ÈáëÈ¢ùÔºåÁ°Æ‰øùÂáÜÁ°ÆÊÄß
    $total_amount = 0;
    if (isset($manual_data['bets']) && is_array($manual_data['bets'])) {
        foreach ($manual_data['bets'] as &$bet) {
            $amount = floatval($bet['amount'] ?? 0);
            $targets = $bet['targets'] ?? [];

            if ($amount > 0) {
                // ÂØπ‰∫éÁâπÁ†Å„ÄÅÂè∑Á†ÅÁ≠âÁé©Ê≥ïÔºåÊØè‰∏™ÁõÆÊ†áÈÉΩÁÆó‰∏ÄÊ¨°‰∏ãÊ≥®
                if ($bet['bet_type'] === 'ÁâπÁ†Å' || $bet['bet_type'] === 'Âè∑Á†Å' || $bet['bet_type'] === 'Âπ≥Á†Å') {
                    $bet_total = $amount * (is_array($targets) ? count($targets) : 1);
                } else {
                    // ÂØπ‰∫éÂÖ≠ËÇñÁ≠âÁªÑÂêàÁé©Ê≥ïÔºåÂè™ÁÆó‰∏ÄÊ¨°‰∏ãÊ≥®
                    $bet_total = $amount;
                }
                $total_amount += $bet_total;
            }

            // Á°Æ‰øùÊØè‰∏™‰∏ãÊ≥®ÈÉΩÊúâÂΩ©Á•®Á±ªÂûã
            if (!isset($bet['lottery_type'])) {
                $bet['lottery_type'] = $manual_data['lottery_type'];
            }
        }
        $manual_data['total_amount'] = $total_amount;
    }

    // ËÆ°ÁÆóÁªìÁÆó
    $settlement_data = calculateManualSettlementDirect($manual_data, $latest_results, $userOddsTemplate);

    return [
        'bets' => $manual_data['bets'] ?? [],
        'total_amount' => $manual_data['total_amount'] ?? 0,
        'lottery_type' => $manual_data['lottery_type'] ?? $lottery_type,
        'settlement' => $settlement_data,
        'raw_text' => $text
    ];
}
```
---
File: backend/auth/get_email_details.php
```
<?php
// File: backend/auth/get_email_details.php (ÂÆåÊï¥‰øÆÂ§çÁâà)

if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

$user_id = $_SESSION['user_id'];
$email_id = $_GET['id'] ?? null;

if (empty($email_id)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email ID is required.']);
    exit;
}

try {
    $pdo = get_db_connection();

    // --- Ëé∑ÂèñÁî®Êà∑ËµîÁéáÊ®°Êùø ---
    $stmt_odds = $pdo->prepare("SELECT * FROM user_odds_templates WHERE user_id = ?");
    $stmt_odds->execute([$user_id]);
    $userOddsTemplate = $stmt_odds->fetch(PDO::FETCH_ASSOC);

    // --- 1. Ëé∑ÂèñÂéüÂßãÈÇÆ‰ª∂ÂÜÖÂÆπ ---
    $stmt_email = $pdo->prepare("SELECT content FROM raw_emails WHERE id = ? AND user_id = ?");
    $stmt_email->execute([$email_id, $user_id]);
    $raw_content = $stmt_email->fetchColumn();

    if ($raw_content === false) {
        http_response_code(404);
        echo json_encode(['status' => 'error', 'message' => 'Email not found or access denied.']);
        exit;
    }

    require_once __DIR__ . '/../helpers/mail_parser.php';
    $clean_content = parse_email_body($raw_content);

    // --- 2. Ëé∑ÂèñÊâÄÊúâÂÖ≥ËÅîÁöÑ‰∏ãÊ≥®ÊâπÊ¨° ---
    $stmt_bets = $pdo->prepare("
        SELECT pb.id, pb.bet_data_json, pb.ai_model_used
        FROM parsed_bets pb
        WHERE pb.email_id = ?
        ORDER BY pb.id ASC
    ");
    $stmt_bets->execute([$email_id]);
    $bet_batches_raw = $stmt_bets->fetchAll(PDO::FETCH_ASSOC);

    $bet_batches = [];
    $enhanced_content = $clean_content;

    // --- 3. Ëé∑ÂèñÊâÄÊúâÂΩ©ÁßçÁöÑÊúÄÊñ∞ÂºÄÂ•ñÁªìÊûú ---
    $sql_latest_results = "
        SELECT r1.*
        FROM lottery_results r1
        JOIN (
            SELECT lottery_type, MAX(id) AS max_id
            FROM lottery_results
            GROUP BY lottery_type
        ) r2 ON r1.lottery_type = r2.lottery_type AND r1.id = r2.max_id
    ";
    $stmt_latest = $pdo->query($sql_latest_results);
    $latest_results_raw = $stmt_latest->fetchAll(PDO::FETCH_ASSOC);

    $latest_results = [];
    foreach ($latest_results_raw as $row) {
        foreach(['winning_numbers', 'zodiac_signs', 'colors'] as $key) {
            $decoded = json_decode($row[$key], true);
            $row[$key] = $decoded ?: [];
        }
        $latest_results[$row['lottery_type']] = $row;
    }

    // --- 4. Â§ÑÁêÜ‰∏ãÊ≥®ÊâπÊ¨° ---
    foreach ($bet_batches_raw as $batch) {
        $batch_data = json_decode($batch['bet_data_json'], true);
        $batch_info = [
            'batch_id' => $batch['id'],
            'data' => $batch_data,
            'ai_model' => $batch['ai_model_used']
        ];

        // --- 5. ‰∏∫ÊØè‰∏™ÊâπÊ¨°ËÆ°ÁÆóÁªìÁÆóÔºà‰ΩøÁî®ÂÆûÈôÖÂºÄÂ•ñÁªìÊûúÂíåÁî®Êà∑ËµîÁéáÊ®°ÊùøÔºâ---
        if (isset($batch_data['bets']) && is_array($batch_data['bets'])) {
            $lottery_type = $batch_data['lottery_type'] ?? 'È¶ôÊ∏ØÂÖ≠ÂêàÂΩ©';
            $lottery_result = $latest_results[$lottery_type] ?? null;

            $settlement_data = calculateBatchSettlement($batch_data, $lottery_result, $userOddsTemplate);
            $batch_info['settlement'] = $settlement_data;

            // --- 6. Â∞ÜÁªìÁÆóÁªìÊûúÂµåÂÖ•ÈÇÆ‰ª∂ÂÜÖÂÆπ ---
            $enhanced_content = embedSettlementInContent(
                $enhanced_content,
                $batch_data,
                $settlement_data,
                $batch['id']
            );
        }

        $bet_batches[] = $batch_info;
    }

    // --- 7. Â¶ÇÊûúÊ≤°Êúâ‰ªª‰ΩïÊâπÊ¨°Ôºå‰ΩøÁî®ÊâãÂä®Ëß£Êûê ---
    if (empty($bet_batches)) {
        require_once __DIR__ . '/../helpers/manual_parser.php';
        $manual_data = parseBetManually($clean_content);
        if (!empty($manual_data['bets'])) {
            // ‰∏∫ÊâãÂä®Ëß£ÊûêÁöÑÊï∞ÊçÆËÆ°ÁÆóÁªìÁÆó
            $settlement_data = calculateManualSettlement($manual_data, $latest_results, $userOddsTemplate);

            $batch_info = [
                'batch_id' => 0,
                'data' => $manual_data,
                'ai_model' => 'manual_parser',
                'settlement' => $settlement_data
            ];

            $bet_batches[] = $batch_info;
            $enhanced_content = embedManualSettlement($clean_content, $manual_data, $settlement_data);
        } else {
            $enhanced_content = $clean_content . "\n\n--- Êú™Ê£ÄÊµãÂà∞‰∏ãÊ≥®‰ø°ÊÅØ ---\n";
        }
    }

    // --- 8. ËøîÂõûÂ¢ûÂº∫ÂêéÁöÑÈÇÆ‰ª∂ÂÜÖÂÆπ ---
    http_response_code(200);
    echo json_encode([
        'status' => 'success',
        'data' => [
            'email_content' => $clean_content,
            'enhanced_content' => $enhanced_content,
            'bet_batches' => $bet_batches,
            'latest_lottery_results' => $latest_results
        ]
    ]);

} catch (Throwable $e) {
    error_log("Error in get_email_details.php for email_id {$email_id}: " . $e->getMessage());
    error_log("Stack trace: " . $e->getTraceAsString());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Internal Server Error: ' . $e->getMessage()]);
}

/**
 * ËÆ°ÁÆóÂçï‰∏™ÊâπÊ¨°ÁöÑÁªìÁÆóÁªìÊûú - ‰ΩøÁî®Áî®Êà∑ËµîÁéáÊ®°Êùø
 */
function calculateBatchSettlement(array $batchData, ?array $lotteryResult = null, ?array $userOddsTemplate = null): array {
    $settlement = [
        'total_bet_amount' => 0,
        'winning_details' => [],
        'net_profits' => [],
        'summary' => '',
        'timestamp' => date('Y-m-d H:i:s'),
        'has_lottery_data' => !is_null($lotteryResult) &&
                             isset($lotteryResult['winning_numbers']) &&
                             is_array($lotteryResult['winning_numbers']) &&
                             !empty($lotteryResult['winning_numbers']),
        'used_odds' => null
    ];

    if (!isset($batchData['bets']) || !is_array($batchData['bets'])) {
        $settlement['summary'] = 'Êó†‰∏ãÊ≥®Êï∞ÊçÆ';
        return $settlement;
    }

    $totalBet = 0;
    $winningBets = [];

    foreach ($batchData['bets'] as $bet) {
        $amount = floatval($bet['amount'] ?? 0);
        $betType = $bet['bet_type'] ?? '';
        $targets = $bet['targets'] ?? [];

        if ($amount > 0 && is_array($targets)) {
            foreach ($targets as $target) {
                $totalBet += $amount;

                // Â¶ÇÊûúÊúâÊúâÊïàÁöÑÂºÄÂ•ñÁªìÊûúÔºåËøõË°åÂÆûÈôÖÁªìÁÆóËÆ°ÁÆó
                if ($settlement['has_lottery_data']) {
                    $winningNumbers = $lotteryResult['winning_numbers'];

                    // Ê†πÊçÆ‰∏ãÊ≥®Á±ªÂûãËé∑ÂèñÂØπÂ∫îÁöÑËµîÁéá
                    $odds = getUserOddsForBetType($betType, $userOddsTemplate);
                    $settlement['used_odds'] = $odds;

                    if ($odds === null) {
                        continue; // Â¶ÇÊûúÊ≤°ÊúâËÆæÁΩÆËØ•Áé©Ê≥ïÁöÑËµîÁéáÔºåË∑≥ËøáÁªìÁÆó
                    }

                    if ($betType === 'ÁâπÁ†Å' || $betType === 'Âè∑Á†Å') {
                        // ÁâπÁ†ÅÁé©Ê≥ïÔºöÂè™ÂØπÊØîÁâπÁ†ÅÔºàÊúÄÂêé‰∏Ä‰∏™Âè∑Á†ÅÔºâ
                        $specialNumber = end($winningNumbers);
                        if (strval(trim($target)) === strval(trim($specialNumber))) {
                            $winningBets[] = [
                                'number' => $target,
                                'amount' => $amount,
                                'odds' => $odds,
                                'bet_type' => $betType
                            ];
                        }
                    } elseif ($betType === 'Âπ≥Á†Å') {
                        // Âπ≥Á†ÅÁé©Ê≥ïÔºöÂØπÊØîÊâÄÊúâÂè∑Á†Å
                        $winningNumbersStr = array_map('strval', array_map('trim', $winningNumbers));
                        if (in_array(strval(trim($target)), $winningNumbersStr)) {
                            $winningBets[] = [
                                'number' => $target,
                                'amount' => $amount,
                                'odds' => $odds,
                                'bet_type' => $betType
                            ];
                        }
                    } elseif ($betType === 'ÁîüËÇñ') {
                        // ÁîüËÇñÁé©Ê≥ïÔºöÊ†πÊçÆÂè∑Á†ÅÂØπÂ∫îÁöÑÁîüËÇñÊù•Âà§Êñ≠
                        $targetZodiac = getZodiacByNumber($target);
                        if ($targetZodiac && isset($lotteryResult['zodiac_signs']) && is_array($lotteryResult['zodiac_signs'])) {
                            $zodiacsStr = array_map('strval', array_map('trim', $lotteryResult['zodiac_signs']));
                            if (in_array($targetZodiac, $zodiacsStr)) {
                                $winningBets[] = [
                                    'number' => $target,
                                    'amount' => $amount,
                                    'odds' => $odds,
                                    'bet_type' => $betType,
                                    'zodiac' => $targetZodiac
                                ];
                            }
                        }
                    }
                    // ÂÖ∂‰ªñÁé©Ê≥ïÁ±ªÂûãÂèØ‰ª•Âú®ËøôÈáåÊâ©Â±ï
                }
            }
        }
    }

    $settlement['total_bet_amount'] = $totalBet;
    $settlement['winning_details'] = $winningBets;

    // ËÆ°ÁÆóÂáÄÊî∂ÁõäÔºà‰ΩøÁî®Áî®Êà∑ËÆæÁΩÆÁöÑÂçï‰∏ÄËµîÁéáÔºâ
    $totalWin = 0;
    foreach ($winningBets as $win) {
        $totalWin += $win['amount'] * $win['odds'];
    }
    $netProfit = $totalWin - $totalBet;

    $settlement['net_profits'] = [
        'total_win' => $totalWin,
        'net_profit' => $netProfit,
        'is_profit' => $netProfit >= 0,
        'odds' => $settlement['used_odds']
    ];

    $winCount = count($winningBets);
    if ($settlement['has_lottery_data']) {
        $specialNumber = end($lotteryResult['winning_numbers']);
        $oddsInfo = $settlement['used_odds'] ? " (ËµîÁéá: {$settlement['used_odds']})" : "";
        $settlement['summary'] = "ÊÄª‰∏ãÊ≥® {$totalBet} ÂÖÉÔºå‰∏≠Â•ñ {$winCount} Ê≥®{$oddsInfo}ÔºåÁâπÁ†Å: {$specialNumber}";
    } else {
        $oddsInfo = $settlement['used_odds'] ? " (ËµîÁéá: {$settlement['used_odds']})" : "";
        $settlement['summary'] = "ÊÄª‰∏ãÊ≥® {$totalBet} ÂÖÉ{$oddsInfo}ÔºàÁ≠âÂæÖÂºÄÂ•ñÊï∞ÊçÆÔºâ";
    }

    return $settlement;
}

/**
 * Ê†πÊçÆ‰∏ãÊ≥®Á±ªÂûãËé∑ÂèñÁî®Êà∑ËÆæÁΩÆÁöÑËµîÁéá
 */
function getUserOddsForBetType(string $betType, ?array $userOddsTemplate): ?float {
    if (!$userOddsTemplate) {
        return null;
    }

    $oddsMapping = [
        'ÁâπÁ†Å' => 'special_code_odds',
        'Âè∑Á†Å' => 'special_code_odds',
        'Âπ≥Á†Å' => 'flat_special_odds',
        'Âπ≥Áâπ' => 'flat_special_odds',
        '‰∏≤Á†Å' => 'serial_code_odds',
        'ËøûËÇñ' => 'even_xiao_odds',
        'ÂÖ≠ËÇñ' => 'six_xiao_odds',
        'Â§ßÂ∞è' => 'size_single_double_odds',
        'ÂçïÂèå' => 'size_single_double_odds'
    ];

    $templateKey = $oddsMapping[$betType] ?? null;
    if ($templateKey && isset($userOddsTemplate[$templateKey]) && $userOddsTemplate[$templateKey] !== null) {
        return floatval($userOddsTemplate[$templateKey]);
    }

    return null;
}

/**
 * ËÆ°ÁÆóÊâãÂä®Ëß£ÊûêÁöÑÁªìÁÆó
 */
function calculateManualSettlement(array $manualData, array $latestResults, ?array $userOddsTemplate = null): array {
    $settlement = [
        'total_bet_amount' => $manualData['total_amount'],
        'winning_details' => [],
        'net_profits' => [],
        'summary' => '',
        'timestamp' => date('Y-m-d H:i:s'),
        'has_lottery_data' => !empty($latestResults),
        'used_odds' => null
    ];

    $winningBets = [];

    // ‰ΩøÁî®ÊâÄÊúâÂΩ©Á•®Á±ªÂûãÁöÑÁªìÊûúËøõË°åÁªìÁÆó
    foreach ($manualData['bets'] as $bet) {
        $amount = $bet['amount'];
        $betType = $bet['bet_type'];
        $targets = $bet['targets'];
        $lotteryType = $bet['lottery_type'] ?? 'È¶ôÊ∏ØÂÖ≠ÂêàÂΩ©';

        // ÈÄâÊã©ÂØπÂ∫îÁöÑÂºÄÂ•ñÁªìÊûú
        $result = null;
        if (isset($latestResults[$lotteryType])) {
            $result = $latestResults[$lotteryType];
        } elseif ($lotteryType === 'Êæ≥Èó®ÂÖ≠ÂêàÂΩ©' && isset($latestResults['Êñ∞Êæ≥Èó®ÂÖ≠ÂêàÂΩ©'])) {
            $result = $latestResults['Êñ∞Êæ≥Èó®ÂÖ≠ÂêàÂΩ©'];
        } elseif ($lotteryType === 'Êæ≥Èó®ÂÖ≠ÂêàÂΩ©' && isset($latestResults['ËÄÅÊæ≥Èó®ÂÖ≠ÂêàÂΩ©'])) {
            $result = $latestResults['ËÄÅÊæ≥Èó®ÂÖ≠ÂêàÂΩ©'];
        } else {
            // Â¶ÇÊûúÊ≤°ÊúâÂØπÂ∫îÁöÑÂºÄÂ•ñÁªìÊûúÔºå‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÂèØÁî®ÁöÑÁªìÊûú
            $result = reset($latestResults) ?: null;
        }

        // Ëé∑ÂèñÁî®Êà∑ËÆæÁΩÆÁöÑËµîÁéá
        $odds = getUserOddsForBetType($betType, $userOddsTemplate);
        $settlement['used_odds'] = $odds;

        foreach ($targets as $target) {
            if ($result && isset($result['winning_numbers']) && is_array($result['winning_numbers'])) {
                $winningNumbers = $result['winning_numbers'];

                if ($betType === 'Âè∑Á†Å' || $betType === 'ÁâπÁ†Å' || $betType === 'ÁîüËÇñ') {
                    // ÁâπÁ†ÅÁé©Ê≥ïÔºöÂØπÊØîÁâπÁ†ÅÔºàÊúÄÂêé‰∏Ä‰∏™Âè∑Á†ÅÔºâ
                    $specialNumber = end($winningNumbers);
                    if (strval(trim($target)) === strval(trim($specialNumber))) {
                        $zodiacInfo = isset($bet['zodiac']) ? " [{$bet['zodiac']}]" : "";
                        $winningBets[] = [
                            'number' => $target,
                            'amount' => $amount,
                            'odds' => $odds ?: 45, // Â¶ÇÊûúÊ≤°ÊúâËÆæÁΩÆËµîÁéáÔºå‰ΩøÁî®ÈªòËÆ§45
                            'bet_type' => $betType,
                            'lottery_type' => $result['lottery_type'],
                            'zodiac' => $bet['zodiac'] ?? null
                        ];
                    }
                }
            }
        }
    }

    $settlement['winning_details'] = $winningBets;

    // ËÆ°ÁÆóÂáÄÊî∂Áõä
    $totalWin = 0;
    foreach ($winningBets as $win) {
        $totalWin += $win['amount'] * $win['odds'];
    }
    $netProfit = $totalWin - $manualData['total_amount'];

    $settlement['net_profits'] = [
        'total_win' => $totalWin,
        'net_profit' => $netProfit,
        'is_profit' => $netProfit >= 0,
        'odds' => $settlement['used_odds']
    ];

    $winCount = count($winningBets);
    if (!empty($latestResults)) {
        $oddsInfo = $settlement['used_odds'] ? " (ËµîÁéá: {$settlement['used_odds']})" : "";
        $settlement['summary'] = "ÊÄª‰∏ãÊ≥® {$manualData['total_amount']} ÂÖÉÔºå‰∏≠Â•ñ {$winCount} Ê≥®{$oddsInfo}";
    } else {
        $oddsInfo = $settlement['used_odds'] ? " (ËµîÁéá: {$settlement['used_odds']})" : "";
        $settlement['summary'] = "ÊÄª‰∏ãÊ≥® {$manualData['total_amount']} ÂÖÉ{$oddsInfo}ÔºàÁ≠âÂæÖÂºÄÂ•ñÊï∞ÊçÆÔºâ";
    }

    return $settlement;
}

/**
 * Ê†πÊçÆÂè∑Á†ÅËé∑ÂèñÁîüËÇñ
 */
function getZodiacByNumber($number): ?string {
    $zodiacMap = [
        '01' => 'Ëõá', '13' => 'Ëõá', '25' => 'Ëõá', '37' => 'Ëõá', '49' => 'Ëõá',
        '02' => 'Èæô', '14' => 'Èæô', '26' => 'Èæô', '38' => 'Èæô',
        '03' => 'ÂÖî', '15' => 'ÂÖî', '27' => 'ÂÖî', '39' => 'ÂÖî',
        '04' => 'Ëôé', '16' => 'Ëôé', '28' => 'Ëôé', '40' => 'Ëôé',
        '05' => 'Áâõ', '17' => 'Áâõ', '29' => 'Áâõ', '41' => 'Áâõ',
        '06' => 'Èº†', '18' => 'Èº†', '30' => 'Èº†', '42' => 'Èº†',
        '07' => 'Áå™', '19' => 'Áå™', '31' => 'Áå™', '43' => 'Áå™',
        '08' => 'Áãó', '20' => 'Áãó', '32' => 'Áãó', '44' => 'Áãó',
        '09' => 'È∏°', '21' => 'È∏°', '33' => 'È∏°', '45' => 'È∏°',
        '10' => 'Áå¥', '22' => 'Áå¥', '34' => 'Áå¥', '46' => 'Áå¥',
        '11' => 'Áæä', '23' => 'Áæä', '35' => 'Áæä', '47' => 'Áæä',
        '12' => 'È©¨', '24' => 'È©¨', '36' => 'È©¨', '48' => 'È©¨'
    ];

    $numberPadded = str_pad(strval(trim($number)), 2, '0', STR_PAD_LEFT);
    return $zodiacMap[$numberPadded] ?? null;
}

/**
 * Â∞ÜÁªìÁÆóÁªìÊûúÂµåÂÖ•ÈÇÆ‰ª∂ÂÜÖÂÆπ
 */
function embedSettlementInContent(string $content, array $batchData, array $settlement, int $batchId): string {
    $rawText = $batchData['raw_text'] ?? '';

    // Â¶ÇÊûúÊ≤°ÊúâÂéüÂßãÊñáÊú¨ÔºåÂú®ÂÜÖÂÆπÊú´Â∞æÊ∑ªÂä†ÁªìÁÆó‰ø°ÊÅØ
    if (empty($rawText)) {
        $settlementHtml = buildSettlementHtml($settlement, $batchId);
        return $content . "\n\n" . $settlementHtml;
    }

    // Êü•ÊâæÂéüÂßãÊñáÊú¨Âú®ÂÜÖÂÆπ‰∏≠ÁöÑ‰ΩçÁΩÆ
    $position = strpos($content, $rawText);

    if ($position === false) {
        // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂéüÂßãÊñáÊú¨ÔºåÂú®ÂÜÖÂÆπÊú´Â∞æÊ∑ªÂä†ÁªìÁÆó‰ø°ÊÅØ
        $settlementHtml = buildSettlementHtml($settlement, $batchId);
        return $content . "\n\n" . $settlementHtml;
    }

    // ÊûÑÂª∫ÁªìÁÆóHTML
    $settlementHtml = buildPlainSettlementHtml($settlement, $batchId);

    // Âú®ÂéüÂßãÊñáÊú¨ÂêéÊèíÂÖ•ÁªìÁÆó‰ø°ÊÅØ
    $insertPosition = $position + strlen($rawText);
    $newContent = substr($content, 0, $insertPosition) .
                  $settlementHtml .
                  substr($content, $insertPosition);

    return $newContent;
}

/**
 * ÂµåÂÖ•ÊâãÂä®Ëß£ÊûêÁöÑÁªìÁÆóÁªìÊûú
 */
function embedManualSettlement(string $content, array $manualData, array $settlement): string {
    $settlementHtml = buildPlainSettlementHtml($settlement, 0);
    return $content . "\n\n" . $settlementHtml;
}

/**
 * ÊûÑÂª∫Á∫ØÊñáÊú¨ÁªìÁÆóHTML
 */
function buildPlainSettlementHtml(array $settlement, int $batchId): string {
    $html = "\n\n" . str_repeat("=", 50) . "\n";
    $html .= "üéØ ÁªìÁÆóÁªìÊûú (ÊâπÊ¨° {$batchId})\n";
    $html .= str_repeat("=", 50) . "\n";

    // ÊÄª‰∏ãÊ≥®ÈáëÈ¢ù
    $html .= "üí∞ ÊÄªÊäïÊ≥®ÈáëÈ¢ù: {$settlement['total_bet_amount']} ÂÖÉ\n";

    // ‰∏≠Â•ñËØ¶ÊÉÖ
    if (!empty($settlement['winning_details'])) {
        $html .= "üéä ‰∏≠Â•ñËØ¶ÊÉÖ:\n";
        foreach ($settlement['winning_details'] as $win) {
            $lotteryTypeInfo = isset($win['lottery_type']) ? " ({$win['lottery_type']})" : "";
            $zodiacInfo = isset($win['zodiac']) ? " [{$win['zodiac']}]" : "";
            $oddsInfo = isset($win['odds']) ? " (ËµîÁéá {$win['odds']})" : "";
            $html .= "   - Âè∑Á†Å {$win['number']}{$zodiacInfo}: {$win['amount']} ÂÖÉ{$oddsInfo}{$lotteryTypeInfo}\n";
        }
    } else {
        if ($settlement['has_lottery_data']) {
            $html .= "‚ùå ‰∏≠Â•ñËØ¶ÊÉÖ: Êú™‰∏≠Â•ñ\n";
        } else {
            $html .= "‚è≥ ‰∏≠Â•ñËØ¶ÊÉÖ: Á≠âÂæÖÂºÄÂ•ñÊï∞ÊçÆ\n";
        }
    }

    // ÁªìÁÆóÁªìÊûú
    $html .= "\nüìà ÁªìÁÆóÁªìÊûú:\n";
    if ($settlement['net_profits'] && isset($settlement['net_profits']['net_profit'])) {
        $netProfit = $settlement['net_profits']['net_profit'];
        $isProfit = $settlement['net_profits']['is_profit'];
        $oddsInfo = $settlement['used_odds'] ? " (ËµîÁéá: {$settlement['used_odds']})" : "";

        $emoji = $isProfit ? 'üü¢' : 'üî¥';
        $profitText = $isProfit ? "ÁõàÂà©" : "‰∫èÊçü";
        $netAmount = abs($netProfit);

        $html .= "{$emoji} {$profitText} {$netAmount} ÂÖÉ{$oddsInfo}\n";
    }

    // Ê∑ªÂä†ÂºÄÂ•ñÊï∞ÊçÆ‰ø°ÊÅØ
    if (!$settlement['has_lottery_data']) {
        $html .= "\n‚ö†Ô∏è  Ê≥®ÊÑè: ÂΩìÂâçÊó†ÂºÄÂ•ñÊï∞ÊçÆÔºå‰ª•‰∏ä‰∏∫Ê®°ÊãüÁªìÁÆóÁªìÊûú\n";
    }

    $html .= str_repeat("=", 50) . "\n";

    return $html;
}

/**
 * ÊûÑÂª∫ÁªìÁÆóHTML - ‰øùÁïôÂéüÂáΩÊï∞ÂÖºÂÆπÊÄß
 */
function buildSettlementHtml(array $settlement, int $batchId): string {
    return buildPlainSettlementHtml($settlement, $batchId);
}
?>```
---
File: backend/auth/get_emails.php
```
<?php
// File: backend/auth/get_emails.php

// Ê†∏ÂøÉ‰æùËµñÁî± index.php Âä†ËΩΩÔºåËøôÈáåÊàë‰ª¨Áõ¥Êé•‰ΩøÁî®

// 1. Ë∫´‰ªΩÈ™åËØÅÊ£ÄÊü•
if (!isset($_SESSION['user_id'])) {
    http_response_code(401); // Unauthorized
    echo json_encode(['status' => 'error', 'message' => 'ÊÇ®ÈúÄË¶ÅÁôªÂΩïÊâçËÉΩÊü•ÁúãÈÇÆ‰ª∂„ÄÇ']);
    exit;
}

$user_id = $_SESSION['user_id'];
$limit = 20; // ÈôêÂà∂‰∏ÄÊ¨°ÊúÄÂ§öËé∑Âèñ20Â∞ÅÈÇÆ‰ª∂

try {
    $pdo = get_db_connection();

    // 2. ‰ªéÊï∞ÊçÆÂ∫ìÊü•ËØ¢ÈÇÆ‰ª∂
    // Êàë‰ª¨Âè™Êü•ËØ¢ raw_emails Ë°®ÔºåÂõ†‰∏∫ÂâçÁ´ØÂàóË°®Âè™ÈúÄË¶ÅÈÇÆ‰ª∂ÁöÑÂü∫Êú¨‰ø°ÊÅØ
    // ÂÖ≥ÈîÆÔºöWHERE user_id = ? Á°Æ‰øù‰∫ÜÁî®Êà∑Âè™ËÉΩÁúãÂà∞Ëá™Â∑±ÁöÑÈÇÆ‰ª∂
    $stmt = $pdo->prepare(
        "SELECT id, status, received_at
         FROM raw_emails
         WHERE user_id = ?
         ORDER BY received_at DESC
         LIMIT ?"
    );

    // PDO::PARAM_INT ÂëäËØâÊï∞ÊçÆÂ∫ìËøôÊòØ‰∏Ä‰∏™Êï¥Êï∞ÔºåÊõ¥ÂÆâÂÖ®
    $stmt->bindParam(1, $user_id, PDO::PARAM_INT);
    $stmt->bindParam(2, $limit, PDO::PARAM_INT);
    $stmt->execute();

    $emails = $stmt->fetchAll(PDO::FETCH_ASSOC);

    // 3. ËøîÂõûÊàêÂäüÂìçÂ∫î
    http_response_code(200);
    echo json_encode(['status' => 'success', 'data' => $emails]);

} catch (PDOException $e) {
    error_log("Error fetching emails for user {$user_id}: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Ëé∑ÂèñÈÇÆ‰ª∂ÂàóË°®Êó∂ÂèëÁîüÊï∞ÊçÆÂ∫ìÈîôËØØ„ÄÇ']);
}
?>```
---
File: backend/auth/update_bet_batch.php
```
<?php
// File: backend/auth/update_bet_batch.php (with AI Learning)

// Include necessary files
require_once __DIR__ . '/../config.php';
require_once __DIR__ . '/../db_operations.php';
require_once __DIR__ . '/../ai_helper.php'; // Include for trainAIWithCorrection

/**
 * Ëß¶ÂèëAIÂ≠¶‰π†‰øÆÊ≠£
 */
function triggerAILearning($batch_id, $original_bet_data, $corrected_data) {
    try {
        $pdo = get_db_connection();
        // Ëé∑ÂèñÂéüÂßãÈÇÆ‰ª∂ÂÜÖÂÆπ
        $stmt = $pdo->prepare("
            SELECT re.content
            FROM parsed_bets pb
            JOIN raw_emails re ON pb.email_id = re.id
            WHERE pb.id = ?
        ");
        $stmt->execute([$batch_id]);
        $original_content = $stmt->fetchColumn();

        if ($original_content) {
            // ÊûÑÂª∫Â≠¶‰π†Êï∞ÊçÆ
            $learning_data = [
                'original_text' => $original_content,
                'original_parse' => $original_bet_data,
                'corrected_parse' => $corrected_data,
                'learning_timestamp' => date('Y-m-d H:i:s')
            ];

            // ÂÆûÈôÖË∞ÉÁî® AI Â≠¶‰π†ÂáΩÊï∞
            trainAIWithCorrection($learning_data);
            error_log("AI Learning Triggered for batch_id: " . $batch_id);

        } else {
            error_log("Could not find original email content for batch_id: " . $batch_id);
        }

    } catch (Exception $e) {
        error_log("Error in AI learning trigger for batch_id {$batch_id}: " . $e->getMessage());
    }
}


// --- Main script execution ---

// 1. Ë∫´‰ªΩÈ™åËØÅ
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

// 2. Ëé∑ÂèñÂπ∂È™åËØÅËæìÂÖ•
$input = json_decode(file_get_contents('php://input'), true);
$batch_id = $input['batch_id'] ?? null;
$updated_data = $input['data'] ?? null;

if (empty($batch_id) || !is_numeric($batch_id) || $updated_data === null) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Invalid input: batch_id and data are required.']);
    exit;
}

$updated_data_json = json_encode($updated_data);
if ($updated_data_json === false) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Invalid JSON data provided.']);
    exit;
}

$pdo = null;
try {
    $pdo = get_db_connection();
    $pdo->beginTransaction();

    // 3. ÂÆâÂÖ®ÊÄßÊ£ÄÊü• & Ëé∑ÂèñÂéüÂßãÊï∞ÊçÆ
    $stmt_check = $pdo->prepare("
        SELECT pb.id, pb.bet_data_json
        FROM parsed_bets pb
        JOIN raw_emails re ON pb.email_id = re.id
        WHERE pb.id = ? AND re.user_id = ?
    ");
    $stmt_check->execute([$batch_id, $_SESSION['user_id']]);
    $original_record = $stmt_check->fetch(PDO::FETCH_ASSOC);

    if ($original_record === false) {
        http_response_code(403);
        echo json_encode(['status' => 'error', 'message' => 'Access denied or record not found.']);
        $pdo->rollBack();
        exit;
    }

    $original_bet_data = json_decode($original_record['bet_data_json'], true);

    // 4. ÊâßË°åÊõ¥Êñ∞
    $stmt_update = $pdo->prepare("UPDATE parsed_bets SET bet_data_json = ? WHERE id = ?");
    $stmt_update->execute([$updated_data_json, $batch_id]);

    // 5. Ëß¶ÂèëAIÂ≠¶‰π† (Â¶ÇÊûúÈúÄË¶Å)
    if (isset($updated_data['correction'])) {
        // ËÆ∞ÂΩï‰øÆÊ≠£Âà∞Êï∞ÊçÆÂ∫ì
        try {
            $stmt_correction = $pdo->prepare("
                INSERT INTO ai_corrections
                (batch_id, original_amount, corrected_amount, correction_reason, corrected_at, user_id)
                VALUES (?, ?, ?, ?, ?, ?)
            ");
            $stmt_correction->execute([
                $batch_id,
                $updated_data['correction']['original_amount'],
                $updated_data['correction']['corrected_amount'],
                $updated_data['correction']['correction_reason'],
                $updated_data['correction']['corrected_at'],
                $_SESSION['user_id']
            ]);
        } catch (Exception $e) {
            error_log("Failed to save AI correction to DB: " . $e->getMessage());
            // This might not be a fatal error, so we log it but don't stop the process
        }

        // Ëß¶ÂèëAIÂ≠¶‰π†
        triggerAILearning($batch_id, $original_bet_data, $updated_data);
    }

    // 6. Êèê‰∫§‰∫ãÂä°
    $pdo->commit();

    http_response_code(200);
    echo json_encode(['status' => 'success', 'message' => 'Bet batch updated successfully.']);

} catch (Exception $e) {
    if ($pdo && $pdo->inTransaction()) {
        $pdo->rollBack();
    }
    error_log("Error updating bet batch {$batch_id}: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'An error occurred during the update process.']);
}

?>```
---
File: backend/lottery/get_result_by_issue.php
```
<?php
// File: backend/lottery/get_result_by_issue.php

$issue_number = $_GET['issue'] ?? null;
$lottery_type = $_GET['type'] ?? null;

if (empty($issue_number) || empty($lottery_type)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Lottery type and issue number are required.']);
    exit;
}

try {
    $pdo = get_db_connection();
    $stmt = $pdo->prepare("SELECT * FROM lottery_results WHERE lottery_type = ? AND issue_number = ?");
    $stmt->execute([$lottery_type, $issue_number]);
    $result = $stmt->fetch(PDO::FETCH_ASSOC);

    if ($result) {
        // Ëß£Á†Å JSON Â≠óÊÆµ
        foreach(['winning_numbers', 'zodiac_signs', 'colors'] as $key) {
            $result[$key] = json_decode($result[$key]) ?: [];
        }
        echo json_encode(['status' => 'success', 'data' => $result]);
    } else {
        http_response_code(404);
        echo json_encode(['status' => 'error', 'message' => 'Lottery result for this issue not found.']);
    }

} catch (PDOException $e) {
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Database error.']);
}
?>```
---
File: backend/lottery/get_results.php
```
<?php
// File: backend/lottery/get_results.php (Simplified, No Requires)

if (!function_exists('get_db_connection')) {
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Core function get_db_connection() is missing.']);
    exit;
}

try {
    $pdo = get_db_connection();
    // ... (rest of the file is the same)
    $sql = "SELECT r1.* FROM lottery_results r1 JOIN (SELECT lottery_type, MAX(id) AS max_id FROM lottery_results GROUP BY lottery_type) r2 ON r1.lottery_type = r2.lottery_type AND r1.id = r2.max_id";
    $stmt = $pdo->query($sql);
    $results = $stmt->fetchAll(PDO::FETCH_ASSOC);
    // ... processing logic ...
    $grouped_results = [];
    foreach ($results as $row) {
        foreach(['winning_numbers', 'zodiac_signs', 'colors'] as $key) {
            $decoded = json_decode($row[$key]);
            $row[$key] = $decoded ?: [];
        }
        $grouped_results[$row['lottery_type']] = $row;
    }
    $lottery_types = ['È¶ôÊ∏ØÂÖ≠ÂêàÂΩ©', 'Êñ∞Êæ≥Èó®ÂÖ≠ÂêàÂΩ©', 'ËÄÅÊæ≥Èó®ÂÖ≠ÂêàÂΩ©'];
    $final_data = [];
    foreach ($lottery_types as $type) {
        $final_data[$type] = $grouped_results[$type] ?? null;
    }
    echo json_encode(['status' => 'success', 'data' => $final_data]);
} catch (Throwable $e) {
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'An error occurred.', 'details' => $e->getMessage()]);
}
?>```
---
File: backend/lottery/rules.php
```
<?php
// File: backend/lottery/rules.php

if (!function_exists('get_lottery_rules')) {
    /**
     * ËøîÂõûÊâÄÊúâÂè∑Á†ÅÁöÑÂ±ûÊÄßÔºåÂåÖÊã¨Ê≥¢Ëâ≤ÂíåÁîüËÇñ„ÄÇ
     * @return array
     */
    function get_lottery_rules() {
        // ‰ΩøÁî®ÈùôÊÄÅÂèòÈáèÔºåÁ°Æ‰øùËøô‰∏™Â∫ûÂ§ßÁöÑÊï∞ÁªÑÂè™Ë¢´ÊûÑÂª∫‰∏ÄÊ¨°
        static $rules = null;

        if ($rules === null) {
            $rules = [
                '01' => ['color' => 'Á∫¢Ê≥¢', 'zodiac' => 'Ëõá'], '02' => ['color' => 'Á∫¢Ê≥¢', 'zodiac' => 'Èæô'],
                '03' => ['color' => 'ËìùÊ≥¢', 'zodiac' => 'ÂÖî'], '04' => ['color' => 'ËìùÊ≥¢', 'zodiac' => 'Ëôé'],
                '05' => ['color' => 'ÁªøÊ≥¢', 'zodiac' => 'Áâõ'], '06' => ['color' => 'ÁªøÊ≥¢', 'zodiac' => 'Èº†'],
                '07' => ['color' => 'Á∫¢Ê≥¢', 'zodiac' => 'Áå™'], '08' => ['color' => 'Á∫¢Ê≥¢', 'zodiac' => 'Áãó'],
                '09' => ['color' => 'ËìùÊ≥¢', 'zodiac' => 'È∏°'], '10' => ['color' => 'ËìùÊ≥¢', 'zodiac' => 'Áå¥'],
                '11' => ['color' => 'ÁªøÊ≥¢', 'zodiac' => 'Áæä'], '12' => ['color' => 'Á∫¢Ê≥¢', 'zodiac' => 'È©¨'],
                '13' => ['color' => 'Á∫¢Ê≥¢', 'zodiac' => 'Ëõá'], '14' => ['color' => 'ËìùÊ≥¢', 'zodiac' => 'Èæô'],
                '15' => ['color' => 'ËìùÊ≥¢', 'zodiac' => 'ÂÖî'], '16' => ['color' => 'ÁªøÊ≥¢', 'zodiac' => 'Ëôé'],
                '17' => ['color' => 'ÁªøÊ≥¢', 'zodiac' => 'Áâõ'], '18' => ['color' => 'Á∫¢Ê≥¢', 'zodiac' => 'Èº†'],
                '19' => ['color' => 'Á∫¢Ê≥¢', 'zodiac' => 'Áå™'], '20' => ['color' => 'ËìùÊ≥¢', 'zodiac' => 'Áãó'],
                '21' => ['color' => 'ÁªøÊ≥¢', 'zodiac' => 'È∏°'], '22' => ['color' => 'ÁªøÊ≥¢', 'zodiac' => 'Áå¥'],
                '23' => ['color' => 'Á∫¢Ê≥¢', 'zodiac' => 'Áæä'], '24' => ['color' => 'Á∫¢Ê≥¢', 'zodiac' => 'È©¨'],
                '25' => ['color' => 'ËìùÊ≥¢', 'zodiac' => 'Ëõá'], '26' => ['color' => 'ËìùÊ≥¢', 'zodiac' => 'Èæô'],
                '27' => ['color' => 'ÁªøÊ≥¢', 'zodiac' => 'ÂÖî'], '28' => ['color' => 'ÁªøÊ≥¢', 'zodiac' => 'Ëôé'],
                '29' => ['color' => 'Á∫¢Ê≥¢', 'zodiac' => 'Áâõ'], '30' => ['color' => 'Á∫¢Ê≥¢', 'zodiac' => 'Èº†'],
                '31' => ['color' => 'ËìùÊ≥¢', 'zodiac' => 'Áå™'], '32' => ['color' => 'ÁªøÊ≥¢', 'zodiac' => 'Áãó'],
                '33' => ['color' => 'ÁªøÊ≥¢', 'zodiac' => 'È∏°'], '34' => ['color' => 'Á∫¢Ê≥¢', 'zodiac' => 'Áå¥'],
                '35' => ['color' => 'Á∫¢Ê≥¢', 'zodiac' => 'Áæä'], '36' => ['color' => 'ËìùÊ≥¢', 'zodiac' => 'È©¨'],
                '37' => ['color' => 'ËìùÊ≥¢', 'zodiac' => 'Ëõá'], '38' => ['color' => 'ÁªøÊ≥¢', 'zodiac' => 'Èæô'],
                '39' => ['color' => 'ÁªøÊ≥¢', 'zodiac' => 'ÂÖî'], '40' => ['color' => 'Á∫¢Ê≥¢', 'zodiac' => 'Ëôé'],
                '41' => ['color' => 'ËìùÊ≥¢', 'zodiac' => 'Áâõ'], '42' => ['color' => 'ËìùÊ≥¢', 'zodiac' => 'Èº†'],
                '43' => ['color' => 'ÁªøÊ≥¢', 'zodiac' => 'Áå™'], '44' => ['color' => 'ÁªøÊ≥¢', 'zodiac' => 'Áãó'],
                '45' => ['color' => 'Á∫¢Ê≥¢', 'zodiac' => 'È∏°'], '46' => ['color' => 'Á∫¢Ê≥¢', 'zodiac' => 'Áå¥'],
                '47' => ['color' => 'ËìùÊ≥¢', 'zodiac' => 'Áæä'], '48' => ['color' => 'ËìùÊ≥¢', 'zodiac' => 'È©¨'],
                '49' => ['color' => 'ÁªøÊ≥¢', 'zodiac' => 'Ëõá'],
            ];
        }
        return $rules;
    }
}

if (!function_exists('get_color_by_number')) {
    /**
     * Ê†πÊçÆÂè∑Á†ÅËé∑ÂèñÂÖ∂Ê≥¢Ëâ≤„ÄÇ
     * @param string $number
     * @return string|null
     */
    function get_color_by_number(string $number) {
        $rules = get_lottery_rules();
        // Á°Æ‰øùÂè∑Á†ÅÊòØ‰∏§‰ΩçÊï∞Ôºå‰æãÂ¶Ç '5' -> '05'
        $number_padded = str_pad($number, 2, '0', STR_PAD_LEFT);
        return $rules[$number_padded]['color'] ?? null;
    }
}

if (!function_exists('get_zodiac_by_number')) {
    /**
     * Ê†πÊçÆÂè∑Á†ÅËé∑ÂèñÂÖ∂ÁîüËÇñ„ÄÇ
     * @param string $number
     * @return string|null
     */
    function get_zodiac_by_number(string $number) {
        $rules = get_lottery_rules();
        $number_padded = str_pad($number, 2, '0', STR_PAD_LEFT);
        return $rules[$number_padded]['zodiac'] ?? null;
    }
}
?>```
---
File: backend/mail/receive.php
```
<?php
// backend/mail/receive.php
require_once __DIR__ . '/../config.php';
require_once __DIR__ . '/../db_operations.php';

// 1. ÂÆâÂÖ®È™åËØÅ (ËØªÂèñ Authorization Header)
$secret = config('EMAIL_WORKER_SECRET');
$auth_header = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
$token = str_replace('Bearer ', '', $auth_header);

if (!$secret || !hash_equals($secret, $token)) { // ‰ΩøÁî® hash_equals Èò≤Ê≠¢Êó∂Â∫èÊîªÂáª
    http_response_code(403);
    echo json_encode(['status' => 'error', 'message' => 'Forbidden: Invalid token.']);
    exit;
}

// 2. Ëé∑Âèñ JSON Body
$input = json_decode(file_get_contents('php://input'), true);
$sender_email = $input['sender'] ?? null;
$raw_content = $input['raw_content'] ?? null;

if (empty($sender_email) || empty($raw_content)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Missing sender or raw_content.']);
    exit;
}

try {
    $pdo = get_db_connection();
    // 3. Êü•ÊâæÁî®Êà∑
    $stmt = $pdo->prepare("SELECT id FROM users WHERE email = ? AND status = 'active'");
    $stmt->execute([$sender_email]);
    $user_id = $stmt->fetchColumn();

    if (!$user_id) {
        error_log("Email received from unregistered/banned user: {$sender_email}");
        http_response_code(200);
        echo json_encode(['status' => 'success', 'message' => 'User not processed.']);
        exit;
    }

    // 4. Â≠òÂÖ•Êï∞ÊçÆÂ∫ì
    $stmt = $pdo->prepare("INSERT INTO raw_emails (user_id, content) VALUES (?, ?)");
    $stmt->execute([$user_id, $raw_content]);

    http_response_code(200);
    echo json_encode(['status' => 'success', 'message' => 'Email received and stored.']);

} catch (PDOException $e) {
    error_log("Error in mail/receive.php: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Database error.']);
}
?>```
---
File: backend/telegram/receiver.php
```
<?php
// File: telegram/receiver.php (FINAL PRODUCTION VERSION)
ini_set('display_errors', 0);
ini_set('log_errors', 1);
ini_set('error_log', __DIR__ . '/receiver_debug.log');
error_reporting(E_ALL);

// Á´ãÂç≥ËÆ∞ÂΩïËØ∑Ê±Ç
error_log("=== WEBHOOK CALLED ===");
error_log("Time: " . date('Y-m-d H:i:s'));

function read_env_and_get_config() {
    static $config = null;
    if ($config === null) {
        $config = [];
        $envPath = dirname(__DIR__) . '/.env';
        if (file_exists($envPath) && is_readable($envPath)) {
            $lines = file($envPath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
            foreach ($lines as $line) {
                $line = trim($line);
                if (strpos($line, ';') === 0) continue;
                if (strpos($line, ';') !== false) $line = substr($line, 0, strpos($line, ';'));
                if (strpos($line, '=') !== false) {
                    list($name, $value) = explode('=', $line, 2);
                    $config[trim($name)] = trim(trim($value), "\"'");
                }
            }
        }
    }
    return $config;
}

function get_db_standalone($config) {
    try {
        $dsn = sprintf("mysql:host=%s;port=%s;dbname=%s;charset=utf8mb4",
            $config['DB_HOST'] ?? 'localhost',
            $config['DB_PORT'] ?? '3306',
            $config['DB_DATABASE'] ?? ''
        );

        $options = [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_TIMEOUT => 5
        ];

        return new PDO($dsn, $config['DB_USERNAME'] ?? '', $config['DB_PASSWORD'] ?? '', $options);
    } catch (PDOException $e) {
        error_log("DATABASE ERROR: " . $e->getMessage());
        throw $e;
    }
}

// --- ‰ºòÂåñÁöÑËá™ÁÑ∂ËØ≠Ë®ÄËß£ÊûêÂô® ---
function parse_natural_lottery_data(string $text) {
    error_log("ÂºÄÂßãËß£ÊûêËá™ÁÑ∂ËØ≠Ë®ÄÂºÄÂ•ñÊï∞ÊçÆ");

    $lines = explode("\n", trim($text));
    if (count($lines) < 3) {
        error_log("Ëß£ÊûêÂ§±Ë¥•: Ë°åÊï∞‰∏çË∂≥");
        return null;
    }

    $lotteryType = '';
    $issueNumber = '';
    $winningNumbers = [];
    $zodiacs = [];
    $colors = [];

    // Ëß£ÊûêÁ¨¨‰∏ÄË°åÔºöÂΩ©Á•®Á±ªÂûãÂíåÊúüÂè∑
    $firstLine = trim($lines[0]);
    if (strpos($firstLine, 'Êñ∞Êæ≥Èó®ÂÖ≠ÂêàÂΩ©') !== false) {
        $lotteryType = 'Êñ∞Êæ≥Èó®ÂÖ≠ÂêàÂΩ©';
    } elseif (strpos($firstLine, 'È¶ôÊ∏ØÂÖ≠ÂêàÂΩ©') !== false) {
        $lotteryType = 'È¶ôÊ∏ØÂÖ≠ÂêàÂΩ©';
    } elseif (strpos($firstLine, 'ËÄÅÊæ≥') !== false) {
        $lotteryType = 'ËÄÅÊæ≥Èó®ÂÖ≠ÂêàÂΩ©';
    } else {
        error_log("Ëß£ÊûêÂ§±Ë¥•: Êó†Ê≥ïËØÜÂà´ÂΩ©Á•®Á±ªÂûã");
        return null;
    }

    // ÊèêÂèñÊúüÂè∑
    if (!preg_match('/Á¨¨:?(\d+)/', $firstLine, $matches)) {
        error_log("Ëß£ÊûêÂ§±Ë¥•: Êó†Ê≥ïÊèêÂèñÊúüÂè∑");
        return null;
    }
    $issueNumber = $matches[1];

    // Ëß£ÊûêÁ¨¨‰∫åË°åÔºöÂºÄÂ•ñÂè∑Á†Å
    $numbersLine = trim($lines[1]);
    preg_match_all('/\b\d+\b/', $numbersLine, $numberMatches);
    $winningNumbers = $numberMatches[0] ?? [];

    if (count($winningNumbers) < 6) {
        error_log("Ëß£ÊûêÂ§±Ë¥•: Âè∑Á†ÅÊï∞Èáè‰∏çË∂≥ - " . count($winningNumbers));
        return null;
    }

    // Ëß£ÊûêÁ¨¨‰∏âË°åÔºöÁîüËÇñ
    if (isset($lines[2])) {
        $zodiacLine = trim($lines[2]);
        $zodiacMap = [
            'Èº†' => 'Èº†', 'Áâõ' => 'Áâõ', 'Ëôé' => 'Ëôé', 'ÂÖî' => 'ÂÖî',
            'Èæç' => 'Èæô', 'Èæô' => 'Èæô', 'Ëõá' => 'Ëõá', 'È¶¨' => 'È©¨',
            'È©¨' => 'È©¨', 'Áæä' => 'Áæä', 'Áå¥' => 'Áå¥', 'Èõû' => 'È∏°',
            'È∏°' => 'È∏°', 'Áãó' => 'Áãó', 'Ë±¨' => 'Áå™', 'Áå™' => 'Áå™'
        ];

        $zodiacParts = preg_split('/\s+/', $zodiacLine);
        foreach ($zodiacParts as $part) {
            $part = trim($part);
            if (!empty($part) && isset($zodiacMap[$part])) {
                $zodiacs[] = $zodiacMap[$part];
            }
        }
    }

    // Ëß£ÊûêÁ¨¨ÂõõË°åÔºöÊ≥¢Ëâ≤
    if (isset($lines[3])) {
        $colorLine = trim($lines[3]);
        $colorMap = [
            'üî¥' => 'Á∫¢Ê≥¢', 'üü¢' => 'ÁªøÊ≥¢', 'üîµ' => 'ËìùÊ≥¢'
        ];

        $colorParts = preg_split('/\s+/', $colorLine);
        foreach ($colorParts as $part) {
            foreach ($colorMap as $emoji => $color) {
                if (strpos($part, $emoji) !== false) {
                    $colors[] = $color;
                    break;
                }
            }
        }
    }

    // Á°Æ‰øùÊï∞ÁªÑÈïøÂ∫¶ÂåπÈÖç
    if (count($zodiacs) !== count($winningNumbers)) {
        $zodiacs = array_fill(0, count($winningNumbers), 'Êú™Áü•');
    }

    if (count($colors) !== count($winningNumbers)) {
        $colors = array_fill(0, count($winningNumbers), 'Êú™Áü•');
    }

    error_log("Ëß£ÊûêÊàêÂäü: {$lotteryType} ÊúüÂè∑:{$issueNumber} Âè∑Á†Å:" . implode(',', $winningNumbers));

    return [
        'lottery_type' => $lotteryType,
        'issue_number' => $issueNumber,
        'winning_numbers' => $winningNumbers,
        'zodiac_signs' => $zodiacs,
        'colors' => $colors,
        'drawing_date' => date('Y-m-d')
    ];
}

// ASCII Ëß£ÊûêÂô®Ôºà‰øùÁïôÂÖºÂÆπÊÄßÔºâ
function parse_ascii_lottery_data(string $text) {
    $text = trim($text, "` \n\r\t\v\x00");

    if (strpos($text, 'lottery_result|') !== 0) {
        return null;
    }

    $parts = explode('|', $text);
    array_shift($parts);
    $data = [];

    foreach ($parts as $part) {
        if (strpos($part, ':') !== false) {
            list($key, $value) = explode(':', $part, 2);
            $data[$key] = $value;
        }
    }

    if (!isset($data['type']) || !isset($data['issue']) || !isset($data['nums'])) {
        return null;
    }

    $type_map = ['1' => 'È¶ôÊ∏ØÂÖ≠ÂêàÂΩ©', '2' => 'Êñ∞Êæ≥Èó®ÂÖ≠ÂêàÂΩ©', '3' => 'ËÄÅÊæ≥Èó®ÂÖ≠ÂêàÂΩ©'];
    $color_map_char = ['R' => 'Á∫¢Ê≥¢', 'G' => 'ÁªøÊ≥¢', 'B' => 'ËìùÊ≥¢'];
    $zodiac_map_char = [
        'S' => 'Èº†', 'N' => 'Áâõ', 'H' => 'Ëôé', 'T' => 'ÂÖî', 'L' => 'Èæô', 's' => 'Ëõá',
        'M' => 'È©¨', 'Y' => 'Áæä', 'h' => 'Áå¥', 'J' => 'È∏°', 'G' => 'Áãó', 'Z' => 'Áå™'
    ];

    $winning_numbers = explode(',', $data['nums']);
    $zodiacs_chars = isset($data['zodiacs']) ? explode(',', $data['zodiacs']) : [];
    $colors_chars = isset($data['colors']) ? explode(',', $data['colors']) : [];

    $colors = [];
    foreach ($colors_chars as $char) {
        $colors[] = $color_map_char[$char] ?? 'Êú™Áü•';
    }

    $zodiacs = [];
    foreach ($zodiacs_chars as $char) {
        $zodiacs[] = $zodiac_map_char[$char] ?? 'Êú™Áü•';
    }

    return [
        'lottery_type' => $type_map[$data['type']] ?? 'Êú™Áü•Á±ªÂûã',
        'issue_number' => $data['issue'],
        'winning_numbers' => $winning_numbers,
        'zodiac_signs' => $zodiacs,
        'colors' => $colors,
        'drawing_date' => date('Y-m-d')
    ];
}

function sendTelegramMessage($chatId, $text, $config) {
    $botToken = $config['TELEGRAM_BOT_TOKEN'] ?? '';
    if (!$botToken) return;

    $apiUrl = "https://api.telegram.org/bot{$botToken}/sendMessage";
    $data = [
        'chat_id' => $chatId,
        'text' => $text,
        'parse_mode' => 'HTML'
    ];

    $options = [
        'http' => [
            'header' => "Content-type: application/x-www-form-urlencoded\r\n",
            'method' => 'POST',
            'content' => http_build_query($data),
            'timeout' => 5
        ]
    ];

    $context = stream_context_create($options);
    @file_get_contents($apiUrl, false, $context);
}

// ‰∏ªÈÄªËæëÂºÄÂßã
try {
    $env_config = read_env_and_get_config();

    // ÂÆâÂÖ®È™åËØÅ
    $secret_from_env = $env_config['TELEGRAM_WEBHOOK_SECRET'] ?? null;
    $secret_from_get = $_GET['secret'] ?? null;

    if (!$secret_from_env || $secret_from_get !== $secret_from_env) {
        http_response_code(403);
        exit('Forbidden');
    }

    $input = file_get_contents('php://input');
    if (!$input) {
        http_response_code(200);
        echo "OK";
        exit;
    }

    $update = json_decode($input, true);
    if (json_last_error() !== JSON_ERROR_NONE) {
        http_response_code(200);
        echo "OK";
        exit;
    }

    // Â§ÑÁêÜÈ¢ëÈÅìÊ∂àÊÅØ
    if (isset($update['channel_post']['text'])) {
        $message_text = $update['channel_post']['text'];

        // È¶ñÂÖàÂ∞ùËØïËá™ÁÑ∂ËØ≠Ë®ÄËß£Êûê
        $parsedData = parse_natural_lottery_data($message_text);

        // Â¶ÇÊûúÂ§±Ë¥•ÔºåÂ∞ùËØïASCIIËß£Êûê
        if (!$parsedData) {
            $parsedData = parse_ascii_lottery_data($message_text);
        }

        if ($parsedData) {
            error_log("Ëß£ÊûêÊàêÂäü: {$parsedData['lottery_type']} ÊúüÂè∑:{$parsedData['issue_number']}");

            try {
                $pdo = get_db_standalone($env_config);
                $sql = "INSERT INTO lottery_results (lottery_type, issue_number, winning_numbers, zodiac_signs, colors, drawing_date)
                        VALUES (?, ?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE
                        winning_numbers=VALUES(winning_numbers), zodiac_signs=VALUES(zodiac_signs),
                        colors=VALUES(colors), drawing_date=VALUES(drawing_date),
                        created_at=CURRENT_TIMESTAMP";

                $stmt = $pdo->prepare($sql);
                $result = $stmt->execute([
                    $parsedData['lottery_type'],
                    $parsedData['issue_number'],
                    json_encode($parsedData['winning_numbers']),
                    json_encode($parsedData['zodiac_signs']),
                    json_encode($parsedData['colors']),
                    $parsedData['drawing_date']
                ]);

                if ($result) {
                    error_log("Êï∞ÊçÆÂ∫ìÊèíÂÖ•ÊàêÂäü: {$parsedData['issue_number']}");

                    // ÂèëÈÄÅÁ°ÆËÆ§Ê∂àÊÅØÁªôÁÆ°ÁêÜÂëò
                    $adminId = $env_config['TELEGRAM_ADMIN_ID'] ?? null;
                    if ($adminId) {
                        $confirmMsg = "‚úÖ ÂºÄÂ•ñÊï∞ÊçÆÂ∑≤‰øùÂ≠ò\n" .
                                     "üìä Á±ªÂûã: " . $parsedData['lottery_type'] . "\n" .
                                     "üé´ ÊúüÂè∑: " . $parsedData['issue_number'] . "\n" .
                                     "üî¢ Âè∑Á†Å: " . implode(', ', $parsedData['winning_numbers']);
                        sendTelegramMessage($adminId, $confirmMsg, $env_config);
                    }
                }

            } catch (PDOException $e) {
                error_log("Êï∞ÊçÆÂ∫ìÈîôËØØ: " . $e->getMessage());
            }
        }
    }
    // Â§ÑÁêÜÁßÅËÅäÊ∂àÊÅØ
    elseif (isset($update['message']['text'])) {
        $chatId = $update['message']['chat']['id'];
        $userId = $update['message']['from']['id'];
        $text = $update['message']['text'];

        $adminId = (int)($env_config['TELEGRAM_ADMIN_ID'] ?? 0);

        if ($userId === $adminId) {
            if ($text === '/start') {
                sendTelegramMessage($chatId, "üëã Ê¨¢ËøéÂõûÊù•ÔºåÁÆ°ÁêÜÂëòÔºÅÁ≥ªÁªüËøêË°åÊ≠£Â∏∏„ÄÇ", $env_config);
            } elseif ($text === '/status') {
                sendTelegramMessage($chatId, "‚úÖ Á≥ªÁªüÁä∂ÊÄÅÊ≠£Â∏∏\nüïí ÊúÄÂêéÊ£ÄÊü•: " . date('Y-m-d H:i:s'), $env_config);
            }
        }
    }

    http_response_code(200);
    echo "OK";

} catch (Throwable $e) {
    error_log("‰∏•ÈáçÈîôËØØ: " . $e->getMessage());
    http_response_code(200);
    echo "OK";
}
?>```
---
File: backend/telegram/parser.php
```
<?php
// File: backend/telegram/parser.php (Batch and Smart Parser Version)

// ÂºïÂÖ•Êàë‰ª¨ÁöÑËßÑÂàôÊñá‰ª∂
require_once __DIR__ . '/../lottery/rules.php';

/**
 * Êô∫ËÉΩÂú∞Ëß£ÊûêÊù•Ëá™ Telegram È¢ëÈÅìÁöÑÂºÄÂ•ñ‰ø°ÊÅØÊñáÊú¨ÔºåÊîØÊåÅÂçïÊù°Ê∂àÊÅØ‰∏≠ÂåÖÂê´Â§ö‰∏™ÂºÄÂ•ñÂÖ¨Âëä„ÄÇ
 *
 * @param string $text ÂÆåÊï¥ÁöÑÈ¢ëÈÅìÊ∂àÊÅØÊñáÊú¨„ÄÇ
 * @return array ËøîÂõû‰∏Ä‰∏™ÂåÖÂê´Èõ∂‰∏™ÊàñÂ§ö‰∏™Ëß£ÊûêÁªìÊûúÁöÑÊï∞ÁªÑ„ÄÇ
 */
function parse_lottery_data_batch(string $text): array {
    $color_map_emoji = ['üî¥' => 'Á∫¢Ê≥¢', 'üü¢' => 'ÁªøÊ≥¢', 'üîµ' => 'ËìùÊ≥¢'];
    $all_results = [];

    // 1. Â∞ÜÊï¥‰∏™ÊñáÊú¨ÂùóÊåâ "‰∏ÄÊ≥¢‰∏≠" ÊàñÁ±ª‰ººÁöÑÂÖ¨ÂëäÂºÄÂ§¥ËøõË°åÂàÜÂâ≤
    // ‰ΩøÁî® preg_split Âπ∂‰øùÁïôÂàÜÈöîÁ¨¶ÔºåËøôÊ†∑ÊØè‰∏™ÂùóÈÉΩÊòØÂÆåÊï¥ÁöÑ
    $blocks = preg_split('/(‰∏ÄÊ≥¢‰∏≠|.*?Á¨¨:.*ÊúüÂºÄÂ•ñÁªìÊûú:)/u', $text, -1, PREG_SPLIT_NO_EMPTY | PREG_SPLIT_DELIM_CAPTURE);

    // ÁªÑÂêàÂàÜÈöîÁ¨¶ÂíåÂÆÉ‰ª¨ÂØπÂ∫îÁöÑÂÜÖÂÆπÂùó
    for ($i = 0; $i < count($blocks); $i += 2) {
        if (!isset($blocks[$i+1])) continue;

        $block_text = $blocks[$i] . $blocks[$i+1];

        // 2. ÂØπÊØè‰∏™Áã¨Á´ãÁöÑÂÖ¨ÂëäÂùóËøõË°åËß£Êûê
        $pattern = '/(Êñ∞Êæ≥Èó®ÂÖ≠ÂêàÂΩ©|È¶ôÊ∏ØÂÖ≠ÂêàÂΩ©|ËÄÅÊæ≥.*?)Á¨¨:(\d+)\s*ÊúüÂºÄÂ•ñÁªìÊûú:\s*([\s\S]*)/u';

        if (!preg_match($pattern, $block_text, $matches)) {
            continue; // Â¶ÇÊûúËøô‰∏™Âùó‰∏çÂåπÈÖçÔºåË∑≥Âà∞‰∏ã‰∏Ä‰∏™
        }

        $lottery_type_raw = $matches[1];
        $issue_number = $matches[2];
        $results_block_text = trim($matches[3]);

        $lottery_type = (strpos($lottery_type_raw, 'ËÄÅÊæ≥') !== false) ? 'ËÄÅÊæ≥Èó®ÂÖ≠ÂêàÂΩ©' : trim($lottery_type_raw);
        $lines = array_values(array_filter(explode("\n", $results_block_text), 'trim'));

        // Ëá≥Â∞ëÈúÄË¶ÅÂè∑Á†ÅË°å
        if (count($lines) < 1) continue;

        $winning_numbers = preg_split('/\s+/', trim($lines[0]));

        // 3. Êô∫ËÉΩÊé®Êñ≠ÊàñËß£ÊûêÁîüËÇñÂíåÊ≥¢Ëâ≤
        $zodiac_signs = [];
        $colors = [];

        $has_zodiac_line = isset($lines[1]) && !preg_match('/[üî¥üü¢üîµ]/u', $lines[1]);
        $has_color_line = isset($lines[2]) || (isset($lines[1]) && preg_match('/[üî¥üü¢üîµ]/u', $lines[1]));

        // ‰ºòÂÖà‰ªéÊñáÊú¨‰∏≠Ëß£Êûê
        if ($has_zodiac_line) {
            $zodiac_signs = preg_split('/\s+/', trim($lines[1]));
        }
        if ($has_color_line) {
            $color_line = isset($lines[2]) ? $lines[2] : $lines[1];
            $raw_colors = preg_split('/\s+/', trim($color_line));
            $colors = array_map(fn($emoji) => $color_map_emoji[$emoji] ?? 'Êú™Áü•', $raw_colors);
        }

        // 4. Â¶ÇÊûúÁº∫Â∞ë‰ø°ÊÅØÔºåÂàô‰ΩøÁî®ËßÑÂàôËøõË°åÊé®Êñ≠
        foreach ($winning_numbers as $index => $number) {
            if (empty($zodiac_signs[$index])) {
                $zodiac_signs[$index] = get_zodiac_by_number($number) ?? 'Êú™Áü•';
            }
            if (empty($colors[$index]) || $colors[$index] === 'Êú™Áü•') {
                $colors[$index] = get_color_by_number($number) ?? 'Êú™Áü•';
            }
        }

        // 5. Êï∞ÊçÆÊ†°È™å
        if (count($winning_numbers) > 0 && count($winning_numbers) === count($zodiac_signs) && count($winning_numbers) === count($colors)) {
            $all_results[] = [
                'lottery_type' => $lottery_type,
                'issue_number' => $issue_number,
                'winning_numbers' => $winning_numbers,
                'zodiac_signs' => $zodiac_signs,
                'colors' => $colors,
                'drawing_date' => date('Y-m-d')
            ];
        }
    }

    return $all_results;
}
?>```
---
File: backend/api_header.php
```
<?php
// File: backend/api_header.php

if (defined('API_HEADER_LOADED')) return;
define('API_HEADER_LOADED', true);

// ‰ΩøÁî® config() ÂáΩÊï∞ÔºåÂπ∂Êèê‰æõ‰∏Ä‰∏™ÂÆâÂÖ®ÁöÑÂ§áÁî®ÂÄºÔºàÂ∞ΩÁÆ°Êàë‰ª¨ÊúüÊúõÂÆÉËÉΩËØªÂà∞Ê≠£Á°ÆÁöÑURLÔºâ
$frontend_url = config('FRONTEND_URL');

// Â¶ÇÊûú frontend_url ‰∏∫Á©∫ÊàñÊú™ËÆæÁΩÆÔºåÂàô‰∏çÂèëÈÄÅ‰ªª‰Ωï CORS Â§¥Ôºå‰ª•‰æøÂú®ÊµèËßàÂô®‰∏≠ÁúãÂà∞Êõ¥ÊòéÁ°ÆÁöÑÈîôËØØ
if ($frontend_url) {
    header("Access-Control-Allow-Origin: " . $frontend_url);
} else {
    // ÊïÖÊÑè‰∏çËÆæÁΩÆÔºåËøôÊ†∑ÊµèËßàÂô®‰ºöÊä•‰∏Ä‰∏™ÂÖ≥‰∫éÁº∫Â∞ëÂ§¥ÁöÑÈîôËØØÔºåËÄå‰∏çÊòØÂÖ≥‰∫é '*' ÁöÑÈîôËØØ
    // ËøôËÉΩÂ∏ÆÂä©Êàë‰ª¨Á°ÆËÆ§ÈóÆÈ¢òÂ∞±ÊòØ FRONTEND_URL Ê≤°ËØªÂà∞
}

header('Access-Control-Allow-Credentials: true');
header('Access-Control-Allow-Methods: GET, POST, OPTIONS, DELETE, PUT');
header('Access-Control-Allow-Headers: Content-Type, Authorization, X-Requested-With');

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(204);
    exit;
}

header('Content-Type: application/json');

if (session_status() === PHP_SESSION_NONE) {
    session_set_cookie_params([
        'lifetime' => 86400, 'path' => '/',
        'domain' => '', 'secure' => true,
        'httponly' => true, 'samesite' => 'None'
    ]);
    session_start();
}```
---
File: backend/migrations/add_line_number_column.php
```
<?php
// File: backend/migrations/add_line_number_column.php

require_once __DIR__ . '/../config.php';
require_once __DIR__ . '/../db_operations.php';

echo "ÂºÄÂßãÊ∑ªÂä† line_number ÂàóÂà∞ parsed_bets Ë°®...\n";

try {
    $pdo = get_db_connection();

    // Ê£ÄÊü•ÂàóÊòØÂê¶Â∑≤Â≠òÂú®
    $check_stmt = $pdo->query("SHOW COLUMNS FROM parsed_bets LIKE 'line_number'");
    if ($check_stmt->rowCount() > 0) {
        echo "line_number ÂàóÂ∑≤Â≠òÂú®ÔºåË∑≥ËøáËøÅÁßª„ÄÇ\n";
        exit(0);
    }

    // Ê∑ªÂä† line_number Âàó
    $sql = "ALTER TABLE parsed_bets ADD COLUMN line_number INT NULL AFTER ai_model_used";
    $pdo->exec($sql);

    echo "‚úÖ ÊàêÂäüÊ∑ªÂä† line_number ÂàóÂà∞ parsed_bets Ë°®\n";

} catch (PDOException $e) {
    echo "‚ùå ËøÅÁßªÂ§±Ë¥•: " . $e->getMessage() . "\n";
    exit(1);
}
?>```
---
File: backend/migrations/create_odds_template_table.php
```
<?php
// File: backend/migrations/create_odds_template_table.php

require_once __DIR__ . '/../config.php';
require_once __DIR__ . '/../db_operations.php';

echo "ÂºÄÂßãÂàõÂª∫ËµîÁéáÊ®°ÊùøË°®...\n";

try {
    $pdo = get_db_connection();

    // Ê£ÄÊü•Ë°®ÊòØÂê¶Â≠òÂú®
    $check_table = $pdo->query("SHOW TABLES LIKE 'user_odds_templates'");
    if ($check_table->rowCount() > 0) {
        echo "user_odds_templates Ë°®Â∑≤Â≠òÂú®ÔºåÊ£ÄÊü•ÂàóÁªìÊûÑ...\n";

        // Ê£ÄÊü•ÂêÑÂàóÊòØÂê¶Â≠òÂú®Ôºå‰∏çÂ≠òÂú®ÂàôÊ∑ªÂä†
        $columns_to_add = [
            'special_code_odds' => 'DECIMAL(8,2) NULL',
            'flat_special_odds' => 'DECIMAL(8,2) NULL',
            'serial_code_odds' => 'DECIMAL(8,2) NULL',
            'even_xiao_odds' => 'DECIMAL(8,2) NULL',
            'six_xiao_odds' => 'DECIMAL(8,2) NULL',
            'size_single_double_odds' => 'DECIMAL(8,2) NULL'
        ];

        foreach ($columns_to_add as $column => $type) {
            $check_column = $pdo->query("SHOW COLUMNS FROM user_odds_templates LIKE '{$column}'");
            if ($check_column->rowCount() === 0) {
                $sql = "ALTER TABLE user_odds_templates ADD COLUMN {$column} {$type}";
                $pdo->exec($sql);
                echo "‚úÖ ÊàêÂäüÊ∑ªÂä† {$column} Âàó\n";
            } else {
                echo "{$column} ÂàóÂ∑≤Â≠òÂú®ÔºåË∑≥Ëøá\n";
            }
        }

    } else {
        // ÂàõÂª∫Êñ∞Ë°®
        $sql = "
        CREATE TABLE IF NOT EXISTS `user_odds_templates` (
          `id` INT AUTO_INCREMENT PRIMARY KEY,
          `user_id` INT NOT NULL,
          `special_code_odds` DECIMAL(8,2) NULL,
          `flat_special_odds` DECIMAL(8,2) NULL,
          `serial_code_odds` DECIMAL(8,2) NULL,
          `even_xiao_odds` DECIMAL(8,2) NULL,
          `six_xiao_odds` DECIMAL(8,2) NULL,
          `size_single_double_odds` DECIMAL(8,2) NULL,
          `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
          `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
          FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE,
          UNIQUE KEY `user_id` (`user_id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
        ";

        $pdo->exec($sql);
        echo "‚úÖ ÊàêÂäüÂàõÂª∫ user_odds_templates Ë°®\n";
    }

    echo "‚úÖ ËµîÁéáÊ®°ÊùøË°®ÁªìÊûÑÊ£ÄÊü•ÂÆåÊàê\n";

} catch (PDOException $e) {
    echo "‚ùå ËøÅÁßªÂ§±Ë¥•: " . $e->getMessage() . "\n";
    exit(1);
}
?>```
---
File: backend/initialize_database.php
```
<?php
// File: backend/initialize_database.php (Final Corrected Version)

// ÂºÄÂêØÂëΩ‰ª§Ë°åÈîôËØØÊòæÁ§∫Ôºå‰ª•‰æøÁúãÂà∞‰ªª‰ΩïÈóÆÈ¢ò
ini_set('display_errors', 1);
error_reporting(E_ALL);

echo "--- Database Initialization Script ---\n\n";
echo "Step 1: Loading core files...\n";

// „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÁ°Æ‰øùÊâÄÊúâÂøÖË¶ÅÁöÑÊñá‰ª∂ÈÉΩË¢´Âä†ËΩΩ
// È¶ñÂÖàÂä†ËΩΩÈÖçÁΩÆÊñá‰ª∂ÔºåÂõ†‰∏∫ÂÆÉÂÆö‰πâ‰∫Ü config() ÂáΩÊï∞
require_once __DIR__ . '/config.php';
// ÁÑ∂ÂêéÂä†ËΩΩÊï∞ÊçÆÂ∫ìÊìç‰ΩúÊñá‰ª∂ÔºåÂõ†‰∏∫ÂÆÉÂÆö‰πâ‰∫Ü get_db_connection() ÂáΩÊï∞
require_once __DIR__ . '/db_operations.php';

echo "  [SUCCESS] All core files loaded.\n\n";

try {
    echo "Step 2: Getting database connection...\n";
    // Áé∞Âú® get_db_connection() ÂáΩÊï∞ËÇØÂÆöÊòØÂ∑≤ÂÆö‰πâÁöÑ
    $pdo = get_db_connection();
    echo "  [SUCCESS] Database connection established.\n\n";

    echo "Step 3: Reading schema file...\n";
    $sql_file_path = __DIR__ . '/database_schema.sql';
    if (!file_exists($sql_file_path)) {
        throw new Exception("File not found: {$sql_file_path}");
    }
    $sql = file_get_contents($sql_file_path);
    echo "  [SUCCESS] SQL schema file read.\n\n";

    echo "Step 4: Executing SQL to create tables...\n";
    $pdo->exec($sql);
    echo "  [SUCCESS] All tables created or already exist.\n\n";

} catch (Throwable $e) { // ÊçïËé∑ÊâÄÊúâÁ±ªÂûãÁöÑÈîôËØØ
    echo "\n[FAILURE] An error occurred during initialization:\n";
    echo "--------------------------------------------------\n";
    echo "Error Type: " . get_class($e) . "\n";
    echo "Message: " . $e->getMessage() . "\n";
    echo "File: " . $e->getFile() . "\n";
    echo "Line: " . $e->getLine() . "\n";
    echo "--------------------------------------------------\n";
    exit(1);
}

echo "--- Initialization Complete! ---\n";
?>```
---
File: backend/config.php
```
<?php
// File: backend/config.php (Final Debugging Version for FRONTEND_URL)

// ÂÆö‰πâ‰∏Ä‰∏™Ë∞ÉËØïÊó•ÂøóÊñá‰ª∂Ë∑ØÂæÑ
define('CONFIG_DEBUG_LOG', __DIR__ . '/config_debug.log');

// Âú®ËÑöÊú¨ÊâßË°åÊó∂ÔºåÂ¶ÇÊûúÊó•ÂøóÂ∑≤Â≠òÂú®ÔºåÂàô‰∏çÊ∏ÖÁ©∫Ôºå‰ª•‰æøÊàë‰ª¨ËøΩÂä†Êó•Âøó
// unlink(CONFIG_DEBUG_LOG);

function _log_config_debug($message) {
    error_log(date('[Y-m-d H:i:s] ') . $message . "\n", 3, CONFIG_DEBUG_LOG);
}

// ËÆ∞ÂΩïÂì™‰∏™Êñá‰ª∂Ê≠£Âú®Âä†ËΩΩ config.php
$caller = debug_backtrace()[0]['file'];
_log_config_debug("--- config.php loaded by: {$caller} ---");

if (!function_exists('config')) {
    function config(string $key, $default = null) {
        static $config = null;

        if ($config === null) {
            _log_config_debug("Static \$config is null. Initializing...");
            $config = [];
            $envPath = __DIR__ . '/.env';

            if (file_exists($envPath) && is_readable($envPath)) {
                $lines = file($envPath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
                if ($lines) {
                    foreach ($lines as $line) {
                        if (strpos(trim($line), ';') === 0) continue;
                        if (strpos($line, ';') !== false) {
                            $line = substr($line, 0, strpos($line, ';'));
                        }
                        if (strpos($line, '=') !== false) {
                            list($name, $value) = explode('=', $line, 2);
                            $name = trim($name);
                            $value = trim(trim($value), "\"'");
                            $config[$name] = $value;
                            if ($name === 'FRONTEND_URL') {
                                _log_config_debug("SUCCESS: Found and loaded [FRONTEND_URL] = [{$value}]");
                            }
                        }
                    }
                }
            } else {
                 _log_config_debug("FATAL: .env file not found or not readable.");
            }
        }

        $returnValue = $config[$key] ?? $default;
        _log_config_debug("config('{$key}') requested, returning: " . ($returnValue ?? 'NULL'));
        return $returnValue;
    }
}

// ... Error Handling ...
ini_set('display_errors', '0');
ini_set('log_errors', '1');
ini_set('error_log', __DIR__ . '/debug.log');
error_reporting(E_ALL);```
---
File: backend/db_operations.php
```
<?php
// File: backend/db_operations.php

if (defined('DB_OPERATIONS_LOADED')) return;
define('DB_OPERATIONS_LOADED', true);

function get_db_connection() {
    static $pdo = null;
    if ($pdo === null) {
        $dsn = sprintf("mysql:host=%s;port=%s;dbname=%s;charset=utf8mb4",
            config('DB_HOST'),
            config('DB_PORT'),
            config('DB_DATABASE')
        );

        $options = [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
            PDO::ATTR_EMULATE_PREPARES => false
        ];

        $pdo = new PDO($dsn, config('DB_USERNAME'), config('DB_PASSWORD'), $options);
    }
    return $pdo;
}
?>```
---
File: backend/ai_helper.php
```
<?php
// File: backend/ai_helper.php (‰ºòÂåñÁâà)

require_once __DIR__ . '/helpers/mail_parser.php';
require_once __DIR__ . '/db_operations.php';
require_once __DIR__ . '/lottery/rules.php';

/**
 * ÂàÜÊûêÈÇÆ‰ª∂ÂÜÖÂÆπÂπ∂ÊèêÂèñ‰∏ãÊ≥®‰ø°ÊÅØÔºåÂêåÊó∂ËøõË°åÁªìÁÆóËÆ°ÁÆó„ÄÇ
 */
function analyzeBetSlipWithAI(string $emailContent, string $lotteryType = 'È¶ôÊ∏ØÂÖ≠ÂêàÂΩ©'): array {
    $cleanBody = parse_email_body($emailContent);

    if ($cleanBody === 'Êó†Ê≥ïËß£ÊûêÈÇÆ‰ª∂Ê≠£Êñá') {
        return ['success' => false, 'message' => 'Failed to parse email body.'];
    }

    // Ëé∑ÂèñAIÂàÜÊûêÁªìÊûú
    $aiResult = analyzeWithCloudflareAI($cleanBody, $lotteryType);

    // Â¶ÇÊûúAIÂàÜÊûêÊàêÂäüÔºåËøõË°åÁªìÁÆóËÆ°ÁÆó
    if ($aiResult['success'] && isset($aiResult['data'])) {
        // Á°Æ‰øùAIËøîÂõûÁöÑÊï∞ÊçÆÂåÖÂê´ÂΩ©Á•®Á±ªÂûã
        if (!isset($aiResult['data']['lottery_type'])) {
            $aiResult['data']['lottery_type'] = $lotteryType;
        }

        $settlementResult = calculateSettlement($aiResult['data']);
        $aiResult['data']['settlement'] = $settlementResult;
    }

    return $aiResult;
}

/**
 * ËÆ°ÁÆóÁªìÁÆóÁªìÊûú
 */
function calculateSettlement(array $betData): array {
    // ÂºïÂÖ•Êï∞ÊçÆÂ∫ìÊìç‰ΩúÂíåÂºÄÂ•ñËßÑÂàô
    require_once __DIR__ . '/db_operations.php';
    require_once __DIR__ . '/lottery/rules.php';

    $lottery_type = $betData['lottery_type'] ?? 'È¶ôÊ∏ØÂÖ≠ÂêàÂΩ©';
    $issue_number = $betData['issue_number'] ?? null;

    if (!$issue_number) {
        return ['status' => 'error', 'message' => '‰∏ãÊ≥®Êï∞ÊçÆ‰∏≠Êú™ÊâæÂà∞ÊúüÂè∑ÔºåÊó†Ê≥ïÁªìÁÆó„ÄÇ'];
    }

    try {
        $pdo = get_db_connection();
        $stmt = $pdo->prepare("SELECT * FROM lottery_results WHERE lottery_type = ? AND issue_number = ?");
        $stmt->execute([$lottery_type, $issue_number]);
        $lottery_result = $stmt->fetch(PDO::FETCH_ASSOC);

        if (!$lottery_result) {
            return ['status' => 'error', 'message' => "Êú™ÊâæÂà∞ÂΩ©Á•®Á±ªÂûã '{$lottery_type}' Á¨¨ '{$issue_number}' ÊúüÁöÑÂºÄÂ•ñÁªìÊûú„ÄÇ"];
        }

        $winning_numbers = json_decode($lottery_result['winning_numbers'], true);
        $special_number = array_pop($winning_numbers);
        $normal_numbers = $winning_numbers;

        $total_bet_amount = 0;
        $total_win_amount = 0;
        $winning_details = [];

        foreach ($betData['bets'] as $bet) {
            $amount = floatval($bet['amount'] ?? 0);
            $bet_type = $bet['bet_type'] ?? '';
            $targets = $bet['targets'] ?? [];

            $bet_total = 0;
            if (in_array($bet_type, ['ÁâπÁ†Å', 'Âè∑Á†Å', 'Âπ≥Á†Å'])) {
                $bet_total = $amount * count($targets);
            } else {
                $bet_total = $amount; // ÁªÑÂêàÁé©Ê≥ïÂè™ÁÆó‰∏ÄÊ¨°
            }
            $total_bet_amount += $bet_total;

            switch ($bet_type) {
                case 'ÁâπÁ†Å':
                case 'Âè∑Á†Å':
                    foreach ($targets as $target) {
                        if ($target == $special_number) {
                            $odds = 45; // ÂÅáËÆæËµîÁéá
                            $win_amount = $amount * $odds;
                            $total_win_amount += $win_amount;
                            $winning_details[] = ['bet_type' => $bet_type, 'target' => $target, 'amount' => $amount, 'odds' => $odds, 'win_amount' => $win_amount];
                        }
                    }
                    break;

                case 'Âπ≥Á†Å':
                    foreach ($targets as $target) {
                        if (in_array($target, $normal_numbers)) {
                            $odds = 7; // ÂÅáËÆæËµîÁéá
                            $win_amount = $amount * $odds;
                            $total_win_amount += $win_amount;
                            $winning_details[] = ['bet_type' => $bet_type, 'target' => $target, 'amount' => $amount, 'odds' => $odds, 'win_amount' => $win_amount];
                        }
                    }
                    break;

                case 'ÁîüËÇñ':
                    $special_zodiac = get_zodiac_by_number($special_number);
                    foreach ($targets as $target_zodiac) {
                        if ($target_zodiac == $special_zodiac) {
                            $odds = 11; // ÂÅáËÆæËµîÁéá
                            $win_amount = $amount * $odds;
                            $total_win_amount += $win_amount;
                            $winning_details[] = ['bet_type' => $bet_type, 'target' => $target_zodiac, 'amount' => $amount, 'odds' => $odds, 'win_amount' => $win_amount];
                        }
                    }
                    break;

                case 'Ëâ≤Ê≥¢':
                    $special_color = get_color_by_number($special_number);
                    foreach ($targets as $target_color) {
                        if (strpos($special_color, $target_color) !== false) {
                            $odds = 2.8; // ÂÅáËÆæËµîÁéá
                            $win_amount = $amount * $odds;
                            $total_win_amount += $win_amount;
                            $winning_details[] = ['bet_type' => $bet_type, 'target' => $target_color, 'amount' => $amount, 'odds' => $odds, 'win_amount' => $win_amount];
                        }
                    }
                    break;
            }
        }

        $net_profit = $total_win_amount - $total_bet_amount;

        return [
            'status' => 'success',
            'total_bet_amount' => $total_bet_amount,
            'total_win_amount' => $total_win_amount,
            'net_profit' => $net_profit,
            'winning_details' => $winning_details,
            'summary' => "ÊÄª‰∏ãÊ≥®: {$total_bet_amount}ÂÖÉ, ÊÄª‰∏≠Â•ñ: {$total_win_amount}ÂÖÉ, ÂáÄÂà©Ê∂¶: {$net_profit}ÂÖÉ.",
            'lottery_result' => $lottery_result
        ];

    } catch (PDOException $e) {
        return ['status' => 'error', 'message' => 'Êï∞ÊçÆÂ∫ìËøûÊé•Â§±Ë¥•: ' . $e->getMessage()];
    } catch (Exception $e) {
        return ['status' => 'error', 'message' => 'ÁªìÁÆóËøáÁ®ã‰∏≠ÂèëÁîüÊú™Áü•ÈîôËØØ: ' . $e->getMessage()];
    }
}

/**
 * ‰ΩøÁî® Cloudflare AI ËøõË°åÂàÜÊûê - ÈíàÂØπ‰Ω†ÁöÑ‰∏ãÊ≥®Ê†ºÂºè‰ºòÂåñÔºåÊîØÊåÅÂΩ©Á•®Á±ªÂûã
 */
function analyzeWithCloudflareAI(string $text, string $lotteryType = 'È¶ôÊ∏ØÂÖ≠ÂêàÂΩ©'): array {
    $accountId = config('CLOUDFLARE_ACCOUNT_ID');
    $apiToken = config('CLOUDFLARE_API_TOKEN');

    if (!$accountId || !$apiToken) {
        return ['success' => false, 'message' => 'Cloudflare AI credentials not configured.'];
    }

    $model = '@cf/meta/llama-3-8b-instruct';
    $url = "https://api.cloudflare.com/client/v4/accounts/{$accountId}/ai/run/{$model}";

    // ÈíàÂØπ‰Ω†ÁöÑ‰∏ãÊ≥®Ê†ºÂºè‰ºòÂåñÁöÑÊèêÁ§∫ËØçÔºåÂåÖÂê´ÂΩ©Á•®Á±ªÂûã‰ø°ÊÅØ
    $prompt = "‰Ω†ÊòØ‰∏Ä‰∏™‰∏ì‰∏öÁöÑÂÖ≠ÂêàÂΩ©‰∏ãÊ≥®ÂçïËØÜÂà´Âä©Êâã„ÄÇËØ∑‰ªé‰ª•‰∏ãÂæÆ‰ø°ËÅäÂ§©ËÆ∞ÂΩï‰∏≠Á≤æÁ°ÆËØÜÂà´Âá∫‰∏ãÊ≥®‰ø°ÊÅØ„ÄÇ\n\nÁâπÂà´Ê≥®ÊÑè‰ª•‰∏ã‰∏ãÊ≥®Ê†ºÂºèÔºö\n1. \"Êæ≥Èó®36,48ÂêÑ30#Ôºå12,24ÂêÑ10#\" ‚Üí Ë°®Á§∫Êæ≥Èó®ÂÖ≠ÂêàÂΩ©ÔºåÂè∑Á†Å36Âíå48ÂêÑ‰∏ãÊ≥®30ÂÖÉÔºåÂè∑Á†Å12Âíå24ÂêÑ‰∏ãÊ≥®10ÂÖÉ\n2. \"Èº†ÔºåÈ∏°Êï∞ÂêÑ‰∫åÂçÅÔºåÂÖîÔºåÈ©¨Êï∞ÂêÑ‰∫îÂÖÉ\" ‚Üí Ë°®Á§∫ÁîüËÇñÈº†ÂíåÈ∏°ÂêÑ‰∏ãÊ≥®20ÂÖÉÔºåÁîüËÇñÂÖîÂíåÈ©¨ÂêÑ‰∏ãÊ≥®5ÂÖÉ\n3. \"È¶ôÊ∏ØÔºö10.22.34.46.04.16.28.40.02.14.26.38.13.25.37.01.23.35.15.27ÂêÑ5Âùó\" ‚Üí Ë°®Á§∫È¶ôÊ∏ØÂÖ≠ÂêàÂΩ©ÔºåËøô‰∫õÂè∑Á†ÅÂêÑ‰∏ãÊ≥®5ÂÖÉ\n4. \"Êæ≥Èó®„ÄÅ40√ó10ÂÖÉ„ÄÅ39„ÄÅ30„ÄÅÂêÑ5ÂÖÉ„ÄÅÈ¶ôÊ∏Ø„ÄÅ40√ó10ÂÖÉ„ÄÅ02„ÄÅ04„ÄÅ09„ÄÅ45„ÄÅÂêÑ5ÂÖÉ\" ‚Üí Ë°®Á§∫Ê∑∑Âêà‰∏ãÊ≥®ÔºåÂåÖÂê´Êæ≥Èó®ÂíåÈ¶ôÊ∏Ø\n\nÂΩìÂâçÂΩ©Á•®Á±ªÂûã: {$lotteryType}\n\nËØ∑‰ª•‰∏•Ê†ºÁöÑJSONÊ†ºÂºèËøîÂõûËØÜÂà´ÁªìÊûúÔºö\n\n{\n    \"lottery_type\": \"{$lotteryType}\",\n    \"issue_number\": \"ÊúüÂè∑ÔºàÂ¶ÇÊûúÊèêÂà∞Ôºâ\",\n    \"bets\": [\n        {\n            \"bet_type\": \"‰∏ãÊ≥®Áé©Ê≥ïÔºàÁâπÁ†Å/Âπ≥Á†Å/ÁîüËÇñ/Ëâ≤Ê≥¢/ËøûËÇñ/ÂÖ≠ËÇñÔºâ\",\n            \"targets\": [\"‰∏ãÊ≥®Âè∑Á†ÅÊàñÁõÆÊ†á\"],\n            \"amount\": ‰∏ãÊ≥®ÈáëÈ¢ù,\n            \"raw_text\": \"ÂéüÂßã‰∏ãÊ≥®ÊñáÊú¨\",\n            \"lottery_type\": \"ÂΩ©Á•®Á±ªÂûãÔºàÊæ≥Èó®ÂÖ≠ÂêàÂΩ©/È¶ôÊ∏ØÂÖ≠ÂêàÂΩ©Ôºâ\"\n        }\n    ],\n    \"total_amount\": ÊÄª‰∏ãÊ≥®ÈáëÈ¢ù\n}\n\nÈáçË¶ÅËßÑÂàôÔºö\n1. ‰øùÊåÅ‰∏ãÊ≥®ÂçïÁöÑÂÆåÊï¥ÊÄßÔºå‰∏çË¶ÅÂ∞Ü‰∏ÄÊù°‰∏ãÊ≥®ÊãÜÂàÜÊàêÂ§ö‰∏™\n2. Â¶ÇÊûú‰∏ãÊ≥®Âçï‰∏≠ÊòéÁ°ÆÊèêÂà∞‰∫ÜÂΩ©Á•®Á±ªÂûãÔºàÂ¶Ç\"Êæ≥Èó®\"„ÄÅ\"È¶ôÊ∏Ø\"ÔºâÔºå‰ΩøÁî®ÊèêÂà∞ÁöÑÁ±ªÂûã\n3. Â¶ÇÊûúÊ≤°ÊúâÊòéÁ°ÆÊèêÂà∞Ôºå‰ΩøÁî®Êèê‰æõÁöÑÈªòËÆ§Á±ªÂûãÔºö{$lotteryType}\n4. ÂØπ‰∫é\"ÂêÑXÂÖÉ\"ÁöÑÊ†ºÂºèÔºåË°®Á§∫ÊØè‰∏™ÁõÆÊ†á‰∏ãÊ≥®XÂÖÉ\n5. ÂØπ‰∫é\"X√óYÂÖÉ\"ÁöÑÊ†ºÂºèÔºåË°®Á§∫Âè∑Á†ÅX‰∏ãÊ≥®YÂÖÉ\n\nËÅäÂ§©ËÆ∞ÂΩïÂéüÊñáÔºö\n---\n{$text}\n---";

    $payload = [
        'messages' => [
            ['role' => 'system', 'content' => '‰Ω†ÊòØ‰∏Ä‰∏™Âè™ËæìÂá∫‰∏•Ê†ºJSONÊ†ºÂºèÁöÑÂä©ÊâãÔºåÂøÖÈ°ªÊåâÁÖßÊåáÂÆöÁöÑJSONÊ†ºÂºèËøîÂõûÊï∞ÊçÆ„ÄÇËØ∑ÂáÜÁ°ÆËØÜÂà´ÂÖ≠ÂêàÂΩ©‰∏ãÊ≥®‰ø°ÊÅØÔºå‰øùÊåÅ‰∏ãÊ≥®ÂçïÁöÑÂÆåÊï¥ÊÄß„ÄÇ'],
            ['role' => 'user', 'content' => $prompt]
        ],
        'max_tokens' => 2000
    ];

    $headers = [
        'Authorization: Bearer ' . $apiToken,
        'Content-Type: ' . 'application/json',
    ];

    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($payload));
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_TIMEOUT, 60);

    $responseBody = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $curlError = curl_error($ch);
    curl_close($ch);

    // ËÆ∞ÂΩïAIË∞ÉÁî®Êó•Âøó
    error_log("AI API Call - HTTP Code: {$httpCode}, Response: {$responseBody}");

    if ($httpCode !== 200) {
        return [
            'success' => false,
            'message' => "Cloudflare AI API Error (HTTP {$httpCode}): " . $responseBody,
            'curl_error' => $curlError
        ];
    }

    $responseData = json_decode($responseBody, true);
    $ai_response_text = $responseData['result']['response'] ?? null;

    if (!$ai_response_text) {
        return [
            'success' => false,
            'message' => 'Invalid response structure from Cloudflare AI.',
            'raw_response' => $responseBody
        ];
    }

    // ËÆ∞ÂΩïAIÂéüÂßãÂìçÂ∫î
    error_log("AI Raw Response: " . $ai_response_text);

    // ÊèêÂèñJSON - Êõ¥ÂÆΩÊùæÁöÑÂåπÈÖç
    preg_match('/\{(?:[^{}]|(?R))*\}/', $ai_response_text, $matches);

    if (empty($matches)) {
        // Â∞ùËØïÊõ¥ÂÆΩÊùæÁöÑÂåπÈÖç
        preg_match('/\{[\s\S]*\}/', $ai_response_text, $matches);
    }

    if (empty($matches)) {
        return [
            'success' => false,
            'message' => 'AI did not return a valid JSON object.',
            'raw_response' => $ai_response_text
        ];
    }

    $bet_data = json_decode($matches[0], true);

    if (json_last_error() !== JSON_ERROR_NONE) {
        return [
            'success' => false,
            'message' => 'Failed to decode JSON from AI response: ' . json_last_error_msg(),
            'raw_json' => $matches[0]
        ];
    }

    // Á°Æ‰øùÂΩ©Á•®Á±ªÂûãÊ≠£Á°ÆËÆæÁΩÆ
    if (!isset($bet_data['lottery_type'])) {
        $bet_data['lottery_type'] = $lotteryType;
    }

    // Âº∫Âà∂ËÅöÂêàÁõ∏ÂêåÈáëÈ¢ùÁöÑ‰∏ãÊ≥®È°π
    if (isset($bet_data['bets']) && is_array($bet_data['bets'])) {
        $aggregatedBets = [];

        // ÊåâÈáëÈ¢ùÂàÜÁªÑËÅöÂêà
        $betGroups = [];
        foreach ($bet_data['bets'] as $bet) {
            $amount = floatval($bet['amount'] ?? 0);
            $betType = $bet['bet_type'] ?? 'ÁâπÁ†Å';

            $key = $betType . '|' . $amount;

            if (!isset($betGroups[$key])) {
                $betGroups[$key] = [
                    'bet_type' => $betType,
                    'amount' => $amount,
                    'targets' => [],
                    'raw_text' => '',
                    'lottery_type' => $bet['lottery_type'] ?? $bet_data['lottery_type']
                ];
            }

            // ÂêàÂπ∂ÁõÆÊ†á
            if (isset($bet['targets']) && is_array($bet['targets'])) {
                $betGroups[$key]['targets'] = array_merge($betGroups[$key]['targets'], $bet['targets']);
            }

            // ÂêàÂπ∂ÂéüÂßãÊñáÊú¨
            if (isset($bet['raw_text'])) {
                $betGroups[$key]['raw_text'] .= ' ' . $bet['raw_text'];
            }
        }

        // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÂπ∂ËÆ°ÁÆóÊØè‰∏™ÁªÑÂêàÁöÑÊÄª‰∏ãÊ≥®
        foreach ($betGroups as $key => $group) {
            $targetCount = count($group['targets']);
            if ($group['bet_type'] === 'ÁâπÁ†Å' || $group['bet_type'] === 'Âè∑Á†Å' || $group['bet_type'] === 'Âπ≥Á†Å') {
                $group['total_bet'] = $group['amount'] * $targetCount;
            } else {
                $group['total_bet'] = $group['amount']; // ÁªÑÂêàÁé©Ê≥ïÂè™ÁÆó‰∏ÄÊ¨°
            }

            $aggregatedBets[] = $group;
        }

        $bet_data['bets'] = $aggregatedBets;

        // ÈáçÊñ∞ËÆ°ÁÆóÊÄªÈáëÈ¢ù
        $totalAmount = 0;
        foreach ($aggregatedBets as $bet) {
            $totalAmount += $bet['total_bet'];
        }
        $bet_data['total_amount'] = $totalAmount;
    }

    return [
        'success' => true,
        'data' => $bet_data,
        'model' => $model,
        'raw_ai_response' => $ai_response_text
    ];
}


/**
 * ÊâãÂä®ÈáçÊñ∞Ëß£ÊûêÈÇÆ‰ª∂ÁöÑÂáΩÊï∞
 */
function reanalyzeEmailWithAI(int $emailId): array {
    try {
        require_once __DIR__ . '/config.php';
        require_once __DIR__ . '/db_operations.php';

        $pdo = get_db_connection();

        // Ëé∑ÂèñÈÇÆ‰ª∂ÂÜÖÂÆπ
        $stmt = $pdo->prepare("SELECT content FROM raw_emails WHERE id = ?");
        $stmt->execute([$emailId]);
        $emailContent = $stmt->fetchColumn();

        if (!$emailContent) {
            return ['success' => false, 'message' => 'Email not found'];
        }

        // Ë∞ÉÁî®AIÂàÜÊûê
        $aiResult = analyzeBetSlipWithAI($emailContent);

        if ($aiResult['success']) {
            // Âà†Èô§ÊóßÁöÑËß£ÊûêËÆ∞ÂΩï
            $stmtDelete = $pdo->prepare("DELETE FROM parsed_bets WHERE email_id = ?");
            $stmtDelete->execute([$emailId]);

            // ÊèíÂÖ•Êñ∞ÁöÑËß£ÊûêËÆ∞ÂΩï
            $model_used = $aiResult['model'] ?? 'unknown_model';
            $bet_data_json = json_encode($aiResult['data']);

            $stmtInsert = $pdo->prepare("INSERT INTO parsed_bets (email_id, bet_data_json, ai_model_used) VALUES (?, ?, ?)");
            $stmtInsert->execute([$emailId, $bet_data_json, $model_used]);

            // Êõ¥Êñ∞ÈÇÆ‰ª∂Áä∂ÊÄÅ
            $stmtUpdate = $pdo->prepare("UPDATE raw_emails SET status = 'processed' WHERE id = ?");
            $stmtUpdate->execute([$emailId]);

            return [
                'success' => true,
                'message' => 'ÈáçÊñ∞Ëß£ÊûêÊàêÂäü',
                'batch_id' => $pdo->lastInsertId()
            ];
        } else {
            // Êõ¥Êñ∞ÈÇÆ‰ª∂Áä∂ÊÄÅ‰∏∫Â§±Ë¥•
            $stmtUpdate = $pdo->prepare("UPDATE raw_emails SET status = 'failed' WHERE id = ?");
            $stmtUpdate->execute([$emailId]);

            return [
                'success' => false,
                'message' => 'AIËß£ÊûêÂ§±Ë¥•: ' . ($aiResult['message'] ?? 'Êú™Áü•ÈîôËØØ')
            ];
        }

    } catch (Exception $e) {
        return [
            'success' => false,
            'message' => 'ÈáçÊñ∞Ëß£ÊûêËøáÁ®ã‰∏≠Âá∫Èîô: ' . $e->getMessage()
        ];
    }
}

/**
 * ‰∏ìÈó®Áî®‰∫éÂçïÊù°‰∏ãÊ≥®Ëß£ÊûêÁöÑAIÂáΩÊï∞
 */
function analyzeSingleBetWithAI(string $betText, string $lotteryType = 'È¶ôÊ∏ØÂÖ≠ÂêàÂΩ©'): array {
    return analyzeBetSlipWithAI($betText, $lotteryType);
}

// Âú® ai_helper.php ‰∏≠Ê∑ªÂä†Â≠¶‰π†ÂáΩÊï∞
function trainAIWithCorrection($learning_data) {
    $accountId = config('CLOUDFLARE_ACCOUNT_ID');
    $apiToken = config('CLOUDFLARE_API_TOKEN');

    if (!$accountId || !$apiToken) {
        return false;
    }

    $model = '@cf/meta/llama-3-8b-instruct';
    $url = "https://api.cloudflare.com/client/v4/accounts/{$accountId}/ai/run/{$model}";

    $prompt = "Ê†πÊçÆ‰ª•‰∏ã‰øÆÊ≠£Êï∞ÊçÆÂ≠¶‰π†Â¶Ç‰ΩïÊõ¥Â•ΩÂú∞Ëß£ÊûêÂÖ≠ÂêàÂΩ©‰∏ãÊ≥®ÂçïÔºö

ÂéüÂßãÊñáÊú¨: {$learning_data['original_text']}\nÂéüÂßãËß£ÊûêÈáëÈ¢ù: {$learning_data['original_parse']['bets'][0]['amount']} ÂÖÉ\n‰øÆÊ≠£ÂêéÈáëÈ¢ù: {$learning_data['corrected_parse']['bets'][0]['amount']} ÂÖÉ\n‰øÆÊ≠£ÂéüÂõ†: {$learning_data['corrected_parse']['correction']['correction_reason']}\n\nËØ∑Â≠¶‰π†Ëøô‰∏™‰øÆÊ≠£ÔºåÂú®Â∞ÜÊù•ÈÅáÂà∞Á±ª‰ºº‰∏ãÊ≥®ÂçïÊó∂‰ΩøÁî®‰øÆÊ≠£ÂêéÁöÑÈáëÈ¢ùÊ®°Âºè„ÄÇ";

    $payload = [
        'messages' => [
            ['role' => 'system', 'content' => '‰Ω†ÊòØ‰∏Ä‰∏™ÂÖ≠ÂêàÂΩ©‰∏ãÊ≥®ÂçïËß£ÊûêAIÔºåÊ≠£Âú®Â≠¶‰π†Áî®Êà∑ÁöÑ‰øÆÊ≠£‰ª•ÊèêÈ´òËß£ÊûêÂáÜÁ°ÆÊÄß„ÄÇ'],
            ['role' => 'user', 'content' => $prompt]
        ],
        'max_tokens' => 500
    ];

    // ÂèëÈÄÅÂ≠¶‰π†ËØ∑Ê±Ç
    $headers = [
        'Authorization: Bearer ' . $apiToken,
        'Content-Type: ' . 'application/json',
    ];

    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($payload));
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);

    $response = curl_exec($ch);
    curl_close($ch);

    error_log("AI Learning Response: " . $response);
    return true;
}
```
---
File: backend/setup_bot.php
```
<?php
// File: backend/setup_bot.php (Final version that reads from .env)

// --- Áã¨Á´ãÁöÑ .env Âä†ËΩΩÂô® (Âíå receiver.php ‰∏≠ÈÇ£‰∏™‰∏ÄÊ†∑) ---
function load_env_for_setup() {
    $envPath = __DIR__ . '/.env';
    if (!file_exists($envPath)) {
        die("Error: .env file not found in " . __DIR__);
    }
    $lines = file($envPath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    if (!$lines) {
        die("Error: Could not read .env file.");
    }
    foreach ($lines as $line) {
        if (strpos(trim($line), ';') === 0) continue;
        if (strpos($line, ';') !== false) $line = substr($line, 0, strpos($line, ';'));
        if (strpos($line, '=') !== false) {
            list($name, $value) = explode('=', $line, 2);
            // ËøôÈáåÊàë‰ª¨Âè™ÈúÄË¶Å getenv ËÉΩÂ∑•‰ΩúÂ∞±Ë°å
            putenv(trim($name) . "=" . trim(trim($value), "\"'"));
        }
    }
}

// Âä†ËΩΩÈÖçÁΩÆ
load_env_for_setup();

$bot_token = getenv('TELEGRAM_BOT_TOKEN');
$webhook_secret = getenv('TELEGRAM_WEBHOOK_SECRET'); // ‰ªé .env ËØªÂèñÊñ∞ÂØÜÈí•

if (!$bot_token || !$webhook_secret) {
    die("Error: TELEGRAM_BOT_TOKEN or TELEGRAM_WEBHOOK_SECRET not found in .env file.");
}

// Áõ¥Êé•ÊåáÂêëÊàë‰ª¨ËΩªÈáèÁ∫ßÁöÑ receiver.php
$webhook_url = "https://wenge.cloudns.ch/telegram/receiver.php?secret=" . urlencode($webhook_secret);

$api_url = "https://api.telegram.org/bot{$bot_token}/setWebhook?url=" . urlencode($webhook_url);

// Ë∞ÉÁî® API Âπ∂ÊòæÁ§∫ÁªìÊûú
$response = file_get_contents($api_url);
header('Content-Type: application/json');
echo $response;
?>```
---
File: backend/index.php
```
<?php
// File: backend/index.php (Ë∑ØÁî±Êõ¥Êñ∞)

/**
 * Main API Entry Point.
 * This script is responsible for loading core dependencies and routing
 * requests to the appropriate endpoint handlers.
 */

// --- 1. Load ALL core dependencies in one place, in the correct order ---

// config.php defines the config() helper function and sets up error logging.
require_once __DIR__ . '/config.php';

// db_operations.php defines get_db_connection() and uses the config() helper.
require_once __DIR__ . '/db_operations.php';

// api_header.php handles CORS headers, session start, and content type. It also uses config().
require_once __DIR__ . '/api_header.php';


// --- 2. Get endpoint parameter from the URL ---
$endpoint = $_GET['endpoint'] ?? null;

if ($endpoint === null) {
    http_response_code(400); // Bad Request
    echo json_encode(['status' => 'error', 'message' => 'Missing endpoint parameter.']);
    exit();
}


// --- 3. Define the routing map ---
// This array maps the 'endpoint' string to the physical PHP file.
$routes = [
    // Authentication endpoints
    'register'              => 'auth/register.php',
    'login'                 => 'auth/login.php',
    'logout'                => 'auth/logout.php',
    'check_session'         => 'auth/check_session.php',

    // Email related endpoints
    'get_emails'            => 'auth/get_emails.php',
    'get_email_details'     => 'auth/get_email_details.php',
    'update_bet_batch'      => 'auth/update_bet_batch.php',
    'reanalyze_email'       => 'auth/reanalyze_email.php',
    'download_settlement'   => 'auth/download_settlement.php',
    'smart_parse_email'     => 'auth/smart_parse_email.php',
    'parse_single_bet'      => 'auth/parse_single_bet.php', // Êñ∞Â¢ûÂçïÊù°Ëß£ÊûêË∑ØÁî±
    'split_email_lines'     => 'auth/split_email_lines.php', // Êñ∞Â¢ûÈÇÆ‰ª∂ÊãÜÂàÜË∑ØÁî±

    // Lottery related endpoints
    'get_lottery_results'       => 'lottery/get_results.php',
    'get_lottery_result_by_issue' => 'lottery/get_result_by_issue.php',

    // Odds template endpoints
    'odds_template'         => 'auth/odds_template.php',
];


// --- 4. Route the request ---
if (isset($routes[$endpoint])) {
    // If the endpoint is valid, include the corresponding handler file.
    require_once __DIR__ . '/' . $routes[$endpoint];
} else {
    // If the endpoint is not found in our map, return a 404 error.
    http_response_code(404); // Not Found
    echo json_encode(['status' => 'error', 'message' => 'Endpoint not found.']);
}

// --- 5. Log the request for debugging ---
if (defined('MAIL_LOG_FILE')) {
    $log_message = sprintf(
        "API Request: %s %s - Endpoint: %s - User: %s\n",
        $_SERVER['REQUEST_METHOD'],
        $_SERVER['REQUEST_URI'],
        $endpoint ?? 'none',
        $_SESSION['user_id'] ?? 'guest'
    );
    error_log($log_message, 3, MAIL_LOG_FILE);
}
?>
```
