--- FILE: backend/auth/login.php ---
<?php
// File: backend/auth/login.php

require_once __DIR__ . '/../db_operations.php';

// 1. è·å– POST è¯·æ±‚çš„ JSON æ•°æ®
$data = json_decode(file_get_contents('php://input'), true);
$email = $data['email'] ?? null;
$password = $data['password'] ?? null;

// 2. åŸºæœ¬éªŒè¯
if (empty($email) || empty($password)) {
    http_response_code(400); // Bad Request
    echo json_encode(['status' => 'error', 'message' => 'é‚®ç®±å’Œå¯†ç ä¸èƒ½ä¸ºç©ºã€‚']);
    exit;
}

try {
    // 3. ä»æ•°æ®åº“ä¸­æŸ¥æ‰¾ç”¨æˆ·
    $pdo = get_db_connection();
    $stmt = $pdo->prepare("SELECT id, email, password_hash, status FROM users WHERE email = ?");
    $stmt->execute([$email]);
    $user = $stmt->fetch(PDO::FETCH_ASSOC);

    // 4. éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨ã€å¯†ç æ˜¯å¦æ­£ç¡®ä»¥åŠè´¦æˆ·çŠ¶æ€
    if ($user && password_verify($password, $user['password_hash'])) {

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«å°ç¦
        if ($user['status'] === 'banned') {
            http_response_code(403); // Forbidden
            echo json_encode(['status' => 'error', 'message' => 'æ‚¨çš„è´¦æˆ·å·²è¢«å°ç¦ã€‚']);
            exit;
        }

        // 5. å¯†ç æ­£ç¡®ï¼Œåˆ›å»º Session
        // api_header.php å·²ç»è°ƒç”¨äº† session_start()
        session_regenerate_id(true); // é˜²æ­¢ä¼šè¯å›ºå®šæ”»å‡»
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['user_email'] = $user['email'];

        // 6. è¿”å›æˆåŠŸå“åº”å’Œç”¨æˆ·ä¿¡æ¯
        http_response_code(200);
        echo json_encode([
            'status' => 'success',
            'message' => 'ç™»å½•æˆåŠŸï¼',
            'user' => [
                'id' => $user['id'],
                'email' => $user['email']
            ]
        ]);

    } else {
        // ç”¨æˆ·ä¸å­˜åœ¨æˆ–å¯†ç é”™è¯¯
        http_response_code(401); // Unauthorized
        echo json_encode(['status' => 'error', 'message' => 'é‚®ç®±æˆ–å¯†ç é”™è¯¯ã€‚']);
    }

} catch (PDOException $e) {
    // æ•°æ®åº“é”™è¯¯
    error_log("Login Error: " . $e->getMessage()); // è®°å½•é”™è¯¯æ—¥å¿—
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚']);
}
?>
--- FILE: backend/auth/logout.php ---
<?php
// File: backend/auth/logout.php

// api_header.php å·²ç»å¯åŠ¨äº† session, æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥æ“ä½œå®ƒ

// 1. æ¸…ç©ºæ‰€æœ‰ session å˜é‡
$_SESSION = [];

// 2. åˆ é™¤ session cookie
// è¿™æ˜¯ç¡®ä¿æµè§ˆå™¨åˆ é™¤ä¼šè¯æ ‡è¯†çš„å…³é”®æ­¥éª¤
if (ini_get("session.use_cookies")) {
    $params = session_get_cookie_params();
    setcookie(session_name(), '', time() - 42000,
        $params["path"], $params["domain"],
        $params["secure"], $params["httponly"]
    );
}

// 3. é”€æ¯æœåŠ¡å™¨ä¸Šçš„ session æ•°æ®
session_destroy();

// 4. è¿”å›æˆåŠŸå“åº”
http_response_code(200);
echo json_encode(['status' => 'success', 'message' => 'ç™»å‡ºæˆåŠŸï¼']);
?>
--- FILE: backend/auth/update_bet_batch.php ---
<?php
// File: backend/auth/update_bet_batch.php (Complete Version)

// 1. èº«ä»½éªŒè¯
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

// 2. è·å–å¹¶éªŒè¯è¾“å…¥
$input = json_decode(file_get_contents('php://input'), true);
$batch_id = $input['batch_id'] ?? null;
$updated_data = $input['data'] ?? null; // The new JSON object/array for bet_data_json

if (empty($batch_id) || !is_numeric($batch_id) || $updated_data === null) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Invalid input: batch_id and data are required.']);
    exit;
}

// å°†æ¥æ”¶åˆ°çš„æ–°æ•°æ®é‡æ–°ç¼–ç ä¸º JSON å­—ç¬¦ä¸²
$updated_data_json = json_encode($updated_data);
if ($updated_data_json === false) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Invalid JSON data provided.']);
    exit;
}

try {
    $pdo = get_db_connection();

    // 3. å®‰å…¨æ€§æ£€æŸ¥ (éå¸¸é‡è¦!)
    // åœ¨æ›´æ–°å‰ï¼Œå¿…é¡»ç¡®è®¤è¿™æ¡ bet batch è®°å½•ç¡®å®å±äºå½“å‰ç™»å½•çš„ç”¨æˆ·ã€‚
    // æˆ‘ä»¬é€šè¿‡ parsed_bets -> raw_emails -> users çš„è¿æ¥æ¥å®ç°ã€‚
    $stmt_check = $pdo->prepare("
        SELECT pb.id FROM parsed_bets pb
        JOIN raw_emails re ON pb.email_id = re.id
        WHERE pb.id = ? AND re.user_id = ?
    ");
    $stmt_check->execute([$batch_id, $_SESSION['user_id']]);

    if ($stmt_check->fetchColumn() === false) {
        // å¦‚æœæŸ¥è¯¢æ²¡æœ‰è¿”å›ä»»ä½•ç»“æœï¼Œè¯´æ˜è¿™æ¡è®°å½•ä¸å±äºå½“å‰ç”¨æˆ·
        http_response_code(403); // Forbidden
        echo json_encode(['status' => 'error', 'message' => 'Access denied: You do not own this bet batch.']);
        exit;
    }

    // 4. æ‰§è¡Œæ›´æ–°
    $stmt_update = $pdo->prepare("UPDATE parsed_bets SET bet_data_json = ? WHERE id = ?");
    $stmt_update->execute([$updated_data_json, $batch_id]);

    if ($stmt_update->rowCount() > 0) {
        // æ›´æ–°æˆåŠŸ
        http_response_code(200);
        echo json_encode(['status' => 'success', 'message' => 'Bet batch updated successfully.']);
    } else {
        // rowCount() ä¸º 0 å¯èƒ½æ„å‘³ç€è®°å½•å­˜åœ¨ï¼Œä½†æäº¤çš„æ•°æ®ä¸åº“ä¸­æ•°æ®å®Œå…¨ç›¸åŒï¼Œæœªå‘ç”Ÿå®é™…æ›´æ–°ã€‚
        // è¿™ä¹Ÿåº”è¯¥è¢«è§†ä¸ºä¸€ç§æˆåŠŸã€‚
        http_response_code(200);
        echo json_encode(['status' => 'success', 'message' => 'No changes detected, but acknowledged.']);
    }

} catch (PDOException $e) {
    error_log("Error updating bet batch {$batch_id}: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'A database error occurred during the update.']);
}
?>
--- FILE: backend/auth/get_email_details.php ---
<?php
// File: backend/auth/get_email_details.php (ä¿®å¤ç‰ˆ)

if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

$user_id = $_SESSION['user_id'];
$email_id = $_GET['id'] ?? null;

if (empty($email_id)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email ID is required.']);
    exit;
}

try {
    $pdo = get_db_connection();

    // --- 1. è·å–åŸå§‹é‚®ä»¶å†…å®¹ ---
    $stmt_email = $pdo->prepare("SELECT content FROM raw_emails WHERE id = ? AND user_id = ?");
    $stmt_email->execute([$email_id, $user_id]);
    $raw_content = $stmt_email->fetchColumn();

    if ($raw_content === false) {
        http_response_code(404);
        echo json_encode(['status' => 'error', 'message' => 'Email not found or access denied.']);
        exit;
    }

    require_once __DIR__ . '/../helpers/mail_parser.php';
    $clean_content = parse_email_body($raw_content);

    // --- 2. è·å–æ‰€æœ‰å…³è”çš„ä¸‹æ³¨æ‰¹æ¬¡ ---
    $stmt_bets = $pdo->prepare("
        SELECT pb.id, pb.bet_data_json, pb.ai_model_used
        FROM parsed_bets pb
        WHERE pb.email_id = ?
        ORDER BY pb.id ASC
    ");
    $stmt_bets->execute([$email_id]);
    $bet_batches_raw = $stmt_bets->fetchAll(PDO::FETCH_ASSOC);

    $bet_batches = [];
    $enhanced_content = $clean_content; // åˆå§‹åŒ–å¢å¼ºå†…å®¹

    foreach ($bet_batches_raw as $batch) {
        $batch_data = json_decode($batch['bet_data_json'], true);
        $batch_info = [
            'batch_id' => $batch['id'],
            'data' => $batch_data,
            'ai_model' => $batch['ai_model_used']
        ];

        // --- 3. ä¸ºæ¯ä¸ªæ‰¹æ¬¡è®¡ç®—ç»“ç®— ---
        if (isset($batch_data['bets']) && is_array($batch_data['bets'])) {
            $settlement_data = calculateBatchSettlement($batch_data);
            $batch_info['settlement'] = $settlement_data;

            // --- 4. å°†ç»“ç®—ç»“æœåµŒå…¥é‚®ä»¶å†…å®¹ ---
            $enhanced_content = embedSettlementInContent(
                $enhanced_content,
                $batch_data,
                $settlement_data,
                $batch['id']
            );
        }

        $bet_batches[] = $batch_info;
    }

    // --- 5. å¦‚æœæ²¡æœ‰ä»»ä½•æ‰¹æ¬¡ï¼Œç¡®ä¿enhanced_contentæœ‰å†…å®¹ ---
    if (empty($bet_batches)) {
        $enhanced_content = $clean_content . "\n\n--- æœªæ£€æµ‹åˆ°ä¸‹æ³¨ä¿¡æ¯ ---\n";
    }

    // --- 6. è·å–æ‰€æœ‰å½©ç§çš„æœ€æ–°å¼€å¥–ç»“æœ ---
    $sql_latest_results = "
        SELECT r1.*
        FROM lottery_results r1
        JOIN (
            SELECT lottery_type, MAX(id) AS max_id
            FROM lottery_results
            GROUP BY lottery_type
        ) r2 ON r1.lottery_type = r2.lottery_type AND r1.id = r2.max_id
    ";
    $stmt_latest = $pdo->query($sql_latest_results);
    $latest_results_raw = $stmt_latest->fetchAll(PDO::FETCH_ASSOC);

    $latest_results = [];
    foreach ($latest_results_raw as $row) {
        foreach(['winning_numbers', 'zodiac_signs', 'colors'] as $key) {
            $row[$key] = json_decode($row[$key]) ?: [];
        }
        $latest_results[$row['lottery_type']] = $row;
    }

    // --- 7. è¿”å›å¢å¼ºåçš„é‚®ä»¶å†…å®¹ ---
    http_response_code(200);
    echo json_encode([
        'status' => 'success',
        'data' => [
            'email_content' => $clean_content, // åŸå§‹å†…å®¹
            'enhanced_content' => $enhanced_content, // åµŒå…¥ç»“ç®—åçš„å†…å®¹
            'bet_batches' => $bet_batches,
            'latest_lottery_results' => $latest_results
        ]
    ]);

} catch (Throwable $e) {
    error_log("Error in get_email_details.php for email_id {$email_id}: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Internal Server Error: ' . $e->getMessage()]);
}

/**
 * è®¡ç®—å•ä¸ªæ‰¹æ¬¡çš„ç»“ç®—ç»“æœ
 */
function calculateBatchSettlement(array $batchData): array {
    $settlement = [
        'total_bet_amount' => 0,
        'winning_details' => [],
        'net_profits' => [],
        'summary' => '',
        'timestamp' => date('Y-m-d H:i:s')
    ];

    if (!isset($batchData['bets']) || !is_array($batchData['bets'])) {
        $settlement['summary'] = 'æ— ä¸‹æ³¨æ•°æ®';
        return $settlement;
    }

    $totalBet = 0;
    $winningBets = [];

    foreach ($batchData['bets'] as $bet) {
        $amount = floatval($bet['amount'] ?? 0);
        $betType = $bet['bet_type'] ?? '';
        $targets = $bet['targets'] ?? [];

        if ($amount > 0 && is_array($targets)) {
            foreach ($targets as $target) {
                $totalBet += $amount;

                // æ¨¡æ‹Ÿä¸­å¥–æƒ…å†µ - åœ¨å®é™…åº”ç”¨ä¸­åº”è¯¥æ ¹æ®å¼€å¥–ç»“æœè®¡ç®—
                $isWin = false;
                if ($betType === 'ç‰¹ç ' || $betType === 'å·ç ') {
                    $isWin = rand(0, 10) > 7; // 30%ä¸­å¥–æ¦‚ç‡æ¨¡æ‹Ÿ

                    if ($isWin) {
                        $winningBets[] = [
                            'number' => $target,
                            'amount' => $amount,
                            'odds' => 45,
                            'bet_type' => $betType
                        ];
                    }
                }
            }
        }
    }

    $settlement['total_bet_amount'] = $totalBet;
    $settlement['winning_details'] = $winningBets;

    // è®¡ç®—ä¸åŒèµ”ç‡ä¸‹çš„å‡€æ”¶ç›Š
    $oddsList = [45, 46, 47];
    foreach ($oddsList as $odds) {
        $totalWin = 0;
        foreach ($winningBets as $win) {
            $totalWin += $win['amount'] * $odds;
        }
        $netProfit = $totalWin - $totalBet;
        $settlement['net_profits'][$odds] = [
            'total_win' => $totalWin,
            'net_profit' => $netProfit,
            'is_profit' => $netProfit >= 0
        ];
    }

    $winCount = count($winningBets);
    $settlement['summary'] = "æ€»ä¸‹æ³¨ {$totalBet} å…ƒï¼Œä¸­å¥– {$winCount} æ³¨";

    return $settlement;
}

/**
 * å°†ç»“ç®—ç»“æœåµŒå…¥é‚®ä»¶å†…å®¹
 */
function embedSettlementInContent(string $content, array $batchData, array $settlement, int $batchId): string {
    $rawText = $batchData['raw_text'] ?? '';

    // å¦‚æœæ²¡æœ‰åŸå§‹æ–‡æœ¬ï¼Œåœ¨å†…å®¹æœ«å°¾æ·»åŠ ç»“ç®—ä¿¡æ¯
    if (empty($rawText)) {
        $settlementHtml = buildSettlementHtml($settlement, $batchId);
        return $content . "\n\n" . $settlementHtml;
    }

    // æŸ¥æ‰¾åŸå§‹æ–‡æœ¬åœ¨å†…å®¹ä¸­çš„ä½ç½®
    $position = strpos($content, $rawText);

    if ($position === false) {
        // å¦‚æœæ‰¾ä¸åˆ°åŸå§‹æ–‡æœ¬ï¼Œåœ¨å†…å®¹æœ«å°¾æ·»åŠ ç»“ç®—ä¿¡æ¯
        $settlementHtml = buildSettlementHtml($settlement, $batchId);
        return $content . "\n\n" . $settlementHtml;
    }

    // æ„å»ºç»“ç®—HTML
    $settlementHtml = buildSettlementHtml($settlement, $batchId);

    // åœ¨åŸå§‹æ–‡æœ¬åæ’å…¥ç»“ç®—ä¿¡æ¯
    $insertPosition = $position + strlen($rawText);
    $newContent = substr($content, 0, $insertPosition) .
                  $settlementHtml .
                  substr($content, $insertPosition);

    return $newContent;
}

/**
 * æ„å»ºç»“ç®—HTML - ä½¿ç”¨é¢œè‰²æ ‡è®°
 */
function buildSettlementHtml(array $settlement, int $batchId): string {
    $html = "\n\n" . str_repeat("=", 50) . "\n";
    $html .= "ğŸ¯ ç»“ç®—ç»“æœ (æ‰¹æ¬¡ {$batchId})\n";
    $html .= str_repeat("=", 50) . "\n";

    // æ€»ä¸‹æ³¨é‡‘é¢ - è“è‰²
    $html .= "ğŸ’° æ€»æŠ•æ³¨é‡‘é¢: <span style='color: blue; font-weight: bold;'>{$settlement['total_bet_amount']} å…ƒ</span>\n";

    // ä¸­å¥–è¯¦æƒ…
    if (!empty($settlement['winning_details'])) {
        $html .= "ğŸŠ ä¸­å¥–è¯¦æƒ…:\n";
        foreach ($settlement['winning_details'] as $win) {
            $html .= "   - å·ç  {$win['number']}: <span style='color: green; font-weight: bold;'>{$win['amount']} å…ƒ</span> (èµ”ç‡ {$win['odds']})\n";
        }
    } else {
        $html .= "âŒ ä¸­å¥–è¯¦æƒ…: <span style='color: red; font-weight: bold;'>æœªä¸­å¥–</span>\n";
    }

    // ä¸åŒèµ”ç‡ç»“ç®— - ä½¿ç”¨çº¢è‰²/è“è‰²æ ‡è®°ç›ˆåˆ©/äºæŸ
    $html .= "\nğŸ“ˆ ä¸åŒèµ”ç‡ç»“ç®—:\n";
    foreach ($settlement['net_profits'] as $odds => $result) {
        $color = $result['is_profit'] ? 'red' : 'blue';
        $emoji = $result['is_profit'] ? 'ğŸŸ¢' : 'ğŸ”´';
        $profitText = $result['is_profit'] ? "ç›ˆåˆ©" : "äºæŸ";
        $netAmount = abs($result['net_profit']);

        $html .= "{$emoji} èµ”ç‡ {$odds}: <span style='color: {$color}; font-weight: bold;'>{$profitText} {$netAmount} å…ƒ</span>\n";
    }

    $html .= str_repeat("=", 50) . "\n";

    return $html;
}
?>
--- FILE: backend/auth/check_session.php ---
<?php
// File: backend/auth/check_session.php

// api_header.php å·²ç»å¯åŠ¨äº† session

// æ£€æŸ¥ session ä¸­æ˜¯å¦å­˜åœ¨ user_id
if (isset($_SESSION['user_id']) && !empty($_SESSION['user_id'])) {
    // ç”¨æˆ·å·²ç™»å½•ï¼Œè¿”å›ç”¨æˆ·ä¿¡æ¯
    http_response_code(200);
    echo json_encode([
        'status' => 'success',
        'isAuthenticated' => true,
        'user' => [
            'id' => $_SESSION['user_id'],
            'email' => $_SESSION['user_email'] ?? 'N/A' // æä¾›ä¸€ä¸ªé»˜è®¤å€¼ä»¥é˜²ä¸‡ä¸€
        ]
    ]);
} else {
    // ç”¨æˆ·æœªç™»å½•
    http_response_code(200); // å³ä½¿æœªç™»å½•ï¼Œè¯·æ±‚æœ¬èº«ä¹Ÿæ˜¯æˆåŠŸçš„
    echo json_encode([
        'status' => 'success',
        'isAuthenticated' => false,
        'user' => null
    ]);
}
?>
--- FILE: backend/auth/register.php ---
<?php // backend/auth/register.php
require_once __DIR__ . '/../db_operations.php';

$data = json_decode(file_get_contents('php://input'), true);
$email = $data['email'] ?? null;
$password = $data['password'] ?? null;

if (!$email || !$password) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email and password are required.']);
    exit;
}

try {
    $pdo = get_db_connection();
    $stmt = $pdo->prepare("SELECT id FROM users WHERE email = ?");
    $stmt->execute([$email]);
    if ($stmt->fetch()) {
        http_response_code(409);
        echo json_encode(['status' => 'error', 'message' => 'Email already registered.']);
        exit;
    }

    $hash = password_hash($password, PASSWORD_DEFAULT);
    $stmt = $pdo->prepare("INSERT INTO users (email, password_hash) VALUES (?, ?)");
    $stmt->execute([$email, $hash]);

    echo json_encode(['status' => 'success', 'message' => 'Registration successful.']);
} catch (PDOException $e) {
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Database error.']);
}
--- FILE: backend/auth/get_email_content.php ---
<?php
// File: backend/auth/get_email_content.php (with Server-Side Parsing)

// æ ¸å¿ƒä¾èµ–ç”± index.php åŠ è½½

// ã€æ–°å¢ã€‘åŠ è½½é‚®ä»¶è§£æå™¨å¸®åŠ©æ–‡ä»¶
// ç¡®ä¿è¿™ä¸ªè·¯å¾„æ˜¯æ­£ç¡®çš„ã€‚å¦‚æœä½ çš„ helpers ç›®å½•åœ¨ backend/ æ ¹ç›®å½•ä¸‹ã€‚
require_once __DIR__ . '/../helpers/mail_parser.php';

// 1. èº«ä»½éªŒè¯æ£€æŸ¥
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

$user_id = $_SESSION['user_id'];
$email_id = $_GET['id'] ?? null;

if (empty($email_id)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email ID is required.']);
    exit;
}

try {
    $pdo = get_db_connection();

    // 2. æŸ¥è¯¢ç‰¹å®šé‚®ä»¶çš„åŸå§‹å†…å®¹
    $stmt = $pdo->prepare(
        "SELECT id, content
         FROM raw_emails
         WHERE id = ? AND user_id = ?"
    );

    $stmt->bindParam(1, $email_id, PDO::PARAM_INT);
    $stmt->bindParam(2, $user_id, PDO::PARAM_INT);
    $stmt->execute();

    $email = $stmt->fetch(PDO::FETCH_ASSOC);

    if ($email) {
        // --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œè¿›è¡Œé‚®ä»¶è§£æ ---
        $raw_content = $email['content'];
        $clean_body = parse_email_body($raw_content);

        // åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„ï¼ŒåªåŒ…å«æˆ‘ä»¬æƒ³è¿”å›ç»™å‰ç«¯çš„æ•°æ®
        $response_data = [
            'id' => $email['id'],
            'content' => $clean_body // è¿”å›è§£æåçš„å¹²å‡€æ­£æ–‡
        ];

        // 3. è¿”å›åŒ…å«å¹²å‡€æ­£æ–‡çš„æˆåŠŸå“åº”
        http_response_code(200);
        echo json_encode(['status' => 'success', 'data' => $response_data]);

    } else {
        http_response_code(404);
        echo json_encode(['status' => 'error', 'message' => 'Email not found or access denied.']);
    }

} catch (PDOException $e) {
    error_log("Error fetching email content for user {$user_id}, email {$email_id}: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Database error.']);
} catch (Throwable $e) {
    // æ•è·å¯èƒ½åœ¨ parse_email_body ä¸­å‘ç”Ÿçš„é”™è¯¯
    error_log("Error parsing email content for email {$email_id}: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Failed to parse email content on server.']);
}
?>
--- FILE: backend/auth/reanalyze_email.php ---
<?php
// File: backend/auth/reanalyze_email.php

// æ ¸å¿ƒä¾èµ–ç”± index.php åŠ è½½

// 1. èº«ä»½éªŒè¯æ£€æŸ¥
if (!isset($_SESSION['user_id'])) {
    http_response_code(401);
    echo json_encode(['status' => 'error', 'message' => 'Unauthorized']);
    exit;
}

// 2. è·å–è¾“å…¥å‚æ•°
$input = json_decode(file_get_contents('php://input'), true);
$email_id = $input['email_id'] ?? null;

if (empty($email_id)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Email ID is required.']);
    exit;
}

// 3. éªŒè¯é‚®ä»¶å±äºå½“å‰ç”¨æˆ·
try {
    $pdo = get_db_connection();

    $stmt = $pdo->prepare("SELECT id FROM raw_emails WHERE id = ? AND user_id = ?");
    $stmt->execute([$email_id, $_SESSION['user_id']]);

    if (!$stmt->fetch()) {
        http_response_code(403);
        echo json_encode(['status' => 'error', 'message' => 'Access denied.']);
        exit;
    }

} catch (PDOException $e) {
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Database error.']);
    exit;
}

// 4. æ‰§è¡Œé‡æ–°è§£æ
require_once __DIR__ . '/../ai_helper.php';
$result = reanalyzeEmailWithAI($email_id);

if ($result['success']) {
    http_response_code(200);
    echo json_encode([
        'status' => 'success',
        'message' => $result['message'],
        'batch_id' => $result['batch_id'] ?? null
    ]);
} else {
    http_response_code(500);
    echo json_encode([
        'status' => 'error',
        'message' => $result['message']
    ]);
}
?>
--- FILE: backend/auth/get_emails.php ---
<?php
// File: backend/auth/get_emails.php

// æ ¸å¿ƒä¾èµ–ç”± index.php åŠ è½½ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨

// 1. èº«ä»½éªŒè¯æ£€æŸ¥
if (!isset($_SESSION['user_id'])) {
    http_response_code(401); // Unauthorized
    echo json_encode(['status' => 'error', 'message' => 'æ‚¨éœ€è¦ç™»å½•æ‰èƒ½æŸ¥çœ‹é‚®ä»¶ã€‚']);
    exit;
}

$user_id = $_SESSION['user_id'];
$limit = 20; // é™åˆ¶ä¸€æ¬¡æœ€å¤šè·å–20å°é‚®ä»¶

try {
    $pdo = get_db_connection();

    // 2. ä»æ•°æ®åº“æŸ¥è¯¢é‚®ä»¶
    // æˆ‘ä»¬åªæŸ¥è¯¢ raw_emails è¡¨ï¼Œå› ä¸ºå‰ç«¯åˆ—è¡¨åªéœ€è¦é‚®ä»¶çš„åŸºæœ¬ä¿¡æ¯
    // å…³é”®ï¼šWHERE user_id = ? ç¡®ä¿äº†ç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±çš„é‚®ä»¶
    $stmt = $pdo->prepare(
        "SELECT id, status, received_at
         FROM raw_emails
         WHERE user_id = ?
         ORDER BY received_at DESC
         LIMIT ?"
    );

    // PDO::PARAM_INT å‘Šè¯‰æ•°æ®åº“è¿™æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œæ›´å®‰å…¨
    $stmt->bindParam(1, $user_id, PDO::PARAM_INT);
    $stmt->bindParam(2, $limit, PDO::PARAM_INT);
    $stmt->execute();

    $emails = $stmt->fetchAll(PDO::FETCH_ASSOC);

    // 3. è¿”å›æˆåŠŸå“åº”
    http_response_code(200);
    echo json_encode(['status' => 'success', 'data' => $emails]);

} catch (PDOException $e) {
    error_log("Error fetching emails for user {$user_id}: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'è·å–é‚®ä»¶åˆ—è¡¨æ—¶å‘ç”Ÿæ•°æ®åº“é”™è¯¯ã€‚']);
}
?>
--- FILE: backend/telegram/parser.php ---
<?php
// File: backend/telegram/parser.php (Batch and Smart Parser Version)

// å¼•å…¥æˆ‘ä»¬çš„è§„åˆ™æ–‡ä»¶
require_once __DIR__ . '/../lottery/rules.php';

/**
 * æ™ºèƒ½åœ°è§£ææ¥è‡ª Telegram é¢‘é“çš„å¼€å¥–ä¿¡æ¯æ–‡æœ¬ï¼Œæ”¯æŒå•æ¡æ¶ˆæ¯ä¸­åŒ…å«å¤šä¸ªå¼€å¥–å…¬å‘Šã€‚
 *
 * @param string $text å®Œæ•´çš„é¢‘é“æ¶ˆæ¯æ–‡æœ¬ã€‚
 * @return array è¿”å›ä¸€ä¸ªåŒ…å«é›¶ä¸ªæˆ–å¤šä¸ªè§£æç»“æœçš„æ•°ç»„ã€‚
 */
function parse_lottery_data_batch(string $text): array {
    $color_map_emoji = ['ğŸ”´' => 'çº¢æ³¢', 'ğŸŸ¢' => 'ç»¿æ³¢', 'ğŸ”µ' => 'è“æ³¢'];
    $all_results = [];

    // 1. å°†æ•´ä¸ªæ–‡æœ¬å—æŒ‰ "ä¸€æ³¢ä¸­" æˆ–ç±»ä¼¼çš„å…¬å‘Šå¼€å¤´è¿›è¡Œåˆ†å‰²
    // ä½¿ç”¨ preg_split å¹¶ä¿ç•™åˆ†éš”ç¬¦ï¼Œè¿™æ ·æ¯ä¸ªå—éƒ½æ˜¯å®Œæ•´çš„
    $blocks = preg_split('/(ä¸€æ³¢ä¸­|.*?ç¬¬:.*æœŸå¼€å¥–ç»“æœ:)/u', $text, -1, PREG_SPLIT_NO_EMPTY | PREG_SPLIT_DELIM_CAPTURE);

    // ç»„åˆåˆ†éš”ç¬¦å’Œå®ƒä»¬å¯¹åº”çš„å†…å®¹å—
    for ($i = 0; $i < count($blocks); $i += 2) {
        if (!isset($blocks[$i+1])) continue;

        $block_text = $blocks[$i] . $blocks[$i+1];

        // 2. å¯¹æ¯ä¸ªç‹¬ç«‹çš„å…¬å‘Šå—è¿›è¡Œè§£æ
        $pattern = '/(æ–°æ¾³é—¨å…­åˆå½©|é¦™æ¸¯å…­åˆå½©|è€æ¾³.*?)ç¬¬:(\d+)\s*æœŸå¼€å¥–ç»“æœ:\s*([\s\S]*)/u';

        if (!preg_match($pattern, $block_text, $matches)) {
            continue; // å¦‚æœè¿™ä¸ªå—ä¸åŒ¹é…ï¼Œè·³åˆ°ä¸‹ä¸€ä¸ª
        }

        $lottery_type_raw = $matches[1];
        $issue_number = $matches[2];
        $results_block_text = trim($matches[3]);

        $lottery_type = (strpos($lottery_type_raw, 'è€æ¾³') !== false) ? 'è€æ¾³é—¨å…­åˆå½©' : trim($lottery_type_raw);
        $lines = array_values(array_filter(explode("\n", $results_block_text), 'trim'));

        // è‡³å°‘éœ€è¦å·ç è¡Œ
        if (count($lines) < 1) continue;

        $winning_numbers = preg_split('/\s+/', trim($lines[0]));

        // 3. æ™ºèƒ½æ¨æ–­æˆ–è§£æç”Ÿè‚–å’Œæ³¢è‰²
        $zodiac_signs = [];
        $colors = [];

        $has_zodiac_line = isset($lines[1]) && !preg_match('/[ğŸ”´ğŸŸ¢ğŸ”µ]/u', $lines[1]);
        $has_color_line = isset($lines[2]) || (isset($lines[1]) && preg_match('/[ğŸ”´ğŸŸ¢ğŸ”µ]/u', $lines[1]));

        // ä¼˜å…ˆä»æ–‡æœ¬ä¸­è§£æ
        if ($has_zodiac_line) {
            $zodiac_signs = preg_split('/\s+/', trim($lines[1]));
        }
        if ($has_color_line) {
            $color_line = isset($lines[2]) ? $lines[2] : $lines[1];
            $raw_colors = preg_split('/\s+/', trim($color_line));
            $colors = array_map(fn($emoji) => $color_map_emoji[$emoji] ?? 'æœªçŸ¥', $raw_colors);
        }

        // 4. å¦‚æœç¼ºå°‘ä¿¡æ¯ï¼Œåˆ™ä½¿ç”¨è§„åˆ™è¿›è¡Œæ¨æ–­
        foreach ($winning_numbers as $index => $number) {
            if (empty($zodiac_signs[$index])) {
                $zodiac_signs[$index] = get_zodiac_by_number($number) ?? 'æœªçŸ¥';
            }
            if (empty($colors[$index]) || $colors[$index] === 'æœªçŸ¥') {
                $colors[$index] = get_color_by_number($number) ?? 'æœªçŸ¥';
            }
        }

        // 5. æ•°æ®æ ¡éªŒ
        if (count($winning_numbers) > 0 && count($winning_numbers) === count($zodiac_signs) && count($winning_numbers) === count($colors)) {
            $all_results[] = [
                'lottery_type' => $lottery_type,
                'issue_number' => $issue_number,
                'winning_numbers' => $winning_numbers,
                'zodiac_signs' => $zodiac_signs,
                'colors' => $colors,
                'drawing_date' => date('Y-m-d')
            ];
        }
    }

    return $all_results;
}
?>
--- FILE: backend/telegram/receiver.php ---
<?php
// File: telegram/receiver.php (FINAL PRODUCTION VERSION)
ini_set('display_errors', 0);
ini_set('log_errors', 1);
ini_set('error_log', __DIR__ . '/receiver_debug.log');
error_reporting(E_ALL);

// ç«‹å³è®°å½•è¯·æ±‚
error_log("=== WEBHOOK CALLED ===");
error_log("Time: " . date('Y-m-d H:i:s'));

function read_env_and_get_config() {
    static $config = null;
    if ($config === null) {
        $config = [];
        $envPath = dirname(__DIR__) . '/.env';
        if (file_exists($envPath) && is_readable($envPath)) {
            $lines = file($envPath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
            foreach ($lines as $line) {
                $line = trim($line);
                if (strpos($line, ';') === 0) continue;
                if (strpos($line, ';') !== false) $line = substr($line, 0, strpos($line, ';'));
                if (strpos($line, '=') !== false) {
                    list($name, $value) = explode('=', $line, 2);
                    $config[trim($name)] = trim(trim($value), "\"'");
                }
            }
        }
    }
    return $config;
}

function get_db_standalone($config) {
    try {
        $dsn = sprintf("mysql:host=%s;port=%s;dbname=%s;charset=utf8mb4",
            $config['DB_HOST'] ?? 'localhost',
            $config['DB_PORT'] ?? '3306',
            $config['DB_DATABASE'] ?? ''
        );

        $options = [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_TIMEOUT => 5
        ];

        return new PDO($dsn, $config['DB_USERNAME'] ?? '', $config['DB_PASSWORD'] ?? '', $options);
    } catch (PDOException $e) {
        error_log("DATABASE ERROR: " . $e->getMessage());
        throw $e;
    }
}

// --- ä¼˜åŒ–çš„è‡ªç„¶è¯­è¨€è§£æå™¨ ---
function parse_natural_lottery_data(string $text) {
    error_log("å¼€å§‹è§£æè‡ªç„¶è¯­è¨€å¼€å¥–æ•°æ®");

    $lines = explode("\n", trim($text));
    if (count($lines) < 3) {
        error_log("è§£æå¤±è´¥: è¡Œæ•°ä¸è¶³");
        return null;
    }

    $lotteryType = '';
    $issueNumber = '';
    $winningNumbers = [];
    $zodiacs = [];
    $colors = [];

    // è§£æç¬¬ä¸€è¡Œï¼šå½©ç¥¨ç±»å‹å’ŒæœŸå·
    $firstLine = trim($lines[0]);
    if (strpos($firstLine, 'æ–°æ¾³é—¨å…­åˆå½©') !== false) {
        $lotteryType = 'æ–°æ¾³é—¨å…­åˆå½©';
    } elseif (strpos($firstLine, 'é¦™æ¸¯å…­åˆå½©') !== false) {
        $lotteryType = 'é¦™æ¸¯å…­åˆå½©';
    } elseif (strpos($firstLine, 'è€æ¾³') !== false) {
        $lotteryType = 'è€æ¾³é—¨å…­åˆå½©';
    } else {
        error_log("è§£æå¤±è´¥: æ— æ³•è¯†åˆ«å½©ç¥¨ç±»å‹");
        return null;
    }

    // æå–æœŸå·
    if (!preg_match('/ç¬¬:?(\d+)/', $firstLine, $matches)) {
        error_log("è§£æå¤±è´¥: æ— æ³•æå–æœŸå·");
        return null;
    }
    $issueNumber = $matches[1];

    // è§£æç¬¬äºŒè¡Œï¼šå¼€å¥–å·ç 
    $numbersLine = trim($lines[1]);
    preg_match_all('/\b\d+\b/', $numbersLine, $numberMatches);
    $winningNumbers = $numberMatches[0] ?? [];

    if (count($winningNumbers) < 6) {
        error_log("è§£æå¤±è´¥: å·ç æ•°é‡ä¸è¶³ - " . count($winningNumbers));
        return null;
    }

    // è§£æç¬¬ä¸‰è¡Œï¼šç”Ÿè‚–
    if (isset($lines[2])) {
        $zodiacLine = trim($lines[2]);
        $zodiacMap = [
            'é¼ ' => 'é¼ ', 'ç‰›' => 'ç‰›', 'è™' => 'è™', 'å…”' => 'å…”',
            'é¾' => 'é¾™', 'é¾™' => 'é¾™', 'è›‡' => 'è›‡', 'é¦¬' => 'é©¬',
            'é©¬' => 'é©¬', 'ç¾Š' => 'ç¾Š', 'çŒ´' => 'çŒ´', 'é›' => 'é¸¡',
            'é¸¡' => 'é¸¡', 'ç‹—' => 'ç‹—', 'è±¬' => 'çŒª', 'çŒª' => 'çŒª'
        ];

        $zodiacParts = preg_split('/\s+/', $zodiacLine);
        foreach ($zodiacParts as $part) {
            $part = trim($part);
            if (!empty($part) && isset($zodiacMap[$part])) {
                $zodiacs[] = $zodiacMap[$part];
            }
        }
    }

    // è§£æç¬¬å››è¡Œï¼šæ³¢è‰²
    if (isset($lines[3])) {
        $colorLine = trim($lines[3]);
        $colorMap = [
            'ğŸ”´' => 'çº¢æ³¢', 'ğŸŸ¢' => 'ç»¿æ³¢', 'ğŸ”µ' => 'è“æ³¢'
        ];

        $colorParts = preg_split('/\s+/', $colorLine);
        foreach ($colorParts as $part) {
            foreach ($colorMap as $emoji => $color) {
                if (strpos($part, $emoji) !== false) {
                    $colors[] = $color;
                    break;
                }
            }
        }
    }

    // ç¡®ä¿æ•°ç»„é•¿åº¦åŒ¹é…
    if (count($zodiacs) !== count($winningNumbers)) {
        $zodiacs = array_fill(0, count($winningNumbers), 'æœªçŸ¥');
    }

    if (count($colors) !== count($winningNumbers)) {
        $colors = array_fill(0, count($winningNumbers), 'æœªçŸ¥');
    }

    error_log("è§£ææˆåŠŸ: {$lotteryType} æœŸå·:{$issueNumber} å·ç :" . implode(',', $winningNumbers));

    return [
        'lottery_type' => $lotteryType,
        'issue_number' => $issueNumber,
        'winning_numbers' => $winningNumbers,
        'zodiac_signs' => $zodiacs,
        'colors' => $colors,
        'drawing_date' => date('Y-m-d')
    ];
}

// ASCII è§£æå™¨ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
function parse_ascii_lottery_data(string $text) {
    $text = trim($text, "` \n\r\t\v\x00");

    if (strpos($text, 'lottery_result|') !== 0) {
        return null;
    }

    $parts = explode('|', $text);
    array_shift($parts);
    $data = [];

    foreach ($parts as $part) {
        if (strpos($part, ':') !== false) {
            list($key, $value) = explode(':', $part, 2);
            $data[$key] = $value;
        }
    }

    if (!isset($data['type']) || !isset($data['issue']) || !isset($data['nums'])) {
        return null;
    }

    $type_map = ['1' => 'é¦™æ¸¯å…­åˆå½©', '2' => 'æ–°æ¾³é—¨å…­åˆå½©', '3' => 'è€æ¾³é—¨å…­åˆå½©'];
    $color_map_char = ['R' => 'çº¢æ³¢', 'G' => 'ç»¿æ³¢', 'B' => 'è“æ³¢'];
    $zodiac_map_char = [
        'S' => 'é¼ ', 'N' => 'ç‰›', 'H' => 'è™', 'T' => 'å…”', 'L' => 'é¾™', 's' => 'è›‡',
        'M' => 'é©¬', 'Y' => 'ç¾Š', 'h' => 'çŒ´', 'J' => 'é¸¡', 'G' => 'ç‹—', 'Z' => 'çŒª'
    ];

    $winning_numbers = explode(',', $data['nums']);
    $zodiacs_chars = isset($data['zodiacs']) ? explode(',', $data['zodiacs']) : [];
    $colors_chars = isset($data['colors']) ? explode(',', $data['colors']) : [];

    $colors = [];
    foreach ($colors_chars as $char) {
        $colors[] = $color_map_char[$char] ?? 'æœªçŸ¥';
    }

    $zodiacs = [];
    foreach ($zodiacs_chars as $char) {
        $zodiacs[] = $zodiac_map_char[$char] ?? 'æœªçŸ¥';
    }

    return [
        'lottery_type' => $type_map[$data['type']] ?? 'æœªçŸ¥ç±»å‹',
        'issue_number' => $data['issue'],
        'winning_numbers' => $winning_numbers,
        'zodiac_signs' => $zodiacs,
        'colors' => $colors,
        'drawing_date' => date('Y-m-d')
    ];
}

function sendTelegramMessage($chatId, $text, $config) {
    $botToken = $config['TELEGRAM_BOT_TOKEN'] ?? '';
    if (!$botToken) return;

    $apiUrl = "https://api.telegram.org/bot{$botToken}/sendMessage";
    $data = [
        'chat_id' => $chatId,
        'text' => $text,
        'parse_mode' => 'HTML'
    ];

    $options = [
        'http' => [
            'header' => "Content-type: application/x-www-form-urlencoded\r\n",
            'method' => 'POST',
            'content' => http_build_query($data),
            'timeout' => 5
        ]
    ];

    $context = stream_context_create($options);
    @file_get_contents($apiUrl, false, $context);
}

// ä¸»é€»è¾‘å¼€å§‹
try {
    $env_config = read_env_and_get_config();

    // å®‰å…¨éªŒè¯
    $secret_from_env = $env_config['TELEGRAM_WEBHOOK_SECRET'] ?? null;
    $secret_from_get = $_GET['secret'] ?? null;

    if (!$secret_from_env || $secret_from_get !== $secret_from_env) {
        http_response_code(403);
        exit('Forbidden');
    }

    $input = file_get_contents('php://input');
    if (!$input) {
        http_response_code(200);
        echo "OK";
        exit;
    }

    $update = json_decode($input, true);
    if (json_last_error() !== JSON_ERROR_NONE) {
        http_response_code(200);
        echo "OK";
        exit;
    }

    // å¤„ç†é¢‘é“æ¶ˆæ¯
    if (isset($update['channel_post']['text'])) {
        $message_text = $update['channel_post']['text'];

        // é¦–å…ˆå°è¯•è‡ªç„¶è¯­è¨€è§£æ
        $parsedData = parse_natural_lottery_data($message_text);

        // å¦‚æœå¤±è´¥ï¼Œå°è¯•ASCIIè§£æ
        if (!$parsedData) {
            $parsedData = parse_ascii_lottery_data($message_text);
        }

        if ($parsedData) {
            error_log("è§£ææˆåŠŸ: {$parsedData['lottery_type']} æœŸå·:{$parsedData['issue_number']}");

            try {
                $pdo = get_db_standalone($env_config);
                $sql = "INSERT INTO lottery_results (lottery_type, issue_number, winning_numbers, zodiac_signs, colors, drawing_date)
                        VALUES (?, ?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE
                        winning_numbers=VALUES(winning_numbers), zodiac_signs=VALUES(zodiac_signs),
                        colors=VALUES(colors), drawing_date=VALUES(drawing_date),
                        created_at=CURRENT_TIMESTAMP";

                $stmt = $pdo->prepare($sql);
                $result = $stmt->execute([
                    $parsedData['lottery_type'],
                    $parsedData['issue_number'],
                    json_encode($parsedData['winning_numbers']),
                    json_encode($parsedData['zodiac_signs']),
                    json_encode($parsedData['colors']),
                    $parsedData['drawing_date']
                ]);

                if ($result) {
                    error_log("æ•°æ®åº“æ’å…¥æˆåŠŸ: {$parsedData['issue_number']}");

                    // å‘é€ç¡®è®¤æ¶ˆæ¯ç»™ç®¡ç†å‘˜
                    $adminId = $env_config['TELEGRAM_ADMIN_ID'] ?? null;
                    if ($adminId) {
                        $confirmMsg = "âœ… å¼€å¥–æ•°æ®å·²ä¿å­˜\n" .
                                     "ğŸ“Š ç±»å‹: " . $parsedData['lottery_type'] . "\n" .
                                     "ğŸ« æœŸå·: " . $parsedData['issue_number'] . "\n" .
                                     "ğŸ”¢ å·ç : " . implode(', ', $parsedData['winning_numbers']);
                        sendTelegramMessage($adminId, $confirmMsg, $env_config);
                    }
                }

            } catch (PDOException $e) {
                error_log("æ•°æ®åº“é”™è¯¯: " . $e->getMessage());
            }
        }
    }
    // å¤„ç†ç§èŠæ¶ˆæ¯
    elseif (isset($update['message']['text'])) {
        $chatId = $update['message']['chat']['id'];
        $userId = $update['message']['from']['id'];
        $text = $update['message']['text'];

        $adminId = (int)($env_config['TELEGRAM_ADMIN_ID'] ?? 0);

        if ($userId === $adminId) {
            if ($text === '/start') {
                sendTelegramMessage($chatId, "ğŸ‘‹ æ¬¢è¿å›æ¥ï¼Œç®¡ç†å‘˜ï¼ç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚", $env_config);
            } elseif ($text === '/status') {
                sendTelegramMessage($chatId, "âœ… ç³»ç»ŸçŠ¶æ€æ­£å¸¸\nğŸ•’ æœ€åæ£€æŸ¥: " . date('Y-m-d H:i:s'), $env_config);
            }
        }
    }

    http_response_code(200);
    echo "OK";

} catch (Throwable $e) {
    error_log("ä¸¥é‡é”™è¯¯: " . $e->getMessage());
    http_response_code(200);
    echo "OK";
}
?>
--- FILE: backend/api_header.php ---
<?php
// File: backend/api_header.php

if (defined('API_HEADER_LOADED')) return;
define('API_HEADER_LOADED', true);

// ä½¿ç”¨ config() å‡½æ•°ï¼Œå¹¶æä¾›ä¸€ä¸ªå®‰å…¨çš„å¤‡ç”¨å€¼ï¼ˆå°½ç®¡æˆ‘ä»¬æœŸæœ›å®ƒèƒ½è¯»åˆ°æ­£ç¡®çš„URLï¼‰
$frontend_url = config('FRONTEND_URL');

// å¦‚æœ frontend_url ä¸ºç©ºæˆ–æœªè®¾ç½®ï¼Œåˆ™ä¸å‘é€ä»»ä½• CORS å¤´ï¼Œä»¥ä¾¿åœ¨æµè§ˆå™¨ä¸­çœ‹åˆ°æ›´æ˜ç¡®çš„é”™è¯¯
if ($frontend_url) {
    header("Access-Control-Allow-Origin: " . $frontend_url);
} else {
    // æ•…æ„ä¸è®¾ç½®ï¼Œè¿™æ ·æµè§ˆå™¨ä¼šæŠ¥ä¸€ä¸ªå…³äºç¼ºå°‘å¤´çš„é”™è¯¯ï¼Œè€Œä¸æ˜¯å…³äº '*' çš„é”™è¯¯
    // è¿™èƒ½å¸®åŠ©æˆ‘ä»¬ç¡®è®¤é—®é¢˜å°±æ˜¯ FRONTEND_URL æ²¡è¯»åˆ°
}

header('Access-Control-Allow-Credentials: true');
header('Access-Control-Allow-Methods: GET, POST, OPTIONS, DELETE, PUT');
header('Access-Control-Allow-Headers: Content-Type, Authorization, X-Requested-With');

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(204);
    exit;
}

header('Content-Type: application/json');

if (session_status() === PHP_SESSION_NONE) {
    session_set_cookie_params([
        'lifetime' => 86400, 'path' => '/',
        'domain' => '', 'secure' => true,
        'httponly' => true, 'samesite' => 'None'
    ]);
    session_start();
}
--- FILE: backend/database_schema.sql ---
CREATE TABLE IF NOT EXISTS `users` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `email` VARCHAR(255) NOT NULL,
  `password_hash` VARCHAR(255) NOT NULL,
  `status` ENUM('active', 'banned') NOT NULL DEFAULT 'active',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `raw_emails` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `user_id` INT NOT NULL,
  `content` MEDIUMTEXT NOT NULL,
  `status` ENUM('pending', 'processed', 'failed') NOT NULL DEFAULT 'pending',
  `received_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `parsed_bets` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `email_id` INT NOT NULL,
  `bet_data_json` JSON NOT NULL,
  `ai_model_used` VARCHAR(50),
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`email_id`) REFERENCES `raw_emails`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `lottery_results` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `lottery_type` VARCHAR(100) NOT NULL,
  `issue_number` VARCHAR(255) NOT NULL,
  `winning_numbers` JSON NOT NULL,
  `zodiac_signs` JSON NOT NULL,
  `colors` JSON NOT NULL,
  `drawing_date` DATE,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY `type_issue` (`lottery_type`, `issue_number`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `settlements` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `bet_id` INT NOT NULL,
  `result_data_json` JSON NOT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`bet_id`) REFERENCES `parsed_bets`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
--- FILE: backend/initialize_database.php ---
<?php
// File: backend/initialize_database.php (Final Corrected Version)

// å¼€å¯å‘½ä»¤è¡Œé”™è¯¯æ˜¾ç¤ºï¼Œä»¥ä¾¿çœ‹åˆ°ä»»ä½•é—®é¢˜
ini_set('display_errors', 1);
error_reporting(E_ALL);

echo "--- Database Initialization Script ---\n\n";
echo "Step 1: Loading core files...\n";

// ã€å…³é”®ä¿®å¤ã€‘ç¡®ä¿æ‰€æœ‰å¿…è¦çš„æ–‡ä»¶éƒ½è¢«åŠ è½½
// é¦–å…ˆåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå› ä¸ºå®ƒå®šä¹‰äº† config() å‡½æ•°
require_once __DIR__ . '/config.php';
// ç„¶ååŠ è½½æ•°æ®åº“æ“ä½œæ–‡ä»¶ï¼Œå› ä¸ºå®ƒå®šä¹‰äº† get_db_connection() å‡½æ•°
require_once __DIR__ . '/db_operations.php';

echo "  [SUCCESS] All core files loaded.\n\n";

try {
    echo "Step 2: Getting database connection...\n";
    // ç°åœ¨ get_db_connection() å‡½æ•°è‚¯å®šæ˜¯å·²å®šä¹‰çš„
    $pdo = get_db_connection();
    echo "  [SUCCESS] Database connection established.\n\n";

    echo "Step 3: Reading schema file...\n";
    $sql_file_path = __DIR__ . '/database_schema.sql';
    if (!file_exists($sql_file_path)) {
        throw new Exception("File not found: {$sql_file_path}");
    }
    $sql = file_get_contents($sql_file_path);
    echo "  [SUCCESS] SQL schema file read.\n\n";

    echo "Step 4: Executing SQL to create tables...\n";
    $pdo->exec($sql);
    echo "  [SUCCESS] All tables created or already exist.\n\n";

} catch (Throwable $e) { // æ•è·æ‰€æœ‰ç±»å‹çš„é”™è¯¯
    echo "\n[FAILURE] An error occurred during initialization:\n";
    echo "--------------------------------------------------\n";
    echo "Error Type: " . get_class($e) . "\n";
    echo "Message: " . $e->getMessage() . "\n";
    echo "File: " . $e->getFile() . "\n";
    echo "Line: " . $e->getLine() . "\n";
    echo "--------------------------------------------------\n";
    exit(1);
}

echo "--- Initialization Complete! ---\n";
?>
--- FILE: backend/ai_helper.php ---
<?php
// File: ai_helper.php (ä¿®å¤ç‰ˆ - æ”¹è¿›AIæç¤ºè¯)

require_once __DIR__ . '/helpers/mail_parser.php';

/**
 * åˆ†æé‚®ä»¶å†…å®¹å¹¶æå–ä¸‹æ³¨ä¿¡æ¯ï¼ŒåŒæ—¶è¿›è¡Œç»“ç®—è®¡ç®—ã€‚
 */
function analyzeBetSlipWithAI(string $emailContent): array {
    $cleanBody = parse_email_body($emailContent);

    if ($cleanBody === 'æ— æ³•è§£æé‚®ä»¶æ­£æ–‡') {
        return ['success' => false, 'message' => 'Failed to parse email body.'];
    }

    // è·å–AIåˆ†æç»“æœ
    $aiResult = analyzeWithCloudflareAI($cleanBody);

    // å¦‚æœAIåˆ†ææˆåŠŸï¼Œè¿›è¡Œç»“ç®—è®¡ç®—
    if ($aiResult['success'] && isset($aiResult['data'])) {
        $settlementResult = calculateSettlement($aiResult['data']);
        $aiResult['settlement'] = $settlementResult;
    }

    return $aiResult;
}

/**
 * è®¡ç®—ç»“ç®—ç»“æœ
 */
function calculateSettlement(array $betData): array {
    $settlement = [
        'total_bet_amount' => 0,
        'winning_details' => [],
        'net_profits' => [],
        'summary' => ''
    ];

    if (!isset($betData['bets']) || !is_array($betData['bets'])) {
        return $settlement;
    }

    $totalBet = 0;
    $winningBets = [];

    foreach ($betData['bets'] as $bet) {
        $amount = floatval($bet['amount'] ?? 0);
        $betType = $bet['bet_type'] ?? '';
        $targets = $bet['targets'] ?? [];

        if ($amount > 0 && is_array($targets)) {
            foreach ($targets as $target) {
                $totalBet += $amount;

                // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æ ¹æ®å¼€å¥–ç»“æœè®¡ç®—
                // å‡è®¾æ‰€æœ‰ä¸‹æ³¨éƒ½æ˜¯ç‰¹ç ç©æ³•
                if ($betType === 'ç‰¹ç ' || $betType === 'å·ç ' || $betType === 'å¹³ç ') {
                    // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä¸å¼€å¥–ç»“æœå¯¹æ¯”
                    // ç°åœ¨å…ˆæ¨¡æ‹Ÿä¸­å¥–æƒ…å†µ
                    $isWin = rand(0, 10) > 7; // 30%ä¸­å¥–æ¦‚ç‡æ¨¡æ‹Ÿ

                    if ($isWin) {
                        $winningBets[] = [
                            'number' => $target,
                            'amount' => $amount,
                            'odds' => 45 // é»˜è®¤èµ”ç‡
                        ];
                    }
                }
            }
        }
    }

    $settlement['total_bet_amount'] = $totalBet;
    $settlement['winning_details'] = $winningBets;

    // è®¡ç®—ä¸åŒèµ”ç‡ä¸‹çš„å‡€æ”¶ç›Š
    $oddsList = [45, 46, 47];
    foreach ($oddsList as $odds) {
        $totalWin = 0;
        foreach ($winningBets as $win) {
            $totalWin += $win['amount'] * $odds;
        }
        $netProfit = $totalWin - $totalBet;
        $settlement['net_profits'][$odds] = [
            'total_win' => $totalWin,
            'net_profit' => $netProfit,
            'is_profit' => $netProfit >= 0
        ];
    }

    $winCount = count($winningBets);
    $settlement['summary'] = "æ€»ä¸‹æ³¨ {$totalBet} å…ƒï¼Œä¸­å¥– {$winCount} æ³¨";

    return $settlement;
}

/**
 * ä½¿ç”¨ Cloudflare AI è¿›è¡Œåˆ†æ - æ”¹è¿›æç¤ºè¯
 */
function analyzeWithCloudflareAI(string $text): array {
    $accountId = config('CLOUDFLARE_ACCOUNT_ID');
    $apiToken = config('CLOUDFLARE_API_TOKEN');

    if (!$accountId || !$apiToken) {
        return ['success' => false, 'message' => 'Cloudflare AI credentials not configured.'];
    }

    $model = '@cf/meta/llama-3-8b-instruct';
    $url = "https://api.cloudflare.com/client/v4/accounts/{$accountId}/ai/run/{$model}";

    // æ”¹è¿›çš„æç¤ºè¯ - æ›´å…·ä½“åœ°é’ˆå¯¹å…­åˆå½©ä¸‹æ³¨æ ¼å¼
    $prompt = "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å…­åˆå½©ä¸‹æ³¨å•è¯†åˆ«åŠ©æ‰‹ã€‚è¯·ä»ä»¥ä¸‹å¾®ä¿¡èŠå¤©è®°å½•ä¸­ç²¾ç¡®è¯†åˆ«å‡ºä¸‹æ³¨ä¿¡æ¯ã€‚

ç‰¹åˆ«æ³¨æ„ä»¥ä¸‹å¸¸è§ä¸‹æ³¨æ ¼å¼ï¼š
1. å·ç ä¸‹æ³¨ï¼š\"36,48å„30#\" è¡¨ç¤ºå·ç 36å’Œ48å„ä¸‹æ³¨30å…ƒ
2. ç”Ÿè‚–ä¸‹æ³¨ï¼š\"é¼ ï¼Œé¸¡æ•°å„äºŒå\" è¡¨ç¤ºé¼ å’Œé¸¡å„ä¸‹æ³¨20å…ƒ
3. å¤šå·ç ä¸‹æ³¨ï¼š\"10.22.34.46.04.16...å„5å—\" è¡¨ç¤ºè¿™äº›å·ç å„ä¸‹æ³¨5å…ƒ
4. æ¾³é—¨/é¦™æ¸¯åŒºåˆ†ï¼šæ³¨æ„åŒºåˆ†æ¾³é—¨å…­åˆå½©å’Œé¦™æ¸¯å…­åˆå½©

è¯·ä»¥ä¸¥æ ¼çš„JSONæ ¼å¼è¿”å›è¯†åˆ«ç»“æœï¼š

{
    \"lottery_type\": \"å½©ç¥¨ç±»å‹ï¼ˆæ¾³é—¨å…­åˆå½©/é¦™æ¸¯å…­åˆå½©ï¼‰\",
    \"issue_number\": \"æœŸå·ï¼ˆå¦‚æœæåˆ°ï¼‰\",
    \"bets\": [
        {
            \"bet_type\": \"ä¸‹æ³¨ç©æ³•ï¼ˆç‰¹ç /å¹³ç /ç”Ÿè‚–/è‰²æ³¢ï¼‰\",
            \"targets\": [\"ä¸‹æ³¨å·ç æˆ–ç›®æ ‡\"],
            \"amount\": ä¸‹æ³¨é‡‘é¢,
            \"raw_text\": \"åŸå§‹ä¸‹æ³¨æ–‡æœ¬\"
        }
    ]
}

èŠå¤©è®°å½•åŸæ–‡ï¼š
---
{$text}
---";

    $payload = [
        'messages' => [
            ['role' => 'system', 'content' => 'ä½ æ˜¯ä¸€ä¸ªåªè¾“å‡ºä¸¥æ ¼JSONæ ¼å¼çš„åŠ©æ‰‹ï¼Œå¿…é¡»æŒ‰ç…§æŒ‡å®šçš„JSONæ ¼å¼è¿”å›æ•°æ®ã€‚'],
            ['role' => 'user', 'content' => $prompt]
        ],
        'max_tokens' => 2000
    ];

    $headers = [
        'Authorization: Bearer ' . $apiToken,
        'Content-Type: ' . 'application/json',
    ];

    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($payload));
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_TIMEOUT, 60);

    $responseBody = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $curlError = curl_error($ch);
    curl_close($ch);

    // è®°å½•AIè°ƒç”¨æ—¥å¿—
    error_log("AI API Call - HTTP Code: {$httpCode}, Response: {$responseBody}");

    if ($httpCode !== 200) {
        return [
            'success' => false,
            'message' => "Cloudflare AI API Error (HTTP {$httpCode}): " . $responseBody,
            'curl_error' => $curlError
        ];
    }

    $responseData = json_decode($responseBody, true);
    $ai_response_text = $responseData['result']['response'] ?? null;

    if (!$ai_response_text) {
        return [
            'success' => false,
            'message' => 'Invalid response structure from Cloudflare AI.',
            'raw_response' => $responseBody
        ];
    }

    // è®°å½•AIåŸå§‹å“åº”
    error_log("AI Raw Response: " . $ai_response_text);

    // æå–JSON - æ›´å®½æ¾çš„åŒ¹é…
    preg_match('/\{(?:[^{}]|(?R))*\}/', $ai_response_text, $matches);

    if (empty($matches)) {
        // å°è¯•æ›´å®½æ¾çš„åŒ¹é…
        preg_match('/\{[\s\S]*\}/', $ai_response_text, $matches);
    }

    if (empty($matches)) {
        return [
            'success' => false,
            'message' => 'AI did not return a valid JSON object.',
            'raw_response' => $ai_response_text
        ];
    }

    $bet_data = json_decode($matches[0], true);

    if (json_last_error() !== JSON_ERROR_NONE) {
        return [
            'success' => false,
            'message' => 'Failed to decode JSON from AI response: ' . json_last_error_msg(),
            'raw_json' => $matches[0]
        ];
    }

    return [
        'success' => true,
        'data' => $bet_data,
        'model' => $model,
        'raw_ai_response' => $ai_response_text
    ];
}

/**
 * æ‰‹åŠ¨é‡æ–°è§£æé‚®ä»¶çš„å‡½æ•°
 */
function reanalyzeEmailWithAI(int $emailId): array {
    try {
        require_once __DIR__ . '/config.php';
        require_once __DIR__ . '/db_operations.php';

        $pdo = get_db_connection();

        // è·å–é‚®ä»¶å†…å®¹
        $stmt = $pdo->prepare("SELECT content FROM raw_emails WHERE id = ?");
        $stmt->execute([$emailId]);
        $emailContent = $stmt->fetchColumn();

        if (!$emailContent) {
            return ['success' => false, 'message' => 'Email not found'];
        }

        // è°ƒç”¨AIåˆ†æ
        $aiResult = analyzeBetSlipWithAI($emailContent);

        if ($aiResult['success']) {
            // åˆ é™¤æ—§çš„è§£æè®°å½•
            $stmtDelete = $pdo->prepare("DELETE FROM parsed_bets WHERE email_id = ?");
            $stmtDelete->execute([$emailId]);

            // æ’å…¥æ–°çš„è§£æè®°å½•
            $model_used = $aiResult['model'] ?? 'unknown_model';
            $bet_data_json = json_encode($aiResult['data']);

            $stmtInsert = $pdo->prepare("INSERT INTO parsed_bets (email_id, bet_data_json, ai_model_used) VALUES (?, ?, ?)");
            $stmtInsert->execute([$emailId, $bet_data_json, $model_used]);

            // æ›´æ–°é‚®ä»¶çŠ¶æ€
            $stmtUpdate = $pdo->prepare("UPDATE raw_emails SET status = 'processed' WHERE id = ?");
            $stmtUpdate->execute([$emailId]);

            return [
                'success' => true,
                'message' => 'é‡æ–°è§£ææˆåŠŸ',
                'batch_id' => $pdo->lastInsertId()
            ];
        } else {
            // æ›´æ–°é‚®ä»¶çŠ¶æ€ä¸ºå¤±è´¥
            $stmtUpdate = $pdo->prepare("UPDATE raw_emails SET status = 'failed' WHERE id = ?");
            $stmtUpdate->execute([$emailId]);

            return [
                'success' => false,
                'message' => 'AIè§£æå¤±è´¥: ' . ($aiResult['message'] ?? 'æœªçŸ¥é”™è¯¯')
            ];
        }

    } catch (Exception $e) {
        return [
            'success' => false,
            'message' => 'é‡æ–°è§£æè¿‡ç¨‹ä¸­å‡ºé”™: ' . $e->getMessage()
        ];
    }
}
?>
--- FILE: backend/index.php ---
<?php
// File: backend/index.php (Final Version)

/**
 * Main API Entry Point.
 * This script is responsible for loading core dependencies and routing
 * requests to the appropriate endpoint handlers.
 */

// --- 1. Load ALL core dependencies in one place, in the correct order ---

// config.php defines the config() helper function and sets up error logging.
require_once __DIR__ . '/config.php';

// db_operations.php defines get_db_connection() and uses the config() helper.
require_once __DIR__ . '/db_operations.php';

// api_header.php handles CORS headers, session start, and content type. It also uses config().
require_once __DIR__ . '/api_header.php';


// --- 2. Get endpoint parameter from the URL ---
$endpoint = $_GET['endpoint'] ?? null;

if ($endpoint === null) {
    http_response_code(400); // Bad Request
    echo json_encode(['status' => 'error', 'message' => 'Missing endpoint parameter.']);
    exit();
}


// --- 3. Define the routing map ---
// This array maps the 'endpoint' string to the physical PHP file.
$routes = [
    // Authentication endpoints
    'register'              => 'auth/register.php',
    'login'                 => 'auth/login.php',
    'logout'                => 'auth/logout.php',
    'check_session'         => 'auth/check_session.php',

    // Email related endpoints
    'get_emails'            => 'auth/get_emails.php',
    'get_email_details'     => 'auth/get_email_details.php',
    'update_bet_batch'      => 'auth/update_bet_batch.php',
    'reanalyze_email'       => 'auth/reanalyze_email.php', // æ–°å¢ï¼šé‡æ–°è§£æé‚®ä»¶

    // Lottery related endpoints
    'get_lottery_results'       => 'lottery/get_results.php',
    'get_lottery_result_by_issue' => 'lottery/get_result_by_issue.php',

    // Settlement related endpoints (Placeholder for future)
    // 'run_settlement'      => 'settlement/run.php',
    // 'get_settlements'     => 'settlement/get_list.php',
];


// --- 4. Route the request ---
if (isset($routes[$endpoint])) {
    // If the endpoint is valid, include the corresponding handler file.
    // The handler file will then take over and produce the output.
    require_once __DIR__ . '/' . $routes[$endpoint];
} else {
    // If the endpoint is not found in our map, return a 404 error.
    http_response_code(404); // Not Found
    echo json_encode(['status' => 'error', 'message' => 'Endpoint not found.']);
}

// --- 5. Log the request for debugging ---
// è®°å½•è¯·æ±‚æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•
if (defined('MAIL_LOG_FILE')) {
    $log_message = sprintf(
        "API Request: %s %s - Endpoint: %s - User: %s\n",
        $_SERVER['REQUEST_METHOD'],
        $_SERVER['REQUEST_URI'],
        $endpoint ?? 'none',
        $_SESSION['user_id'] ?? 'guest'
    );
    error_log($log_message, 3, MAIL_LOG_FILE);
}
?>
--- FILE: backend/lottery/rules.php ---
<?php
// File: backend/lottery/rules.php

if (!function_exists('get_lottery_rules')) {
    /**
     * è¿”å›æ‰€æœ‰å·ç çš„å±æ€§ï¼ŒåŒ…æ‹¬æ³¢è‰²å’Œç”Ÿè‚–ã€‚
     * @return array
     */
    function get_lottery_rules() {
        // ä½¿ç”¨é™æ€å˜é‡ï¼Œç¡®ä¿è¿™ä¸ªåºå¤§çš„æ•°ç»„åªè¢«æ„å»ºä¸€æ¬¡
        static $rules = null;

        if ($rules === null) {
            $rules = [
                '01' => ['color' => 'çº¢æ³¢', 'zodiac' => 'è›‡'], '02' => ['color' => 'çº¢æ³¢', 'zodiac' => 'é¾™'],
                '03' => ['color' => 'è“æ³¢', 'zodiac' => 'å…”'], '04' => ['color' => 'è“æ³¢', 'zodiac' => 'è™'],
                '05' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'ç‰›'], '06' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'é¼ '],
                '07' => ['color' => 'çº¢æ³¢', 'zodiac' => 'çŒª'], '08' => ['color' => 'çº¢æ³¢', 'zodiac' => 'ç‹—'],
                '09' => ['color' => 'è“æ³¢', 'zodiac' => 'é¸¡'], '10' => ['color' => 'è“æ³¢', 'zodiac' => 'çŒ´'],
                '11' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'ç¾Š'], '12' => ['color' => 'çº¢æ³¢', 'zodiac' => 'é©¬'],
                '13' => ['color' => 'çº¢æ³¢', 'zodiac' => 'è›‡'], '14' => ['color' => 'è“æ³¢', 'zodiac' => 'é¾™'],
                '15' => ['color' => 'è“æ³¢', 'zodiac' => 'å…”'], '16' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'è™'],
                '17' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'ç‰›'], '18' => ['color' => 'çº¢æ³¢', 'zodiac' => 'é¼ '],
                '19' => ['color' => 'çº¢æ³¢', 'zodiac' => 'çŒª'], '20' => ['color' => 'è“æ³¢', 'zodiac' => 'ç‹—'],
                '21' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'é¸¡'], '22' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'çŒ´'],
                '23' => ['color' => 'çº¢æ³¢', 'zodiac' => 'ç¾Š'], '24' => ['color' => 'çº¢æ³¢', 'zodiac' => 'é©¬'],
                '25' => ['color' => 'è“æ³¢', 'zodiac' => 'è›‡'], '26' => ['color' => 'è“æ³¢', 'zodiac' => 'é¾™'],
                '27' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'å…”'], '28' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'è™'],
                '29' => ['color' => 'çº¢æ³¢', 'zodiac' => 'ç‰›'], '30' => ['color' => 'çº¢æ³¢', 'zodiac' => 'é¼ '],
                '31' => ['color' => 'è“æ³¢', 'zodiac' => 'çŒª'], '32' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'ç‹—'],
                '33' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'é¸¡'], '34' => ['color' => 'çº¢æ³¢', 'zodiac' => 'çŒ´'],
                '35' => ['color' => 'çº¢æ³¢', 'zodiac' => 'ç¾Š'], '36' => ['color' => 'è“æ³¢', 'zodiac' => 'é©¬'],
                '37' => ['color' => 'è“æ³¢', 'zodiac' => 'è›‡'], '38' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'é¾™'],
                '39' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'å…”'], '40' => ['color' => 'çº¢æ³¢', 'zodiac' => 'è™'],
                '41' => ['color' => 'è“æ³¢', 'zodiac' => 'ç‰›'], '42' => ['color' => 'è“æ³¢', 'zodiac' => 'é¼ '],
                '43' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'çŒª'], '44' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'ç‹—'],
                '45' => ['color' => 'çº¢æ³¢', 'zodiac' => 'é¸¡'], '46' => ['color' => 'çº¢æ³¢', 'zodiac' => 'çŒ´'],
                '47' => ['color' => 'è“æ³¢', 'zodiac' => 'ç¾Š'], '48' => ['color' => 'è“æ³¢', 'zodiac' => 'é©¬'],
                '49' => ['color' => 'ç»¿æ³¢', 'zodiac' => 'è›‡'],
            ];
        }
        return $rules;
    }
}

if (!function_exists('get_color_by_number')) {
    /**
     * æ ¹æ®å·ç è·å–å…¶æ³¢è‰²ã€‚
     * @param string $number
     * @return string|null
     */
    function get_color_by_number(string $number) {
        $rules = get_lottery_rules();
        // ç¡®ä¿å·ç æ˜¯ä¸¤ä½æ•°ï¼Œä¾‹å¦‚ '5' -> '05'
        $number_padded = str_pad($number, 2, '0', STR_PAD_LEFT);
        return $rules[$number_padded]['color'] ?? null;
    }
}

if (!function_exists('get_zodiac_by_number')) {
    /**
     * æ ¹æ®å·ç è·å–å…¶ç”Ÿè‚–ã€‚
     * @param string $number
     * @return string|null
     */
    function get_zodiac_by_number(string $number) {
        $rules = get_lottery_rules();
        $number_padded = str_pad($number, 2, '0', STR_PAD_LEFT);
        return $rules[$number_padded]['zodiac'] ?? null;
    }
}
?>
--- FILE: backend/lottery/get_results.php ---
<?php
// File: backend/lottery/get_results.php (Simplified, No Requires)

if (!function_exists('get_db_connection')) {
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Core function get_db_connection() is missing.']);
    exit;
}

try {
    $pdo = get_db_connection();
    // ... (rest of the file is the same)
    $sql = "SELECT r1.* FROM lottery_results r1 JOIN (SELECT lottery_type, MAX(id) AS max_id FROM lottery_results GROUP BY lottery_type) r2 ON r1.lottery_type = r2.lottery_type AND r1.id = r2.max_id";
    $stmt = $pdo->query($sql);
    $results = $stmt->fetchAll(PDO::FETCH_ASSOC);
    // ... processing logic ...
    $grouped_results = [];
    foreach ($results as $row) {
        foreach(['winning_numbers', 'zodiac_signs', 'colors'] as $key) {
            $decoded = json_decode($row[$key]);
            $row[$key] = $decoded ?: [];
        }
        $grouped_results[$row['lottery_type']] = $row;
    }
    $lottery_types = ['é¦™æ¸¯å…­åˆå½©', 'æ–°æ¾³é—¨å…­åˆå½©', 'è€æ¾³é—¨å…­åˆå½©'];
    $final_data = [];
    foreach ($lottery_types as $type) {
        $final_data[$type] = $grouped_results[$type] ?? null;
    }
    echo json_encode(['status' => 'success', 'data' => $final_data]);
} catch (Throwable $e) {
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'An error occurred.', 'details' => $e->getMessage()]);
}
?>
--- FILE: backend/lottery/get_result_by_issue.php ---
<?php
// File: backend/lottery/get_result_by_issue.php

$issue_number = $_GET['issue'] ?? null;
$lottery_type = $_GET['type'] ?? null;

if (empty($issue_number) || empty($lottery_type)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Lottery type and issue number are required.']);
    exit;
}

try {
    $pdo = get_db_connection();
    $stmt = $pdo->prepare("SELECT * FROM lottery_results WHERE lottery_type = ? AND issue_number = ?");
    $stmt->execute([$lottery_type, $issue_number]);
    $result = $stmt->fetch(PDO::FETCH_ASSOC);

    if ($result) {
        // è§£ç  JSON å­—æ®µ
        foreach(['winning_numbers', 'zodiac_signs', 'colors'] as $key) {
            $result[$key] = json_decode($result[$key]) ?: [];
        }
        echo json_encode(['status' => 'success', 'data' => $result]);
    } else {
        http_response_code(404);
        echo json_encode(['status' => 'error', 'message' => 'Lottery result for this issue not found.']);
    }

} catch (PDOException $e) {
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Database error.']);
}
?>
--- FILE: backend/mail_receiver_light.php ---
<?php
// File: mail_receiver_light.php (å®Œå…¨ç®€åŒ–ç‰ˆ - æ— é¢‘ç‡æ£€æŸ¥)

// --- ç‹¬ç«‹çš„æ—¥å¿—ç³»ç»Ÿ ---
define('MAIL_LOG_FILE', __DIR__ . '/mail_debug.log');
function log_mail_debug($message) {
    error_log(date('[Y-m-d H:i:s] ') . $message . "\n", 3, MAIL_LOG_FILE);
}

log_mail_debug("=== é‚®ä»¶æ¥æ”¶å™¨å¼€å§‹ (ç®€åŒ–ç‰ˆ) ===");

try {
    // --- 1. åŠ è½½æ‰€æœ‰æ ¸å¿ƒä¾èµ– ---
    require_once __DIR__ . '/config.php';
    require_once __DIR__ . '/ai_helper.php';
    log_mail_debug("ä¾èµ–åŠ è½½å®Œæˆ");

    // --- 2. å®‰å…¨éªŒè¯ (Bearer Token) ---
    $secret = config('EMAIL_WORKER_SECRET');
    if (!$secret) {
        throw new Exception("EMAIL_WORKER_SECRET æœªé…ç½®");
    }

    $auth_header = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
    $token = str_replace('Bearer ', '', $auth_header);

    if (!hash_equals($secret, $token)) {
        log_mail_debug("ç¦æ­¢è®¿é—®: æ— æ•ˆçš„ token");
        http_response_code(403);
        echo json_encode(['status' => 'error', 'message' => 'ç¦æ­¢è®¿é—®']);
        exit;
    }
    log_mail_debug("å®‰å…¨æ£€æŸ¥é€šè¿‡");

    // --- 3. è·å–å¹¶éªŒè¯è¾“å…¥ (JSONæ ¼å¼) ---
    $json_input = file_get_contents('php://input');
    if (empty($json_input)) {
        throw new Exception("ç©ºçš„ JSON è¾“å…¥");
    }

    $input = json_decode($json_input, true);
    if ($input === null) {
        throw new Exception("æ— æ•ˆçš„ JSON æ•°æ®");
    }

    $sender_email = $input['sender'] ?? null;
    $raw_content = $input['raw_content'] ?? null;

    if (empty($sender_email) || empty($raw_content)) {
        throw new Exception("ç¼ºå°‘ 'sender' æˆ– 'raw_content' å­—æ®µ");
    }
    log_mail_debug("æ”¶åˆ°æ¥è‡ª: " . $sender_email . " çš„é‚®ä»¶");

    // --- 4. è¿æ¥æ•°æ®åº“ ---
    $dsn = sprintf("mysql:host=%s;port=%s;dbname=%s;charset=utf8mb4",
        config('DB_HOST'), config('DB_PORT'), config('DB_DATABASE')
    );
    $options = [ PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION ];
    $pdo = new PDO($dsn, config('DB_USERNAME'), config('DB_PASSWORD'), $options);
    log_mail_debug("æ•°æ®åº“è¿æ¥æˆåŠŸ");

    // --- 5. æŸ¥æ‰¾ç”¨æˆ· ---
    $stmt_find = $pdo->prepare("SELECT id FROM users WHERE email = ? AND status = 'active'");
    $stmt_find->execute([$sender_email]);
    $user_id = $stmt_find->fetchColumn();

    if ($user_id) {
        log_mail_debug("æ‰¾åˆ°ç”¨æˆ· ID: " . $user_id);

        // --- æ­¥éª¤ A: å­˜å…¥åŸå§‹é‚®ä»¶ ---
        $stmt_insert_raw = $pdo->prepare("INSERT INTO raw_emails (user_id, content, status) VALUES (?, ?, 'pending')");
        $stmt_insert_raw->execute([$user_id, $raw_content]);
        $email_id = $pdo->lastInsertId();
        log_mail_debug("é‚®ä»¶å­˜å…¥ raw_emailsï¼ŒID: " . $email_id);

        // --- æ­¥éª¤ B: è°ƒç”¨ AI åˆ†æ ---
        log_mail_debug("è°ƒç”¨ AI åˆ†æé‚®ä»¶å†…å®¹...");
        $ai_result = analyzeBetSlipWithAI($raw_content);

        if ($ai_result['success']) {
            // AI åˆ†ææˆåŠŸ
            $model_used = $ai_result['model'] ?? 'unknown_model';
            log_mail_debug("AI åˆ†ææˆåŠŸã€‚æ¨¡å‹: " . $model_used);
            $bet_data_json = json_encode($ai_result['data']);

            // å­˜å…¥ parsed_bets è¡¨
            $stmt_insert_parsed = $pdo->prepare("INSERT INTO parsed_bets (email_id, bet_data_json, ai_model_used) VALUES (?, ?, ?)");
            $stmt_insert_parsed->execute([$email_id, $bet_data_json, $model_used]);

            // æ›´æ–° raw_emails çŠ¶æ€ä¸º processed
            $stmt_update_status = $pdo->prepare("UPDATE raw_emails SET status = 'processed' WHERE id = ?");
            $stmt_update_status->execute([$email_id]);
            log_mail_debug("è§£ææ•°æ®å·²å­˜å‚¨ï¼ŒçŠ¶æ€æ›´æ–°ä¸º processed");

            http_response_code(200);
            echo json_encode([
                'status' => 'success',
                'message' => 'é‚®ä»¶å¤„ç†å®Œæˆ',
                'ai_status' => 'success',
                'email_id' => $email_id,
                'model_used' => $model_used
            ]);
        } else {
            // AI åˆ†æå¤±è´¥
            $error_message = $ai_result['message'] ?? 'æœªçŸ¥ AI é”™è¯¯';
            log_mail_debug("AI åˆ†æå¤±è´¥ã€‚åŸå› : " . $error_message);

            // æ›´æ–° raw_emails çŠ¶æ€ä¸º failed
            $stmt_update_status = $pdo->prepare("UPDATE raw_emails SET status = 'failed' WHERE id = ?");
            $stmt_update_status->execute([$email_id]);

            http_response_code(200);
            echo json_encode([
                'status' => 'success',
                'message' => 'é‚®ä»¶å·²ä¿å­˜ä½† AI åˆ†æå¤±è´¥',
                'ai_status' => 'failed',
                'email_id' => $email_id,
                'ai_error' => $error_message
            ]);
        }

    } else {
        log_mail_debug("ç”¨æˆ· '{$sender_email}' æœªæ‰¾åˆ°æˆ–æœªæ¿€æ´»ã€‚å¿½ç•¥é‚®ä»¶");
        http_response_code(200);
        echo json_encode(['status' => 'success', 'message' => 'ç”¨æˆ·æœªå¤„ç†']);
    }

} catch (Throwable $e) {
    log_mail_debug("--- ä¸¥é‡é”™è¯¯ ---");
    log_mail_debug("é”™è¯¯ä¿¡æ¯: " . $e->getMessage());
    log_mail_debug("æ–‡ä»¶: " . $e->getFile() . " ç¬¬ " . $e->getLine() . " è¡Œ");
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'å†…éƒ¨æœåŠ¡å™¨é”™è¯¯']);
}

log_mail_debug("=== é‚®ä»¶æ¥æ”¶å™¨å®Œæˆ ===\n");
?>
--- FILE: backend/db_operations.php ---
<?php
// File: backend/db_operations.php (Final Standardized Version)

if (defined('DB_OPERATIONS_LOADED')) return;
define('DB_OPERATIONS_LOADED', true);

function get_db_connection() {
    static $pdo = null;
    if ($pdo === null) {
        // ã€å…³é”®ä¿®æ”¹ã€‘ç¡®ä¿æˆ‘ä»¬è¯»å–çš„æ˜¯æ ‡å‡†åŒ–çš„å˜é‡å
        $dsn = sprintf("mysql:host=%s;port=%s;dbname=%s;charset=utf8mb4",
            config('DB_HOST'),
            config('DB_PORT'),
            config('DB_DATABASE') // è¯»å– DB_DATABASE
        );

        $options = [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
        ];

        // è¯»å– DB_USERNAME å’Œ DB_PASSWORD
        $pdo = new PDO($dsn, config('DB_USERNAME'), config('DB_PASSWORD'), $options);
    }
    return $pdo;
}
--- FILE: backend/helpers/mail_parser.php ---
<?php
// File: backend/helpers/mail_parser.php

if (!function_exists('parse_email_body')) {
    /**
     * ä»åŸå§‹ MIME é‚®ä»¶æ–‡æœ¬ä¸­è§£æå¹¶è§£ç å‡ºæœ€åˆé€‚çš„ç”¨æˆ·æ­£æ–‡ã€‚
     * ä¼˜å…ˆæå– text/plain éƒ¨åˆ†ã€‚
     *
     * @param string $raw_email å®Œæ•´çš„åŸå§‹é‚®ä»¶å†…å®¹ã€‚
     * @return string æ¸…ç†å’Œè§£ç åçš„æ­£æ–‡æ–‡æœ¬ã€‚
     */
    function parse_email_body(string $raw_email): string {
        // 1. åˆ†ç¦»é‚®ä»¶å¤´å’Œé‚®ä»¶ä½“
        $parts = explode("\r\n\r\n", $raw_email, 2);
        if (count($parts) !== 2) {
            return $raw_email; // æ ¼å¼ä¸è§„èŒƒï¼Œè¿”å›åŸæ–‡
        }
        list($headers_raw, $body_raw) = $parts;

        // 2. è§£æé‚®ä»¶å¤´çš„ Content-Type
        if (!preg_match('/Content-Type: (.*)/i', $headers_raw, $matches)) {
            return $body_raw; // æ²¡æœ‰ Content-Typeï¼Œç›´æ¥è¿”å›é‚®ä»¶ä½“
        }
        $content_type_header = $matches[1];

        // 3. å¦‚æœä¸æ˜¯ multipart é‚®ä»¶ï¼Œç›´æ¥è§£ç é‚®ä»¶ä½“
        if (strpos(strtolower($content_type_header), 'multipart/') === false) {
            if (preg_match('/Content-Transfer-Encoding: (base64|quoted-printable)/i', $headers_raw, $encoding_match)) {
                return decode_body_part($body_raw, $encoding_match[1]);
            }
            return $body_raw;
        }

        // 4. å¦‚æœæ˜¯ multipart é‚®ä»¶ï¼Œè§£æ boundary
        if (!preg_match('/boundary="?([^"]+)"?/i', $content_type_header, $boundary_match)) {
            return $body_raw; // æ‰¾ä¸åˆ° boundaryï¼Œæ— æ³•è§£æ
        }
        $boundary = $boundary_match[1];

        // 5. æŒ‰ boundary åˆ†å‰²é‚®ä»¶ä½“
        $body_parts = explode('--' . $boundary, $body_raw);
        array_shift($body_parts); // ç§»é™¤ç¬¬ä¸€ä¸ªç©ºéƒ¨åˆ†
        array_pop($body_parts);   // ç§»é™¤æœ€åä¸€ä¸ª '--' ç»“å°¾çš„éƒ¨åˆ†

        $plain_text_body = '';
        $html_body = '';

        // 6. éå†æ¯ä¸ªéƒ¨åˆ†ï¼Œå¯»æ‰¾ text/plain å’Œ text/html
        foreach ($body_parts as $part) {
            if (empty(trim($part))) continue;

            $part_parts = explode("\r\n\r\n", $part, 2);
            if (count($part_parts) !== 2) continue;
            list($part_header_raw, $part_body_raw) = $part_parts;

            // æ£€æŸ¥å½“å‰éƒ¨åˆ†çš„ Content-Type
            if (preg_match('/Content-Type: text\/plain/i', $part_header_raw)) {
                if (preg_match('/Content-Transfer-Encoding: (base64|quoted-printable)/i', $part_header_raw, $encoding_match)) {
                    $plain_text_body = decode_body_part($part_body_raw, $encoding_match[1]);
                } else {
                    $plain_text_body = $part_body_raw;
                }
            } elseif (preg_match('/Content-Type: text\/html/i', $part_header_raw)) {
                if (preg_match('/Content-Transfer-Encoding: (base64|quoted-printable)/i', $part_header_raw, $encoding_match)) {
                    // è§£ç HTMLå¹¶å»é™¤æ‰€æœ‰HTMLæ ‡ç­¾ï¼Œå¾—åˆ°çº¯æ–‡æœ¬
                    $html_body = strip_tags(decode_body_part($part_body_raw, $encoding_match[1]));
                } else {
                    $html_body = strip_tags($part_body_raw);
                }
            }
        }

        // 7. ä¼˜å…ˆè¿”å›çº¯æ–‡æœ¬æ­£æ–‡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›ä»HTMLä¸­æå–çš„æ–‡æœ¬
        return trim($plain_text_body) ?: trim($html_body) ?: 'æ— æ³•è§£æé‚®ä»¶æ­£æ–‡';
    }
}

if (!function_exists('decode_body_part')) {
    /**
     * è§£ç  base64 æˆ– quoted-printable ç¼–ç çš„é‚®ä»¶ä½“éƒ¨åˆ†ã€‚
     * @param string $body
     * @param string $encoding
     * @return string
     */
    function decode_body_part(string $body, string $encoding): string {
        $encoding = strtolower(trim($encoding));
        if ($encoding === 'base64') {
            return base64_decode($body);
        } elseif ($encoding === 'quoted-printable') {
            return quoted_printable_decode($body);
        }
        return $body; // å¦‚æœç¼–ç ä¸è®¤è¯†ï¼Œè¿”å›åŸæ–‡
    }
}
?>
--- FILE: backend/mail/receive.php ---
<?php
// backend/mail/receive.php
require_once __DIR__ . '/../config.php';
require_once __DIR__ . '/../db_operations.php';

// 1. å®‰å…¨éªŒè¯ (è¯»å– Authorization Header)
$secret = config('EMAIL_WORKER_SECRET');
$auth_header = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
$token = str_replace('Bearer ', '', $auth_header);

if (!$secret || !hash_equals($secret, $token)) { // ä½¿ç”¨ hash_equals é˜²æ­¢æ—¶åºæ”»å‡»
    http_response_code(403);
    echo json_encode(['status' => 'error', 'message' => 'Forbidden: Invalid token.']);
    exit;
}

// 2. è·å– JSON Body
$input = json_decode(file_get_contents('php://input'), true);
$sender_email = $input['sender'] ?? null;
$raw_content = $input['raw_content'] ?? null;

if (empty($sender_email) || empty($raw_content)) {
    http_response_code(400);
    echo json_encode(['status' => 'error', 'message' => 'Missing sender or raw_content.']);
    exit;
}

try {
    $pdo = get_db_connection();
    // 3. æŸ¥æ‰¾ç”¨æˆ·
    $stmt = $pdo->prepare("SELECT id FROM users WHERE email = ? AND status = 'active'");
    $stmt->execute([$sender_email]);
    $user_id = $stmt->fetchColumn();

    if (!$user_id) {
        error_log("Email received from unregistered/banned user: {$sender_email}");
        http_response_code(200);
        echo json_encode(['status' => 'success', 'message' => 'User not processed.']);
        exit;
    }

    // 4. å­˜å…¥æ•°æ®åº“
    $stmt = $pdo->prepare("INSERT INTO raw_emails (user_id, content) VALUES (?, ?)");
    $stmt->execute([$user_id, $raw_content]);

    http_response_code(200);
    echo json_encode(['status' => 'success', 'message' => 'Email received and stored.']);

} catch (PDOException $e) {
    error_log("Error in mail/receive.php: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'Database error.']);
}
?>
--- FILE: backend/config.php ---
<?php
// File: backend/config.php (Final Debugging Version for FRONTEND_URL)

// å®šä¹‰ä¸€ä¸ªè°ƒè¯•æ—¥å¿—æ–‡ä»¶è·¯å¾„
define('CONFIG_DEBUG_LOG', __DIR__ . '/config_debug.log');

// åœ¨è„šæœ¬æ‰§è¡Œæ—¶ï¼Œå¦‚æœæ—¥å¿—å·²å­˜åœ¨ï¼Œåˆ™ä¸æ¸…ç©ºï¼Œä»¥ä¾¿æˆ‘ä»¬è¿½åŠ æ—¥å¿—
// unlink(CONFIG_DEBUG_LOG);

function _log_config_debug($message) {
    error_log(date('[Y-m-d H:i:s] ') . $message . "\n", 3, CONFIG_DEBUG_LOG);
}

// è®°å½•å“ªä¸ªæ–‡ä»¶æ­£åœ¨åŠ è½½ config.php
$caller = debug_backtrace()[0]['file'];
_log_config_debug("--- config.php loaded by: {$caller} ---");

if (!function_exists('config')) {
    function config(string $key, $default = null) {
        static $config = null;

        if ($config === null) {
            _log_config_debug("Static \$config is null. Initializing...");
            $config = [];
            $envPath = __DIR__ . '/.env';

            if (file_exists($envPath) && is_readable($envPath)) {
                $lines = file($envPath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
                if ($lines) {
                    foreach ($lines as $line) {
                        if (strpos(trim($line), ';') === 0) continue;
                        if (strpos($line, ';') !== false) {
                            $line = substr($line, 0, strpos($line, ';'));
                        }
                        if (strpos($line, '=') !== false) {
                            list($name, $value) = explode('=', $line, 2);
                            $name = trim($name);
                            $value = trim(trim($value), "\"'");
                            $config[$name] = $value;
                            if ($name === 'FRONTEND_URL') {
                                _log_config_debug("SUCCESS: Found and loaded [FRONTEND_URL] = [{$value}]");
                            }
                        }
                    }
                }
            } else {
                 _log_config_debug("FATAL: .env file not found or not readable.");
            }
        }

        $returnValue = $config[$key] ?? $default;
        _log_config_debug("config('{$key}') requested, returning: " . ($returnValue ?? 'NULL'));
        return $returnValue;
    }
}

// ... Error Handling ...
ini_set('display_errors', '0');
ini_set('log_errors', '1');
ini_set('error_log', __DIR__ . '/debug.log');
error_reporting(E_ALL);
--- FILE: backend/setup_bot.php ---
<?php
// File: backend/setup_bot.php (Final version that reads from .env)

// --- ç‹¬ç«‹çš„ .env åŠ è½½å™¨ (å’Œ receiver.php ä¸­é‚£ä¸ªä¸€æ ·) ---
function load_env_for_setup() {
    $envPath = __DIR__ . '/.env';
    if (!file_exists($envPath)) {
        die("Error: .env file not found in " . __DIR__);
    }
    $lines = file($envPath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    if (!$lines) {
        die("Error: Could not read .env file.");
    }
    foreach ($lines as $line) {
        if (strpos(trim($line), ';') === 0) continue;
        if (strpos($line, ';') !== false) $line = substr($line, 0, strpos($line, ';'));
        if (strpos($line, '=') !== false) {
            list($name, $value) = explode('=', $line, 2);
            // è¿™é‡Œæˆ‘ä»¬åªéœ€è¦ getenv èƒ½å·¥ä½œå°±è¡Œ
            putenv(trim($name) . "=" . trim(trim($value), "\"'"));
        }
    }
}

// åŠ è½½é…ç½®
load_env_for_setup();

$bot_token = getenv('TELEGRAM_BOT_TOKEN');
$webhook_secret = getenv('TELEGRAM_WEBHOOK_SECRET'); // ä» .env è¯»å–æ–°å¯†é’¥

if (!$bot_token || !$webhook_secret) {
    die("Error: TELEGRAM_BOT_TOKEN or TELEGRAM_WEBHOOK_SECRET not found in .env file.");
}

// ç›´æ¥æŒ‡å‘æˆ‘ä»¬è½»é‡çº§çš„ receiver.php
$webhook_url = "https://wenge.cloudns.ch/telegram/receiver.php?secret=" . urlencode($webhook_secret);

$api_url = "https://api.telegram.org/bot{$bot_token}/setWebhook?url=" . urlencode($webhook_url);

// è°ƒç”¨ API å¹¶æ˜¾ç¤ºç»“æœ
$response = file_get_contents($api_url);
header('Content-Type: application/json');
echo $response;
?>
