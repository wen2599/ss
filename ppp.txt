--- File: frontend/package.json ---

{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.23.1"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.0.3",
    "vite": "^4.4.5"
  }
}
--- End of File: frontend/package.json ---


--- File: frontend/src/pages/HomePage.jsx ---

// src/pages/HomePage.jsx
import React from 'react';
import LotteryResults from '../components/LotteryResults';

function HomePage() {
  return (
    <div>
      <h1>å¼€å¥–ä¸­å¿ƒ</h1>
      <LotteryResults />
    </div>
  );
}
export default HomePage;
--- End of File: frontend/src/pages/HomePage.jsx ---


--- File: frontend/src/pages/EmailsListPage.jsx ---

// File: frontend/pages/EmailsListPage.jsx (æ·»åŠ é‚®ä»¶æ•°é‡æ˜¾ç¤º)

import React, { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';
import { apiService } from '../api';

const StatusBadge = ({ status }) => {
    const statusStyles = {
        pending: { backgroundColor: '#ffc107', color: '#333' },
        processed: { backgroundColor: '#28a745', color: 'white' },
        failed: { backgroundColor: '#dc3545', color: 'white' },
    };
    const style = { padding: '0.25rem 0.5rem', borderRadius: '12px', fontSize: '0.8rem', fontWeight: 'bold', ...statusStyles[status] };
    return <span style={style}>{status.toUpperCase()}</span>;
};

function EmailsListPage() {
  const [emails, setEmails] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    apiService.getEmails()
      .then(response => {
        if (response.status === 'success') {
          setEmails(response.data);
        } else {
          setError(response.message);
        }
      })
      .catch(err => setError(err.message))
      .finally(() => setLoading(false));
  }, []);

  const renderContent = () => {
    if (loading) return <p>æ­£åœ¨åŠ è½½é‚®ä»¶åˆ—è¡¨...</p>;
    if (error) return <p style={{ color: 'red' }}>é”™è¯¯: {error}</p>;
    if (emails.length === 0) return <p>æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é‚®ä»¶ã€‚</p>;

    return (
      <div>
        <div style={{
          backgroundColor: '#e7f3ff',
          border: '1px solid #b3d9ff',
          borderRadius: '8px',
          padding: '1rem',
          marginBottom: '1rem'
        }}>
          <p style={{ margin: 0, fontWeight: 'bold', color: '#0066cc' }}>
            ğŸ“§ ç³»ç»Ÿè‡ªåŠ¨ç»´æŠ¤ï¼šæœ€å¤šä¿å­˜æœ€è¿‘10å°é‚®ä»¶ï¼Œæ–°é‚®ä»¶ä¼šè‡ªåŠ¨æ›¿æ¢æ—§é‚®ä»¶
          </p>
          <p style={{ margin: '0.5rem 0 0 0', fontSize: '0.9rem', color: '#666' }}>
            å½“å‰é‚®ä»¶æ•°é‡: {emails.length} / 10
          </p>
        </div>

        <table>
          <thead>
            <tr>
              <th>é‚®ä»¶ ID</th>
              <th>å¤„ç†çŠ¶æ€</th>
              <th>æ¥æ”¶æ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {emails.map(email => (
              <tr key={email.id}>
                <td>#{email.id}</td>
                <td><StatusBadge status={email.status} /></td>
                <td>{new Date(email.received_at).toLocaleString()}</td>
                <td>
                  <Link to={`/emails/${email.id}`} className="button-link">
                    æŸ¥çœ‹åŸæ–‡ä¸ç»“ç®—
                  </Link>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    );
  };

  return (
    <div className="card">
      <h2>é‚®ä»¶åˆ—è¡¨</h2>
      {renderContent()}
    </div>
  );
}

export default EmailsListPage;

--- End of File: frontend/src/pages/EmailsListPage.jsx ---


--- File: frontend/src/pages/AuthPage.jsx ---

// src/pages/AuthPage.jsx
import React, { useState } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

function AuthPage() {
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [message, setMessage] = useState('');
  const [isSuccess, setIsSuccess] = useState(false);
  const [loading, setLoading] = useState(false);

  const { login, register } = useAuth();
  const navigate = useNavigate();
  const location = useLocation();
  const from = location.state?.from?.pathname || '/emails';

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setMessage('');
    setIsSuccess(false);
    try {
      if (isLogin) {
        await login(email, password);
        navigate(from, { replace: true });
      } else {
        const response = await register(email, password);
        setMessage(response.message + " ç°åœ¨å¯ä»¥ç™»å½•äº†ã€‚");
        setIsSuccess(true);
        setIsLogin(true);
      }
    } catch (error) {
      setMessage(error.message);
      setIsSuccess(false);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="card" style={{ maxWidth: '400px', margin: 'auto', marginTop: '4rem' }}>
      <h2>{isLogin ? 'ç™»å½•' : 'æ³¨å†Œ'}</h2>
      <form onSubmit={handleSubmit}>
        <div>
          <label htmlFor="email">é‚®ç®±åœ°å€</label>
          <input id="email" type="email" value={email} onChange={e => setEmail(e.target.value)} required autoComplete="email" disabled={loading} />
        </div>
        <div>
          <label htmlFor="password">å¯†ç </label>
          <input id="password" type="password" value={password} onChange={e => setPassword(e.target.value)} required autoComplete={isLogin ? "current-password" : "new-password"} disabled={loading} />
        </div>
        <button type="submit" disabled={loading}>{loading ? 'å¤„ç†ä¸­...' : (isLogin ? 'ç™»å½•' : 'æ³¨å†Œ')}</button>
      </form>
      <p>
        {isLogin ? 'è¿˜æ²¡æœ‰è´¦æˆ·?' : 'å·²æœ‰è´¦æˆ·?'}
        <button onClick={() => { setIsLogin(!isLogin); setMessage(''); }} className="link-button" disabled={loading}>
          åˆ‡æ¢åˆ°{isLogin ? 'æ³¨å†Œ' : 'ç™»å½•'}
        </button>
      </p>
      {message && <p className={`message ${isSuccess ? 'success' : ''}`}>{message}</p>}
    </div>
  );
}

export default AuthPage;
--- End of File: frontend/src/pages/AuthPage.jsx ---


--- File: frontend/src/pages/SettlementsPage.jsx ---

// src/pages/SettlementsPage.jsx
import React, { useState, useEffect } from 'react';
import { apiService } from '../api';

function SettlementsPage() {
    const [settlements, setSettlements] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        apiService.getSettlements()
            .then(data => setSettlements(data.data))
            .finally(() => setLoading(false));
    }, []);

    if (loading) return <p>æ­£åœ¨åŠ è½½ç»“ç®—å•...</p>;

    return (
        <div className="card">
            <h2>ç»“ç®—è¡¨å•</h2>
            <table>
                <thead>
                    <tr><th>ID</th><th>æŠ•æ³¨ID</th><th>æ€»èµ¢/äº</th><th>åˆ›å»ºæ—¶é—´</th></tr>
                </thead>
                <tbody>
                    {settlements.map(item => (
                        <tr key={item.id}>
                            <td>{item.id}</td>
                            <td>{item.bet_id}</td>
                            <td style={{ color: item.total_win > 0 ? 'green' : 'red' }}>{item.total_win}</td>
                            <td>{new Date(item.created_at).toLocaleString()}</td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    );
}

export default SettlementsPage;
--- End of File: frontend/src/pages/SettlementsPage.jsx ---


--- File: frontend/src/pages/EmailDetailPage.jsx ---

// File: frontend/src/pages/EmailDetailPage.jsx (ä¿®å¤ emailId ä¼ é€’é—®é¢˜)
import React, { useState, useEffect } from 'react';
import { useParams, Link } from 'react-router-dom';
import { apiService } from '../api';
import SingleBetCard from '../components/SingleBetCard';

// æ‰¹é‡é‡æ–°è§£ææ¨¡æ€æ¡†ç»„ä»¶
function BatchReparseModal({ isOpen, onClose, onConfirm, loading, unparsedCount }) {
  const [selectedTypes, setSelectedTypes] = useState([]);
  const lotteryTypes = [
    { value: 'é¦™æ¸¯å…­åˆå½©', label: 'é¦™æ¸¯å…­åˆå½© (å‘¨äºŒã€å››ã€å…­å¼€å¥–)' },
    { value: 'æ–°æ¾³é—¨å…­åˆå½©', label: 'æ–°æ¾³é—¨å…­åˆå½© (æ¯æ—¥å¼€å¥–)' },
    { value: 'è€æ¾³é—¨å…­åˆå½©', label: 'è€æ¾³é—¨å…­åˆå½© (æ¯æ—¥å¼€å¥–)' }
  ];
  const handleTypeToggle = (type) => {
    setSelectedTypes([type]);
  };
  const handleConfirm = () => {
    if (selectedTypes.length === 0) {
      alert('è¯·é€‰æ‹©ä¸€ç§å½©ç¥¨ç±»å‹');
      return;
    }
    onConfirm(selectedTypes);
  };
  if (!isOpen) return null;
  return (
    <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
      <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '8px', minWidth: '400px', maxWidth: '500px' }}>
        <h3 style={{ marginTop: 0, marginBottom: '1.5rem' }}>æ‰¹é‡é‡æ–°è§£æ</h3>
        <div style={{ marginBottom: '1.5rem' }}>
          <p><strong>æœªè§£æè¡Œæ•°:</strong> {unparsedCount}</p>
        </div>
        <div style={{ marginBottom: '1.5rem' }}>
          <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>é€‰æ‹©å½©ç¥¨ç±»å‹:</label>
          {lotteryTypes.map(type => (
            <div key={type.value} style={{ marginBottom: '0.5rem' }}>
              <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                <input type="radio" name="batchLotteryType" checked={selectedTypes.includes(type.value)} onChange={() => handleTypeToggle(type.value)} style={{ marginRight: '0.5rem' }} />
                {type.label}
              </label>
            </div>
          ))}
        </div>
        <div style={{ display: 'flex', gap: '0.5rem', justifyContent: 'flex-end' }}>
          <button onClick={onClose} disabled={loading} style={{ padding: '0.5rem 1rem', backgroundColor: '#6c757d', color: 'white', border: 'none', borderRadius: '4px' }}>å–æ¶ˆ</button>
          <button onClick={handleConfirm} disabled={loading || selectedTypes.length === 0} style={{ padding: '0.5rem 1rem', backgroundColor: (loading || selectedTypes.length === 0) ? '#6c757d' : '#28a745', color: 'white', border: 'none', borderRadius: '4px' }}>{loading ? 'è§£æä¸­...' : 'å¼€å§‹æ‰¹é‡è§£æ'}</button>
        </div>
      </div>
    </div>
  );
}

function EmailDetailPage() {
  const { emailId } = useParams();
  const [loading, setLoading] = useState(true);
  const [viewMode, setViewMode] = useState('split');
  const [error, setError] = useState(null);
  const [pageData, setPageData] = useState({ email_content: '', lines: [] });
  const [hasOddsTemplate, setHasOddsTemplate] = useState(true);
  const [reparsing, setReparsing] = useState(false);
  const [showReparseModal, setShowReparseModal] = useState(false);

  // ç¡®ä¿ emailId æ˜¯æ•°å­—
  const numericEmailId = parseInt(emailId, 10);

  useEffect(() => {
    fetchEmailLines();
    checkOddsTemplate();
  }, [emailId]);

  const checkOddsTemplate = async () => {
    try {
      const response = await apiService.getOddsTemplate();
      setHasOddsTemplate(response.status === 'success' && Object.values(response.data).some(v => v));
    } catch (error) {
      setHasOddsTemplate(false);
    }
  };

  const fetchEmailLines = () => {
    setLoading(true);
    setError(null);
    apiService.splitEmailLines(emailId)
      .then(res => {
        if (res.status === 'success') setPageData(res.data);
        else setError({ message: res.message || 'è·å–æ•°æ®å¤±è´¥' });
      })
      .catch(err => setError({ message: err.message || 'ç½‘ç»œè¯·æ±‚å¤±è´¥' }))
      .finally(() => setLoading(false));
  };

  const handleLineUpdate = (lineNumber, updateData) => {
    setPageData(prev => ({
      ...prev,
      lines: prev.lines.map(line =>
        line.line_number === lineNumber
          ? {
              ...line,
              is_parsed: true,
              batch_data: {
                batch_id: updateData.batch_id,
                data: updateData.parse_result
              }
            }
          : line
      )
    }));
  };

  const handleLineDelete = (lineNumber) => {
    setPageData(prev => ({
      ...prev,
      lines: prev.lines.map(line =>
        line.line_number === lineNumber
          ? { ...line, is_parsed: false, batch_data: null }
          : line
      )
    }));
  };

  const handleBatchReparse = async (selectedTypes) => {
    if (!selectedTypes || selectedTypes.length === 0) return alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ç§å½©ç¥¨ç±»å‹');
    setReparsing(true);
    setShowReparseModal(false);
    const lotteryType = selectedTypes[0];
    const unparsedLines = pageData.lines.filter(line => !line.is_parsed);
    if (unparsedLines.length === 0) {
      alert('æ‰€æœ‰è¡Œéƒ½å·²è§£æå®Œæˆï¼');
      setReparsing(false);
      return;
    }
    let successCount = 0, errorCount = 0;
    for (const line of unparsedLines) {
      try {
        const result = await apiService.parseSingleBet(numericEmailId, line.text, line.line_number, lotteryType);
        if (result.status === 'success') {
          handleLineUpdate(line.line_number, result.data);
          successCount++;
        } else {
          errorCount++;
        }
      } catch (error) {
        errorCount++;
      }
      await new Promise(resolve => setTimeout(resolve, 100));
    }
    alert(`æ‰¹é‡è§£æå®Œæˆï¼æˆåŠŸ: ${successCount} æ¡ï¼Œå¤±è´¥: ${errorCount} æ¡`);
    setReparsing(false);
  };

  const globalStats = pageData.lines.reduce((stats, line) => {
    if (line.is_parsed && line.batch_data?.data?.settlement) {
      const settlement = line.batch_data.data.settlement;
      stats.totalBet += settlement.total_bet_amount || 0;
      stats.totalWin += settlement.net_profits?.total_win || 0;
      stats.parsedCount++;
    }
    return stats;
  }, { totalBet: 0, totalWin: 0, parsedCount: 0 });

  if (loading) return <div className="card"><p>æ­£åœ¨æ‹†åˆ†é‚®ä»¶å†…å®¹...</p></div>;
  if (error) return <div className="card"><p style={{ color: 'red' }}>é”™è¯¯: {error.message}</p><button onClick={fetchEmailLines}>é‡æ–°åŠ è½½</button></div>;

  return (
    <div className="card">
      {!hasOddsTemplate && (
        <div style={{ backgroundColor: '#fff3cd', border: '1px solid #ffeaa7', padding: '1rem', marginBottom: '1rem' }}>
          <p style={{ margin: 0 }}>âš ï¸ æ‚¨è¿˜æ²¡æœ‰è®¾ç½®èµ”ç‡æ¨¡æ¿ï¼Œç»“ç®—è®¡ç®—å¯èƒ½ä¸å‡†ç¡®ã€‚è¯·å…ˆ <Link to="/odds-template">è®¾ç½®èµ”ç‡</Link></p>
        </div>
      )}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
        <h2>æ™ºèƒ½è§£æé¢æ¿ (é‚®ä»¶ID: {emailId})</h2>
        <div>
          <button onClick={() => setShowReparseModal(true)} disabled={reparsing}>{reparsing ? 'æ‰¹é‡è§£æä¸­...' : 'æ‰¹é‡é‡æ–°è§£æ'}</button>
          <button onClick={() => setViewMode('original')}>åŸå§‹è§†å›¾</button>
          <button onClick={() => setViewMode('split')}>åˆ†æ¡è§£æ</button>
        </div>
      </div>
      <div style={{ backgroundColor: '#e7f3ff', border: '1px solid #b3d9ff', padding: '1rem', marginBottom: '1.5rem' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', flexWrap: 'wrap' }}>
          <div><strong>æ€»æ¡æ•°:</strong> {pageData.lines.length}</div>
          <div><strong>å·²è§£æ:</strong> {globalStats.parsedCount}</div>
          <div><strong>æœªè§£æ:</strong> {pageData.lines.length - globalStats.parsedCount}</div>
          <div><strong>æ€»ä¸‹æ³¨:</strong> {globalStats.totalBet} å…ƒ</div>
          <div><strong>æ€»ä¸­å¥–:</strong> {globalStats.totalWin} å…ƒ</div>
          <div style={{ color: (globalStats.totalWin - globalStats.totalBet) >= 0 ? 'red' : 'blue', fontWeight: 'bold' }}>
            <strong>å‡€ç›ˆäº:</strong> {(globalStats.totalWin - globalStats.totalBet) >= 0 ? '+' : ''}{globalStats.totalWin - globalStats.totalBet} å…ƒ
          </div>
        </div>
      </div>
      {viewMode === 'original' ? (
        <pre className="email-content-background">{pageData.email_content}</pre>
      ) : (
        <div>
          {pageData.lines.map(line => (
            <SingleBetCard
              key={line.line_number}
              lineData={line}
              emailId={numericEmailId} // ç¡®ä¿ä¼ é€’æ•°å­—ç±»å‹çš„ emailId
              onUpdate={handleLineUpdate}
              onDelete={handleLineDelete}
            />
          ))}
        </div>
      )}
      {showReparseModal && (
        <BatchReparseModal
          isOpen={showReparseModal}
          onClose={() => setShowReparseModal(false)}
          onConfirm={handleBatchReparse}
          loading={reparsing}
          unparsedCount={pageData.lines.length - globalStats.parsedCount}
        />
      )}
    </div>
  );
}

export default EmailDetailPage;

--- End of File: frontend/src/pages/EmailDetailPage.jsx ---


--- File: frontend/src/pages/OddsTemplatePage.jsx ---

import React, { useState, useEffect } from 'react';
import { apiService } from '../api';

function OddsTemplatePage() {
  const [template, setTemplate] = useState({
    special_code_odds: '',
    flat_special_odds: '',
    serial_code_odds: '',
    even_xiao_odds: '',
    six_xiao_odds: '',
    size_single_double_odds: ''
  });
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);
  const [message, setMessage] = useState('');
  const [isSuccess, setIsSuccess] = useState(false);

  useEffect(() => {
    fetchTemplate();
  }, []);

  const fetchTemplate = async () => {
    setLoading(true);
    try {
      const response = await apiService.getOddsTemplate();
      if (response.status === 'success') {
        setTemplate(response.data);
      }
    } catch (error) {
      console.error('è·å–èµ”ç‡æ¨¡æ¿å¤±è´¥:', error);
      setMessage('è·å–æ¨¡æ¿å¤±è´¥: ' + error.message);
      setIsSuccess(false);
    } finally {
      setLoading(false);
    }
  };

  const handleInputChange = (field, value) => {
    setTemplate(prev => ({
      ...prev,
      [field]: value
    }));
  };

  const handleSave = async () => {
    setSaving(true);
    setMessage('');

    try {
      const response = await apiService.updateOddsTemplate(template);
      if (response.status === 'success') {
        setMessage('èµ”ç‡æ¨¡æ¿ä¿å­˜æˆåŠŸï¼');
        setIsSuccess(true);
      } else {
        setMessage('ä¿å­˜å¤±è´¥: ' + response.message);
        setIsSuccess(false);
      }
    } catch (error) {
      console.error('ä¿å­˜èµ”ç‡æ¨¡æ¿å¤±è´¥:', error);
      setMessage('ä¿å­˜å¤±è´¥: ' + error.message);
      setIsSuccess(false);
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="card">
        <div style={{ textAlign: 'center', padding: '2rem' }}>
          <p>æ­£åœ¨åŠ è½½èµ”ç‡æ¨¡æ¿...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="card">
      <h2>èµ”ç‡æ¨¡æ¿è®¾ç½®</h2>

      <div style={{
        backgroundColor: '#e7f3ff',
        border: '1px solid #b3d9ff',
        borderRadius: '8px',
        padding: '1rem',
        marginBottom: '1.5rem'
      }}>
        <p style={{ margin: 0, fontWeight: 'bold', color: '#0066cc' }}>
          ğŸ’¡ æç¤ºï¼šè¯·è®¾ç½®å„ç§ç©æ³•çš„èµ”ç‡ï¼Œé‚®ä»¶ç»“ç®—å°†ä½¿ç”¨æ‚¨è®¾ç½®çš„èµ”ç‡è¿›è¡Œè®¡ç®—
        </p>
      </div>

      <div style={{ display: 'grid', gap: '1rem', maxWidth: '500px' }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
          <label style={{ minWidth: '120px', fontWeight: 'bold' }}>ç‰¹ç èµ”ç‡:</label>
          <input
            type="number"
            step="0.01"
            value={template.special_code_odds || ''}
            onChange={(e) => handleInputChange('special_code_odds', e.target.value)}
            placeholder="è¯·è¾“å…¥ç‰¹ç èµ”ç‡"
            style={{ flex: 1, padding: '0.5rem', border: '1px solid #ccc', borderRadius: '4px' }}
          />
        </div>

        <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
          <label style={{ minWidth: '120px', fontWeight: 'bold' }}>å¹³ç‰¹èµ”ç‡:</label>
          <input
            type="number"
            step="0.01"
            value={template.flat_special_odds || ''}
            onChange={(e) => handleInputChange('flat_special_odds', e.target.value)}
            placeholder="è¯·è¾“å…¥å¹³ç‰¹èµ”ç‡"
            style={{ flex: 1, padding: '0.5rem', border: '1px solid #ccc', borderRadius: '4px' }}
          />
        </div>

        <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
          <label style={{ minWidth: '120px', fontWeight: 'bold' }}>ä¸²ç èµ”ç‡:</label>
          <input
            type="number"
            step="0.01"
            value={template.serial_code_odds || ''}
            onChange={(e) => handleInputChange('serial_code_odds', e.target.value)}
            placeholder="è¯·è¾“å…¥ä¸²ç èµ”ç‡"
            style={{ flex: 1, padding: '0.5rem', border: '1px solid #ccc', borderRadius: '4px' }}
          />
        </div>

        <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
          <label style={{ minWidth: '120px', fontWeight: 'bold' }}>è¿è‚–èµ”ç‡:</label>
          <input
            type="number"
            step="0.01"
            value={template.even_xiao_odds || ''}
            onChange={(e) => handleInputChange('even_xiao_odds', e.target.value)}
            placeholder="è¯·è¾“å…¥è¿è‚–èµ”ç‡"
            style={{ flex: 1, padding: '0.5rem', border: '1px solid #ccc', borderRadius: '4px' }}
          />
        </div>

        <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
          <label style={{ minWidth: '120px', fontWeight: 'bold' }}>å…­è‚–èµ”ç‡:</label>
          <input
            type="number"
            step="0.01"
            value={template.six_xiao_odds || ''}
            onChange={(e) => handleInputChange('six_xiao_odds', e.target.value)}
            placeholder="è¯·è¾“å…¥å…­è‚–èµ”ç‡"
            style={{ flex: 1, padding: '0.5rem', border: '1px solid #ccc', borderRadius: '4px' }}
          />
        </div>

        <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
          <label style={{ minWidth: '120px', fontWeight: 'bold' }}>å¤§å°å•åŒèµ”ç‡:</label>
          <input
            type="number"
            step="0.01"
            value={template.size_single_double_odds || ''}
            onChange={(e) => handleInputChange('size_single_double_odds', e.target.value)}
            placeholder="è¯·è¾“å…¥å¤§å°å•åŒèµ”ç‡"
            style={{ flex: 1, padding: '0.5rem', border: '1px solid #ccc', borderRadius: '4px' }}
          />
        </div>
      </div>

      <div style={{ marginTop: '1.5rem', display: 'flex', gap: '0.5rem' }}>
        <button
          onClick={handleSave}
          disabled={saving}
          style={{
            padding: '0.75rem 1.5rem',
            backgroundColor: saving ? '#6c757d' : '#007bff',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: saving ? 'not-allowed' : 'pointer',
            fontSize: '1rem'
          }}
        >
          {saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜æ¨¡æ¿'}
        </button>

        <button
          onClick={fetchTemplate}
          disabled={loading}
          style={{
            padding: '0.75rem 1.5rem',
            backgroundColor: '#6c757d',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: 'pointer',
            fontSize: '1rem'
          }}
        >
          é‡æ–°åŠ è½½
        </button>
      </div>

      {message && (
        <div style={{
          marginTop: '1rem',
          padding: '0.75rem',
          borderRadius: '4px',
          backgroundColor: isSuccess ? '#d4edda' : '#f8d7da',
          color: isSuccess ? '#155724' : '#721c24',
          border: `1px solid ${isSuccess ? '#c3e6cb' : '#f5c6cb'}`
        }}>
          {message}
        </div>
      )}
    </div>
  );
}

export default OddsTemplatePage;

--- End of File: frontend/src/pages/OddsTemplatePage.jsx ---


--- File: frontend/src/index.css ---

/* src/index.css (Fully Responsive Version with Extra Large Lottery Numbers) */

/* --- Global & Layout --- */
:root {
  --primary-color: #007bff;
  --danger-color: #dc3545;
  --success-color: #28a745;
  --info-color: #17a2b8;
  --background-color: #f4f7f9;
  --card-background: #ffffff;
  --text-color: #333;
  --text-light: #666;
  --border-color: #e0e0e0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  background-color: var(--background-color);
  color: var(--text-color);
  margin: 0;
}

#root {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

main.container {
  flex-grow: 1;
  width: 100%;
  max-width: 1200px;
  margin: 2rem auto;
  padding: 0 1rem;
  box-sizing: border-box;
}

/* --- Navbar --- */
.navbar {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 2rem;
  background-color: var(--card-background);
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  border-bottom: 1px solid var(--border-color);
  gap: 1rem;
}
.nav-brand a {
  font-weight: bold;
  font-size: 1.5rem;
  color: var(--text-color);
  text-decoration: none;
}
.nav-links {
  list-style: none;
  display: flex;
  gap: 1.5rem;
  margin: 0;
  padding: 0;
}
.nav-links a {
  color: var(--text-light);
  text-decoration: none;
  transition: color 0.3s ease;
}
.nav-links a:hover {
  color: var(--primary-color);
}
.nav-links a.active {
  color: var(--primary-color);
  font-weight: bold;
}
.nav-auth {
  display: flex;
  align-items: center;
  gap: 1rem;
}
.nav-auth span {
  font-weight: 500;
}

/* --- General Elements & Cards --- */
.card {
  background-color: var(--card-background);
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  margin-bottom: 20px;
}
a {
  text-decoration: none;
  color: var(--primary-color);
  transition: color 0.3s ease;
}
a:hover {
  color: #0056b3;
}

/* --- Lottery Banner Styles --- */
.lottery-banners-container {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.lottery-banner {
  border: 1px solid var(--border-color);
  border-radius: 8px;
  background-color: var(--card-background);
  box-shadow: 0 2px 8px rgba(0,0,0,0.07);
  overflow: hidden;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.lottery-banner:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.banner-header {
  padding: 0.75rem 1.5rem;
  background-color: #f9fafb;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}
.banner-header h3 {
  margin: 0;
  font-size: 1.5rem; /* å¢å¤§å­—ä½“ */
  font-weight: 800; /* åŠ ç²— */
  color: #dc3545; /* çº¢è‰²å­—ä½“ */
  text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}
.banner-header p {
  margin: 0;
  font-size: 1rem;
  color: var(--text-light);
  font-weight: 500;
}

.numbers-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr) 0.5fr 1fr;
  gap: 15px;
  padding: 2rem;
  align-items: center;
  justify-items: center;
}

.number-cell {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  aspect-ratio: 1 / 1;
  border-radius: 50%;
  color: #fff;
  font-weight: 900; /* æç²— */
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
  font-size: 3.6rem; /* å¢å¤§ä¸€å€ - ä»1.8remå¢åŠ åˆ°3.6rem */
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  min-width: 80px;
  min-height: 80px;
  width: 100%;
  max-width: 120px;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}
.number-cell:hover {
  transform: scale(1.08);
  box-shadow: 0 5px 15px rgba(0,0,0,0.4);
}

.number-cell:nth-child(7) {
  grid-column: 8;
}

.color-red {
  background: linear-gradient(145deg, #f85032, #e73827);
  border: 3px solid #c62828;
}
.color-green {
  background: linear-gradient(145deg, #56ab2f, #a8e063);
  border: 3px solid #2e7d32;
}
.color-blue {
  background: linear-gradient(145deg, #2196F3, #4FC3F7);
  border: 3px solid #1565c0;
}
.color-unknown {
  background: linear-gradient(145deg, #868e96, #adb5bd);
  border: 3px solid #6c757d;
}

/* --- Settlement & Email Page Styles --- */
.settlement-card {
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  margin: 2rem 0;
  padding: 1rem;
  background-color: #f8fdff;
  transition: box-shadow 0.3s ease;
}
.settlement-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.settlement-details {
  background-color: #fff8e1;
  border: 1px solid #ffecb3;
  padding: 1rem;
  border-radius: 4px;
  margin-top: 1rem;
}

.settlement-details p {
  margin: 0.5rem 0;
  font-size: 1.15rem;
  color: #c51162;
}

.settlement-details p strong {
  color: #333;
}

.email-content-background {
  white-space: pre-wrap;
  word-break: break-all;
  background-color: #f9f9f9;
  padding: 1.5rem;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
  margin: 1rem 0;
  line-height: 1.6;
  font-size: 14px;
}

.global-totals-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 1.5rem;
  border-radius: 12px;
  margin-top: 1rem;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.global-totals-card h3 {
  margin-top: 0;
  color: white;
}

.global-totals-card p {
  margin: 0.75rem 0;
  font-size: 1.1rem;
}

.global-totals-card hr {
  border: none;
  border-top: 1px solid rgba(255,255,255,0.3);
  margin: 1rem 0;
}

/* --- ç»“ç®—ç›¸å…³æ ·å¼ --- */
.settlement-highlight {
  background-color: #fff3cd;
  border-left: 4px solid #ffc107;
  padding: 0.5rem 1rem;
  margin: 0.5rem 0;
}

.profit-text {
  color: #dc3545;
  font-weight: bold;
}

.loss-text {
  color: #007bff;
  font-weight: bold;
}

/* --- è§†å›¾åˆ‡æ¢æŒ‰é’® --- */
.view-toggle {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.view-toggle button {
  padding: 0.5rem 1rem;
  border: 2px solid #007bff;
  background: white;
  color: #007bff;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
}

.view-toggle button.active {
  background: #007bff;
  color: white;
}

.view-toggle button:hover {
  background: #0056b3;
  color: white;
}

/* --- è¡¨å•å’ŒæŒ‰é’®æ ·å¼ --- */
button {
  padding: 0.5rem 1rem;
  background-color: var(--primary-color);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background-color 0.3s ease;
}
button:hover {
  background-color: #0056b3;
}
button:disabled {
  background-color: #6c757d;
  cursor: not-allowed;
}

input, textarea {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #ced4da;
  border-radius: 4px;
  font-size: 0.9rem;
  box-sizing: border-box;
}
input:focus, textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

/* --- è¡¨æ ¼æ ·å¼ --- */
table {
  width: 100%;
  border-collapse: collapse;
  margin: 1rem 0;
}
th, td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid #dee2e6;
}
th {
  background-color: #f8f9fa;
  font-weight: 600;
}
tr:hover {
  background-color: #f8f9fa;
}

/* --- åŠ è½½å’Œé”™è¯¯çŠ¶æ€ --- */
.loading {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 2rem;
}
.error {
  color: var(--danger-color);
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  border-radius: 4px;
  padding: 1rem;
  margin: 1rem 0;
}

/* --- å“åº”å¼è®¾è®¡ --- */
@media (max-width: 1024px) {
  .number-cell {
    font-size: 3rem; /* åœ¨ä¸­ç­‰å±å¹•ä¸Šç¨å¾®å‡å° */
    min-width: 70px;
    min-height: 70px;
  }
}

@media (max-width: 768px) {
  main.container {
    margin: 1rem auto;
    padding: 0 0.5rem;
  }

  .navbar {
    padding: 1rem;
    justify-content: center;
    flex-direction: column;
    gap: 0.5rem;
  }

  .nav-links {
    gap: 1rem;
  }

  .banner-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.25rem;
    padding: 0.5rem 1rem;
  }

  .banner-header h3 {
    font-size: 1.3rem;
  }

  .numbers-grid {
    padding: 1.5rem;
    gap: 10px;
    grid-template-columns: repeat(4, 1fr) 0.3fr 1fr;
  }

  .number-cell {
    font-size: 2.5rem; /* åœ¨å¹³æ¿ä¸Šä¿æŒè¾ƒå¤§å­—ä½“ */
    min-width: 60px;
    min-height: 60px;
  }

  .card {
    padding: 1rem;
  }

  .email-content-background {
    padding: 1rem;
    font-size: 13px;
  }
}

@media (max-width: 480px) {
  .numbers-grid {
    grid-template-columns: repeat(3, 1fr) 0.3fr 1fr;
    gap: 8px;
    padding: 1rem;
  }

  .number-cell {
    font-size: 2rem; /* åœ¨æ‰‹æœºä¸Šä¿æŒå¯è§æ€§ */
    min-width: 50px;
    min-height: 50px;
  }

  .banner-header h3 {
    font-size: 1.1rem;
  }

  .banner-header p {
    font-size: 0.9rem;
  }
}

/* --- åŠ¨ç”»æ•ˆæœ --- */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.fade-in {
  animation: fadeIn 0.5s ease-in;
}

@keyframes slideIn {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.slide-in {
  animation: slideIn 0.5s ease-out;
}

/* --- ç‰¹æ®Šå½©ç¥¨ç±»å‹æ ‡é¢˜æ ·å¼ --- */
.lottery-banner[data-type="é¦™æ¸¯å…­åˆå½©"] .banner-header h3,
.lottery-banner[data-type="æ–°æ¾³é—¨å…­åˆå½©"] .banner-header h3,
.lottery-banner[data-type="è€æ¾³é—¨å…­åˆå½©"] .banner-header h3 {
  color: #dc3545; /* çº¢è‰² */
  font-size: 1.6rem; /* å¢å¤§å­—ä½“ */
  font-weight: 900; /* æ›´åŠ ç²—é‡ */
  text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
}

/* --- è¾…åŠ©ç±» --- */
.text-center { text-align: center; }
.text-left { text-align: left; }
.text-right { text-align: right; }
.mt-1 { margin-top: 0.5rem; }
.mt-2 { margin-top: 1rem; }
.mt-3 { margin-top: 1.5rem; }
.mb-1 { margin-bottom: 0.5rem; }
.mb-2 { margin-bottom: 1rem; }
.mb-3 { margin-bottom: 1.5rem; }
.p-1 { padding: 0.5rem; }
.p-2 { padding: 1rem; }
.p-3 { padding: 1.5rem; }

/* --- é“¾æ¥æŒ‰é’®æ ·å¼ --- */
.link-button {
  background: none;
  border: none;
  color: var(--primary-color);
  text-decoration: underline;
  cursor: pointer;
  padding: 0;
  font-size: inherit;
}
.link-button:hover {
  color: #0056b3;
  background: none;
}

/* --- æ¶ˆæ¯æç¤ºæ ·å¼ --- */
.message {
  padding: 0.75rem;
  border-radius: 4px;
  margin: 1rem 0;
}
.message.success {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}
.message.error {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}
.message.warning {
  background-color: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
}
.message.info {
  background-color: #d1ecf1;
  color: #0c5460;
  border: 1px solid #bee5eb;
}

/* --- æ•°å­—çƒç‰¹æ®Šæ•ˆæœ --- */
.number-cell::after {
  content: '';
  position: absolute;
  top: 10%;
  left: 10%;
  width: 80%;
  height: 80%;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 70%);
  pointer-events: none;
}

.number-cell {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}
/* æ—‹è½¬åŠ¨ç”» */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* è°ƒè¯•ä¿¡æ¯æ ·å¼ */
details {
  border: 1px solid #dee2e6;
  border-radius: 4px;
  padding: 0.5rem;
}

details summary {
  cursor: pointer;
  font-weight: bold;
}

details[open] summary {
  margin-bottom: 0.5rem;
}

/* ç¡®ä¿HTMLå†…å®¹æ­£ç¡®æ˜¾ç¤º */
.email-content-background span {
  display: inline;
}

/* è§†å›¾æ¨¡å¼æç¤º */
.view-mode-hint {
  padding: 0.5rem;
  background-color: #e7f3ff;
  border-left: 4px solid #007bff;
  margin-bottom: 1rem;
  border-radius: 4px;
}

--- End of File: frontend/src/index.css ---


--- File: frontend/src/main.jsx ---

// src/main.jsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import { BrowserRouter } from 'react-router-dom';
import App from './App.jsx';
import './index.css';

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);
--- End of File: frontend/src/main.jsx ---


--- File: frontend/src/context/AuthContext.jsx ---

// src/context/AuthContext.jsx
import React, { createContext, useState, useContext, useEffect } from 'react';
import { apiService } from '../api';

const AuthContext = createContext(null);

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // åº”ç”¨åŠ è½½æ—¶ï¼Œæ£€æŸ¥åç«¯ session
    apiService.checkSession()
      .then(data => {
        if (data.status === 'success' && data.isAuthenticated) {
          setUser(data.user);
        }
      })
      .catch(() => setUser(null)) // å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œåˆ™è§†ä¸ºæœªç™»å½•
      .finally(() => setLoading(false));
  }, []);

  const login = async (email, password) => {
    const data = await apiService.login(email, password);
    if (data.status === 'success') {
      setUser(data.user);
    }
    return data; // è¿”å›æ•´ä¸ªå“åº”ç»™ç»„ä»¶å¤„ç†
  };

  const register = (email, password) => {
    return apiService.register(email, password);
  };

  const logout = async () => {
    await apiService.logout();
    setUser(null);
  };

  const value = { user, loading, login, register, logout };

  return (
    <AuthContext.Provider value={value}>
      {!loading && children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => {
  return useContext(AuthContext);
};
--- End of File: frontend/src/context/AuthContext.jsx ---


--- File: frontend/src/components/AuthForm.jsx ---

// frontend/src/components/AuthForm.jsx
import React, { useState } from 'react';
import { apiService } from '../api';

function AuthForm({ onAuthSuccess }) {
  const [isLogin, setIsLogin] = useState(true);
  // ... form state: email, password, message, loading ...

  const handleSubmit = async (e) => {
    e.preventDefault();
    // setLoading(true); setMessage('');
    try {
      if (isLogin) {
        // await apiService.login(email, password);
        alert('ç™»å½•æˆåŠŸ (æ¨¡æ‹Ÿ)'); // Placeholder
        onAuthSuccess();
      } else {
        const data = await apiService.register(email, password);
        // setMessage(data.message); setIsLogin(true);
        alert(data.message); // Simple feedback
      }
    } catch (error) {
      // setMessage(error.message);
      alert(error.message);
    } finally {
      // setLoading(false);
    }
  };

  // ... return JSX form with inputs and buttons ...
  return (/* ... your form JSX here ... */);
}
export default AuthForm;
--- End of File: frontend/src/components/AuthForm.jsx ---


--- File: frontend/src/components/LotteryTypeModal.jsx ---

import React, { useState } from 'react';

function LotteryTypeModal({ isOpen, onClose, onConfirm, loading }) {
  const [selectedTypes, setSelectedTypes] = useState([]);

  const lotteryTypes = [
    { value: 'é¦™æ¸¯å…­åˆå½©', label: 'é¦™æ¸¯å…­åˆå½© (å‘¨äºŒã€å››ã€å…­å¼€å¥–)' },
    { value: 'æ–°æ¾³é—¨å…­åˆå½©', label: 'æ–°æ¾³é—¨å…­åˆå½© (æ¯æ—¥å¼€å¥–)' },
    { value: 'è€æ¾³é—¨å…­åˆå½©', label: 'è€æ¾³é—¨å…­åˆå½© (æ¯æ—¥å¼€å¥–)' }
  ];

  const handleTypeToggle = (type) => {
    setSelectedTypes(prev =>
      prev.includes(type)
        ? prev.filter(t => t !== type)
        : [...prev, type]
    );
  };

  const handleConfirm = () => {
    if (selectedTypes.length === 0) {
      alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§å½©ç¥¨ç±»å‹');
      return;
    }
    onConfirm(selectedTypes);
  };

  if (!isOpen) return null;

  return (
    <div style={{
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      backgroundColor: 'rgba(0,0,0,0.5)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 1000
    }}>
      <div style={{
        backgroundColor: 'white',
        padding: '2rem',
        borderRadius: '8px',
        minWidth: '400px',
        maxWidth: '500px'
      }}>
        <h3 style={{ marginTop: 0, marginBottom: '1.5rem' }}>é€‰æ‹©å½©ç¥¨ç±»å‹</h3>

        <div style={{ marginBottom: '1.5rem' }}>
          {lotteryTypes.map(type => (
            <div key={type.value} style={{ marginBottom: '0.5rem' }}>
              <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                <input
                  type="checkbox"
                  checked={selectedTypes.includes(type.value)}
                  onChange={() => handleTypeToggle(type.value)}
                  style={{ marginRight: '0.5rem' }}
                />
                {type.label}
              </label>
            </div>
          ))}
        </div>

        <div style={{
          backgroundColor: '#fff3cd',
          border: '1px solid #ffeaa7',
          borderRadius: '4px',
          padding: '1rem',
          marginBottom: '1.5rem'
        }}>
          <p style={{ margin: 0, color: '#856404', fontSize: '0.9rem' }}>
            ğŸ’¡ æç¤ºï¼šè¯·æŸ¥çœ‹å¼€å¥–è®°å½•ç¡®è®¤å¼€å¥–å·ç æ­£ç¡®åå†è¿›è¡Œç»“ç®—
          </p>
        </div>

        <div style={{ display: 'flex', gap: '0.5rem', justifyContent: 'flex-end' }}>
          <button
            onClick={onClose}
            disabled={loading}
            style={{
              padding: '0.5rem 1rem',
              backgroundColor: '#6c757d',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: loading ? 'not-allowed' : 'pointer'
            }}
          >
            å–æ¶ˆ
          </button>
          <button
            onClick={handleConfirm}
            disabled={loading || selectedTypes.length === 0}
            style={{
              padding: '0.5rem 1rem',
              backgroundColor: loading ? '#6c757d' : '#007bff',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: (loading || selectedTypes.length === 0) ? 'not-allowed' : 'pointer'
            }}
          >
            {loading ? 'è§£æä¸­...' : 'å¼€å§‹è§£æ'}
          </button>
        </div>
      </div>
    </div>
  );
}

export default LotteryTypeModal;
--- End of File: frontend/src/components/LotteryTypeModal.jsx ---


--- File: frontend/src/components/Navbar.jsx ---

// File: frontend/src/components/Navbar.jsx

import React from 'react';
import { NavLink, useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

function Navbar() {
  const { user, logout } = useAuth();
  const navigate = useNavigate();

  const handleLogout = async () => {
    try {
      await logout();
      navigate('/');
    } catch (error) {
      console.error("Logout failed:", error);
    }
  };

  return (
    <nav className="navbar">
      <div className="nav-brand">
        <NavLink to="/">ç»“ç®—ç³»ç»Ÿ</NavLink>
      </div>
      <ul className="nav-links">
        <li><NavLink to="/">å¼€å¥–è®°å½•</NavLink></li>
        {user && <li><NavLink to="/emails">é‚®ä»¶åŸæ–‡</NavLink></li>}
        {user && <li><NavLink to="/odds-template">èµ”ç‡è®¾ç½®</NavLink></li>}
      </ul>
      <div className="nav-auth">
        {user ? (
          <>
            <span>æ¬¢è¿, {user.email}</span>
            <button onClick={handleLogout}>é€€å‡ºç™»å½•</button>
          </>
        ) : (
          <NavLink to="/auth">æ³¨å†Œ/ç™»å½•</NavLink>
        )}
      </div>
    </nav>
  );
}

export default Navbar;

--- End of File: frontend/src/components/Navbar.jsx ---


--- File: frontend/src/components/SingleBetCard.jsx ---

// File: frontend/src/components/SingleBetCard.jsx (ä¿®å¤å¿«é€Ÿæ ¡å‡†åŠŸèƒ½)
import React, { useState, useMemo } from 'react';
import { apiService } from '../api';
import QuickCalibrationModal from './QuickCalibrationModal';

function SingleBetCard({ lineData, emailId, onUpdate, onDelete }) {
  const [isParsing, setIsParsing] = useState(false);
  const [showLotteryModal, setShowLotteryModal] = useState(false);
  const [showCalibrationModal, setShowCalibrationModal] = useState(false);

  const handleParse = () => setShowLotteryModal(true);

  const handleConfirmParse = async (lotteryTypes) => {
    setIsParsing(true);
    setShowLotteryModal(false);
    try {
      const result = await apiService.parseSingleBet(
        emailId, // ç›´æ¥ä½¿ç”¨æ•°å­—ç±»å‹çš„ emailId
        lineData.text,
        lineData.line_number,
        lotteryTypes[0]
      );
      if (result.status === 'success') onUpdate(lineData.line_number, result.data);
      else alert('è§£æå¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
    } catch (error) {
      alert('è§£æå¤±è´¥: ' + error.message);
    } finally {
      setIsParsing(false);
    }
  };

  const handleLineUpdate = (lineNumber, data) => {
    onUpdate(lineNumber, data);
  };

  const formatTargets = (targets) => {
    if (!Array.isArray(targets)) return String(targets || '');
    if (targets.every(t => !isNaN(t))) return targets.map(n => String(n).padStart(2, '0')).join('.');
    return targets.join(', ');
  };

  const aggregatedBets = useMemo(() => {
    if (!lineData.is_parsed || !lineData.batch_data?.data?.bets) return [];
    const groups = {};
    lineData.batch_data.data.bets.forEach(bet => {
      const key = `${bet.bet_type}_${bet.amount}`;
      if (!groups[key]) groups[key] = { ...bet, targets: [] };
      if (Array.isArray(bet.targets)) groups[key].targets.push(...bet.targets);
    });
    return Object.values(groups);
  }, [lineData.batch_data]);

  const displayTotalAmount = lineData.batch_data?.data?.settlement?.total_bet_amount ?? lineData.batch_data?.data?.total_amount ?? 0;

  return (
    <>
      <div style={{ border: '1px solid #e0e0e0', borderRadius: '8px', padding: '1rem', marginBottom: '1rem', backgroundColor: lineData.is_parsed ? '#f8fdff' : '#f9f9f9' }}>
        <div style={{ display: 'inline-block', backgroundColor: lineData.is_parsed ? '#28a745' : '#6c757d', color: 'white', borderRadius: '12px', padding: '0.25rem 0.5rem', fontSize: '0.8rem', marginBottom: '0.5rem' }}>
          ç¬¬ {lineData.line_number} æ¡ {lineData.is_parsed ? 'âœ… å·²è§£æ' : 'âŒ æœªè§£æ'}
        </div>
        <div style={{ backgroundColor: '#f5f5f5', padding: '0.75rem', borderRadius: '4px', marginBottom: '1rem', fontFamily: 'monospace', fontSize: '0.9rem', whiteSpace: 'pre-wrap' }}>
          {lineData.text}
        </div>
        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
          {!lineData.is_parsed ? (
            <button onClick={handleParse} disabled={isParsing} style={{ backgroundColor: isParsing ? '#6c757d' : '#28a745', color: 'white', border: 'none', borderRadius: '4px', padding: '0.5rem 1rem' }}>
              {isParsing ? 'è§£æä¸­...' : 'è§£ææ­¤æ¡'}
            </button>
          ) : (
            <>
              <button onClick={() => setShowCalibrationModal(true)} style={{ backgroundColor: '#ffc107', color: '#212529', border: 'none', borderRadius: '4px', padding: '0.5rem 1rem' }}>
                æ ¡å‡†é‡‘é¢
              </button>
              <button onClick={() => { if (window.confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§£æç»“æœå—ï¼Ÿ')) { onDelete(lineData.line_number); } }} style={{ backgroundColor: '#dc3545', color: 'white', border: 'none', borderRadius: '4px', padding: '0.5rem 1rem' }}>
                åˆ é™¤è§£æ
              </button>
            </>
          )}
        </div>
        {lineData.is_parsed && lineData.batch_data && (
          <div style={{ marginTop: '1rem' }}>
            <div style={{ backgroundColor: '#e8f5e8', border: '1px solid #4caf50', padding: '0.75rem', borderRadius: '4px' }}>
              <h4 style={{ margin: '0 0 0.5rem 0', color: '#2e7d32' }}>âœ… AIè§£æç»“æœ</h4>
              {lineData.batch_data.data.lottery_type && <div style={{ marginBottom: '1rem', padding: '0.5rem', backgroundColor: '#d4edda', borderRadius: '4px', display: 'inline-block' }}><strong>å½©ç¥¨ç±»å‹:</strong> {lineData.batch_data.data.lottery_type}</div>}
              <div style={{ marginBottom: '1rem' }}>
                {aggregatedBets.map((bet, index) => (
                  <div key={index} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '0.75rem', padding: '0.75rem', backgroundColor: 'white', borderRadius: '6px', border: '1px solid #dee2e6' }}>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: 'bold', fontSize: '1rem' }}>{bet.bet_type} ({Array.isArray(bet.targets) ? bet.targets.length : 0}ä¸ª)</div>
                      <div style={{ fontFamily: 'monospace', wordBreak: 'break-word', backgroundColor: '#f8f9fa', padding: '0.5rem', borderRadius: '4px', marginTop: '0.5rem' }}>{formatTargets(bet.targets)}</div>
                    </div>
                    <div style={{ textAlign: 'right', minWidth: '100px', marginLeft: '0.5rem' }}>
                      <div style={{ fontSize: '1rem', fontWeight: 'bold', color: '#e74c3c' }}>{bet.amount} å…ƒ</div>
                      <div style={{ fontSize: '0.8rem', color: '#7f8c8d' }}>{['ç‰¹ç ', 'å·ç ', 'å¹³ç '].includes(bet.bet_type) ? 'æ¯ä¸ª' : 'æ€»å…±'}</div>
                    </div>
                  </div>
                ))}
              </div>
              {lineData.batch_data.data.settlement && (
                <div style={{ marginTop: '1rem', padding: '1rem', backgroundColor: '#fff3cd', borderRadius: '8px', border: '1px solid #ffeaa7' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-around', alignItems: 'center', marginBottom: '1rem', textAlign: 'center' }}>
                    <div>
                      <div style={{ fontSize: '0.9rem', color: '#6c757d' }}>æ€»ä¸‹æ³¨</div>
                      <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>{displayTotalAmount} å…ƒ</div>
                    </div>
                    <div>
                      <div style={{ fontSize: '0.9rem', color: '#6c757d' }}>ä¸­å¥–æ³¨æ•°</div>
                      <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>{lineData.batch_data.data.settlement.winning_details?.length || 0}</div>
                    </div>
                  </div>
                  {lineData.batch_data.data.settlement.net_profits && (
                    <div style={{ padding: '0.75rem', backgroundColor: lineData.batch_data.data.settlement.net_profits.net_profit >= 0 ? '#d4edda' : '#f8d7da', borderRadius: '6px', textAlign: 'center', fontWeight: 'bold', fontSize: '1.1rem', color: lineData.batch_data.data.settlement.net_profits.net_profit >= 0 ? '#155724' : '#721c24' }}>
                      {lineData.batch_data.data.settlement.net_profits.net_profit >= 0 ? 'ğŸ‰ ç›ˆåˆ©' : 'ğŸ“‰ äºæŸ'}
                      <span style={{ fontSize: '1.25rem', marginLeft: '0.5rem' }}>{lineData.batch_data.data.settlement.net_profits.net_profit >= 0 ? '+' : ''}{lineData.batch_data.data.settlement.net_profits.net_profit} å…ƒ</span>
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        )}
      </div>

      {/* å¿«é€Ÿæ ¡å‡†æ¨¡æ€æ¡† */}
      <QuickCalibrationModal
        isOpen={showCalibrationModal}
        onClose={() => setShowCalibrationModal(false)}
        lineData={lineData}
        emailId={Number(emailId)}
        onUpdate={handleLineUpdate}
      />

      <LotteryTypeModal
        isOpen={showLotteryModal}
        onClose={() => setShowLotteryModal(false)}
        onConfirm={handleConfirmParse}
        loading={isParsing}
      />
    </>
  );
}

function LotteryTypeModal({ isOpen, onClose, onConfirm, loading }) {
    const [selectedTypes, setSelectedTypes] = useState([]);
    const lotteryTypes = [
      { value: 'é¦™æ¸¯å…­åˆå½©', label: 'é¦™æ¸¯å…­åˆå½© (å‘¨äºŒã€å››ã€å…­å¼€å¥–)' },
      { value: 'æ–°æ¾³é—¨å…­åˆå½©', label: 'æ–°æ¾³é—¨å…­åˆå½© (æ¯æ—¥å¼€å¥–)' },
      { value: 'è€æ¾³é—¨å…­åˆå½©', label: 'è€æ¾³é—¨å…­åˆå½© (æ¯æ—¥å¼€å¥–)' }
    ];
    const handleTypeToggle = (type) => { setSelectedTypes([type]); };
    const handleConfirm = () => {
      if (selectedTypes.length === 0) {
        alert('è¯·é€‰æ‹©ä¸€ç§å½©ç¥¨ç±»å‹');
        return;
      }
      onConfirm(selectedTypes);
    };

    if (!isOpen) return null;

    return (
      <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
        <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '12px', minWidth: '400px', maxWidth: '500px' }}>
          <h3>é€‰æ‹©å½©ç¥¨ç±»å‹</h3>
          <div style={{ marginBottom: '1.5rem' }}>
            {lotteryTypes.map(type => (
              <label key={type.value} style={{ display: 'block', marginBottom: '0.5rem' }}>
                <input
                  type="radio"
                  name="lotteryType"
                  checked={selectedTypes.includes(type.value)}
                  onChange={() => handleTypeToggle(type.value)}
                  style={{ marginRight: '0.5rem' }}
                />
                {type.label}
              </label>
            ))}
          </div>
          <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '1rem' }}>
            <button onClick={onClose} disabled={loading} style={{ padding: '0.5rem 1rem', backgroundColor: '#6c757d', color: 'white', border: 'none', borderRadius: '4px' }}>
              å–æ¶ˆ
            </button>
            <button
              onClick={handleConfirm}
              disabled={loading || selectedTypes.length === 0}
              style={{
                padding: '0.5rem 1rem',
                backgroundColor: (loading || selectedTypes.length === 0) ? '#6c757d' : '#007bff',
                color: 'white',
                border: 'none',
                borderRadius: '4px'
              }}
            >
              {loading ? 'è§£æä¸­...' : 'å¼€å§‹è§£æ'}
            </button>
          </div>
        </div>
      </div>
    );
}

export default SingleBetCard;
--- End of File: frontend/src/components/SingleBetCard.jsx ---


--- File: frontend/src/components/AiCalibrationModal.jsx ---

// File: frontend/src/components/AiCalibrationModal.jsx (æ¥æ”¶å¹¶ä½¿ç”¨ emailId)
import React, { useState, useEffect } from 'react';
import { apiService } from '../api';

function AiCalibrationModal({ isOpen, onClose, lineData, emailId, onUpdate }) {
  const [betType, setBetType] = useState('ç‰¹ç ');
  const [targets, setTargets] = useState('');
  const [amountMode, setAmountMode] = useState('per_target');
  const [amount, setAmount] = useState('');
  const [reason, setReason] = useState('');
  const [isSaving, setIsSaving] = useState(false);

  useEffect(() => {
    if (isOpen && lineData) {
      const initialBet = lineData.batch_data?.data?.bets?.[0] || {};
      setBetType(initialBet.bet_type || 'ç‰¹ç ');
      const initialTargets = Array.isArray(initialBet.targets) ? initialBet.targets.join('.') : '';
      setTargets(initialTargets);
      setAmount(initialBet.amount || '');
      setAmountMode('per_target');
      setReason('');
    }
  }, [isOpen, lineData]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsSaving(true);
    try {
      if (!targets || !amount) {
        throw new Error('ä¸‹æ³¨ç›®æ ‡å’Œé‡‘é¢ä¸èƒ½ä¸ºç©º');
      }

      const payload = {
        email_id: parseInt(emailId, 10),
        line_number: lineData.line_number,
        batch_id: lineData.batch_data.batch_id,
        correction: {
          bet_type: betType,
          targets: targets,
          amount_mode: amountMode,
          amount: parseFloat(amount),
          reason: reason
        }
      };

      // ã€è°ƒè¯•æ­¥éª¤ã€‘æ£€æŸ¥æˆ‘ä»¬å³å°†å‘é€çš„æ•°æ®
      console.log('Sending calibration payload:', payload);

      // æ£€æŸ¥ email_id æ˜¯å¦æœ‰æ•ˆ
      if (!payload.email_id || isNaN(payload.email_id)) {
        throw new Error('å‰ç«¯é”™è¯¯ï¼šEmail ID æ— æ•ˆï¼Œæ— æ³•å‘é€è¯·æ±‚ã€‚');
      }

      const result = await apiService.calibrateAiParse(payload);

      if (result.status === 'success') {
        alert('æ ¡å‡†æˆåŠŸï¼');
        onUpdate(lineData.line_number, result.data);
        onClose();
      } else {
        throw new Error(result.message || 'æ ¡å‡†å¤±è´¥');
      }

    } catch (error) {
      console.error("Calibration failed:", error); // åœ¨æ§åˆ¶å°æ‰“å°è¯¦ç»†é”™è¯¯
      alert('é”™è¯¯: ' + error.message);
    } finally {
      setIsSaving(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
      <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '8px', width: '500px' }}>
        <h3 style={{ marginTop: 0 }}>æ ¡å‡†AIè§£æ</h3>

        <div style={{ backgroundColor: '#f5f5f5', padding: '0.75rem', borderRadius: '4px', marginBottom: '1rem', fontFamily: 'monospace' }}>
          <strong>åŸå§‹æ–‡æœ¬:</strong> {lineData.text}
        </div>

        <form onSubmit={handleSubmit}>
          <div style={{ marginBottom: '1rem' }}>
            <label>ç©æ³•ç±»å‹</label>
            <select value={betType} onChange={e => setBetType(e.target.value)} style={{ width: '100%', padding: '0.5rem' }}>
              <option value="ç‰¹ç ">ç‰¹ç </option>
              <option value="å¹³ç ">å¹³ç </option>
              <option value="è¿è‚–">è¿è‚–</option>
              <option value="å…­è‚–">å…­è‚–</option>
            </select>
          </div>
          <div style={{ marginBottom: '1rem' }}>
            <label>ä¸‹æ³¨å·ç /ç›®æ ‡ (ç”¨.æˆ–,åˆ†éš”)</label>
            <input type="text" value={targets} onChange={e => setTargets(e.target.value)} style={{ width: '100%', padding: '0.5rem' }} />
          </div>
          <div style={{ marginBottom: '1rem' }}>
            <label>é‡‘é¢æ¨¡å¼</label>
            <div style={{ display: 'flex', gap: '1rem', marginTop: '0.5rem' }}>
              <label><input type="radio" value="per_target" checked={amountMode === 'per_target'} onChange={e => setAmountMode(e.target.value)} /> æ¯ä¸ª</label>
              <label><input type="radio" value="total" checked={amountMode === 'total'} onChange={e => setAmountMode(e.target.value)} /> æ€»å…±</label>
            </div>
          </div>
          <div style={{ marginBottom: '1rem' }}>
            <label>é‡‘é¢ (å…ƒ)</label>
            <input type="number" value={amount} onChange={e => setAmount(e.target.value)} style={{ width: '100%', padding: '0.5rem' }} />
          </div>
          <div style={{ marginBottom: '1.5rem' }}>
            <label>ä¿®æ­£ç†ç”± (é€‰å¡«ï¼Œå¸®åŠ©AIå­¦ä¹ )</label>
            <input type="text" value={reason} onChange={e => setReason(e.target.value)} placeholder="ä¾‹å¦‚: AIæœªè¯†åˆ«'å—'ä¸ºé‡‘é¢å•ä½" style={{ width: '100%', padding: '0.5rem' }} />
          </div>
          <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '1rem' }}>
            <button type="button" onClick={onClose} disabled={isSaving}>å–æ¶ˆ</button>
            <button type="submit" disabled={isSaving} style={{ backgroundColor: '#28a745', color: 'white' }}>
              {isSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜å¹¶è®©AIå­¦ä¹ '}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

export default AiCalibrationModal;

--- End of File: frontend/src/components/AiCalibrationModal.jsx ---


--- File: frontend/src/components/QuickCalibrationModal.jsx ---

// File: frontend/src/components/QuickCalibrationModal.jsx (å®Œå…¨é‡å†™ç‰ˆ)
import React, { useState, useEffect } from 'react';
import { apiService } from '../api';

function QuickCalibrationModal({ isOpen, onClose, lineData, emailId, onUpdate }) {
  const [correctedAmount, setCorrectedAmount] = useState('');
  const [reason, setReason] = useState('');
  const [isSaving, setIsSaving] = useState(false);
  const [calculationHelp, setCalculationHelp] = useState('');

  useEffect(() => {
    if (isOpen && lineData) {
      const originalAmount = lineData.batch_data?.data?.total_amount ?? 0;
      setCorrectedAmount(originalAmount.toString());
      setReason('');
      setCalculationHelp('');

      // è‡ªåŠ¨è®¡ç®—å¸®åŠ©æ–‡æœ¬
      calculateHelpText(lineData.text, originalAmount);
    }
  }, [isOpen, lineData]);

  const calculateHelpText = (text, currentAmount) => {
    if (!text) return;

    // ç®€å•çš„é‡‘é¢æå–é€»è¾‘
    const amountMatches = text.match(/(\d+)\s*(å…ƒ|å—|é—·)/g);
    if (amountMatches) {
      const amounts = amountMatches.map(match => {
        const amount = match.match(/\d+/);
        return amount ? parseInt(amount[0]) : 0;
      });

      const totalFromText = amounts.reduce((sum, amount) => sum + amount, 0);

      if (totalFromText > 0 && totalFromText !== currentAmount) {
        setCalculationHelp(`æ£€æµ‹åˆ°æ–‡æœ¬ä¸­å¯èƒ½çš„æ€»é‡‘é¢: ${totalFromText} å…ƒ`);
      }
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    if (!correctedAmount || isNaN(parseFloat(correctedAmount))) {
      alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ€»é‡‘é¢');
      return;
    }

    const amount = parseFloat(correctedAmount);
    if (amount <= 0) {
      alert('é‡‘é¢å¿…é¡»å¤§äº0');
      return;
    }

    setIsSaving(true);

    try {
      // æ„å»ºè¯·æ±‚è´Ÿè½½ - ç¡®ä¿æ‰€æœ‰å‚æ•°éƒ½æ˜¯æ­£ç¡®çš„ç±»å‹
      const payload = {
        email_id: parseInt(emailId, 10), // ç¡®ä¿æ˜¯æ•°å­—
        line_number: parseInt(lineData.line_number, 10),
        batch_id: parseInt(lineData.batch_data?.batch_id, 10),
        corrected_total_amount: amount,
        reason: reason.trim(),
      };

      console.log('å‘é€å¿«é€Ÿæ ¡å‡†è¯·æ±‚:', payload);

      // éªŒè¯å¿…éœ€å‚æ•°
      if (!payload.email_id || !payload.line_number || !payload.batch_id) {
        throw new Error('ç¼ºå°‘å¿…è¦çš„å‚æ•°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }

      const result = await apiService.quickCalibrateAi(payload);

      if (result.status === 'success') {
        alert(result.message || 'æ ¡å‡†æˆåŠŸï¼');
        if (onUpdate) {
          onUpdate(lineData.line_number, result.data);
        }
        onClose();
      } else {
        throw new Error(result.message || 'æ ¡å‡†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }

    } catch (error) {
      console.error("å¿«é€Ÿæ ¡å‡†å¤±è´¥:", error);

      // æ›´å‹å¥½çš„é”™è¯¯æç¤º
      let errorMessage = error.message;
      if (error.message.includes('Email ID is required')) {
        errorMessage = 'é‚®ä»¶IDå‚æ•°é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
      } else if (error.message.includes('Record not found')) {
        errorMessage = 'æœªæ‰¾åˆ°å¯¹åº”çš„è§£æè®°å½•ï¼Œå¯èƒ½å·²è¢«åˆ é™¤';
      } else if (error.message.includes('Unauthorized')) {
        errorMessage = 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
      }

      alert('é”™è¯¯: ' + errorMessage);
    } finally {
      setIsSaving(false);
    }
  };

  const handleAmountChange = (value) => {
    setCorrectedAmount(value);

    // å®æ—¶è®¡ç®—å¸®åŠ©
    if (lineData?.text && value) {
      calculateHelpText(lineData.text, parseFloat(value));
    }
  };

  if (!isOpen) return null;

  return (
    <div style={{
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      backgroundColor: 'rgba(0,0,0,0.5)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 1000
    }}>
      <div style={{
        backgroundColor: 'white',
        padding: '2rem',
        borderRadius: '12px',
        width: '500px',
        maxWidth: '90%',
        maxHeight: '90vh',
        overflow: 'auto'
      }}>
        <h3 style={{ marginTop: 0, marginBottom: '1.5rem', color: '#333' }}>
          ğŸ¯ å¿«é€Ÿæ ¡å‡†AIè§£æ
        </h3>

        {/* åŸå§‹æ–‡æœ¬æ˜¾ç¤º */}
        <div style={{
          backgroundColor: '#f8f9fa',
          padding: '1rem',
          borderRadius: '6px',
          marginBottom: '1.5rem',
          border: '1px solid #e9ecef'
        }}>
          <div style={{ fontSize: '0.9rem', color: '#6c757d', marginBottom: '0.5rem' }}>
            <strong>åŸå§‹æ–‡æœ¬:</strong>
          </div>
          <div style={{
            fontFamily: 'monospace',
            whiteSpace: 'pre-wrap',
            wordBreak: 'break-all',
            backgroundColor: '#fff',
            padding: '0.75rem',
            borderRadius: '4px',
            border: '1px solid #dee2e6',
            fontSize: '0.85rem'
          }}>
            {lineData.text}
          </div>
        </div>

        {/* å½“å‰è§£æä¿¡æ¯ */}
        {lineData.batch_data && (
          <div style={{
            backgroundColor: '#fff3cd',
            padding: '1rem',
            borderRadius: '6px',
            marginBottom: '1.5rem',
            border: '1px solid #ffeaa7'
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <div>
                <strong>AIå½“å‰è§£ææ€»é¢:</strong>
                <span style={{
                  fontSize: '1.2rem',
                  fontWeight: 'bold',
                  color: '#e74c3c',
                  marginLeft: '0.5rem'
                }}>
                  {lineData.batch_data?.data?.total_amount ?? 'æœªè¯†åˆ«'} å…ƒ
                </span>
              </div>
              {lineData.batch_data.data?.lottery_type && (
                <span style={{
                  backgroundColor: '#e7f3ff',
                  color: '#0066cc',
                  padding: '0.25rem 0.5rem',
                  borderRadius: '12px',
                  fontSize: '0.8rem',
                  fontWeight: 'bold'
                }}>
                  {lineData.batch_data.data.lottery_type}
                </span>
              )}
            </div>
          </div>
        )}

        <form onSubmit={handleSubmit}>
          {/* é‡‘é¢è¾“å…¥ */}
          <div style={{ marginBottom: '1.5rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>
              ğŸ’° æ­£ç¡®çš„æ€»é‡‘é¢ (å…ƒ)
            </label>
            <input
              type="number"
              step="0.01"
              min="0.01"
              value={correctedAmount}
              onChange={(e) => handleAmountChange(e.target.value)}
              style={{
                width: '100%',
                boxSizing: 'border-box',
                padding: '0.75rem',
                fontSize: '1.1rem',
                border: '2px solid #007bff',
                borderRadius: '6px',
                backgroundColor: '#f8fdff'
              }}
              autoFocus
              required
              disabled={isSaving}
            />
            {calculationHelp && (
              <div style={{
                fontSize: '0.8rem',
                color: '#28a745',
                marginTop: '0.5rem',
                fontStyle: 'italic'
              }}>
                ğŸ’¡ {calculationHelp}
              </div>
            )}
          </div>

          {/* ç†ç”±è¾“å…¥ */}
          <div style={{ marginBottom: '1.5rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>
              ğŸ“ ä¿®æ­£ç†ç”± (é€‰å¡«ï¼Œå¸®åŠ©AIå­¦ä¹ )
            </label>
            <input
              type="text"
              value={reason}
              onChange={(e) => setReason(e.target.value)}
              placeholder="ä¾‹å¦‚: 10.22å„5å—, æ€»å…±æ˜¯10å…ƒ"
              style={{
                width: '100%',
                boxSizing: 'border-box',
                padding: '0.75rem',
                border: '1px solid #ced4da',
                borderRadius: '6px'
              }}
              disabled={isSaving}
            />
            <div style={{
              fontSize: '0.8rem',
              color: '#6c757d',
              marginTop: '0.5rem'
            }}>
              æä¾›ä¿®æ­£ç†ç”±å¯ä»¥å¸®åŠ©AIæ›´å¥½åœ°ç†è§£æ‚¨çš„æ„å›¾ï¼Œæé«˜æœªæ¥è§£æçš„å‡†ç¡®æ€§
            </div>
          </div>

          {/* æ“ä½œæŒ‰é’® */}
          <div style={{
            display: 'flex',
            justifyContent: 'flex-end',
            gap: '1rem',
            paddingTop: '1rem',
            borderTop: '1px solid #e9ecef'
          }}>
            <button
              type="button"
              onClick={onClose}
              disabled={isSaving}
              style={{
                padding: '0.75rem 1.5rem',
                backgroundColor: '#6c757d',
                color: 'white',
                border: 'none',
                borderRadius: '6px',
                cursor: isSaving ? 'not-allowed' : 'pointer',
                fontSize: '1rem',
                opacity: isSaving ? 0.6 : 1
              }}
            >
              å–æ¶ˆ
            </button>
            <button
              type="submit"
              disabled={isSaving}
              style={{
                padding: '0.75rem 1.5rem',
                backgroundColor: isSaving ? '#6c757d' : '#28a745',
                color: 'white',
                border: 'none',
                borderRadius: '6px',
                cursor: isSaving ? 'not-allowed' : 'pointer',
                fontSize: '1rem',
                fontWeight: 'bold',
                opacity: isSaving ? 0.6 : 1
              }}
            >
              {isSaving ? 'ğŸ”„ æäº¤ä¸­...' : 'ğŸš€ æäº¤ç»™AIé‡æ–°è§£æ'}
            </button>
          </div>
        </form>

        {/* æç¤ºä¿¡æ¯ */}
        <div style={{
          marginTop: '1.5rem',
          padding: '1rem',
          backgroundColor: '#e7f3ff',
          borderRadius: '6px',
          border: '1px solid #b3d9ff'
        }}>
          <div style={{ fontSize: '0.9rem', color: '#0066cc' }}>
            <strong>ğŸ’¡ ä½¿ç”¨æç¤º:</strong>
            <ul style={{ margin: '0.5rem 0 0 1rem', padding: 0 }}>
              <li>è¾“å…¥æ­£ç¡®çš„æ€»é‡‘é¢åï¼ŒAIä¼šé‡æ–°è§£æä¸‹æ³¨å†…å®¹</li>
              <li>ç³»ç»Ÿä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—ç»“ç®—ç»“æœ</li>
              <li>æ‚¨çš„ä¿®æ­£ä¼šå¸®åŠ©AIå­¦ä¹ ï¼Œæé«˜æœªæ¥å‡†ç¡®æ€§</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
}

export default QuickCalibrationModal;
--- End of File: frontend/src/components/QuickCalibrationModal.jsx ---


--- File: frontend/src/components/RequireAuth.jsx ---

// src/components/RequireAuth.jsx
import React from 'react';
import { useLocation, Navigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

function RequireAuth({ children }) {
  const { user } = useAuth();
  const location = useLocation();

  if (!user) {
    // å¦‚æœæœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µï¼Œå¹¶è®°å½•ä»å“ªä¸ªé¡µé¢æ¥çš„
    return <Navigate to="/auth" state={{ from: location }} replace />;
  }

  return children;
}

export default RequireAuth;
--- End of File: frontend/src/components/RequireAuth.jsx ---


--- File: frontend/src/components/LotteryResults.jsx ---

// src/components/LotteryResults.jsx (Banner Version)
import React, { useState, useEffect } from 'react';
import { apiService } from '../api';

// å®šä¹‰å½©ç¥¨ç±»å‹å’Œå®ƒä»¬çš„é¡ºåº
const LOTTERY_TYPES = ['é¦™æ¸¯å…­åˆå½©', 'æ–°æ¾³é—¨å…­åˆå½©', 'è€æ¾³é—¨å…­åˆå½©'];

// æ³¢è‰²æ–‡å­—åˆ° CSS ç±»åçš„æ˜ å°„
const colorClassMap = {
  'çº¢æ³¢': 'color-red',
  'ç»¿æ³¢': 'color-green',
  'è“æ³¢': 'color-blue',
};

// å•ä¸ªå¼€å¥–å·ç æ ¼å­çš„ç»„ä»¶
const NumberCell = ({ number, color }) => {
  const bgColorClass = colorClassMap[color] || 'color-unknown';
  return (
    <div className={`number-cell ${bgColorClass}`}>
      {number}
    </div>
  );
};

// å•ä¸ªæ¨ªå¹…çš„ç»„ä»¶
const LotteryBanner = ({ type, data }) => {
  if (!data) {
    return (
      <div className="lottery-banner">
        <div className="banner-header">
          <h3>{type}</h3>
          <p>ç­‰å¾…å¼€å¥–...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="lottery-banner">
      <div className="banner-header">
        <h3>{type}</h3>
        <p>ç¬¬ {data.issue_number} æœŸ - {data.drawing_date}</p>
      </div>
      <div className="numbers-grid">
        {data.winning_numbers.map((number, index) => (
          <NumberCell key={index} number={number} color={data.colors[index]} />
        ))}
      </div>
    </div>
  );
};


// ä¸»ç»„ä»¶
function LotteryResults() {
  const [results, setResults] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchData = () => {
        apiService.getLotteryResults()
        .then(response => {
          if (response.status === 'success') {
            setResults(response.data);
          } else {
            setError(response.message || 'Failed to load data');
          }
        })
        .catch(err => setError(err.message))
        .finally(() => setLoading(false));
    };

    fetchData();
    // è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡æ•°æ®
    const intervalId = setInterval(fetchData, 30000);

    // ç»„ä»¶å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
    return () => clearInterval(intervalId);
  }, []);

  if (loading) return <p>æ­£åœ¨åŠ è½½å¼€å¥–è®°å½•...</p>;
  if (error) return <p style={{ color: 'red' }}>é”™è¯¯: {error}</p>;
  if (!results) return <p>æ— æ³•åŠ è½½æ•°æ®ç»“æ„ã€‚</p>;

  return (
    <div className="lottery-banners-container">
      {LOTTERY_TYPES.map(type => (
        <LotteryBanner key={type} type={type} data={results[type]} />
      ))}
    </div>
  );
}

export default LotteryResults;
--- End of File: frontend/src/components/LotteryResults.jsx ---


--- File: frontend/src/components/SettlementCard.jsx ---

import React, { useState, useMemo } from 'react';
import { apiService } from '../api';

/**
 * SettlementCard ç»„ä»¶ - ä¿®å¤ç‰ˆ
 * æ˜¾ç¤ºè¯¦ç»†çš„ç»“ç®—ä¿¡æ¯å¹¶æä¾›ç¼–è¾‘åŠŸèƒ½
 */
const SettlementCard = ({ batch, lotteryResult, onUpdate }) => {
  const { batch_id, data, settlement, ai_model } = batch;
  const [isEditing, setIsEditing] = useState(false);
  const [editableData, setEditableData] = useState(JSON.stringify(data.bets, null, 2));
  const [isSaving, setIsSaving] = useState(false);

  // ç»“ç®—è®¡ç®— - ä¿®å¤ç‰ˆ
  const { totalBetAmount, winningBets, summaryText } = useMemo(() => {
    if (settlement) {
      return {
        totalBetAmount: settlement.total_bet_amount,
        winningBets: settlement.winning_details,
        summaryText: settlement.summary
      };
    }

    // å¦‚æœæ²¡æœ‰ç»“ç®—æ•°æ®ï¼Œä½¿ç”¨å‰ç«¯è®¡ç®—
    let total = 0;
    const winners = [];
    const betSummary = {};

    if (Array.isArray(data.bets)) {
      data.bets.forEach(bet => {
        const amount = Number(bet.amount) || 0;
        if ((bet.bet_type === 'å·ç ' || bet.bet_type === 'ç‰¹ç ' || bet.bet_type === 'å¹³ç ') && Array.isArray(bet.targets)) {
          bet.targets.forEach(targetNumber => {
            total += amount;
            betSummary[amount] = (betSummary[amount] || 0) + 1;

            // å¦‚æœæœ‰å¼€å¥–ç»“æœï¼Œè¿›è¡Œå®é™…ç»“ç®—
            if (lotteryResult && Array.isArray(lotteryResult.winning_numbers)) {
              // ç‰¹ç ç©æ³•ï¼šåªå¯¹æ¯”ç‰¹ç ï¼ˆæœ€åä¸€ä¸ªå·ç ï¼‰
              if (bet.bet_type === 'ç‰¹ç ' || bet.bet_type === 'å·ç ') {
                const specialNumber = lotteryResult.winning_numbers[lotteryResult.winning_numbers.length - 1];
                if (String(targetNumber).trim() === String(specialNumber).trim()) {
                  winners.push({
                    number: targetNumber,
                    amount: amount,
                    bet_type: bet.bet_type
                  });
                }
              }
              // å¹³ç ç©æ³•ï¼šå¯¹æ¯”æ‰€æœ‰å·ç 
              else if (bet.bet_type === 'å¹³ç ') {
                if (lotteryResult.winning_numbers.includes(String(targetNumber).trim())) {
                  winners.push({
                    number: targetNumber,
                    amount: amount,
                    bet_type: bet.bet_type
                  });
                }
              }
            }
          });
        }
      });
    }

    const summaryParts = Object.entries(betSummary).map(([amount, count]) => `${amount}å…ƒx${count}ä¸ª`);
    const summary = `æ€»ä¸‹æ³¨ ${total} å…ƒ (${summaryParts.join(', ')})`;

    return { totalBetAmount: total, winningBets: winners, summaryText: summary };
  }, [data.bets, lotteryResult, settlement]);

  // ä¿å­˜ä¿®æ”¹
  const handleSave = async () => {
    setIsSaving(true);
    try {
      const updatedBets = JSON.parse(editableData);
      if (!Array.isArray(updatedBets)) {
        throw new Error("JSON æ ¼å¼å¿…é¡»æ˜¯ä¸€ä¸ªæ•°ç»„ [...]");
      }

      const updatedBatchData = { ...data, bets: updatedBets };
      await apiService.updateBetBatch(batch_id, updatedBatchData);
      onUpdate(batch_id, updatedBatchData);
      setIsEditing(false);
    } catch (e) {
      alert("JSON æ ¼å¼é”™è¯¯æˆ–ä¿å­˜å¤±è´¥: " + e.message);
    } finally {
      setIsSaving(false);
    }
  };

  // æ¸²æŸ“ä¸­å¥–è¯¦æƒ… - ä¿®å¤ç‰ˆ
  const renderWinningDetails = (odds) => {
    // å¦‚æœæ²¡æœ‰å¼€å¥–ç»“æœï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
    if (!lotteryResult || !Array.isArray(lotteryResult.winning_numbers)) {
      return (
        <div style={{ color: '#666', fontStyle: 'italic' }}>
          æš‚æ— å¼€å¥–æ•°æ®ï¼Œæ— æ³•è®¡ç®—ä¸­å¥–æƒ…å†µ
          {lotteryResult && (
            <div style={{ fontSize: '0.8rem', marginTop: '0.25rem' }}>
              æœ€æ–°å¼€å¥–æœŸå·: {lotteryResult.issue_number}
            </div>
          )}
        </div>
      );
    }

    // å¦‚æœæœ‰å¼€å¥–ç»“æœä½†æœªä¸­å¥–
    if (winningBets.length === 0) {
      const totalWinAmount = 0;
      const netProfit = -totalBetAmount;

      return (
        <>
          <span style={{ color: 'green', fontWeight: 'bold' }}>
            æœªä¸­å¥–
          </span>{' '}
          |{' '}
          <span style={{ fontWeight: 'bold', color: netProfit >= 0 ? 'red' : 'blue' }}>
            å‡€äº {Math.abs(netProfit)} å…ƒ
          </span>
        </>
      );
    }

    // è®¡ç®—ä¸­å¥–é‡‘é¢
    const totalWinAmount = winningBets.reduce((sum, bet) => sum + (bet.amount * odds), 0);
    const netProfit = totalWinAmount - totalBetAmount;

    return (
      <>
        <span style={{ color: 'red', fontWeight: 'bold' }}>
          ä¸­ {winningBets.length} æ³¨, èµ¢ {totalWinAmount}å…ƒ
        </span>{' '}
        |{' '}
        <span style={{ fontWeight: 'bold', color: netProfit >= 0 ? 'red' : 'blue' }}>
          å‡€{netProfit >= 0 ? 'èµ¢' : 'äº'} {Math.abs(netProfit)} å…ƒ
        </span>
      </>
    );
  };

  // è·å–ç‰¹ç å·ç 
  const getSpecialNumber = () => {
    if (!lotteryResult || !Array.isArray(lotteryResult.winning_numbers)) {
      return 'æš‚æ— ';
    }
    return lotteryResult.winning_numbers[lotteryResult.winning_numbers.length - 1];
  };

  return (
    <div className="settlement-card" style={{
      border: '2px solid #e3f2fd',
      borderRadius: '8px',
      margin: '1rem 0',
      padding: '1rem',
      backgroundColor: '#f8fdff'
    }}>
      {/* æ‰¹æ¬¡å¤´éƒ¨ä¿¡æ¯ */}
      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: '1rem',
        paddingBottom: '0.5rem',
        borderBottom: '1px solid #e0e0e0'
      }}>
        <div>
          <strong>æ‰¹æ¬¡ ID: {batch_id}</strong>
          <span style={{ marginLeft: '1rem', color: '#666', fontSize: '0.9rem' }}>
            AIæ¨¡å‹: {ai_model}
          </span>
        </div>
        <button
          onClick={() => setIsEditing(!isEditing)}
          style={{
            padding: '0.25rem 0.5rem',
            backgroundColor: isEditing ? '#dc3545' : '#007bff',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: 'pointer',
            fontSize: '0.8rem'
          }}
        >
          {isEditing ? 'å–æ¶ˆä¿®æ”¹' : 'ä¿®æ”¹è¯†åˆ«'}
        </button>
      </div>

      {/* åŸå§‹æ–‡æœ¬ */}
      <div style={{
        whiteSpace: 'pre-wrap',
        backgroundColor: '#f5f5f5',
        padding: '0.5rem',
        borderRadius: '4px',
        marginBottom: '1rem',
        fontFamily: 'monospace',
        fontSize: '0.9rem'
      }}>
        {data.raw_text}
      </div>

      {/* å¼€å¥–ä¿¡æ¯ */}
      {lotteryResult && (
        <div style={{
          backgroundColor: '#e8f5e8',
          border: '1px solid #4caf50',
          padding: '0.75rem',
          borderRadius: '4px',
          marginBottom: '1rem'
        }}>
          <p style={{ margin: '0 0 0.5rem 0', fontWeight: 'bold', color: '#2e7d32' }}>
            ğŸ¯ å¼€å¥–ä¿¡æ¯: {lotteryResult.lottery_type} ç¬¬ {lotteryResult.issue_number} æœŸ
          </p>
          <p style={{ margin: '0.25rem 0', fontSize: '0.9rem' }}>
            <strong>å¼€å¥–å·ç :</strong> {lotteryResult.winning_numbers?.join(', ') || 'æš‚æ— '}
          </p>
          <p style={{ margin: '0.25rem 0', fontSize: '0.9rem' }}>
            <strong>ç‰¹ç :</strong> <span style={{ color: 'red', fontWeight: 'bold' }}>{getSpecialNumber()}</span>
          </p>
        </div>
      )}

      {/* ç»“ç®—è¯¦æƒ… */}
      <div className="settlement-details">
        {/* AI è¯†åˆ«æ¦‚è¦ */}
        <div style={{
          backgroundColor: '#fff3cd',
          border: '1px solid #ffeaa7',
          padding: '0.75rem',
          borderRadius: '4px',
          marginBottom: '1rem'
        }}>
          <p style={{
            color: '#856404',
            fontSize: '1.1rem',
            margin: '0.5rem 0',
            fontWeight: 'bold'
          }}>
            ğŸ¯ AIè¯†åˆ«æ¦‚è¦: {summaryText}
          </p>
        </div>

        {/* ç»“ç®—ç»“æœ */}
        <div className="results-grid">
          <div style={{ marginBottom: '0.5rem' }}>
            <strong>ä¸­å¥–è¯¦æƒ…:</strong>{' '}
            {winningBets.length > 0 ? (
              <span style={{ color: 'red', fontWeight: 'bold' }}>
                {winningBets.map(b => `${b.number}(${b.amount}å…ƒ)`).join(', ')}
              </span>
            ) : lotteryResult ? (
              <span style={{ color: 'green' }}>æ— ä¸­å¥–</span>
            ) : (
              <span style={{ color: '#666' }}>ç­‰å¾…å¼€å¥–æ•°æ®...</span>
            )}
          </div>

          <div style={{ marginBottom: '0.5rem' }}>
            <strong>ç»“ç®—ç»“æœ:</strong>{' '}
            {settlement.net_profits && settlement.net_profits.odds ? (
              <>
                <span style={{
                  color: settlement.net_profits.is_profit ? 'red' : 'blue',
                  fontWeight: 'bold'
                }}>
                  {settlement.net_profits.is_profit ? 'ç›ˆåˆ©' : 'äºæŸ'} {Math.abs(settlement.net_profits.net_profit)} å…ƒ
                </span>
                {' '}(èµ”ç‡: {settlement.net_profits.odds})
              </>
            ) : (
              <span style={{ color: '#666' }}>æœªè®¾ç½®è¯¥ç©æ³•çš„èµ”ç‡</span>
            )}
          </div>
        </div>
      </div>

      {/* ç¼–è¾‘æ¨¡å¼ */}
      {isEditing && (
        <div style={{
          marginTop: '1rem',
          padding: '1rem',
          backgroundColor: '#f8f9fa',
          border: '1px solid #dee2e6',
          borderRadius: '4px'
        }}>
          <p style={{ fontSize: '0.9rem', color: '#666', margin: '0 0 0.5rem 0' }}>
            è¯·ç›´æ¥ç¼–è¾‘ä»¥ä¸‹ä»£è¡¨ä¸‹æ³¨å†…å®¹çš„ JSON æ•°æ®ï¼š
          </p>
          <textarea
            value={editableData}
            onChange={(e) => setEditableData(e.target.value)}
            style={{
              width: '98%',
              height: '200px',
              fontFamily: 'monospace',
              fontSize: '0.9rem',
              border: '1px solid #ccc',
              padding: '8px',
              borderRadius: '4px'
            }}
          />
          <div style={{ marginTop: '0.5rem' }}>
            <button
              onClick={handleSave}
              disabled={isSaving}
              style={{
                padding: '0.5rem 1rem',
                backgroundColor: '#28a745',
                color: 'white',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer',
                marginRight: '0.5rem'
              }}
            >
              {isSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜ä¿®æ”¹'}
            </button>
            <button
              onClick={() => setIsEditing(false)}
              style={{
                padding: '0.5rem 1rem',
                backgroundColor: '#6c757d',
                color: 'white',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer'
              }}
            >
              å–æ¶ˆ
            </button>
          </div>
        </div>
      )}

      {/* è°ƒè¯•ä¿¡æ¯ */}
      {process.env.NODE_ENV === 'development' && (
        <details style={{ marginTop: '1rem', fontSize: '0.8rem' }}>
          <summary>è°ƒè¯•ä¿¡æ¯</summary>
          <div style={{ background: '#f5f5f5', padding: '0.5rem', borderRadius: '4px' }}>
            <p><strong>æ‰¹æ¬¡æ•°æ®:</strong> {JSON.stringify(data, null, 2)}</p>
            <p><strong>å¼€å¥–ç»“æœ:</strong> {JSON.stringify(lotteryResult, null, 2)}</p>
            <p><strong>ä¸­å¥–æ³¨æ•°:</strong> {winningBets.length}</p>
          </div>
        </details>
      )}
    </div>
  );
};

export default SettlementCard;

--- End of File: frontend/src/components/SettlementCard.jsx ---


--- File: frontend/src/api/index.js ---

// File: frontend/src/api/index.js (ä¿®å¤å“åº”ä½“å¤šæ¬¡è¯»å–é—®é¢˜)

const API_BASE_URL = 'https://wenge.cloudns.ch/index.php';

async function request(endpoint, options = {}, queryParams = '') {
  const defaultOptions = {
    credentials: 'include',
    headers: {
      'Content-Type': 'application/json',
    },
  };

  const finalOptions = {
    ...defaultOptions,
    ...options,
    headers: {
      ...defaultOptions.headers,
      ...options.headers,
    },
  };

  const url = `${API_BASE_URL}?endpoint=${endpoint}${queryParams}`;

  try {
    console.log(`Making API request to: ${endpoint}`);
    const response = await fetch(url, finalOptions);

    if (!response.ok) {
      if (response.status === 401) {
        if (typeof window !== 'undefined' && window.location.pathname !== '/auth') {
          window.location.href = '/auth';
        }
        throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
      }

      let errorMessage = `Error ${response.status}`;
      try {
        // å…‹éš†å“åº”ä»¥é¿å…å¤šæ¬¡è¯»å–é—®é¢˜
        const errorResponse = response.clone();
        const errorText = await errorResponse.text();
        try {
          const errorData = JSON.parse(errorText);
          errorMessage = errorData.message || errorMessage;
        } catch (e) {
          errorMessage = errorText || errorMessage;
        }
      } catch (e) {
        // å¦‚æœæ— æ³•è¯»å–é”™è¯¯å“åº”ï¼Œä½¿ç”¨é»˜è®¤é”™è¯¯ä¿¡æ¯
        console.error('Failed to read error response:', e);
      }

      throw new Error(errorMessage);
    }

    if (endpoint === 'download_settlement') {
        return response.blob();
    }

    const data = await response.json();
    console.log(`API request to ${endpoint} successful`);
    return data;
  } catch (error) {
    console.error(`API request to ${endpoint} failed:`, error);
    if (error.name === 'TypeError' && error.message.includes('fetch')) {
      throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
    }
    throw error;
  }
}

export const apiService = {
  register(email, password) {
    return request('register', {
      method: 'POST',
      body: JSON.stringify({ email, password })
    });
  },

  login(email, password) {
    return request('login', {
      method: 'POST',
      body: JSON.stringify({ email, password })
    });
  },

  logout() {
    return request('logout', { method: 'POST' });
  },

  checkSession() {
    return request('check_session');
  },

  getLotteryResults(type = 'all', limit = 10) {
    return request('get_lottery_results', {}, `&type=${encodeURIComponent(type)}&limit=${limit}`);
  },

  getLotteryResultByIssue(type, issue) {
    return request('get_lottery_result_by_issue', {}, `&type=${encodeURIComponent(type)}&issue=${issue}`);
  },

  getEmails() {
    return request('get_emails');
  },

  getEmailContent(id) {
    return request('get_email_content', {}, `&id=${id}`);
  },

  getEmailDetails(id) {
    return request('get_email_details', {}, `&id=${id}`);
  },

  splitEmailLines(emailId) {
    return request('split_email_lines', {}, `&id=${emailId}`);
  },

  parseSingleBet(emailId, betText, lineNumber, lotteryType = 'é¦™æ¸¯å…­åˆå½©') {
    return request('parse_single_bet', {
      method: 'POST',
      body: JSON.stringify({
        email_id: emailId,
        bet_text: betText,
        line_number: lineNumber,
        lottery_type: lotteryType
      })
    });
  },

  updateBetBatch(batchId, data) {
    return request('update_bet_batch', {
      method: 'POST',
      body: JSON.stringify({ batch_id: batchId, data: data })
    });
  },

  deleteBetBatch(batchId) {
    return request('delete_bet_batch', {
      method: 'POST',
      body: JSON.stringify({ batch_id: batchId })
    });
  },

  reanalyzeEmail(emailId) {
    return request('reanalyze_email', {
      method: 'POST',
      body: JSON.stringify({ email_id: emailId })
    });
  },

  downloadSettlement(emailId) {
    return request('download_settlement', {}, `&id=${emailId}`);
  },

  smartParseEmail(emailId, lotteryTypes) {
    return request('smart_parse_email', {
      method: 'POST',
      body: JSON.stringify({
        email_id: emailId,
        lottery_types: lotteryTypes
      })
    });
  },

  /**
   * å¿«é€Ÿæ ¡å‡†AI
   * @param {object} payload - åŒ…å«é‡‘é¢å’Œç†ç”±çš„æ ¡å‡†æ•°æ®
   * @returns {Promise}
   */
  quickCalibrateAi(payload) {
    console.log('å¿«é€Ÿæ ¡å‡†APIè°ƒç”¨ï¼Œpayload:', payload);
    return request('quick_calibrate_ai', {
        method: 'POST',
        body: JSON.stringify(payload)
    });
  },

  /**
   * ä¼ ç»Ÿæ ¡å‡†AIï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
   * @param {object} payload - åŒ…å«è¯¦ç»†æ ¡å‡†æ•°æ®çš„è´Ÿè½½
   * @returns {Promise}
   */
  calibrateAiParse(payload) {
    console.log('ä¼ ç»Ÿæ ¡å‡†APIè°ƒç”¨ï¼Œpayload:', payload);
    return request('calibrate_ai_parse', {
        method: 'POST',
        body: JSON.stringify(payload)
    });
  },

  getOddsTemplate() {
    return request('odds_template');
  },

  updateOddsTemplate(templateData) {
    return request('odds_template', {
      method: 'POST',
      body: JSON.stringify(templateData)
    });
  },

  getSettlements() {
    return Promise.resolve({
      status: 'success',
      data: [
        { id: 1, bet_id: 101, total_win: 500, created_at: new Date().toISOString() },
        { id: 2, bet_id: 102, total_win: -200, created_at: new Date(Date.now() - 86400000).toISOString() }
      ]
    });
  },

  runSettlement(betId, lotteryResult) {
    return Promise.resolve({
      status: 'success',
      data: {
        id: Date.now(),
        bet_id: betId,
        total_win: Math.random() > 0.5 ? 450 : -100,
        created_at: new Date().toISOString()
      }
    });
  }
};

export default apiService;
--- End of File: frontend/src/api/index.js ---


--- File: frontend/src/App.jsx ---

// File: frontend/src/App.jsx

import React from 'react';
import { Routes, Route } from 'react-router-dom';
import { AuthProvider } from './context/AuthContext';

import Navbar from './components/Navbar';
import RequireAuth from './components/RequireAuth';

import HomePage from './pages/HomePage';
import AuthPage from './pages/AuthPage';
import EmailsListPage from './pages/EmailsListPage';
import EmailDetailPage from './pages/EmailDetailPage';
import OddsTemplatePage from './pages/OddsTemplatePage'; // æ–°å¢

function App() {
  return (
    <AuthProvider>
      <Navbar />
      <main className="container">
        <Routes>
          <Route path="/" element={<HomePage />} />
          <Route path="/auth" element={<AuthPage />} />

          <Route
            path="/emails"
            element={<RequireAuth><EmailsListPage /></RequireAuth>}
          />
          <Route
            path="/emails/:emailId"
            element={<RequireAuth><EmailDetailPage /></RequireAuth>}
          />
          <Route
            path="/odds-template"
            element={<RequireAuth><OddsTemplatePage /></RequireAuth>}
          />

          <Route path="*" element={
            <div className="card"><h1>404 - é¡µé¢æœªæ‰¾åˆ°</h1></div>
          } />
        </Routes>
      </main>
    </AuthProvider>
  );
}

export default App;

--- End of File: frontend/src/App.jsx ---


--- File: frontend/public/_worker.js ---

// File: frontend/public/_worker.js (ä¿®å¤ç‰ˆ)

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    // Only proxy API requests
    if (url.pathname.startsWith('/api/')) {
      const endpoint = url.pathname.substring(5);
      const backendUrl = `https://wenge.cloudns.ch/index.php?endpoint=${endpoint}${url.search}`;

      // ä¿®å¤ï¼šåˆ›å»ºæ–°çš„è¯·æ±‚å¯¹è±¡ï¼Œé¿å…æµå¼ body é—®é¢˜
      const backendRequestInit = {
        method: request.method,
        headers: new Headers(request.headers),
        // å¯¹äºé GET è¯·æ±‚ï¼Œå…‹éš† body ä»¥é¿å…æµå¼é—®é¢˜
        body: request.method !== 'GET' && request.body ? await request.clone().arrayBuffer() : null,
        // æ·»åŠ  duplex è®¾ç½®
        duplex: 'half'
      };

      try {
        const backendRequest = new Request(backendUrl, backendRequestInit);
        return await fetch(backendRequest);
      } catch (e) {
        return new Response(`Backend server is unreachable: ${e.message}`, { status: 503 });
      }
    }

    // Serve static assets
    return env.ASSETS.fetch(request);
  },
};

--- End of File: frontend/public/_worker.js ---


--- File: frontend/index.html ---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:,">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é‚®ä»¶å¤„ç†ç³»ç»Ÿ</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
--- End of File: frontend/index.html ---
