--- FILE: frontend/src/api/index.js ---
// File: frontend/src/api/index.js (Complete Version)

const API_BASE_URL = 'https://wenge.cloudns.ch/index.php';

/**
 * ç»Ÿä¸€çš„APIè¯·æ±‚å‡½æ•°
 * @param {string} endpoint - APIç«¯ç‚¹
 * @param {object} options - è¯·æ±‚é€‰é¡¹
 * @param {string} queryParams - æŸ¥è¯¢å‚æ•°
 * @returns {Promise} è¿”å›Promiseå¯¹è±¡
 */
async function request(endpoint, options = {}, queryParams = '') {
  // è®¾ç½®é»˜è®¤é€‰é¡¹
  const defaultOptions = {
    credentials: 'include',
    headers: {
      'Content-Type': 'application/json',
    },
  };

  // åˆå¹¶é€‰é¡¹
  const finalOptions = {
    ...defaultOptions,
    ...options,
    headers: {
      ...defaultOptions.headers,
      ...options.headers,
    },
  };

  const url = `${API_BASE_URL}?endpoint=${endpoint}${queryParams}`;

  try {
    console.log(`Making API request to: ${endpoint}`);
    const response = await fetch(url, finalOptions);

    // æ£€æŸ¥å“åº”çŠ¶æ€
    if (!response.ok) {
      // å¦‚æœæ˜¯401æœªæˆæƒï¼Œå¯èƒ½æ˜¯sessionè¿‡æœŸï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
      if (response.status === 401) {
        if (typeof window !== 'undefined' && window.location.pathname !== '/auth') {
          window.location.href = '/auth';
        }
        throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
      }

      // å°è¯•è§£æé”™è¯¯ä¿¡æ¯
      let errorMessage = `Error ${response.status}`;
      try {
        const errorData = await response.text();
        if (errorData) {
          const parsedError = JSON.parse(errorData);
          errorMessage = parsedError.message || errorMessage;
        }
      } catch (e) {
        // å¦‚æœæ— æ³•è§£æJSONï¼Œä½¿ç”¨åŸå§‹é”™è¯¯æ–‡æœ¬
        errorMessage = await response.text() || errorMessage;
      }

      throw new Error(errorMessage);
    }

    // è§£æå“åº”æ•°æ®
    const data = await response.json();

    // è®°å½•æˆåŠŸçš„APIè°ƒç”¨
    console.log(`API request to ${endpoint} successful`);

    return data;
  } catch (error) {
    console.error(`API request to ${endpoint} failed:`, error);

    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œæä¾›æ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
    if (error.name === 'TypeError' && error.message.includes('fetch')) {
      throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
    }

    throw error;
  }
}

// APIæœåŠ¡å¯¹è±¡
export const apiService = {
  // ==================== è®¤è¯ç›¸å…³ ====================

  /**
   * ç”¨æˆ·æ³¨å†Œ
   * @param {string} email - é‚®ç®±
   * @param {string} password - å¯†ç 
   * @returns {Promise}
   */
  register(email, password) {
    return request('register', {
      method: 'POST',
      body: JSON.stringify({ email, password })
    });
  },

  /**
   * ç”¨æˆ·ç™»å½•
   * @param {string} email - é‚®ç®±
   * @param {string} password - å¯†ç 
   * @returns {Promise}
   */
  login(email, password) {
    return request('login', {
      method: 'POST',
      body: JSON.stringify({ email, password })
    });
  },

  /**
   * ç”¨æˆ·ç™»å‡º
   * @returns {Promise}
   */
  logout() {
    return request('logout', { method: 'POST' });
  },

  /**
   * æ£€æŸ¥ä¼šè¯çŠ¶æ€
   * @returns {Promise}
   */
  checkSession() {
    return request('check_session');
  },

  // ==================== å½©ç¥¨ç›¸å…³ ====================

  /**
   * è·å–å½©ç¥¨ç»“æœ
   * @param {string} type - å½©ç¥¨ç±»å‹
   * @param {number} limit - é™åˆ¶æ•°é‡
   * @returns {Promise}
   */
  getLotteryResults(type = 'all', limit = 10) {
    return request('get_lottery_results', {}, `&type=${encodeURIComponent(type)}&limit=${limit}`);
  },

  /**
   * æ ¹æ®æœŸå·è·å–å½©ç¥¨ç»“æœ
   * @param {string} type - å½©ç¥¨ç±»å‹
   * @param {string} issue - æœŸå·
   * @returns {Promise}
   */
  getLotteryResultByIssue(type, issue) {
    return request('get_lottery_result_by_issue', {}, `&type=${encodeURIComponent(type)}&issue=${issue}`);
  },

  // ==================== é‚®ä»¶ç›¸å…³ ====================

  /**
   * è·å–é‚®ä»¶åˆ—è¡¨
   * @returns {Promise}
   */
  getEmails() {
    return request('get_emails');
  },

  /**
   * è·å–é‚®ä»¶å†…å®¹
   * @param {number} id - é‚®ä»¶ID
   * @returns {Promise}
   */
  getEmailContent(id) {
    return request('get_email_content', {}, `&id=${id}`);
  },

  /**
   * è·å–é‚®ä»¶è¯¦æƒ…ï¼ˆåŒ…å«ç»“ç®—ä¿¡æ¯ï¼‰
   * @param {number} id - é‚®ä»¶ID
   * @returns {Promise}
   */
  getEmailDetails(id) {
    return request('get_email_details', {}, `&id=${id}`);
  },

  /**
   * æ›´æ–°ä¸‹æ³¨æ‰¹æ¬¡
   * @param {number} batchId - æ‰¹æ¬¡ID
   * @param {object} data - ä¸‹æ³¨æ•°æ®
   * @returns {Promise}
   */
  updateBetBatch(batchId, data) {
    return request('update_bet_batch', {
      method: 'POST',
      body: JSON.stringify({ batch_id: batchId, data: data })
    });
  },

  /**
   * é‡æ–°è§£æé‚®ä»¶
   * @param {number} emailId - é‚®ä»¶ID
   * @returns {Promise}
   */
  reanalyzeEmail(emailId) {
    return request('reanalyze_email', {
      method: 'POST',
      body: JSON.stringify({ email_id: emailId })
    });
  },

  // ==================== ç»“ç®—ç›¸å…³ ====================

  /**
   * è·å–ç»“ç®—åˆ—è¡¨ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
   * @returns {Promise}
   */
  getSettlements() {
    // æš‚æ—¶è¿”å›æ¨¡æ‹Ÿæ•°æ®
    return Promise.resolve({
      status: 'success',
      data: [
        {
          id: 1,
          bet_id: 101,
          total_win: 500,
          created_at: new Date().toISOString(),
          lottery_type: 'é¦™æ¸¯å…­åˆå½©',
          issue_number: '2024001'
        },
        {
          id: 2,
          bet_id: 102,
          total_win: -200,
          created_at: new Date(Date.now() - 86400000).toISOString(),
          lottery_type: 'æ¾³é—¨å…­åˆå½©',
          issue_number: '2024001'
        }
      ]
    });
  },

  /**
   * è¿è¡Œç»“ç®—ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
   * @param {number} betId - ä¸‹æ³¨ID
   * @param {object} lotteryResult - å¼€å¥–ç»“æœ
   * @returns {Promise}
   */
  runSettlement(betId, lotteryResult) {
    // æš‚æ—¶è¿”å›æ¨¡æ‹Ÿæ•°æ®
    return Promise.resolve({
      status: 'success',
      data: {
        id: Date.now(),
        bet_id: betId,
        total_win: Math.random() > 0.5 ? 450 : -100,
        created_at: new Date().toISOString(),
        details: {
          winning_bets: Math.random() > 0.5 ? 2 : 0,
          total_bet_amount: 100,
          net_profit: Math.random() > 0.5 ? 350 : -100
        }
      }
    });
  }
};

// ==================== å·¥å…·å‡½æ•° ====================

/**
 * å¤„ç†APIé”™è¯¯
 * @param {Error} error - é”™è¯¯å¯¹è±¡
 * @param {string} context - ä¸Šä¸‹æ–‡æè¿°
 */
export function handleApiError(error, context = 'æ“ä½œ') {
  console.error(`${context}å¤±è´¥:`, error);

  let userMessage = error.message;

  // æ ¹æ®é”™è¯¯ç±»å‹æä¾›æ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
  if (error.message.includes('ç½‘ç»œè¿æ¥å¤±è´¥')) {
    userMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
  } else if (error.message.includes('ç™»å½•å·²è¿‡æœŸ')) {
    userMessage = 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
  } else if (error.message.includes('401')) {
    userMessage = 'è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•';
  } else if (error.message.includes('403')) {
    userMessage = 'æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œæ­¤æ“ä½œ';
  } else if (error.message.includes('404')) {
    userMessage = 'è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨';
  } else if (error.message.includes('500')) {
    userMessage = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
  }

  // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œå¯ä»¥é›†æˆåˆ°é€šçŸ¥ç³»ç»Ÿ
  if (typeof window !== 'undefined') {
    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¨å±€é€šçŸ¥
    alert(`${context}å¤±è´¥: ${userMessage}`);
  }

  return userMessage;
}

/**
 * é‡è¯•æœºåˆ¶
 * @param {Function} apiCall - APIè°ƒç”¨å‡½æ•°
 * @param {number} maxRetries - æœ€å¤§é‡è¯•æ¬¡æ•°
 * @param {number} delay - é‡è¯•å»¶è¿Ÿ(ms)
 * @returns {Promise}
 */
export function withRetry(apiCall, maxRetries = 3, delay = 1000) {
  return new Promise((resolve, reject) => {
    const attempt = (retryCount) => {
      apiCall()
        .then(resolve)
        .catch((error) => {
          if (retryCount < maxRetries) {
            console.log(`APIè°ƒç”¨å¤±è´¥ï¼Œç¬¬${retryCount + 1}æ¬¡é‡è¯•...`);
            setTimeout(() => attempt(retryCount + 1), delay * retryCount);
          } else {
            reject(error);
          }
        });
    };

    attempt(0);
  });
}

/**
 * é˜²æŠ–APIè°ƒç”¨
 * @param {Function} apiCall - APIè°ƒç”¨å‡½æ•°
 * @param {number} delay - å»¶è¿Ÿæ—¶é—´(ms)
 * @returns {Function} é˜²æŠ–å‡½æ•°
 */
export function debounceApiCall(apiCall, delay = 300) {
  let timeoutId;

  return (...args) => {
    return new Promise((resolve, reject) => {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => {
        apiCall(...args).then(resolve).catch(reject);
      }, delay);
    });
  };
}

// é»˜è®¤å¯¼å‡ºAPIæœåŠ¡
export default apiService;
--- FILE: frontend/src/index.css ---
/* src/index.css (Fully Responsive Version with Extra Large Lottery Numbers) */

/* --- Global & Layout --- */
:root {
  --primary-color: #007bff;
  --danger-color: #dc3545;
  --success-color: #28a745;
  --info-color: #17a2b8;
  --background-color: #f4f7f9;
  --card-background: #ffffff;
  --text-color: #333;
  --text-light: #666;
  --border-color: #e0e0e0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  background-color: var(--background-color);
  color: var(--text-color);
  margin: 0;
}

#root {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

main.container {
  flex-grow: 1;
  width: 100%;
  max-width: 1200px;
  margin: 2rem auto;
  padding: 0 1rem;
  box-sizing: border-box;
}

/* --- Navbar --- */
.navbar {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 2rem;
  background-color: var(--card-background);
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  border-bottom: 1px solid var(--border-color);
  gap: 1rem;
}
.nav-brand a {
  font-weight: bold;
  font-size: 1.5rem;
  color: var(--text-color);
  text-decoration: none;
}
.nav-links {
  list-style: none;
  display: flex;
  gap: 1.5rem;
  margin: 0;
  padding: 0;
}
.nav-links a {
  color: var(--text-light);
  text-decoration: none;
  transition: color 0.3s ease;
}
.nav-links a:hover {
  color: var(--primary-color);
}
.nav-links a.active {
  color: var(--primary-color);
  font-weight: bold;
}
.nav-auth {
  display: flex;
  align-items: center;
  gap: 1rem;
}
.nav-auth span {
  font-weight: 500;
}

/* --- General Elements & Cards --- */
.card {
  background-color: var(--card-background);
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  margin-bottom: 20px;
}
a {
  text-decoration: none;
  color: var(--primary-color);
  transition: color 0.3s ease;
}
a:hover {
  color: #0056b3;
}

/* --- Lottery Banner Styles --- */
.lottery-banners-container {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.lottery-banner {
  border: 1px solid var(--border-color);
  border-radius: 8px;
  background-color: var(--card-background);
  box-shadow: 0 2px 8px rgba(0,0,0,0.07);
  overflow: hidden;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.lottery-banner:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.banner-header {
  padding: 0.75rem 1.5rem;
  background-color: #f9fafb;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}
.banner-header h3 {
  margin: 0;
  font-size: 1.5rem; /* å¢å¤§å­—ä½“ */
  font-weight: 800; /* åŠ ç²— */
  color: #dc3545; /* çº¢è‰²å­—ä½“ */
  text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}
.banner-header p {
  margin: 0;
  font-size: 1rem;
  color: var(--text-light);
  font-weight: 500;
}

.numbers-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr) 0.5fr 1fr;
  gap: 15px;
  padding: 2rem;
  align-items: center;
  justify-items: center;
}

.number-cell {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  aspect-ratio: 1 / 1;
  border-radius: 50%;
  color: #fff;
  font-weight: 900; /* æç²— */
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
  font-size: 3.6rem; /* å¢å¤§ä¸€å€ - ä»1.8remå¢åŠ åˆ°3.6rem */
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  min-width: 80px;
  min-height: 80px;
  width: 100%;
  max-width: 120px;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}
.number-cell:hover {
  transform: scale(1.08);
  box-shadow: 0 5px 15px rgba(0,0,0,0.4);
}

.number-cell:nth-child(7) {
  grid-column: 8;
}

.color-red {
  background: linear-gradient(145deg, #f85032, #e73827);
  border: 3px solid #c62828;
}
.color-green {
  background: linear-gradient(145deg, #56ab2f, #a8e063);
  border: 3px solid #2e7d32;
}
.color-blue {
  background: linear-gradient(145deg, #2196F3, #4FC3F7);
  border: 3px solid #1565c0;
}
.color-unknown {
  background: linear-gradient(145deg, #868e96, #adb5bd);
  border: 3px solid #6c757d;
}

/* --- Settlement & Email Page Styles --- */
.settlement-card {
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  margin: 2rem 0;
  padding: 1rem;
  background-color: #f8fdff;
  transition: box-shadow 0.3s ease;
}
.settlement-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.settlement-details {
  background-color: #fff8e1;
  border: 1px solid #ffecb3;
  padding: 1rem;
  border-radius: 4px;
  margin-top: 1rem;
}

.settlement-details p {
  margin: 0.5rem 0;
  font-size: 1.15rem;
  color: #c51162;
}

.settlement-details p strong {
  color: #333;
}

.email-content-background {
  white-space: pre-wrap;
  word-break: break-all;
  background-color: #f9f9f9;
  padding: 1.5rem;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
  margin: 1rem 0;
  line-height: 1.6;
  font-size: 14px;
}

.global-totals-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 1.5rem;
  border-radius: 12px;
  margin-top: 1rem;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.global-totals-card h3 {
  margin-top: 0;
  color: white;
}

.global-totals-card p {
  margin: 0.75rem 0;
  font-size: 1.1rem;
}

.global-totals-card hr {
  border: none;
  border-top: 1px solid rgba(255,255,255,0.3);
  margin: 1rem 0;
}

/* --- ç»“ç®—ç›¸å…³æ ·å¼ --- */
.settlement-highlight {
  background-color: #fff3cd;
  border-left: 4px solid #ffc107;
  padding: 0.5rem 1rem;
  margin: 0.5rem 0;
}

.profit-text {
  color: #dc3545;
  font-weight: bold;
}

.loss-text {
  color: #007bff;
  font-weight: bold;
}

/* --- è§†å›¾åˆ‡æ¢æŒ‰é’® --- */
.view-toggle {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.view-toggle button {
  padding: 0.5rem 1rem;
  border: 2px solid #007bff;
  background: white;
  color: #007bff;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
}

.view-toggle button.active {
  background: #007bff;
  color: white;
}

.view-toggle button:hover {
  background: #0056b3;
  color: white;
}

/* --- è¡¨å•å’ŒæŒ‰é’®æ ·å¼ --- */
button {
  padding: 0.5rem 1rem;
  background-color: var(--primary-color);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background-color 0.3s ease;
}
button:hover {
  background-color: #0056b3;
}
button:disabled {
  background-color: #6c757d;
  cursor: not-allowed;
}

input, textarea {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #ced4da;
  border-radius: 4px;
  font-size: 0.9rem;
  box-sizing: border-box;
}
input:focus, textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

/* --- è¡¨æ ¼æ ·å¼ --- */
table {
  width: 100%;
  border-collapse: collapse;
  margin: 1rem 0;
}
th, td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid #dee2e6;
}
th {
  background-color: #f8f9fa;
  font-weight: 600;
}
tr:hover {
  background-color: #f8f9fa;
}

/* --- åŠ è½½å’Œé”™è¯¯çŠ¶æ€ --- */
.loading {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 2rem;
}
.error {
  color: var(--danger-color);
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  border-radius: 4px;
  padding: 1rem;
  margin: 1rem 0;
}

/* --- å“åº”å¼è®¾è®¡ --- */
@media (max-width: 1024px) {
  .number-cell {
    font-size: 3rem; /* åœ¨ä¸­ç­‰å±å¹•ä¸Šç¨å¾®å‡å° */
    min-width: 70px;
    min-height: 70px;
  }
}

@media (max-width: 768px) {
  main.container {
    margin: 1rem auto;
    padding: 0 0.5rem;
  }

  .navbar {
    padding: 1rem;
    justify-content: center;
    flex-direction: column;
    gap: 0.5rem;
  }

  .nav-links {
    gap: 1rem;
  }

  .banner-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.25rem;
    padding: 0.5rem 1rem;
  }

  .banner-header h3 {
    font-size: 1.3rem;
  }

  .numbers-grid {
    padding: 1.5rem;
    gap: 10px;
    grid-template-columns: repeat(4, 1fr) 0.3fr 1fr;
  }

  .number-cell {
    font-size: 2.5rem; /* åœ¨å¹³æ¿ä¸Šä¿æŒè¾ƒå¤§å­—ä½“ */
    min-width: 60px;
    min-height: 60px;
  }

  .card {
    padding: 1rem;
  }

  .email-content-background {
    padding: 1rem;
    font-size: 13px;
  }
}

@media (max-width: 480px) {
  .numbers-grid {
    grid-template-columns: repeat(3, 1fr) 0.3fr 1fr;
    gap: 8px;
    padding: 1rem;
  }

  .number-cell {
    font-size: 2rem; /* åœ¨æ‰‹æœºä¸Šä¿æŒå¯è§æ€§ */
    min-width: 50px;
    min-height: 50px;
  }

  .banner-header h3 {
    font-size: 1.1rem;
  }

  .banner-header p {
    font-size: 0.9rem;
  }
}

/* --- åŠ¨ç”»æ•ˆæœ --- */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.fade-in {
  animation: fadeIn 0.5s ease-in;
}

@keyframes slideIn {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.slide-in {
  animation: slideIn 0.5s ease-out;
}

/* --- ç‰¹æ®Šå½©ç¥¨ç±»å‹æ ‡é¢˜æ ·å¼ --- */
.lottery-banner[data-type="é¦™æ¸¯å…­åˆå½©"] .banner-header h3,
.lottery-banner[data-type="æ–°æ¾³é—¨å…­åˆå½©"] .banner-header h3,
.lottery-banner[data-type="è€æ¾³é—¨å…­åˆå½©"] .banner-header h3 {
  color: #dc3545; /* çº¢è‰² */
  font-size: 1.6rem; /* å¢å¤§å­—ä½“ */
  font-weight: 900; /* æ›´åŠ ç²—é‡ */
  text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
}

/* --- è¾…åŠ©ç±» --- */
.text-center { text-align: center; }
.text-left { text-align: left; }
.text-right { text-align: right; }
.mt-1 { margin-top: 0.5rem; }
.mt-2 { margin-top: 1rem; }
.mt-3 { margin-top: 1.5rem; }
.mb-1 { margin-bottom: 0.5rem; }
.mb-2 { margin-bottom: 1rem; }
.mb-3 { margin-bottom: 1.5rem; }
.p-1 { padding: 0.5rem; }
.p-2 { padding: 1rem; }
.p-3 { padding: 1.5rem; }

/* --- é“¾æ¥æŒ‰é’®æ ·å¼ --- */
.link-button {
  background: none;
  border: none;
  color: var(--primary-color);
  text-decoration: underline;
  cursor: pointer;
  padding: 0;
  font-size: inherit;
}
.link-button:hover {
  color: #0056b3;
  background: none;
}

/* --- æ¶ˆæ¯æç¤ºæ ·å¼ --- */
.message {
  padding: 0.75rem;
  border-radius: 4px;
  margin: 1rem 0;
}
.message.success {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}
.message.error {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}
.message.warning {
  background-color: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
}
.message.info {
  background-color: #d1ecf1;
  color: #0c5460;
  border: 1px solid #bee5eb;
}

/* --- æ•°å­—çƒç‰¹æ®Šæ•ˆæœ --- */
.number-cell::after {
  content: '';
  position: absolute;
  top: 10%;
  left: 10%;
  width: 80%;
  height: 80%;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 70%);
  pointer-events: none;
}

.number-cell {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}
/* æ—‹è½¬åŠ¨ç”» */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* è°ƒè¯•ä¿¡æ¯æ ·å¼ */
details {
  border: 1px solid #dee2e6;
  border-radius: 4px;
  padding: 0.5rem;
}

details summary {
  cursor: pointer;
  font-weight: bold;
}

details[open] summary {
  margin-bottom: 0.5rem;
}

/* ç¡®ä¿HTMLå†…å®¹æ­£ç¡®æ˜¾ç¤º */
.email-content-background span {
  display: inline;
}

/* è§†å›¾æ¨¡å¼æç¤º */
.view-mode-hint {
  padding: 0.5rem;
  background-color: #e7f3ff;
  border-left: 4px solid #007bff;
  margin-bottom: 1rem;
  border-radius: 4px;
}

--- FILE: frontend/src/pages/EmailDetailPage.jsx ---
import React, { useState, useEffect, useMemo } from 'react';
import { useParams } from 'react-router-dom';
import { apiService } from '../api';
import SettlementCard from '../components/SettlementCard';

function EmailDetailPage() {
  const { emailId } = useParams();
  const [loading, setLoading] = useState(true);
  const [reanalyzing, setReanalyzing] = useState(false);
  const [error, setError] = useState(null);
  const [pageData, setPageData] = useState({
    email_content: '',
    enhanced_content: '',
    bet_batches: [],
    latest_lottery_results: {}
  });
  const [viewMode, setViewMode] = useState('enhanced');

  // æ•°æ®è·å–
  useEffect(() => {
    fetchEmailDetails();
  }, [emailId]);

  const fetchEmailDetails = () => {
    setLoading(true);
    setError(null);

    apiService.getEmailDetails(emailId)
      .then(res => {
        if (res.status === 'success') {
          console.log('è·å–åˆ°çš„æ•°æ®:', res.data);
          setPageData(res.data);
        } else {
          setError({ message: res.message || 'è·å–æ•°æ®å¤±è´¥' });
        }
      })
      .catch(err => {
        console.error('è·å–é‚®ä»¶è¯¦æƒ…é”™è¯¯:', err);
        setError({ message: err.message || 'ç½‘ç»œè¯·æ±‚å¤±è´¥' });
      })
      .finally(() => setLoading(false));
  };

  // é‡æ–°è§£æé‚®ä»¶
  const handleReanalyze = async () => {
    setReanalyzing(true);
    try {
      const response = await fetch('/api/reanalyze_email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email_id: parseInt(emailId) }),
        credentials: 'include'
      });

      const result = await response.json();

      if (result.status === 'success') {
        alert('é‡æ–°è§£ææˆåŠŸï¼');
        // é‡æ–°åŠ è½½æ•°æ®
        fetchEmailDetails();
      } else {
        alert('é‡æ–°è§£æå¤±è´¥: ' + result.message);
      }
    } catch (error) {
      alert('é‡æ–°è§£æè¯·æ±‚å¤±è´¥: ' + error.message);
    } finally {
      setReanalyzing(false);
    }
  };

  // å¤„ç†æ‰¹æ¬¡æ›´æ–°
  const handleBatchUpdate = (batchId, updatedData) => {
    setPageData(prevData => ({
      ...prevData,
      bet_batches: prevData.bet_batches.map(b =>
        b.batch_id === batchId ? { ...b, data: updatedData } : b
      )
    }));
  };

  // å…¨å±€æ€»è®¡è®¡ç®—
  const globalTotals = useMemo(() => {
    let totalBet = 0;
    let totalWin45 = 0, totalWin46 = 0, totalWin47 = 0;

    if (pageData && Array.isArray(pageData.bet_batches)) {
      pageData.bet_batches.forEach(batch => {
        if (batch.settlement) {
          totalBet += batch.settlement.total_bet_amount || 0;
          totalWin45 += batch.settlement.net_profits?.[45]?.total_win || 0;
          totalWin46 += batch.settlement.net_profits?.[46]?.total_win || 0;
          totalWin47 += batch.settlement.net_profits?.[47]?.total_win || 0;
        }
      });
    }

    return {
      totalBet,
      netProfit45: totalWin45 - totalBet,
      netProfit46: totalWin46 - totalBet,
      netProfit47: totalWin47 - totalBet,
    };
  }, [pageData]);

  // æ¸²æŸ“å†…å®¹
  const renderContent = () => {
    const content = viewMode === 'enhanced' ?
      pageData.enhanced_content :
      pageData.email_content;

    return (
      <pre
        className="email-content-background"
        style={{
          whiteSpace: 'pre-wrap',
          wordBreak: 'break-word',
          lineHeight: '1.5',
          fontSize: '14px',
          fontFamily: 'inherit'
        }}
      >
        {content}
      </pre>
    );
  };

  // æ¸²æŸ“ç»“ç®—å¡ç‰‡
  const renderSettlementCards = () => {
    if (!Array.isArray(pageData.bet_batches) || pageData.bet_batches.length === 0) {
      return (
        <div className="settlement-card" style={{
          border: '2px solid #ffc107',
          borderRadius: '8px',
          margin: '1rem 0',
          padding: '1rem',
          backgroundColor: '#fff3cd',
          textAlign: 'center'
        }}>
          <p style={{ color: '#856404', margin: '0 0 1rem 0' }}>
            ğŸ“ æœªæ£€æµ‹åˆ°AIè§£æçš„ä¸‹æ³¨ä¿¡æ¯
          </p>
          <button
            onClick={handleReanalyze}
            disabled={reanalyzing}
            style={{
              padding: '0.5rem 1rem',
              backgroundColor: reanalyzing ? '#6c757d' : '#007bff',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: reanalyzing ? 'not-allowed' : 'pointer'
            }}
          >
            {reanalyzing ? 'è§£æä¸­...' : 'é‡æ–°è§£æé‚®ä»¶'}
          </button>
        </div>
      );
    }

    return pageData.bet_batches.map(batch => {
      const lotteryResult = pageData.latest_lottery_results[batch.data?.lottery_type];

      return (
        <SettlementCard
          key={batch.batch_id}
          batch={batch}
          lotteryResult={lotteryResult}
          onUpdate={handleBatchUpdate}
        />
      );
    });
  };

  if (loading) {
    return (
      <div className="card">
        <div style={{ textAlign: 'center', padding: '2rem' }}>
          <p>æ­£åœ¨åŠ è½½æ™ºèƒ½æ ¸ç®—é¢æ¿...</p>
          <div style={{
            width: '40px',
            height: '40px',
            border: '4px solid #f3f3f3',
            borderTop: '4px solid #007bff',
            borderRadius: '50%',
            animation: 'spin 1s linear infinite',
            margin: '0 auto'
          }}></div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="card" style={{ color: 'red', textAlign: 'center' }}>
        <h3>åŠ è½½å¤±è´¥</h3>
        <p>é”™è¯¯: {error.message}</p>
        <button
          onClick={fetchEmailDetails}
          style={{
            padding: '0.5rem 1rem',
            backgroundColor: '#007bff',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: 'pointer',
            marginRight: '0.5rem'
          }}
        >
          é‡æ–°åŠ è½½
        </button>
        <button
          onClick={handleReanalyze}
          disabled={reanalyzing}
          style={{
            padding: '0.5rem 1rem',
            backgroundColor: reanalyzing ? '#6c757d' : '#28a745',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: reanalyzing ? 'not-allowed' : 'pointer'
          }}
        >
          {reanalyzing ? 'è§£æä¸­...' : 'å¼ºåˆ¶é‡æ–°è§£æ'}
        </button>
      </div>
    );
  }

  return (
    <div className="card">
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
        <h2>æ™ºèƒ½æ ¸ç®—é¢æ¿ (é‚®ä»¶ID: {emailId})</h2>
        <div>
          <button
            onClick={() => setViewMode('original')}
            style={{
              marginRight: '0.5rem',
              padding: '0.5rem 1rem',
              backgroundColor: viewMode === 'original' ? '#007bff' : '#f8f9fa',
              color: viewMode === 'original' ? 'white' : '#333',
              border: '1px solid #ddd',
              borderRadius: '4px',
              cursor: 'pointer'
            }}
          >
            åŸå§‹å†…å®¹
          </button>
          <button
            onClick={() => setViewMode('enhanced')}
            style={{
              padding: '0.5rem 1rem',
              backgroundColor: viewMode === 'enhanced' ? '#007bff' : '#f8f9fa',
              color: viewMode === 'enhanced' ? 'white' : '#333',
              border: '1px solid #ddd',
              borderRadius: '4px',
              cursor: 'pointer'
            }}
          >
            ç»“ç®—è§†å›¾
          </button>
        </div>
      </div>

      {/* æ“ä½œæŒ‰é’® */}
      <div style={{
        display: 'flex',
        gap: '0.5rem',
        marginBottom: '1rem',
        padding: '0.5rem',
        backgroundColor: '#f8f9fa',
        borderRadius: '4px'
      }}>
        <button
          onClick={handleReanalyze}
          disabled={reanalyzing}
          style={{
            padding: '0.5rem 1rem',
            backgroundColor: reanalyzing ? '#6c757d' : '#28a745',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: reanalyzing ? 'not-allowed' : 'pointer',
            fontSize: '0.9rem'
          }}
        >
          {reanalyzing ? 'ğŸ”„ è§£æä¸­...' : 'ğŸ”„ é‡æ–°è§£æé‚®ä»¶'}
        </button>
        <button
          onClick={fetchEmailDetails}
          style={{
            padding: '0.5rem 1rem',
            backgroundColor: '#17a2b8',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: 'pointer',
            fontSize: '0.9rem'
          }}
        >
          ğŸ”„ åˆ·æ–°æ•°æ®
        </button>
      </div>

      {/* è§†å›¾æ¨¡å¼æç¤º */}
      <div style={{
        padding: '0.5rem',
        backgroundColor: viewMode === 'enhanced' ? '#e7f3ff' : '#f8f9fa',
        borderLeft: `4px solid ${viewMode === 'enhanced' ? '#007bff' : '#6c757d'}`,
        marginBottom: '1rem',
        borderRadius: '4px'
      }}>
        <small>
          å½“å‰æ¨¡å¼: <strong>{viewMode === 'enhanced' ? 'ç»“ç®—è§†å›¾' : 'åŸå§‹å†…å®¹'}</strong>
          {viewMode === 'enhanced' && pageData.enhanced_content === pageData.email_content &&
            ' - æœªæ£€æµ‹åˆ°ç»“ç®—ä¿¡æ¯ï¼Œæ˜¾ç¤ºåŸå§‹å†…å®¹'}
        </small>
      </div>

      <hr />

      {/* å†…å®¹æ˜¾ç¤ºåŒºåŸŸ */}
      <div style={{
        border: '1px solid #e0e0e0',
        borderRadius: '8px',
        padding: '1rem',
        backgroundColor: '#fafafa',
        marginBottom: '1rem',
        minHeight: '200px'
      }}>
        {renderContent()}
      </div>

      {/* åœ¨åŸå§‹è§†å›¾ä¸‹æ˜¾ç¤ºç»“ç®—å¡ç‰‡ */}
      {viewMode === 'original' && (
        <>
          <h3>AIè§£æç»“æœ</h3>
          {renderSettlementCards()}
        </>
      )}

      <hr style={{ border: 'none', borderTop: '2px solid #ccc', margin: '2rem 0' }} />

      {/* å…¨å±€åˆè®¡ */}
      <h3>å…¨å±€ç»“ç®—æ±‡æ€»</h3>
      <div className="global-totals-card">
        <p><strong>æ€»ä¸‹æ³¨é‡‘é¢: {globalTotals.totalBet} å…ƒ</strong></p>
        <hr />
        <p>
          <strong>èµ”ç‡ 45:</strong> æ€»ç›ˆäº{' '}
          <span style={{
            fontWeight: 'bold',
            color: globalTotals.netProfit45 >= 0 ? 'red' : 'blue'
          }}>
            {globalTotals.netProfit45 >= 0 ? '+' : ''}{globalTotals.netProfit45} å…ƒ
          </span>
        </p>
        <p>
          <strong>èµ”ç‡ 46:</strong> æ€»ç›ˆäº{' '}
          <span style={{
            fontWeight: 'bold',
            color: globalTotals.netProfit46 >= 0 ? 'red' : 'blue'
          }}>
            {globalTotals.netProfit46 >= 0 ? '+' : ''}{globalTotals.netProfit46} å…ƒ
          </span>
        </p>
        <p>
          <strong>èµ”ç‡ 47:</strong> æ€»ç›ˆäº{' '}
          <span style={{
            fontWeight: 'bold',
            color: globalTotals.netProfit47 >= 0 ? 'red' : 'blue'
          }}>
            {globalTotals.netProfit47 >= 0 ? '+' : ''}{globalTotals.netProfit47} å…ƒ
          </span>
        </p>
      </div>
    </div>
  );
}

// æ·»åŠ æ—‹è½¬åŠ¨ç”»
const styles = `
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
`;

// æ³¨å…¥æ ·å¼
const styleSheet = document.createElement('style');
styleSheet.innerText = styles;
document.head.appendChild(styleSheet);

export default EmailDetailPage;
--- FILE: frontend/src/pages/HomePage.jsx ---
// src/pages/HomePage.jsx
import React from 'react';
import LotteryResults from '../components/LotteryResults';

function HomePage() {
  return (
    <div>
      <h1>å¼€å¥–ä¸­å¿ƒ</h1>
      <LotteryResults />
    </div>
  );
}
export default HomePage;
--- FILE: frontend/src/pages/SettlementsPage.jsx ---
// src/pages/SettlementsPage.jsx
import React, { useState, useEffect } from 'react';
import { apiService } from '../api';

function SettlementsPage() {
    const [settlements, setSettlements] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        apiService.getSettlements()
            .then(data => setSettlements(data.data))
            .finally(() => setLoading(false));
    }, []);

    if (loading) return <p>æ­£åœ¨åŠ è½½ç»“ç®—å•...</p>;

    return (
        <div className="card">
            <h2>ç»“ç®—è¡¨å•</h2>
            <table>
                <thead>
                    <tr><th>ID</th><th>æŠ•æ³¨ID</th><th>æ€»èµ¢/äº</th><th>åˆ›å»ºæ—¶é—´</th></tr>
                </thead>
                <tbody>
                    {settlements.map(item => (
                        <tr key={item.id}>
                            <td>{item.id}</td>
                            <td>{item.bet_id}</td>
                            <td style={{ color: item.total_win > 0 ? 'green' : 'red' }}>{item.total_win}</td>
                            <td>{new Date(item.created_at).toLocaleString()}</td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    );
}

export default SettlementsPage;
--- FILE: frontend/src/pages/AuthPage.jsx ---
// src/pages/AuthPage.jsx
import React, { useState } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

function AuthPage() {
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [message, setMessage] = useState('');
  const [isSuccess, setIsSuccess] = useState(false);
  const [loading, setLoading] = useState(false);

  const { login, register } = useAuth();
  const navigate = useNavigate();
  const location = useLocation();
  const from = location.state?.from?.pathname || '/emails';

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setMessage('');
    setIsSuccess(false);
    try {
      if (isLogin) {
        await login(email, password);
        navigate(from, { replace: true });
      } else {
        const response = await register(email, password);
        setMessage(response.message + " ç°åœ¨å¯ä»¥ç™»å½•äº†ã€‚");
        setIsSuccess(true);
        setIsLogin(true);
      }
    } catch (error) {
      setMessage(error.message);
      setIsSuccess(false);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="card" style={{ maxWidth: '400px', margin: 'auto', marginTop: '4rem' }}>
      <h2>{isLogin ? 'ç™»å½•' : 'æ³¨å†Œ'}</h2>
      <form onSubmit={handleSubmit}>
        <div>
          <label htmlFor="email">é‚®ç®±åœ°å€</label>
          <input id="email" type="email" value={email} onChange={e => setEmail(e.target.value)} required autoComplete="email" disabled={loading} />
        </div>
        <div>
          <label htmlFor="password">å¯†ç </label>
          <input id="password" type="password" value={password} onChange={e => setPassword(e.target.value)} required autoComplete={isLogin ? "current-password" : "new-password"} disabled={loading} />
        </div>
        <button type="submit" disabled={loading}>{loading ? 'å¤„ç†ä¸­...' : (isLogin ? 'ç™»å½•' : 'æ³¨å†Œ')}</button>
      </form>
      <p>
        {isLogin ? 'è¿˜æ²¡æœ‰è´¦æˆ·?' : 'å·²æœ‰è´¦æˆ·?'}
        <button onClick={() => { setIsLogin(!isLogin); setMessage(''); }} className="link-button" disabled={loading}>
          åˆ‡æ¢åˆ°{isLogin ? 'æ³¨å†Œ' : 'ç™»å½•'}
        </button>
      </p>
      {message && <p className={`message ${isSuccess ? 'success' : ''}`}>{message}</p>}
    </div>
  );
}

export default AuthPage;
--- FILE: frontend/src/pages/EmailsListPage.jsx ---
// File: frontend/pages/EmailsListPage.jsx (Was EmailsPage.jsx)

import React, { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';
import { apiService } from '../api';

const StatusBadge = ({ status }) => {
    const statusStyles = {
        pending: { backgroundColor: '#ffc107', color: '#333' },
        processed: { backgroundColor: '#28a745', color: 'white' },
        failed: { backgroundColor: '#dc3545', color: 'white' },
    };
    const style = { padding: '0.25rem 0.5rem', borderRadius: '12px', fontSize: '0.8rem', fontWeight: 'bold', ...statusStyles[status] };
    return <span style={style}>{status.toUpperCase()}</span>;
};

function EmailsListPage() {
  const [emails, setEmails] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    apiService.getEmails()
      .then(response => {
        if (response.status === 'success') setEmails(response.data);
        else setError(response.message);
      })
      .catch(err => setError(err.message))
      .finally(() => setLoading(false));
  }, []);

  const renderContent = () => {
    if (loading) return <p>æ­£åœ¨åŠ è½½é‚®ä»¶åˆ—è¡¨...</p>;
    if (error) return <p style={{ color: 'red' }}>é”™è¯¯: {error}</p>;
    if (emails.length === 0) return <p>æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é‚®ä»¶ã€‚</p>;

    return (
      <table>
        <thead>
          <tr>
            <th>é‚®ä»¶ ID</th>
            <th>å¤„ç†çŠ¶æ€</th>
            <th>æ¥æ”¶æ—¶é—´</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {emails.map(email => (
            <tr key={email.id}>
              <td>#{email.id}</td>
              <td><StatusBadge status={email.status} /></td>
              <td>{new Date(email.received_at).toLocaleString()}</td>
              <td>
                <Link to={`/emails/${email.id}`} className="button-link">
                  æŸ¥çœ‹åŸæ–‡ä¸ç»“ç®—
                </Link>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    );
  };

  return (
    <div className="card">
      <h2>é‚®ä»¶åˆ—è¡¨</h2>
      {renderContent()}
    </div>
  );
}

export default EmailsListPage;

--- FILE: frontend/src/main.jsx ---
// src/main.jsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import { BrowserRouter } from 'react-router-dom';
import App from './App.jsx';
import './index.css';

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);
--- FILE: frontend/src/App.jsx ---
// File: frontend/src/App.jsx (Simplified Routes)

import React from 'react';
import { Routes, Route } from 'react-router-dom';
import { AuthProvider } from './context/AuthContext';

import Navbar from './components/Navbar';
import RequireAuth from './components/RequireAuth';

import HomePage from './pages/HomePage';
import AuthPage from './pages/AuthPage';
import EmailsListPage from './pages/EmailsListPage'; // Renamed for clarity
import EmailDetailPage from './pages/EmailDetailPage'; // This is now the core workbench

function App() {
  return (
    <AuthProvider>
      <Navbar />
      <main className="container">
        <Routes>
          <Route path="/" element={<HomePage />} />
          <Route path="/auth" element={<AuthPage />} />

          <Route
            path="/emails"
            element={<RequireAuth><EmailsListPage /></RequireAuth>}
          />
          <Route
            path="/emails/:emailId"
            element={<RequireAuth><EmailDetailPage /></RequireAuth>}
          />

          <Route path="*" element={
            <div className="card"><h1>404 - é¡µé¢æœªæ‰¾åˆ°</h1></div>
          } />
        </Routes>
      </main>
    </AuthProvider>
  );
}

export default App;

--- FILE: frontend/src/context/AuthContext.jsx ---
// src/context/AuthContext.jsx
import React, { createContext, useState, useContext, useEffect } from 'react';
import { apiService } from '../api';

const AuthContext = createContext(null);

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // åº”ç”¨åŠ è½½æ—¶ï¼Œæ£€æŸ¥åç«¯ session
    apiService.checkSession()
      .then(data => {
        if (data.status === 'success' && data.isAuthenticated) {
          setUser(data.user);
        }
      })
      .catch(() => setUser(null)) // å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œåˆ™è§†ä¸ºæœªç™»å½•
      .finally(() => setLoading(false));
  }, []);

  const login = async (email, password) => {
    const data = await apiService.login(email, password);
    if (data.status === 'success') {
      setUser(data.user);
    }
    return data; // è¿”å›æ•´ä¸ªå“åº”ç»™ç»„ä»¶å¤„ç†
  };

  const register = (email, password) => {
    return apiService.register(email, password);
  };

  const logout = async () => {
    await apiService.logout();
    setUser(null);
  };

  const value = { user, loading, login, register, logout };

  return (
    <AuthContext.Provider value={value}>
      {!loading && children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => {
  return useContext(AuthContext);
};
--- FILE: frontend/src/components/SettlementCard.jsx ---
import React, { useState, useMemo } from 'react';
import { apiService } from '../api';

/**
 * SettlementCard ç»„ä»¶ - å¢å¼ºç‰ˆ
 * æ˜¾ç¤ºè¯¦ç»†çš„ç»“ç®—ä¿¡æ¯å¹¶æä¾›ç¼–è¾‘åŠŸèƒ½
 */
const SettlementCard = ({ batch, lotteryResult, onUpdate }) => {
  const { batch_id, data, settlement, ai_model } = batch;
  const [isEditing, setIsEditing] = useState(false);
  const [editableData, setEditableData] = useState(JSON.stringify(data.bets, null, 2));
  const [isSaving, setIsSaving] = useState(false);

  // ç»“ç®—è®¡ç®—
  const { totalBetAmount, winningBets, summaryText } = useMemo(() => {
    if (settlement) {
      return {
        totalBetAmount: settlement.total_bet_amount,
        winningBets: settlement.winning_details,
        summaryText: settlement.summary
      };
    }

    // å¦‚æœæ²¡æœ‰ç»“ç®—æ•°æ®ï¼Œä½¿ç”¨å‰ç«¯è®¡ç®—
    let total = 0;
    const winners = [];
    const specialNumber = lotteryResult?.winning_numbers[6];
    const betSummary = {};

    if (Array.isArray(data.bets)) {
      data.bets.forEach(bet => {
        const amount = Number(bet.amount) || 0;
        if ((bet.bet_type === 'å·ç ' || bet.bet_type === 'ç‰¹ç ') && Array.isArray(bet.targets)) {
          bet.targets.forEach(targetNumber => {
            total += amount;
            betSummary[amount] = (betSummary[amount] || 0) + 1;

            if (lotteryResult && specialNumber && String(targetNumber).trim() === String(specialNumber).trim()) {
              winners.push({ number: targetNumber, amount: amount });
            }
          });
        }
      });
    }

    const summaryParts = Object.entries(betSummary).map(([amount, count]) => `${amount}å…ƒx${count}ä¸ª`);
    const summary = `æ€»ä¸‹æ³¨ ${total} å…ƒ (${summaryParts.join(', ')})`;

    return { totalBetAmount: total, winningBets: winners, summaryText: summary };
  }, [data.bets, lotteryResult, settlement]);

  // ä¿å­˜ä¿®æ”¹
  const handleSave = async () => {
    setIsSaving(true);
    try {
      const updatedBets = JSON.parse(editableData);
      if (!Array.isArray(updatedBets)) {
        throw new Error("JSON æ ¼å¼å¿…é¡»æ˜¯ä¸€ä¸ªæ•°ç»„ [...]");
      }

      const updatedBatchData = { ...data, bets: updatedBets };
      await apiService.updateBetBatch(batch_id, updatedBatchData);
      onUpdate(batch_id, updatedBatchData);
      setIsEditing(false);
    } catch (e) {
      alert("JSON æ ¼å¼é”™è¯¯æˆ–ä¿å­˜å¤±è´¥: " + e.message);
    } finally {
      setIsSaving(false);
    }
  };

  // æ¸²æŸ“ä¸­å¥–è¯¦æƒ…
  const renderWinningDetails = (odds) => {
    if (!lotteryResult) {
      return <span style={{ color: '#666' }}>ç­‰å¾…å¼€å¥–å·ç ...</span>;
    }
    if (winningBets.length === 0) {
      return (
        <span style={{ fontWeight: 'bold', color: 'green' }}>
          æœªä¸­å¥– | å‡€äº {totalBetAmount} å…ƒ
        </span>
      );
    }

    const totalWinAmount = winningBets.reduce((sum, bet) => sum + (bet.amount * odds), 0);
    const netProfit = totalWinAmount - totalBetAmount;

    return (
      <>
        <span style={{ color: 'blue', fontWeight: 'bold' }}>
          ä¸­ {winningBets.length} æ³¨, èµ¢ {totalWinAmount}å…ƒ
        </span>{' '}
        |{' '}
        <span style={{ fontWeight: 'bold', color: netProfit >= 0 ? 'red' : 'green' }}>
          å‡€{netProfit >= 0 ? 'èµ¢' : 'äº'} {Math.abs(netProfit)} å…ƒ
        </span>
      </>
    );
  };

  return (
    <div className="settlement-card" style={{
      border: '2px solid #e3f2fd',
      borderRadius: '8px',
      margin: '1rem 0',
      padding: '1rem',
      backgroundColor: '#f8fdff'
    }}>
      {/* æ‰¹æ¬¡å¤´éƒ¨ä¿¡æ¯ */}
      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: '1rem',
        paddingBottom: '0.5rem',
        borderBottom: '1px solid #e0e0e0'
      }}>
        <div>
          <strong>æ‰¹æ¬¡ ID: {batch_id}</strong>
          <span style={{ marginLeft: '1rem', color: '#666', fontSize: '0.9rem' }}>
            AIæ¨¡å‹: {ai_model}
          </span>
        </div>
        <button
          onClick={() => setIsEditing(!isEditing)}
          style={{
            padding: '0.25rem 0.5rem',
            backgroundColor: isEditing ? '#dc3545' : '#007bff',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: 'pointer',
            fontSize: '0.8rem'
          }}
        >
          {isEditing ? 'å–æ¶ˆä¿®æ”¹' : 'ä¿®æ”¹è¯†åˆ«'}
        </button>
      </div>

      {/* åŸå§‹æ–‡æœ¬ */}
      <div style={{
        whiteSpace: 'pre-wrap',
        backgroundColor: '#f5f5f5',
        padding: '0.5rem',
        borderRadius: '4px',
        marginBottom: '1rem',
        fontFamily: 'monospace',
        fontSize: '0.9rem'
      }}>
        {data.raw_text}
      </div>

      {/* ç»“ç®—è¯¦æƒ… */}
      <div className="settlement-details">
        {/* AI è¯†åˆ«æ¦‚è¦ */}
        <div style={{
          backgroundColor: '#fff3cd',
          border: '1px solid #ffeaa7',
          padding: '0.75rem',
          borderRadius: '4px',
          marginBottom: '1rem'
        }}>
          <p style={{
            color: '#856404',
            fontSize: '1.1rem',
            margin: '0.5rem 0',
            fontWeight: 'bold'
          }}>
            ğŸ¯ AIè¯†åˆ«æ¦‚è¦: {summaryText}
          </p>
        </div>

        {/* ç»“ç®—ç»“æœ */}
        <div className="results-grid">
          <div style={{ marginBottom: '0.5rem' }}>
            <strong>ä¸­å¥–è¯¦æƒ…:</strong>{' '}
            {winningBets.length > 0 ? (
              <span style={{ color: 'blue' }}>
                {winningBets.map(b => `${b.number}(${b.amount}å…ƒ)`).join(', ')}
              </span>
            ) : (
              <span style={{ color: 'green' }}>æ— </span>
            )}
          </div>

          <div style={{ marginBottom: '0.5rem' }}>
            <strong>èµ”ç‡ 45:</strong> {renderWinningDetails(45)}
          </div>
          <div style={{ marginBottom: '0.5rem' }}>
            <strong>èµ”ç‡ 46:</strong> {renderWinningDetails(46)}
          </div>
          <div style={{ marginBottom: '0.5rem' }}>
            <strong>èµ”ç‡ 47:</strong> {renderWinningDetails(47)}
          </div>
        </div>
      </div>

      {/* ç¼–è¾‘æ¨¡å¼ */}
      {isEditing && (
        <div style={{
          marginTop: '1rem',
          padding: '1rem',
          backgroundColor: '#f8f9fa',
          border: '1px solid #dee2e6',
          borderRadius: '4px'
        }}>
          <p style={{ fontSize: '0.9rem', color: '#666', margin: '0 0 0.5rem 0' }}>
            è¯·ç›´æ¥ç¼–è¾‘ä»¥ä¸‹ä»£è¡¨ä¸‹æ³¨å†…å®¹çš„ JSON æ•°æ®ï¼š
          </p>
          <textarea
            value={editableData}
            onChange={(e) => setEditableData(e.target.value)}
            style={{
              width: '98%',
              height: '200px',
              fontFamily: 'monospace',
              fontSize: '0.9rem',
              border: '1px solid #ccc',
              padding: '8px',
              borderRadius: '4px'
            }}
          />
          <div style={{ marginTop: '0.5rem' }}>
            <button
              onClick={handleSave}
              disabled={isSaving}
              style={{
                padding: '0.5rem 1rem',
                backgroundColor: '#28a745',
                color: 'white',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer',
                marginRight: '0.5rem'
              }}
            >
              {isSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜ä¿®æ”¹'}
            </button>
            <button
              onClick={() => setIsEditing(false)}
              style={{
                padding: '0.5rem 1rem',
                backgroundColor: '#6c757d',
                color: 'white',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer'
              }}
            >
              å–æ¶ˆ
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default SettlementCard;
--- FILE: frontend/src/components/AuthForm.jsx ---
// frontend/src/components/AuthForm.jsx
import React, { useState } from 'react';
import { apiService } from '../api';

function AuthForm({ onAuthSuccess }) {
  const [isLogin, setIsLogin] = useState(true);
  // ... form state: email, password, message, loading ...

  const handleSubmit = async (e) => {
    e.preventDefault();
    // setLoading(true); setMessage('');
    try {
      if (isLogin) {
        // await apiService.login(email, password);
        alert('ç™»å½•æˆåŠŸ (æ¨¡æ‹Ÿ)'); // Placeholder
        onAuthSuccess();
      } else {
        const data = await apiService.register(email, password);
        // setMessage(data.message); setIsLogin(true);
        alert(data.message); // Simple feedback
      }
    } catch (error) {
      // setMessage(error.message);
      alert(error.message);
    } finally {
      // setLoading(false);
    }
  };

  // ... return JSX form with inputs and buttons ...
  return (/* ... your form JSX here ... */);
}
export default AuthForm;
--- FILE: frontend/src/components/Navbar.jsx ---
// File: frontend/src/components/Navbar.jsx (Simplified)

import React from 'react';
import { NavLink, useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

function Navbar() {
  const { user, logout } = useAuth();
  const navigate = useNavigate();

  const handleLogout = async () => {
    try {
      await logout();
      navigate('/');
    } catch (error) {
      console.error("Logout failed:", error);
    }
  };

  return (
    <nav className="navbar">
      <div className="nav-brand">
        <NavLink to="/">ç»“ç®—ç³»ç»Ÿ</NavLink>
      </div>
      <ul className="nav-links">
        <li><NavLink to="/">å¼€å¥–è®°å½•</NavLink></li>
        {user && <li><NavLink to="/emails">é‚®ä»¶åŸæ–‡</NavLink></li>}
      </ul>
      <div className="nav-auth">
        {user ? (
          <>
            <span>æ¬¢è¿, {user.email}</span>
            <button onClick={handleLogout}>é€€å‡ºç™»å½•</button>
          </>
        ) : (
          <NavLink to="/auth">æ³¨å†Œ/ç™»å½•</NavLink>
        )}
      </div>
    </nav>
  );
}

export default Navbar;

--- FILE: frontend/src/components/RequireAuth.jsx ---
// src/components/RequireAuth.jsx
import React from 'react';
import { useLocation, Navigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

function RequireAuth({ children }) {
  const { user } = useAuth();
  const location = useLocation();

  if (!user) {
    // å¦‚æœæœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µï¼Œå¹¶è®°å½•ä»å“ªä¸ªé¡µé¢æ¥çš„
    return <Navigate to="/auth" state={{ from: location }} replace />;
  }

  return children;
}

export default RequireAuth;
--- FILE: frontend/src/components/LotteryResults.jsx ---
// src/components/LotteryResults.jsx (Banner Version)
import React, { useState, useEffect } from 'react';
import { apiService } from '../api';

// å®šä¹‰å½©ç¥¨ç±»å‹å’Œå®ƒä»¬çš„é¡ºåº
const LOTTERY_TYPES = ['é¦™æ¸¯å…­åˆå½©', 'æ–°æ¾³é—¨å…­åˆå½©', 'è€æ¾³é—¨å…­åˆå½©'];

// æ³¢è‰²æ–‡å­—åˆ° CSS ç±»åçš„æ˜ å°„
const colorClassMap = {
  'çº¢æ³¢': 'color-red',
  'ç»¿æ³¢': 'color-green',
  'è“æ³¢': 'color-blue',
};

// å•ä¸ªå¼€å¥–å·ç æ ¼å­çš„ç»„ä»¶
const NumberCell = ({ number, color }) => {
  const bgColorClass = colorClassMap[color] || 'color-unknown';
  return (
    <div className={`number-cell ${bgColorClass}`}>
      {number}
    </div>
  );
};

// å•ä¸ªæ¨ªå¹…çš„ç»„ä»¶
const LotteryBanner = ({ type, data }) => {
  if (!data) {
    return (
      <div className="lottery-banner">
        <div className="banner-header">
          <h3>{type}</h3>
          <p>ç­‰å¾…å¼€å¥–...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="lottery-banner">
      <div className="banner-header">
        <h3>{type}</h3>
        <p>ç¬¬ {data.issue_number} æœŸ - {data.drawing_date}</p>
      </div>
      <div className="numbers-grid">
        {data.winning_numbers.map((number, index) => (
          <NumberCell key={index} number={number} color={data.colors[index]} />
        ))}
      </div>
    </div>
  );
};


// ä¸»ç»„ä»¶
function LotteryResults() {
  const [results, setResults] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchData = () => {
        apiService.getLotteryResults()
        .then(response => {
          if (response.status === 'success') {
            setResults(response.data);
          } else {
            setError(response.message || 'Failed to load data');
          }
        })
        .catch(err => setError(err.message))
        .finally(() => setLoading(false));
    };

    fetchData();
    // è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡æ•°æ®
    const intervalId = setInterval(fetchData, 30000);

    // ç»„ä»¶å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
    return () => clearInterval(intervalId);
  }, []);

  if (loading) return <p>æ­£åœ¨åŠ è½½å¼€å¥–è®°å½•...</p>;
  if (error) return <p style={{ color: 'red' }}>é”™è¯¯: {error}</p>;
  if (!results) return <p>æ— æ³•åŠ è½½æ•°æ®ç»“æ„ã€‚</p>;

  return (
    <div className="lottery-banners-container">
      {LOTTERY_TYPES.map(type => (
        <LotteryBanner key={type} type={type} data={results[type]} />
      ))}
    </div>
  );
}

export default LotteryResults;
--- FILE: frontend/package.json ---
{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.23.1"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.0.3",
    "vite": "^4.4.5"
  }
}
--- FILE: frontend/index.html ---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:,">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é‚®ä»¶å¤„ç†ç³»ç»Ÿ</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
--- FILE: frontend/public/_worker.js ---
// File: frontend/public/_worker.js

export default {
  /**
   * @param {Request} request
   * @param {object} env
   * @param {object} ctx
   */
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    // Only proxy requests that start with /api/
    if (url.pathname.startsWith('/api/')) {
      // Extract the endpoint from the path, e.g., /api/register -> register
      const endpoint = url.pathname.substring(5);

      // Construct the new backend URL
      // Example: https://wenge.cloudns.ch/index.php?endpoint=register
      const backendUrl = `https://wenge.cloudns.ch/index.php?endpoint=${endpoint}${url.search}`;

      // Create a new request to the backend, copying the original request's properties.
      // This is a robust way to forward the request, including method, headers, and body.
      const backendRequest = new Request(backendUrl, request);

      // Forward the request to the backend and return the response.
      try {
        return await fetch(backendRequest);
      } catch (e) {
        // If the backend is unreachable, return a 503 error.
        return new Response(`Backend server is unreachable: ${e.message}`, { status: 503 });
      }
    }

    // For all other requests, serve the static assets from Cloudflare Pages.
    return env.ASSETS.fetch(request);
  },
};
