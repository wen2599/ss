<?php\n// backend/db_connection.php\n\n// Ensure this file is included only once\nif (!function_exists(\'get_db_connection\')) {\n    \n    /**\n     * Creates and returns a new MySQLi database connection.\n     * This function centralizes the database connection logic.\n     *\n     * @return mysqli|null The mysqli connection object on success, or null on failure.\n     */\n    function get_db_connection() {\n        // Load environment variables using the robust loader\n        require_once __DIR__ . \'/env_loader.php\';\n\n        // Explicitly call load_env() to get the array of variables\n        $env_vars = load_env();\n        \n        // Log loaded environment variables (excluding password for security)\n        error_log(\"DB Connection: Loaded env_vars (excluding password): \" . json_encode(array_diff_key($env_vars, [\'DB_PASSWORD\' => \'\'])));\n\n        // Get credentials from the returned array, ensuring correct key names\n        $db_host = $env_vars[\'DB_HOST\'] ?? null;\n        $db_user = $env_vars[\'DB_USER\'] ?? null;\n        $db_password = $env_vars[\'DB_PASSWORD\'] ?? null;\n        $db_name = $env_vars[\'DB_NAME\'] ?? null;\n        $db_port = $env_vars[\'DB_PORT\'] ?? null; // Assuming DB_PORT might be present in .env\n\n        // Log the individual parsed credentials (excluding password)\n        error_log(\"DB Connection: Parsed credentials: Host=\{$db_host\}, User=\{$db_user\}, Name=\{$db_name\}, Port=\{$db_port}\");\n\n        // Check if all credentials are loaded\n        if (empty($db_host) || empty($db_user) || empty($db_password) || empty($db_name)) {\n            error_log(\"DB Connection Error: Database credentials (DB_HOST, DB_USER, DB_PASSWORD, DB_NAME) are not fully set or are empty in the .env file. Host='{$db_host}', User='{$db_user}', Name='{$db_name}'\");\n            return null; \n        }\n\n        // Create a new database connection\n        // The '@' suppresses the default PHP warning, allowing us to handle the error explicitly.\n        if ($db_port) {\n            @$conn = new mysqli($db_host, $db_user, $db_password, $db_name, $db_port);\n        } else {\n            @$conn = new mysqli($db_host, $db_user, $db_password, $db_name);\n        }\n\n        // Check for connection errors\n        if ($conn->connect_error) {\n            // Log the detailed error for the administrator\n            error_log(\"CRITICAL DB Connection Failed: Host='{$db_host}', User='{$db_user}', Port='{$db_port}'. Error: \" . $conn->connect_error);\n            return null;\n        }\n\n        // Set the character set to utf8mb4 for full Unicode support\n        $conn->set_charset(\"utf8mb4\");\n\n        error_log(\"DB Connection: Successfully connected to database '{$db_name}' on host '{$db_host}'.\");\n        return $conn;\n    }\n}\n