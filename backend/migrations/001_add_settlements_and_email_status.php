<?php\n\ndeclare(strict_types=1);\n\n// backend/migrations/001_add_settlements_and_email_status.php\n\nfunction run_migration(mysqli $db_connection): void\n{\n    echo \"[任务] 正在处理迁移 001_add_settlements_and_email_status...\\n\";\n\n    // --- 任务1: 创建 \`settlements\` 表 ---\n    echo \"[子任务 1/2] 正在检查并创建 \`settlements\` 表...\\n\";\n    \$table_name = \'settlements\';\n    \$check_table_query = \"SHOW TABLES LIKE '{\$table_name}'\";\n    \$result = \$db_connection->query(\$check_table_query);\n\n    if (\$result && \$result->num_rows > 0) {\n        echo \"[跳过] \`{\$table_name}\` 表已经存在。\\n\";\n    } else {\n        echo \"[执行] 正在创建 \`{\$table_name}\` 表...\\n\";\n        \$create_table_sql = \"\"\n        CREATE TABLE `settlements` (\n          `id` int(11) NOT NULL AUTO_INCREMENT,\n          `email_id` int(11) NOT NULL,\n          `user_id` int(11) NOT NULL,\n          `draw_period` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,\n          `customer_name` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,\n          `total_amount` decimal(10,2) NOT NULL DEFAULT 0.00,\n          `total_winnings` decimal(10,2) DEFAULT NULL,\n          `settlement_data` json NOT NULL,\n          `status` varchar(50) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'pending_settlement',\n          `created_at` timestamp NOT NULL DEFAULT current_timestamp(),\n          `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(),\n          PRIMARY KEY (`id`),\n          UNIQUE KEY `unique_email_id` (`email_id`),\n          KEY `user_id` (`user_id`),\n          KEY `draw_period` (`draw_period`)\n        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n        \"\";\n\n        if (\$db_connection->query(\$create_table_sql) === TRUE) {\n            echo \"[成功] \`{\$table_name}\` 表已成功创建。\\n\";\n        } else {\n            throw new Exception(\"创建 \`{\$table_name}\` 表失败: \" . \$db_connection->error);\n        }\n    }\n\n    // --- 任务2: 为 \`emails\` 表添加 `is_processed` 字段 ---\n    echo \"[子任务 2/2] 正在检查并为 \`emails\` 表添加 `is_processed` 字段...\\n\";\n    \$column_name = \'is_processed\';\n    \$check_column_query = \"SHOW COLUMNS FROM `emails` LIKE '{\$column_name}'\";\n    \$result = \$db_connection->query(\$check_column_query);\n\n    if (\$result && \$result->num_rows > 0) {\n        echo \"[跳过] `{\$column_name}` 字段已经存在于 `emails` 表中。\\n\";\n    } else {\n        echo \"[执行] 正在添加 `{\$column_name}` 字段...\\n\";\n        \$alter_table_sql = \"ALTER TABLE `emails` ADD `is_processed` TINYINT(1) NOT NULL DEFAULT 0 AFTER `body`\";\n        if (\$db_connection->query(\$alter_table_sql) === TRUE) {\n            echo \"[成功] `{\$column_name}` 字段已成功添加到 `emails` 表中。\\n\";\n        } else {\n            throw new Exception(\"添加 `{\$column_name}` 字段失败: \" . \$db_connection->error);\n        }\n    }\n    echo \"[完成] 迁移 001_add_settlements_and_email_status 处理完毕。\\n\";\n}\n