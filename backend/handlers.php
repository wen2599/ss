<?php\n\ndeclare(strict_types=1);\n\n// backend/handlers.php\n\nrequire_once __DIR__ . \'/settlement_rules.php\';\n\n/**\n * Handles the /help and /start command.\n */\nfunction handle_help_command($chat_id): void\n{\n    $reply_text = \"æ‚¨å¥½, ç®¡ç†å‘˜ï¼è¯·ä½¿ç”¨ä¸‹é¢çš„èœå•è¿›è¡Œæ“ä½œæˆ–ç›´æ¥è¾“å…¥å‘½ä»¤ï¼š\\n\\n\" .\n                  \"<b>--- æ ¸å¿ƒä¸šåŠ¡ ---</b>\\n\" .\n                  \"/settle [æœŸå·] - æ‰§è¡ŒæŒ‡å®šæœŸå·çš„ç»“ç®—\\n\" .\n                  \"/report [æœŸå·] - è·å–æŒ‡å®šæœŸå·çš„ç»“ç®—æŠ¥å‘Š\\n\" .\n                  \"/latest - æŸ¥è¯¢æœ€æ–°å¼€å¥–è®°å½•\\n\" .\n                  \"/add [ç±»å‹] [æœŸå·] [å·ç ] - æ‰‹åŠ¨æ·»åŠ å¼€å¥–è®°å½•\\n\" .\n                  \"/delete [ç±»å‹] [æœŸå·] - åˆ é™¤å¼€å¥–è®°å½•\\n\\n\" .\n                  \"<b>--- ç”¨æˆ·ç®¡ç† ---</b>\\n\" .\
                  \"/stats - æŸ¥çœ‹ç³»ç»Ÿæ¦‚å†µ\\n\" .\
                  \"/finduser [å…³é”®è¯] - æŸ¥æ‰¾ç”¨æˆ· (ç”¨æˆ·å/é‚®ç®±)\\n\" .\
                  \"/deleteuser [å…³é”®è¯] - åˆ é™¤ç”¨æˆ·åŠæ‰€æœ‰æ•°æ®\\n\\n\" .\
                  \"<b>--- AI åŠ©æ‰‹ ---</b>\\n\" .\
                  \"/setgeminikey [å¯†é’¥] - é…ç½®Gemini API Key\\n\" .\
                  \"/cfchat [é—®é¢˜] - ä¸Cloudflare AIå¯¹è¯\\n\" .\
                  \"/geminichat [é—®é¢˜] - ä¸Gemini AIå¯¹è¯\\n\" .\
                  \"/help - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯\";\n\n    $keyboard = [\n        \'keyboard\' => [\n            [[\'text\' => \'ç»“ç®—\'], [\'text\' => \'ç»“ç®—æŠ¥å‘Š\']],\n            [[\'text\' => \'æœ€æ–°å¼€å¥–\'], [\'text\' => \'ç³»ç»Ÿç»Ÿè®¡\']],\n            [[\'text\' => \'æŸ¥æ‰¾ç”¨æˆ·\'], [\'text\' => \'åˆ é™¤ç”¨æˆ·\']],\n            [[\'text\' => \'CF AI å¯¹è¯\'], [\'text\' => \'Gemini AI å¯¹è¯\']],\n            [[\'text\' => \'æ›´æ¢Gemini Key\'], [\'text\' => \'å¸®åŠ©è¯´æ˜\']]\n        ],\n        \'resize_keyboard\' => true,\n        \'one_time_keyboard\' => false,\n        \'selective\' => true\n    ];\n\n    $reply_markup = json_encode($keyboard);\n    send_telegram_message($chat_id, $reply_text, $reply_markup, \"HTML\");\n}\n\n/**\n * Handles the /stats command.\n */\nfunction handle_stats_command($chat_id): void\n{\n    global $db_connection; // ç¡®ä¿ db_connection å¯ç”¨\n    $stats = get_system_stats();\n    $reply_text = \"ğŸ“Š ç³»ç»Ÿç»Ÿè®¡æ•°æ®:\\n\" .\n                  \"  - æ³¨å†Œç”¨æˆ·æ•°: {$stats[\'users\']}\\n\" .\
                  \"  - å·²ä¿å­˜é‚®ä»¶æ•°: {$stats[\'emails\']}\\n\" .\
                  \"  - å¼€å¥–è®°å½•æ•°: {$stats[\'lottery_draws\']}\";\n    send_telegram_message($chat_id, $reply_text);\n}\n\n/**\n * Handles the /latest command.\n */\nfunction handle_latest_command($chat_id): void\n{\n    global $db_connection;\n    $query = \"SELECT draw_date, lottery_type, draw_period, numbers FROM lottery_draws ORDER BY id DESC LIMIT 1\";\n    $result = $db_connection->query($query);\n\n    if ($row = $result->fetch_assoc()) {\n        $reply_text = \"æœ€æ–°å¼€å¥–è®°å½•:\\n\" .\
                      \"  - ç±»å‹: {$row[\'lottery_type\']}\\n\" .\
                      \"  - æ—¥æœŸ: {$row[\'draw_date\']}\\n\" .\
                      \"  - æœŸå·: {$row[\'draw_period\']}\\n\" .\
                      \"  - å·ç : {$row[\'numbers\']}\";\n    } else {\n        $reply_text = \"æ•°æ®åº“ä¸­æ²¡æœ‰å¼€å¥–è®°å½•ã€‚\";\n    }\n    send_telegram_message($chat_id, $reply_text);\n}\n\n/**\n * Handles the /add command.\n */\nfunction handle_add_command($chat_id, array $command_parts): void\n{\n    if (count($command_parts) < 4) {\n        send_telegram_message($chat_id, \"æ ¼å¼é”™è¯¯ã€‚ç”¨æ³•: /add [ç±»å‹] [æœŸå·] [å·ç ]\");\n        return;\n    }\n\n    $data = [\n        \'lottery_type\' => $command_parts[1],\n        \'draw_period\'  => $command_parts[2],\n        \'numbers\'      => $command_parts[3],\n        \'draw_date\'    => date(\'Y-m-d\')\n    ];\n\n    if (save_lottery_draw($data)) {\n        send_telegram_message($chat_id, \"æˆåŠŸæ·»åŠ å¼€å¥–è®°å½•ã€‚\");\n    } else {\n        send_telegram_message($chat_id, \"æ·»åŠ å¼€å¥–è®°å½•å¤±è´¥ï¼Œå¯èƒ½è¯¥æœŸå·å·²å­˜åœ¨ã€‚è¯·æ£€æŸ¥æ—¥å¿—ã€‚\");\n    }\n}\n\n/**\n * Handles the /delete command.\n */\nfunction handle_delete_command($chat_id, array $command_parts): void\n{\n    if (count($command_parts) < 3) {\n        send_telegram_message($chat_id, \"æ ¼å¼é”™è¯¯ã€‚ç”¨æ³•: /delete [ç±»å‹] [æœŸå·]\");\n        return;\n    }\n\n    global $db_connection;\n    $lottery_type = $command_parts[1];\n    $draw_period = $command_parts[2];\n\n    $stmt = $db_connection->prepare(\"DELETE FROM lottery_draws WHERE lottery_type = ? AND draw_period = ?\");\n    $stmt->bind_param(\"ss\", $lottery_type, $draw_period);\n\n    if ($stmt->execute() && $stmt->affected_rows > 0) {\n        send_telegram_message($chat_id, \"æˆåŠŸåˆ é™¤è®°å½•ã€‚\");\n    } else {\n        send_telegram_message($chat_id, \"æœªæ‰¾åˆ°è¦åˆ é™¤çš„è®°å½•ã€‚\");\n    }\n    $stmt->close();\n}\n\n\n/**\n * Handles the /finduser command.\n */\nfunction handle_find_user_command($chat_id, array $command_parts): void\n{\n    if (count($command_parts) < 2) {\n        send_telegram_message($chat_id, \"æ ¼å¼é”™è¯¯ã€‚ç”¨æ³•: /finduser [ç”¨æˆ·åæˆ–é‚®ç®±]\");\n        return;\n    }\n    \n    global $db_connection;\n    $search_term = $command_parts[1];\n\n    $stmt = $db_connection->prepare(\"SELECT id, username, email, created_at FROM users WHERE username = ? OR email = ?\");\n    $stmt->bind_param(\"ss\", $search_term, $search_term);\n    $stmt->execute();\n    $result = $stmt->get_result();\n\n    if ($user = $result->fetch_assoc()) {\n        $reply_text = \"âœ… æ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯:\\n\" .\
                      \"  - ç”¨æˆ·ID: {$user[\'id\']}\\n\" .\
                      \"  - ç”¨æˆ·å: {$user[\'username\']}\\n\" .\
                      \"  - é‚®ç®±: {$user[\'email\']}\\n\" .\
                      \"  - æ³¨å†Œæ—¶é—´: {$user[\'created_at\']}\";\n    } else {\n        $reply_text = \"âŒ æœªæ‰¾åˆ°ç”¨æˆ·: \" . htmlspecialchars($search_term);\n    }\n    $stmt->close();\n    send_telegram_message($chat_id, $reply_text);\n}\n\n\n/**\n * Handles the /deleteuser command.\n */\nfunction handle_delete_user_command($chat_id, array $command_parts): void\n{\n    if (count($command_parts) < 2) {\n        send_telegram_message($chat_id, \"æ ¼å¼é”™è¯¯ã€‚ç”¨æ³•: /deleteuser [ç”¨æˆ·åæˆ–é‚®ç®±]\");\n        return;\n    }\n\n    global $db_connection;\n    $search_term = $command_parts[1];\n\n    $stmt_find = $db_connection->prepare(\"SELECT id, username, email FROM users WHERE username = ? OR email = ?\");\n    $stmt_find->bind_param(\"ss\", $search_term, $search_term);\n    $stmt_find->execute();\n    $result = $stmt_find->get_result();\n    \n    if (!$user = $result->fetch_assoc()) {\n        send_telegram_message($chat_id, \"âŒ æœªæ‰¾åˆ°ç”¨æˆ·: \" . htmlspecialchars($search_term));\n        $stmt_find->close();\n        return;\n    }\n    $stmt_find->close();\n    \n    $user_id = $user[\'id\'];\n    $username = $user[\'username\'];\n\n    $db_connection->begin_transaction();\n    try {\n        $stmt_delete_emails = $db_connection->prepare(\"DELETE FROM emails WHERE user_id = ?\");\n        $stmt_delete_emails->bind_param(\"i\", $user_id);\n        $stmt_delete_emails->execute();\n        $email_rows_affected = $stmt_delete_emails->affected_rows;\n        $stmt_delete_emails->close();\n\n        $stmt_delete_user = $db_connection->prepare(\"DELETE FROM users WHERE id = ?\");\n        $stmt_delete_user->bind_param(\"i\", $user_id);\n        $stmt_delete_user->execute();\n        \n        $db_connection->commit();\n        send_telegram_message($chat_id, \"âœ… æˆåŠŸåˆ é™¤ç”¨æˆ· {$username} åŠ {$email_rows_affected} å°å…³è”é‚®ä»¶ã€‚\");\n\n    } catch (Exception $e) {\n        $db_connection->rollback();\n        send_telegram_message($chat_id, \"âŒ æ“ä½œå¤±è´¥ï¼åœ¨åˆ é™¤è¿‡ç¨‹ä¸­å‘ç”Ÿä¸¥é‡é”™è¯¯: \" . $e->getMessage());\n    }\n}\n\n/**\n * Handles setting the Gemini API key.\n */\nfunction handle_set_gemini_key_command($chat_id, array $command_parts): void\n{\n    if (count($command_parts) < 2) {\n        send_telegram_message($chat_id, \"æ ¼å¼é”™è¯¯ã€‚ç”¨æ³•: /setgeminikey [APIå¯†é’¥]\");\n        return;\n    }\n    \n    $api_key = $command_parts[1];\n    if (set_gemini_api_key($api_key)) {\n        send_telegram_message($chat_id, \"âœ… Gemini APIå¯†é’¥å·²æˆåŠŸæ›´æ–°ã€‚\");\n    } else {\n        send_telegram_message($chat_id, \"âŒ æ›´æ–°Gemini APIå¯†é’¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“æˆ–æ—¥å¿—ã€‚\");\n    }\n}\n\n/**\n * Handles a chat request with an AI service.\n */\nfunction handle_ai_chat_command($chat_id, string $prompt, string $service): void\n{\n    send_telegram_message($chat_id, \"æ­£åœ¨æ€è€ƒä¸­ï¼Œè¯·ç¨å€™...\");\n\n    $response = chat_with_ai($prompt, $service);\n\n    if ($response !== null) {\n        // Telegramå¯¹Markdownçš„è§£æè¦æ±‚ç‰¹å®šå­—ç¬¦è¢«è½¬ä¹‰\n        $escaped_response = str_replace(\n            [\'_\', \'*\', \'`\', \'[\'], \n            [\'\\_\', \'\\*\', \'\\`\', \'\\[\'], \n            $response\n        );\n        send_telegram_message($chat_id, $escaped_response, null, \'Markdown\');\n    } else {\n        $error_message = \"âŒ AIï¼ˆ{$service}ï¼‰è°ƒç”¨å¤±è´¥ã€‚\\nè¯·æ£€æŸ¥ï¼š\\n1. Cloudflareå‡­æ®æ˜¯å¦åœ¨.envä¸­æ­£ç¡®é…ç½®ã€‚\\n2. Gemini APIå¯†é’¥æ˜¯å¦å·²é€šè¿‡Botæ­£ç¡®è®¾ç½®ã€‚\\n3. APIæœåŠ¡æœ¬èº«æ˜¯å¦å¯ç”¨ã€‚\";\n        send_telegram_message($chat_id, $error_message);\n    }\n}\n\n/**\n * [MODIFIED] Handles the /settle command to process settlements for a specific draw period.\n */\nfunction handle_settle_command($chat_id, array $command_parts): void\n{\n    if (count($command_parts) < 2) {\n        send_telegram_message($chat_id, \"æ ¼å¼é”™è¯¯ã€‚ç”¨æ³•: /settle [æœŸå·]\");\n        return;\n    }\n    $draw_period = $command_parts[1];\n\n    send_telegram_message($chat_id, \"æ”¶åˆ°è¯·æ±‚ï¼æ­£åœ¨å¼€å§‹ä¸ºæœŸå· {$draw_period} è¿›è¡Œç»“ç®—...\");\n\n    $result = process_settlements_for_draw($draw_period);\n\n    if ($result === null) {\n        send_telegram_message($chat_id, \"âŒ ç»“ç®—å¤±è´¥: æœªèƒ½æ‰¾åˆ°æœŸå·ä¸º {$draw_period} çš„å¼€å¥–è®°å½•ã€‚è¯·å…ˆæ·»åŠ è¯¥æœŸçš„å¼€å¥–å·ç ã€‚\");\n        return;\n    }\n\n    if ($result[\'settled_count\'] === 0) {\n        send_telegram_message($chat_id, \"â„¹ï¸ æœŸå· {$draw_period} æ²¡æœ‰æ‰¾åˆ°å¾…ç»“ç®—çš„å•æ®ã€‚\");\n        return;\n    }\n\n    $net_profit = $result[\'total_bets\'] - $result[\'total_winnings\'];\n    $profit_emoji = $net_profit >= 0 ? \'ğŸŸ¢\' : \'ğŸ”´\';\n\n    $reply_text = \"âœ… <b>æœŸå· {$draw_period} ç»“ç®—å®Œæˆï¼</b>\\n\\n\" .\
                  \"- ç»“ç®—å•æ®æ•°: {$result[\'settled_count\']} å¼ \\n\" .\
                  \"- æ€»æŠ•æ³¨é¢: \" . number_format($result[\'total_bets\'], 2) . \"\\n\" .\
                  \"- æ€»æ´¾å¥–é¢: \" . number_format($result[\'total_winnings\'], 2) . \"\\n\" .\
                  \"- {$profit_emoji} æœ¬æœŸåˆ©æ¶¦: \" . number_format($net_profit, 2);\n\n    send_telegram_message($chat_id, $reply_text, null, \'HTML\');\n}\n\n/**\n * [MODIFIED] Handles the /report command to show a summary for a settled draw period.\n */\nfunction handle_report_command($chat_id, array $command_parts): void\n{\n    if (count($command_parts) < 2) {\n        send_telegram_message($chat_id, \"æ ¼å¼é”™è¯¯ã€‚ç”¨æ³•: /report [æœŸå·]\");\n        return;\n    }\n    $draw_period = $command_parts[1];\n\n    $report = generate_settlement_report($draw_period);\n\n    if ($report === null) {\n        send_telegram_message($chat_id, \"âŒ æœªèƒ½ç”ŸæˆæŠ¥å‘Š: æœªæ‰¾åˆ°ä»»ä½•ä¸æœŸå· {$draw_period} ç›¸å…³çš„å·²ç»“ç®—å•æ®ã€‚\");\n        return;\n    }\n\n    $net_profit = $report[\'total_bets\'] - $report[\'total_winnings\'];\n    $profit_emoji = $net_profit >= 0 ? \'ğŸŸ¢\' : \'ğŸ”´\';\n\n    $reply_text = \"ğŸ“Š <b>æœŸå· {$draw_period} ç»“ç®—æŠ¥å‘Š</b>\\n\\n\" .\
                  \"- å·²ç»“ç®—å•æ®: {$report[\'settled_count\']} å¼ \\n\" .\
                  \"- æ€»æŠ•æ³¨é¢: \" . number_format($report[\'total_bets\'], 2) . \"\\n\" .\
                  \"- æ€»æ´¾å¥–é¢: \" . number_format($report[\'total_winnings\'], 2) . \"\\n\" .\
                  \"- {$profit_emoji} æœ¬æœŸåˆ©æ¶¦: \" . number_format($net_profit, 2);\n    \n    send_telegram_message($chat_id, $reply_text, null, \'HTML\');\n}\n\n// --- Helper functions for settlement --- \n\n/**\n * [MODIFIED] Core settlement processing logic for a given draw period.\n */\nfunction process_settlements_for_draw(string $draw_period): ?array\n{\n    global $db_connection;\n    \n    // 1. Get lottery winning numbers\n    $stmt_draw = $db_connection->prepare(\"SELECT numbers FROM lottery_draws WHERE draw_period = ?\");\n    $stmt_draw->bind_param(\"s\", $draw_period);\n    $stmt_draw->execute();\n    $result_draw = $stmt_draw->get_result();\n    if (!($draw = $result_draw->fetch_assoc())) {\n        return null; // Draw not found\n    }\n    $winning_numbers = array_map(\'intval\', explode(\',\', $draw[\'numbers\']));\n    $stmt_draw->close();\n\n    // 2. Get all pending settlements for this draw\n    $stmt_settlements = $db_connection->prepare(\"SELECT id, settlement_data FROM settlements WHERE draw_period = ? AND status = \'pending_settlement\'\");\n    $stmt_settlements->bind_param(\"s\", $draw_period);\n    $stmt_settlements->execute();\n    $pending_settlements = $stmt_settlements->get_result()->fetch_all(MYSQLI_ASSOC);\n    $stmt_settlements->close();\n\n    if (empty($pending_settlements)) {\n        return [\'settled_count\' => 0, \'total_bets\' => 0, \'total_winnings\' => 0];\n    }\n\n    $total_winnings_all = 0;\n    $total_bets_all = 0;\n    \n    $db_connection->begin_transaction();\n    try {\n        foreach ($pending_settlements as $settlement) {\n            $settlement_id = $settlement[\'id\'];\n            $bets = json_decode($settlement[\'settlement_data\'], true);\n            $total_winnings_single = 0;\n\n            foreach ($bets as &$bet) { // Pass by reference to update\n                $winnings = calculate_winnings($bet, $winning_numbers);\n                $bet[\'winnings\'] = $winnings;\n                $bet[\'status\'] = $winnings > 0 ? \'ä¸­å¥–\' : \'æœªä¸­å¥–\'; // æ›´æ–°çŠ¶æ€\n                $total_winnings_single += $winnings;\n                $total_bets_all += floatval($bet[\'amount\']);\n            }\n            unset($bet); // Unset reference\n\n            $total_winnings_all += $total_winnings_single;\n\n            // Update settlement in DB\n            $stmt_update = $db_connection->prepare(\"UPDATE settlements SET total_winnings = ?, settlement_data = ?, status = \'settled\' WHERE id = ?\");\n            $updated_data_json = json_encode($bets);\n            $stmt_update->bind_param(\"dsi\", $total_winnings_single, $updated_data_json, $settlement_id);\n            $stmt_update->execute();\n            $stmt_update->close();\n        }\n        $db_connection->commit();\n    } catch (Exception $e) {\n        $db_connection->rollback();\n        error_log(\"Settlement failed: \" . $e->getMessage());\n        return null;\n    }\n\n    return [\n        \'settled_count\' => count($pending_settlements),\n        \'total_bets\' => $total_bets_all,\n        \'total_winnings\' => $total_winnings_all\n    ];\n}\n\n/**\n * [MODIFIED] Generates a report for an already settled draw periodã€‚\n */\nfunction generate_settlement_report(string $draw_period): ?array\n{\n    global $db_connection;\n    $stmt = $db_connection->prepare(\"SELECT COUNT(id) as settled_count, SUM(total_amount) as total_bets, SUM(total_winnings) as total_winnings FROM settlements WHERE draw_period = ? AND status = \'settled\'\");\n    $stmt->bind_param(\"s\", $draw_period);\n    $stmt->execute();\n    $result = $stmt->get_result()->fetch_assoc();\n    $stmt->close();\n\n    if (empty($result) || $result[\'settled_count\'] == 0) {\n        return null;\n    }\n\n    return [\n        \'settled_count\' => (int)$result[\'settled_count\'],\n        \'total_bets\' => (float)$result[\'total_bets\'],\n        \'total_winnings\' => (float)$result[\'total_winnings\']\n    ];\n}\n