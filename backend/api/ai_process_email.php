<?php\n\ndeclare(strict_types=1);\n\n// backend/api/ai_process_email.php\n\nrequire_once __DIR__ . \'/../bootstrap.php\';\nrequire_once __DIR__ . \'/../ai_helpers.php\';\n\nheader(\"Content-Type: application/json\");\n\nif ($_SERVER[\'REQUEST_METHOD\'] !== \'POST\') {\n    http_response_code(405);\n    echo json_encode([\'status\' => \'error\', \'message\' => \'仅允许POST方法\']);\n    exit;\n}\n\n$user_id = verify_jwt_token();\nif (!$user_id) {\n    http_response_code(401);\n    echo json_encode([\'status\' => \'error\', \'message\' => \'认证失败\']);\n    exit;\n}\n\n$data = json_decode(file_get_contents(\'php://input\'), true);\n$email_id = $data[\'email_id\'] ?? null;\n$correction_feedback = $data[\'correction\'] ?? null; // [NEW] 接收修正指令\n\nif (!$email_id) {\n    http_response_code(400);\n    echo json_encode([\'status\' => \'error\', \'message\' => \'缺少 email_id\']);\n    exit;\n}\n\nglobal $db_connection;\n$stmt = $db_connection->prepare(\"SELECT body FROM emails WHERE id = ? AND user_id = ?\");\n$stmt->bind_param(\"ii\", $email_id, $user_id);\n$stmt->execute();\n$result = $stmt->get_result();\n\nif (!$email = $result->fetch_assoc()) {\n    http_response_code(404);\n    echo json_encode([\'status\' => \'error\', \'message\' => \'未找到该邮件或无权访问\']);\n    exit;\n}\n$stmt->close();\n\n$email_body = $email[\'body\'];\n\n// [MODIFIED] 将修正指令传递给AI\n$organized_data = organize_email_with_ai($email_body, $correction_feedback);\n\nif (!$organized_data) {\n    http_response_code(500);\n    $error_msg = $correction_feedback \n        ? \'AI根据您的指令修正失败，请尝试更清晰的描述。\例如：“第一条是特码，不是平码”。\' \n        : \'AI处理邮件失败，两个AI服务均无法完成任务。\';\n    echo json_encode([\'status\' => \'error\', \'message\' => $error_msg]);\n    exit;\n}\n\n// [MODIFIED] 这里暂时不将AI结果存回数据库，因为前端需要先确认\n// 后续步骤将是前端把最终确认的结算单保存\nhttp_response_code(200);\necho json_encode([\'status\' => \'success\', \'message\' => \'AI成功生成结算单\', \'data\' => $organized_data]);\n