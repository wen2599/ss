<?php\n\ndeclare(strict_types=1);\n\n// backend/settlement_rules.php\n\n/**\n * 根据号码获取对应的生肖。\n * 注意：这是一个基于通用年份的示例，实际的生肖分配可能因年份而异。\n * 您可能需要根据您业务的实际规则来调整此映射。\n * @param int $number 号码 (1-49)\n * @return string|null 对应的生肖，如果号码无效则返回null。\n */\nfunction get_zodiac_for_number(int $number): ?string\n{\n    if ($number < 1 || $number > 49) {\n        return null;\n    }\n\n    $zodiacs = [\n        '鼠' => [1, 13, 25, 37, 49],\n        '牛' => [12, 24, 36, 48],\n        '虎' => [11, 23, 35, 47],\n        '兔' => [10, 22, 34, 46],\n        '龙' => [9, 21, 33, 45],\n        '蛇' => [8, 20, 32, 44],\n        '马' => [7, 19, 31, 43],\n        '羊' => [6, 18, 30, 42],\n        '猴' => [5, 17, 29, 41],\n        '鸡' => [4, 16, 28, 40],\n        '狗' => [3, 15, 27, 39],\n        '猪' => [2, 14, 26, 38],\n    ];\n\n    foreach ($zodiacs as $zodiac => $numbers) {\n        if (in_array($number, $numbers)) {\n            return $zodiac;\n        }\n    }\n    return null; // Should not happen with valid numbers\n}\n\n/**\n * 核心结算函数：根据投注信息和开奖结果计算输赢金额。\n * @param array $bet 单条投注信息，包含 [\'type\', \'content\', \'amount\', \'odds\']。\n * @param array $winning_numbers 开奖号码数组 (7个数字)。\n * @return float 输赢金额。赢了是正数，输了是0。\n */\nfunction calculate_winnings(array $bet, array $winning_numbers): float\n{\n    $odds = floatval($bet['odds'] ?? 0);\n    $amount = floatval($bet['amount'] ?? 0);\n    if ($odds <= 0 || $amount <= 0) {\n        return 0.0;\n    }\n\n    $normal_numbers = array_slice($winning_numbers, 0, 6);\n    $special_number = $winning_numbers[6] ?? null;\n\n    switch (strtolower(trim($bet['type']))) {\n\n        case '特码':\n            $bet_number = intval($bet['content']);\n            return $bet_number === intval($special_number) ? $amount * $odds : 0.0;\n\n        case '平码':\n            $bet_number = intval($bet['content']);\n            return in_array($bet_number, $normal_numbers) ? $amount * $odds : 0.0;\n\n        case '三中二':\n            $bet_numbers = array_map(\'intval\', explode(',', $bet['content']));\n            $hit_count = count(array_intersect($bet_numbers, $normal_numbers));\n            // 规则：投注3个号码，命中至少2个平码即中奖。\n            return $hit_count >= 2 ? $amount * $odds : 0.0;\n\n        case '平一肖':\n            $bet_zodiac = trim($bet['content']);\n            foreach ($winning_numbers as $num) {\n                if (get_zodiac_for_number(intval($num)) === $bet_zodiac) {\n                    return $amount * $odds;\n                }\n            }\n            return 0.0;\n\n        case '合肖':\n            $bet_zodiacs = array_map(\'trim\', explode(',', $bet['content']));\n            $special_zodiac = get_zodiac_for_number(intval($special_number));\n            return in_array($special_zodiac, $bet_zodiacs) ? $amount * $odds : 0.0;\n\n        case '连肖':\n            $bet_zodiacs = array_map(\'trim\', explode(',', $bet['content']));\n            $winning_zodiacs = array_unique(array_map(fn($num) => get_zodiac_for_number(intval($num)), $winning_numbers));\n            $hit_count = count(array_intersect($bet_zodiacs, $winning_zodiacs));\n            // 规则：投注的生肖必须全部出现在开奖号码中。\n            return $hit_count === count($bet_zodiacs) ? $amount * $odds : 0.0;\n\n        default:\n            // 对于未知的投注类型，不计算输赢。\n            return 0.0;\n    }\n}\n