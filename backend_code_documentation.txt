backend/api_curl_helper.php
```php
<?php

/**
 * 通用的 API 调用辅助函数，处理 cURL 请求和基础错误。
 *
 * @param string $url API 的 URL 端点。
 * @param array $payload 要发送的请求体数据。
 * @param array $headers HTTP 请求头。
 * @param int $timeout 超时时间（秒）。
 * @return array 包含 http_code, response_body, curl_error 的数组。
 */
function _call_api_curl($url, $payload, $headers, $timeout = 90) {
    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($payload));
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_TIMEOUT, $timeout);

    $responseBody = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $curlError = curl_error($ch);
    curl_close($ch);

    return [
        'http_code' => $httpCode,
        'response_body' => $responseBody,
        'curl_error' => $curlError
    ];
}
```
--- 文件结束 ---

backend/api_header.php
```php
<?php
// backend/api_header.php

// Define the allowed origin. Use a specific domain for production for better security.
$allowed_origin = getenv('FRONTEND_URL') ?: '*'; // Fallback to wildcard for development if not set

// Set CORS headers to allow requests from the frontend domain.
// The 'Access-Control-Allow-Origin' header specifies which origins are allowed to access the resource.
header("Access-Control-Allow-Origin: {$allowed_origin}");

// The 'Access-Control-Allow-Credentials' header is crucial for sending cookies (and session data) across domains.
// It tells the browser that the server allows the request to include user credentials.
header('Access-Control-Allow-Credentials: true');

// The 'Access-Control-Allow-Methods' header specifies the HTTP methods allowed for the resource.
header('Access-Control-Allow-Methods: GET, POST, OPTIONS, DELETE, PUT');

// The 'Access-Control-Allow-Headers' header specifies the HTTP headers that can be used during the actual request.
header('Access-Control-Allow-Headers: Content-Type, Authorization, X-Requested-With');

// Handle pre-flight OPTIONS requests.
// A pre-flight request is sent by the browser to check if the server understands CORS and is aware of the actual request's method and headers.
// If the request method is 'OPTIONS', we terminate the script here to prevent further processing.
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(204); // No Content
    exit;
}

// Set a consistent JSON content type for all API responses.
header('Content-Type: application/json');

// Start or resume the session to access user authentication data.
// This must come after the CORS headers, especially in a cross-origin context.
if (session_status() === PHP_SESSION_NONE) {
    // Configure session cookie for cross-site contexts
    session_set_cookie_params([
        'lifetime' => 86400, // 24 hours
        'path' => '/',
        'domain' => '', // Set your domain in production, e.g., '.yourdomain.com'
        'secure' => true,   // Important for HTTPS
        'httponly' => true,
        'samesite' => 'None' // Crucial for cross-origin requests
    ]);
    session_start();
}

// Ensure errors are handled, and config is loaded.
require_once __DIR__ . '/config.php';
```
--- 文件结束 ---

backend/check_env.php
```php
<?php
header('Content-Type: text/plain; charset=utf-8');

echo "--- Environment Variable Diagnostic --- \n\n";

$envPath = __DIR__ . '/.env';

echo "Checking for .env file at: " . $envPath . "\n";

if (file_exists($envPath)) {
    echo "SUCCESS: .env file found.\n";
} else {
    echo "ERROR: .env file NOT FOUND at the expected location.\n";
    exit;
}

if (is_readable($envPath)) {
    echo "SUCCESS: .env file is readable.\n\n";
} else {
    echo "ERROR: .env file is NOT READABLE. Please check file permissions (e.g., `chmod 644 .env`).\n";
    exit;
}

// --- Test loading the .env file ---
$lines = file($envPath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
if ($lines === false) {
    echo "ERROR: Failed to read the .env file content, even though it exists and is readable.\n";
    exit;
}

echo "--- Simulating .env loading --- \n";
$found_db_host = false;
$found_telegram_secret = false;

foreach ($lines as $line) {
    if (strpos(trim($line), '#') === 0) continue;
    if (strpos($line, '=') !== false) {
        list($name, $value) = explode('=', $line, 2);
        $name = trim($name);
        if ($name === 'DB_HOST') {
            $found_db_host = true;
            echo "Found DB_HOST variable.\n";
        }
        if ($name === 'TELEGRAM_WEBHOOK_SECRET') {
            $found_telegram_secret = true;
            echo "Found TELEGRAM_WEBHOOK_SECRET variable.\n";
        }
    }
}

echo "\n--- Verification --- \n";
if ($found_db_host) {
    echo "SUCCESS: DB_HOST was found in the .env file.\n";
} else {
    echo "ERROR: DB_HOST was NOT found in the .env file.\n";
}

if ($found_telegram_secret) {
    echo "SUCCESS: TELEGRAM_WEBHOOK_SECRET was found in the .env file.\n";
} else {
    echo "ERROR: TELEGRAM_WEBHOOK_SECRET was NOT found in the .env file.\n";
}

echo "\n--- Final Diagnosis --- \n";
if ($found_db_host && $found_telegram_secret) {
    echo "The .env file seems correct. If issues persist, the problem might be with the `putenv` function on your server's PHP configuration or another server-level issue.\n";
} else {
    echo "One or more critical variables are missing from your .env file. Please ensure the file is complete and correctly formatted.\n";
}

?>
```
--- 文件结束 ---

backend/check_lottery_data.php
```php
<?php
// backend/check_lottery_data.php

// Set headers for clear text output in the browser
header('Content-Type: text/plain; charset=utf-8');

echo "--- Lottery Data Diagnostic Script ---\n\n";

// Include necessary files
require_once __DIR__ . '/api_header.php';
require_once __DIR__ . '/db_operations.php';

echo "Attempting to connect to the database...\n";

$pdo = get_db_connection();

if (is_array($pdo) && isset($pdo['db_error'])) {
    echo "FATAL: Database connection failed!\n";
    echo "Error: " . $pdo['db_error'] . "\n";
    exit;
}
if (!$pdo) {
    echo "FATAL: Database connection failed! (Returned null)\n";
    exit;
}

echo "Database connection successful.\n\n";
echo "Querying the 'lottery_results' table for any 10 entries...\n";

try {
    // A simple query to get a sample of data from the table
    $stmt = $pdo->query("SELECT * FROM lottery_results LIMIT 10");
    $results = $stmt->fetchAll(PDO::FETCH_ASSOC);

    if (empty($results)) {
        echo "RESULT: The 'lottery_results' table is EMPTY or contains no data.\n\n";
        echo "This is the primary reason why no lottery numbers are displayed.\n";
        echo "Please check the process that is supposed to be populating this table with data.\n";
    } else {
        echo "RESULT: Found " . count($results) . " entries. The table is NOT empty.\n\n";
        echo "Here is a sample of the data:\n\n";
        print_r($results);
        echo "\n\nIf the 'lottery_type' values below do not exactly match '新澳门六合彩', '香港六合彩', or '老澳门六合彩', the query will not find them.\n";
    }
} catch (PDOException $e) {
    echo "ERROR: An exception occurred while querying the database.\n";
    echo "Message: " . $e->getMessage() . "\n";
}

echo "\n--- End of Diagnostic Script ---\n";

?>
```
--- 文件结束 ---

backend/check_session.php
```php
<?php
// backend/check_session.php

require_once __DIR__ . '/api_header.php'; // Ensures session handling is started

// Check if the user is logged in
if (isset($_SESSION['user_id'])) {
    // User is authenticated, return their data
    // You might want to fetch more user details from the database here
    echo json_encode([
        'status' => 'success',
        'isAuthenticated' => true,
        'user' => [
            'id' => $_SESSION['user_id'],
            'email' => $_SESSION['user_email'] ?? 'N/A' 
        ]
    ]);
} else {
    // User is not authenticated
    echo json_encode([
        'status' => 'success',
        'isAuthenticated' => false
    ]);
}
?>
```
--- 文件结束 ---

backend/config.php
```php
<?php

// Define a constant for the base directory to ensure consistent paths.
if (!defined('DIR')) {
    define('DIR', __DIR__);
}

// --- Custom Debug Logging Function ---
function write_custom_debug_log($message) {
    // Log file is placed in the same directory as this script.
    $logFile = DIR . '/env_debug.log';
    // Use @ to suppress errors if the directory is not writable.
    @file_put_contents($logFile, date('[Y-m-d H:i:s]') . ' ' . $message . PHP_EOL, FILE_APPEND | LOCK_EX);
}

write_custom_debug_log("------ Config.php Entry Point ------");
write_custom_debug_log("Script running as user: " . (function_exists('posix_getpwuid') ? posix_getpwuid(posix_geteuid())['name'] : 'N/A'));

// --- Pre-emptive Writable Check ---
if (!is_writable(DIR)) {
    write_custom_debug_log("FATAL: Directory " . DIR . " is not writable.");
    // We don't exit here, to allow the rest of the script to try, but we log the critical failure.
} else {
    write_custom_debug_log("OK: Directory " . DIR . " is writable.");
}

/**
 * Robust .env loader
 */
function load_env_robust() {
    // Create an array of potential .env paths to check.
    $envPaths = [
        dirname(__DIR__) . '/.env', // Check parent directory first
        __DIR__ . '/.env'           // Then check the current directory (backend/)
    ];

    $envPathFound = null;

    foreach ($envPaths as $path) {
        write_custom_debug_log("Attempting to load .env from: {$path}");
        if (file_exists($path) && is_readable($path)) {
            $envPathFound = $path;
            write_custom_debug_log("Found readable .env file at: {$envPathFound}");
            break; // Stop searching once a valid file is found.
        } else {
            write_custom_debug_log(".env not found or not readable at {$path}");
        }
    }

    if ($envPathFound === null) {
        write_custom_debug_log("FATAL: Could not find a readable .env file in any of the checked locations.");
        return false;
    }

    $lines = file($envPathFound, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    if ($lines === false) {
        write_custom_debug_log("Failed to read .env file with file() function from: {$envPathFound}");
        return false;
    }

    write_custom_debug_log("Successfully read " . count($lines) . " lines from .env at {$envPathFound}.");

    foreach ($lines as $line) {
        $trim = trim($line);
        if ($trim === '' || strpos($trim, '#') === 0) {
            continue;
        }

        if (strpos($trim, '=') === false) {
            continue;
        }
        list($key, $value) = explode('=', $trim, 2);
        $key = trim($key);
        $value = trim($value);

        if ((substr($value, 0, 1) === '"' && substr($value, -1) === '"') ||
            (substr($value, 0, 1) === "'" && substr($value, -1) === "'")) {
            $value = substr($value, 1, -1);
        }

        putenv("{$key}={$value}");
        $_ENV[$key] = $value;
        $_SERVER[$key] = $value;

        // Log confirmation, but hide sensitive values.
        $sensitive_keys = ['DB_PASSWORD', 'TELEGRAM_BOT_TOKEN', 'GEMINI_API_KEY', 'CLOUDFLARE_API_TOKEN'];
        $display_value = in_array($key, $sensitive_keys, true) ? '***' : $value;
        write_custom_debug_log("Loaded env: {$key} = {$display_value}");
    }

    return true;
}

// Load environment variables only once per request.
if (!defined('ENV_LOADED_ROBUST')) {
    write_custom_debug_log("ENV_LOADED_ROBUST not defined, loading env variables.");
    if (load_env_robust()) {
        write_custom_debug_log("load_env_robust() completed successfully.");
    } else {
        write_custom_debug_log("load_env_robust() failed.");
    }
    define('ENV_LOADED_ROBUST', true);
    write_custom_debug_log("DB_HOST after load: " . (getenv('DB_HOST') ?: 'N/A'));
    write_custom_debug_log("DB_USER after load: " . (getenv('DB_USER') ?: 'N/A'));
}

// --- PHP Error Reporting Configuration ---
ini_set('display_errors', '0'); // Do not display errors to the user in production.
ini_set('log_errors', '1');
ini_set('error_log', DIR . '/debug.log');
error_reporting(E_ALL);
write_custom_debug_log("PHP error reporting configured to log to " . DIR . '/debug.log');

// --- Helper Scripts Inclusion ---
require_once DIR . '/db_operations.php';
require_once DIR . '/telegram_helpers.php';
require_once DIR . '/user_state_manager.php';
require_once DIR . '/api_curl_helper.php';
require_once DIR . '/gemini_ai_helper.php';
require_once DIR . '/cloudflare_ai_helper.php';
require_once DIR . '/env_manager.php';

write_custom_debug_log("------ Config.php Exit Point ------");

?>
```
--- 文件结束 ---

backend/db_operations.php
```php
<?php
/**
 * db_operations.php (MODIFIED TO BE SELF-SUFFICIENT)
 * This file now includes its own lightweight .env loader at the top.
 * This ensures that any script including this file will have the necessary
 * database environment variables loaded automatically.
 */

// --- START: Self-contained .env loader ---
if (!function_exists('load_env_if_not_loaded')) {
    function load_env_if_not_loaded() {
        // Check if a key known to be in the .env file is already loaded.
        // If it is, we assume the environment is already set up and do nothing.
        if (getenv('DB_HOST')) {
            return;
        }

        $envPath = __DIR__ . '/.env';
        if (!file_exists($envPath) || !is_readable($envPath)) return;

        $lines = file($envPath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
        if ($lines === false) return;

        foreach ($lines as $line) {
            $trim = trim($line);
            if ($trim === '' || strpos($trim, '#') === 0) continue;
            if (strpos($trim, '=') !== false) {
                list($key, $value) = explode('=', $trim, 2);
                $key = trim($key);
                $value = trim($value);
                // Remove surrounding quotes
                if ((substr($value, 0, 1) === '"' && substr($value, -1) === '"') ||
                    (substr($value, 0, 1) === "'" && substr($value, -1) === "'")) {
                    $value = substr($value, 1, -1);
                }
                putenv("{$key}={$value}");
                $_ENV[$key] = $value;
                $_SERVER[$key] = $value;
            }
        }
    }
    // Immediately call the loader function when this file is included.
    load_env_if_not_loaded();
}
// --- END: Self-contained .env loader ---


/**
 * Establishes and returns a singleton PDO database connection.
 */
function get_db_connection() {
    static $pdo = null;
    if ($pdo === null) {
        $host = getenv('DB_HOST');
        $port = getenv('DB_PORT');
        $dbname = getenv('DB_DATABASE');
        $user = getenv('DB_USER');
        $pass = getenv('DB_PASSWORD');

        // This check is now more likely to pass.
        if (empty($host) || empty($port) || empty($dbname) || empty($user)) {
             $error_msg = "Database connection error: Required environment variables are not set. Check DB_HOST, DB_PORT, DB_DATABASE, DB_USER in .env";
             error_log($error_msg);
             return ['db_error' => $error_msg];
        }

        $dsn = "mysql:host={$host};port={$port};dbname={$dbname};charset=utf8mb4";
        $options = [
            PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
            PDO::ATTR_EMULATE_PREPARES   => false,
        ];
        try {
            $pdo = new PDO($dsn, $user, $pass, $options);
        } catch (PDOException $e) {
            $error_msg = "Database connection failed: " . $e->getMessage();
            error_log($error_msg);
            return ['db_error' => $error_msg];
        }
    }
    return $pdo;
}

// ... the rest of the functions (getAllUsers, deleteUserByEmail, storeLotteryResult) remain exactly the same ...
// (You can copy them from your original file or just leave them as they are if you only add the top part)

/**
 * Retrieves all users from the database.
 */
function getAllUsers() {
    $pdo = get_db_connection();
    if (is_array($pdo) && isset($pdo['db_error'])) {
        error_log("getAllUsers: Failed to get database connection - " . $pdo['db_error']);
        return [];
    }
    if (!$pdo) return [];
    try {
        $stmt = $pdo->query("SELECT id, email, created_at FROM users ORDER BY created_at DESC");
        return $stmt->fetchAll();
    } catch (PDOException $e) {
        error_log("Error in getAllUsers: " . $e->getMessage());
        return [];
    }
}

/**
 * Deletes a user from the database by their email address.
 */
function deleteUserByEmail($email) {
    $pdo = get_db_connection();
    if (is_array($pdo) && isset($pdo['db_error'])) {
        error_log("deleteUserByEmail: Failed to get database connection - " . $pdo['db_error']);
        return false;
    }
    if (!$pdo) return false;
    try {
        $stmt = $pdo->prepare("DELETE FROM users WHERE email = ?");
        $stmt->execute([$email]);
        return $stmt->rowCount() > 0;
    } catch (PDOException $e) {
        error_log("Error in deleteUserByEmail for {$email}: " . $e->getMessage());
        return false;
    }
}

/**
 * Stores lottery results into the lottery_results table.
 */
function storeLotteryResult($lotteryType, $issueNumber, $winningNumbers, $zodiacSigns, $colors, $drawingDate) {
    $pdo = get_db_connection();
    if (is_array($pdo) && isset($pdo['db_error'])) {
        error_log("storeLotteryResult: Failed to get database connection - " . $pdo['db_error']);
        return false;
    }
    if (!$pdo) {
        error_log("storeLotteryResult: No database connection (returned null unexpectedly).");
        return false;
    }
    try {
        $stmt = $pdo->prepare("SELECT id FROM lottery_results WHERE lottery_type = ? AND issue_number = ?");
        $stmt->execute([$lotteryType, $issueNumber]);
        if ($stmt->fetch()) {
            error_log("Lottery result for type '{$lotteryType}' and issue '{$issueNumber}' already exists. Skipping insertion.");
            return true;
        }
        $stmt = $pdo->prepare(
            "INSERT INTO lottery_results (lottery_type, issue_number, winning_numbers, zodiac_signs, colors, drawing_date) VALUES (?, ?, ?, ?, ?, ?)"
        );
        $stmt->execute([$lotteryType, $issueNumber, $winningNumbers, $zodiacSigns, $colors, $drawingDate]);
        error_log("Successfully stored lottery result for {$lotteryType} - {$issueNumber}.");
        return true;
    } catch (PDOException $e) {
        error_log("Error storing lottery result for {$lotteryType} - {$issueNumber}: " . $e->getMessage());
        return false;
    }
}
```
--- 文件结束 ---

backend/cloudflare_ai_helper.php
```php
<?php

/**
 * 调用 Cloudflare Workers AI REST API。
 *
 * @param string $prompt 要发送给模型的文本提示。
 * @return string 模型的文本响应或错误信息。
 */
function call_cloudflare_ai_api($prompt) {
    // 从环境变量获取信息，这是最佳实践
    $accountId = getenv('CLOUDFLARE_ACCOUNT_ID');
    $apiToken = getenv('CLOUDFLARE_API_TOKEN');

    // 检查凭证是否已配置
    if (empty($accountId) || empty($apiToken)) {
        return '❌ **错误**: Cloudflare 账户ID或API令牌未配置。请检查环境变量。';
    }

    // 您可以在这里更换其他模型，例如 @cf/mistral/mistral-7b-instruct-v0.1
    $model = '@cf/meta/llama-3-8b-instruct';
    $apiUrl = "https://api.cloudflare.com/client/v4/accounts/{$accountId}/ai/run/{$model}";

    $payload = [
        'messages' => [
            ['role' => 'system', 'content' => '你是一个乐于助人的中文AI助手。'],
            ['role' => 'user', 'content' => $prompt]
        ]
    ];

    $headers = [
        'Authorization: Bearer ' . $apiToken,
        'Content-Type: application/json'
    ];

    // 使用通用函数发起请求
    $result = _call_api_curl($apiUrl, $payload, $headers);

    if ($result['http_code'] !== 200) {
        return "❌ **API 请求失败**: \n状态码: {$result['http_code']}\n响应: {$result['response_body']}\nCURL错误: {$result['curl_error']}";
    }

    $responseData = json_decode($result['response_body'], true);
    if (json_last_error() !== JSON_ERROR_NONE) {
        return '❌ **错误**: 解析 Cloudflare AI 的 JSON 响应失败。';
    }

    // 从响应中提取AI生成的文本
    $textResponse = $responseData['result']['response'] ?? null;
    if (!$textResponse) {
        // 如果找不到响应，打印整个响应体以便调试
        return '❌ **错误**: 未在 Cloudflare AI 输出中找到有效的文本响应。完整响应：' . $result['response_body'];
    }

    return $textResponse;
}
?>
```
--- 文件结束 ---

backend/database_schema.sql
```sql
-- Main user table for authentication
CREATE TABLE IF NOT EXISTS `users` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `username` varchar(255) NOT NULL,
  `email` varchar(255) NOT NULL,
  `password_hash` varchar(255) NOT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `email` (`email`),
  UNIQUE KEY `username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Table for authorizing emails before registration (currently unused but kept for potential future use)
CREATE TABLE IF NOT EXISTS `authorized_emails` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `email` varchar(255) NOT NULL,
  `status` varchar(50) NOT NULL DEFAULT 'pending',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Table for storing received emails
CREATE TABLE IF NOT EXISTS `emails` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `user_id` INT NOT NULL,
  `sender` VARCHAR(255) NOT NULL,
  `recipient` VARCHAR(255) NOT NULL,
  `subject` VARCHAR(255),
  `html_content` LONGTEXT,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  -- Columns for AI-extracted data
  `vendor_name` VARCHAR(255) DEFAULT NULL,
  `bill_amount` DECIMAL(10, 2) DEFAULT NULL,
  `currency` VARCHAR(10) DEFAULT NULL,
  `due_date` DATE DEFAULT NULL,
  `invoice_number` VARCHAR(255) DEFAULT NULL,
  `category` VARCHAR(100) DEFAULT NULL,
  `is_processed` BOOLEAN NOT NULL DEFAULT FALSE,
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Table for storing lottery results
CREATE TABLE IF NOT EXISTS `lottery_results` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `lottery_type` VARCHAR(100) NOT NULL,
  `issue_number` VARCHAR(255) NOT NULL,
  `winning_numbers` VARCHAR(255) NOT NULL,
  `zodiac_signs` VARCHAR(255) NOT NULL,
  `colors` VARCHAR(255) NOT NULL,
  `drawing_date` DATE,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY `type_issue` (`lottery_type`, `issue_number`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```
--- 文件结束 ---

backend/delete_bill.php
```php
<?php
// backend/delete_bill.php

require_once __DIR__ . '/api_header.php';

// --- Authentication Check ---
if (!isset($_SESSION['user_id'])) {
    http_response_code(401); // Unauthorized
    echo json_encode(['status' => 'error', 'message' => 'You must be logged in to perform this action.']);
    exit;
}

// Check if the request method is DELETE
if ($_SERVER['REQUEST_METHOD'] !== 'DELETE') {
    http_response_code(405); // Method Not Allowed
    echo json_encode(['status' => 'error', 'message' => 'Invalid request method.']);
    exit;
}

$pdo = get_db_connection();
$userId = $_SESSION['user_id'];
$emailId = $_GET['id'] ?? null;

if (!$emailId) {
    http_response_code(400); // Bad Request
    echo json_encode(['status' => 'error', 'message' => 'Bill ID is required.']);
    exit;
}

try {
    // Prepare and execute the delete query
    // IMPORTANT: The WHERE clause includes user_id to ensure a user can only delete their own bills.
    $stmt = $pdo->prepare("DELETE FROM emails WHERE id = ? AND user_id = ?");
    $stmt->execute([$emailId, $userId]);

    // Check if any row was actually deleted
    if ($stmt->rowCount() > 0) {
        echo json_encode(['status' => 'success', 'message' => '账单已成功删除。']);
    } else {
        // This means either the bill didn't exist or it didn't belong to the user
        http_response_code(404); // Not Found
        echo json_encode(['status' => 'error', 'message' => '未找到该账单或无权删除。']);
    }
} catch (PDOException $e) {
    error_log("Error deleting bill: " . $e->getMessage());
    http_response_code(500);
    echo json_encode(['status' => 'error', 'message' => 'An error occurred while deleting the bill.']);
}
```
--- 文件结束 ---
