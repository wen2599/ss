# GitHub Actions Workflow for Deploying Backend API
#
# This workflow automates the deployment of the backend API to a remote server.
# It is triggered on pushes to the 'main' branch that involve changes within the 'backend/' directory.
# Crucially, it excludes the 'config.php' file from the synchronization process to protect server-specific configurations.

name: Deploy Backend API

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**' # Trigger the workflow if any file in the backend directory changes
      - '!.github/workflows/**' # Do not trigger on workflow changes to avoid loops

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v3

      - name: 2. Set up SSH
        # This step configures the SSH connection to the server.
        # It uses secrets to securely store credentials.
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SERV00_KEY }}

      - name: 3. Add Server to Known Hosts
        # This prevents the 'Host key verification failed' error by adding the server's host key.
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERV00_HOST }} >> ~/.ssh/known_hosts

      - name: 4. Deploy Backend Files using rsync
        # This is the core deployment step.
        # It synchronizes the 'backend/' directory with the target directory on the server.
        # The '--exclude' flag is critical: it prevents 'config.php' from being overwritten.
        run: |
          rsync -avz --delete \
            --exclude 'config.php' \
            --exclude 'webhook_log.txt' \
            ./backend/ ${{ secrets.SERV00_USER }}@${{ secrets.SERV00_HOST }}:${{ secrets.SERV00_PATH }}
